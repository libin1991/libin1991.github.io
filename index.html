<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="LuckDay">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="LuckDay">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LuckDay">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>LuckDay</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LuckDay</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/æµ…è°ˆ-instanceof-å’Œ-typeof-çš„å®ç°åŸç†/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/æµ…è°ˆ-instanceof-å’Œ-typeof-çš„å®ç°åŸç†/" itemprop="url">æµ…è°ˆ instanceof å’Œ typeof çš„å®ç°åŸç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T13:17:32+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="typeof-å®ç°åŸç†"><a href="#typeof-å®ç°åŸç†" class="headerlink" title="typeof å®ç°åŸç†"></a>typeof å®ç°åŸç†</h3><p><code>typeof</code> ä¸€èˆ¬è¢«ç”¨äºåˆ¤æ–­ä¸€ä¸ªå˜é‡çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>typeof</code> æ¥åˆ¤æ–­<code>number</code>, <code>string</code>, <code>object</code>, <code>boolean</code>, <code>function</code>, <code>undefined</code>,<code>symbol</code> è¿™ä¸ƒç§ç±»å‹ï¼Œè¿™ç§åˆ¤æ–­èƒ½å¸®åŠ©æˆ‘ä»¬æå®šä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åœ¨åˆ¤æ–­ä¸æ˜¯ object ç±»å‹çš„æ•°æ®çš„æ—¶å€™ï¼Œ<code>typeof</code>èƒ½æ¯”è¾ƒæ¸…æ¥šçš„å‘Šè¯‰æˆ‘ä»¬å…·ä½“æ˜¯å“ªä¸€ç±»çš„ç±»å‹ã€‚ä½†æ˜¯ï¼Œå¾ˆé—æ†¾çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>typeof</code> åœ¨åˆ¤æ–­ä¸€ä¸ª objectçš„æ•°æ®çš„æ—¶å€™åªèƒ½å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæ•°æ®æ˜¯ object, è€Œä¸èƒ½ç»†è‡´çš„å…·ä½“åˆ°æ˜¯å“ªä¸€ç§ object, æ¯”å¦‚ğŸ‘‰</p>
<pre><code>let s =newString(&apos;abc&apos;);
typeof s ===&apos;object&apos;// true
s instanceofString// true
</code></pre><p>è¦æƒ³åˆ¤æ–­ä¸€ä¸ªæ•°æ®å…·ä½“æ˜¯å“ªä¸€ç§ object çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ <code>instanceof</code> è¿™ä¸ªæ“ä½œç¬¦æ¥åˆ¤æ–­ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢ä¼šè¯´åˆ°ã€‚</p>
<p>æ¥è°ˆè°ˆå…³äº <code>typeof</code> çš„åŸç†å§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæƒ³ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ï¼Œjs åœ¨åº•å±‚æ˜¯æ€ä¹ˆå­˜å‚¨æ•°æ®çš„ç±»å‹ä¿¡æ¯å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œä¸€ä¸ª js çš„å˜é‡ï¼Œåœ¨å®ƒçš„åº•å±‚å®ç°ä¸­ï¼Œå®ƒçš„ç±»å‹ä¿¡æ¯æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<p>å…¶å®ï¼Œjs åœ¨åº•å±‚å­˜å‚¨å˜é‡çš„æ—¶å€™ï¼Œä¼šåœ¨å˜é‡çš„æœºå™¨ç çš„ä½ä½1-3ä½å­˜å‚¨å…¶ç±»å‹ä¿¡æ¯ğŸ‘‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">000ï¼šå¯¹è±¡</span><br><span class="line"></span><br><span class="line">010ï¼šæµ®ç‚¹æ•°</span><br><span class="line"></span><br><span class="line">100ï¼šå­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">110ï¼šå¸ƒå°”</span><br></pre></td></tr></table></figure></p>
<ul>
<li>1ï¼šæ•´æ•°</li>
</ul>
<p>but, å¯¹äº <code>undefined</code> å’Œ <code>null</code> æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªå€¼çš„ä¿¡æ¯å­˜å‚¨æ˜¯æœ‰ç‚¹ç‰¹æ®Šçš„ã€‚</p>
<p><code>null</code>ï¼šæ‰€æœ‰æœºå™¨ç å‡ä¸º0</p>
<p><code>undefined</code>ï¼šç”¨ âˆ’2^30 æ•´æ•°æ¥è¡¨ç¤º</p>
<p>æ‰€ä»¥ï¼Œ<code>typeof</code> åœ¨åˆ¤æ–­ <code>null</code> çš„æ—¶å€™å°±å‡ºç°é—®é¢˜äº†ï¼Œç”±äº <code>null</code> çš„æ‰€æœ‰æœºå™¨ç å‡ä¸º0ï¼Œå› æ­¤ç›´æ¥è¢«å½“åšäº†å¯¹è±¡æ¥çœ‹å¾…ã€‚</p>
<p>ç„¶è€Œç”¨ <code>instanceof</code> æ¥åˆ¤æ–­çš„è¯ğŸ‘‰</p>
<pre><code>nullinstanceofnull// TypeError: Right-hand side of &apos;instanceof&apos; is not an object
</code></pre><p><code>null</code> ç›´æ¥è¢«åˆ¤æ–­ä¸ºä¸æ˜¯ objectï¼Œè¿™ä¹Ÿæ˜¯ JavaScript çš„å†å²é—ç•™bugï¼Œå¯ä»¥å‚è€ƒtypeofã€‚</p>
<p>å› æ­¤åœ¨ç”¨ <code>typeof</code> æ¥åˆ¤æ–­å˜é‡ç±»å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæœ€å¥½æ˜¯ç”¨ <code>typeof</code> æ¥åˆ¤æ–­åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆåŒ…æ‹¬<code>symbol</code>ï¼‰ï¼Œé¿å…å¯¹ null çš„åˆ¤æ–­ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªä¸é”™çš„åˆ¤æ–­ç±»å‹çš„æ–¹æ³•ï¼Œå°±æ˜¯<strong><font color="#dd0000">Object.prototype.toString</font></strong>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ–¹æ³•æ¥å¯¹ä¸€ä¸ªå˜é‡çš„ç±»å‹æ¥è¿›è¡Œæ¯”è¾ƒå‡†ç¡®çš„åˆ¤æ–­</p>
<pre><code>Object.prototype.toString.call(1)// &quot;[object Number]&quot;
Object.prototype.toString.call(&apos;hi&apos;)// &quot;[object String]&quot;
Object.prototype.toString.call({a:&apos;hi&apos;})// &quot;[object Object]&quot;
Object.prototype.toString.call([1,&apos;a&apos;])// &quot;[object Array]&quot;
Object.prototype.toString.call(true)// &quot;[object Boolean]&quot;
Object.prototype.toString.call(()=&gt;{})// &quot;[object Function]&quot;
Object.prototype.toString.call(null)// &quot;[object Null]&quot;
Object.prototype.toString.call(undefined)// &quot;[object Undefined]&quot;
Object.prototype.toString.call(Symbol(1))// &quot;[object Symbol]&quot;
</code></pre><h3 id="instanceof-æ“ä½œç¬¦çš„å®ç°åŸç†"><a href="#instanceof-æ“ä½œç¬¦çš„å®ç°åŸç†" class="headerlink" title="instanceof æ“ä½œç¬¦çš„å®ç°åŸç†"></a>instanceof æ“ä½œç¬¦çš„å®ç°åŸç†</h3><p>ä¹‹å‰æˆ‘ä»¬æåˆ°äº† <code>instanceof</code> æ¥åˆ¤æ–­å¯¹è±¡çš„å…·ä½“ç±»å‹ï¼Œå…¶å® <code>instanceof</code> ä¸»è¦çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­ä¸€ä¸ªå®ä¾‹æ˜¯å¦å±äºæŸç§ç±»å‹</p>
<pre><code>let person =function(){
}
let nicole =new person()
nicole instanceof person // true
</code></pre><p>å½“ç„¶ï¼Œ<code>instanceof</code> ä¹Ÿå¯ä»¥åˆ¤æ–­ä¸€ä¸ªå®ä¾‹æ˜¯å¦æ˜¯å…¶çˆ¶ç±»å‹æˆ–è€…ç¥–å…ˆç±»å‹çš„å®ä¾‹ã€‚</p>
<pre><code>let person =function(){
}
let programmer =function(){
}
programmer.prototype =new person()
let nicole =new programmer()
nicole instanceof person // true
nicole instanceof programmer // true
</code></pre><p>è¿™æ˜¯ <code>instanceof</code> çš„ç”¨æ³•ï¼Œä½†æ˜¯ <code>instanceof</code> çš„åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ® ECMAScript è¯­è¨€è§„èŒƒï¼Œæˆ‘æ¢³ç†äº†ä¸€ä¸‹å¤§æ¦‚çš„æ€è·¯ï¼Œç„¶åæ•´ç†äº†ä¸€æ®µä»£ç å¦‚ä¸‹</p>
<pre><code>function new_instance_of(leftVaule, rightVaule){
    let rightProto = rightVaule.prototype;// å–å³è¡¨è¾¾å¼çš„ prototype å€¼
    leftVaule = leftVaule.__proto__;// å–å·¦è¡¨è¾¾å¼çš„__proto__å€¼
    while(true){
        if(leftVaule ===null){
            returnfalse;    
        }
        if(leftVaule === rightProto){
            returntrue;    
        }
        leftVaule = leftVaule.__proto__ 
    }
}
</code></pre><p><font color="#dd0000">å…¶å® <code>instanceof</code> ä¸»è¦çš„å®ç°åŸç†å°±æ˜¯åªè¦å³è¾¹å˜é‡çš„ <code>prototype</code> åœ¨å·¦è¾¹å˜é‡çš„åŸå‹é“¾ä¸Šå³å¯ã€‚å› æ­¤ï¼Œ<code>instanceof</code> åœ¨æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­ä¼šéå†å·¦è¾¹å˜é‡çš„åŸå‹é“¾ï¼Œç›´åˆ°æ‰¾åˆ°å³è¾¹å˜é‡çš„ <code>prototype</code>ï¼Œå¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™ä¼šè¿”å› falseï¼Œå‘Šè¯‰æˆ‘ä»¬å·¦è¾¹å˜é‡å¹¶éæ˜¯å³è¾¹å˜é‡çš„å®ä¾‹ã€‚<br></font><br><br>çœ‹å‡ ä¸ªå¾ˆæœ‰è¶£çš„ä¾‹å­</p>
<pre><code>functionFoo(){
}
Object instanceof Object// true
Function instanceof Function// true
Function instanceof Object// true
Foo instanceof Foo// false
Foo instanceof Object// true
Foo instanceof Function// true
</code></pre><p>è¦æƒ³å…¨éƒ¨ç†è§£ <code>instanceof</code> çš„åŸç†ï¼Œé™¤äº†æˆ‘ä»¬åˆšåˆšæåˆ°çš„å®ç°åŸç†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ JavaScript çš„åŸå‹ç»§æ‰¿åŸç†ã€‚</p>
<p>å…³äºåŸå‹ç»§æ‰¿çš„åŸç†ï¼Œæˆ‘ç®€å•ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/meG6Vo0MevjCzDE6dwt2qtltaDsSluC9M8KmmeZsLSJnFTgdTtcCRToR3zWJFYicViaUlvyAGdfwEzADj8Jk8kzQ/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""><br>æˆ‘ä»¬çŸ¥é“æ¯ä¸ª JavaScript å¯¹è±¡å‡æœ‰ä¸€ä¸ªéšå¼çš„ <code>__proto__</code> åŸå‹å±æ€§ï¼Œè€Œæ˜¾å¼çš„åŸå‹å±æ€§æ˜¯ <code>prototype</code>ï¼Œåªæœ‰ <code>Object.prototype.__proto__</code> å±æ€§åœ¨æœªä¿®æ”¹çš„æƒ…å†µä¸‹ä¸º null å€¼ã€‚æ ¹æ®å›¾ä¸Šçš„åŸç†ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸Šé¢æåˆ°çš„å‡ ä¸ªæœ‰è¶£çš„ <code>instanceof</code> ä½¿ç”¨çš„ä¾‹å­ã€‚</p>
<p><code>Object instanceof Object</code></p>
<p>ç”±å›¾å¯çŸ¥ï¼ŒObject çš„ <code>prototype</code> å±æ€§æ˜¯ <code>Object.prototype</code>, è€Œç”±äº Object æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”± Function æ‰€åˆ›å»ºï¼Œæ‰€ä»¥ <code>Object.__proto__</code> çš„å€¼æ˜¯ <code>Function.prototype</code>ï¼Œè€Œ <code>Function.prototype</code> çš„ <code>__proto__</code> å±æ€§æ˜¯ <code>Object.prototype</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡ºï¼Œ<code>Object instanceof Object</code> çš„ç»“æœæ˜¯ true ã€‚ç”¨ä»£ç ç®€å•çš„è¡¨ç¤ºä¸€ä¸‹</p>
<pre><code>leftValue =Object.__proto__ =Function.prototype;
rightValue =Object.prototype;
// ç¬¬ä¸€æ¬¡åˆ¤æ–­
leftValue != rightValue
leftValue =Function.prototype.__proto__ =Object.prototype
// ç¬¬äºŒæ¬¡åˆ¤æ–­
leftValue === rightValue
// è¿”å› true
</code></pre><p><code>Function instanceof Function</code> å’Œ <code>Function instanceof Object</code> çš„è¿è¡Œè¿‡ç¨‹ä¸ <code>Object instanceof Object</code> ç±»ä¼¼ï¼Œæ•…ä¸å†è¯¦è¯´ã€‚</p>
<p><code>Foo instanceof Foo</code></p>
<p>Foo å‡½æ•°çš„ <code>prototype</code> å±æ€§æ˜¯ <code>Foo.prototype</code>ï¼Œè€Œ Foo çš„ <code>__proto__</code> å±æ€§æ˜¯ <code>Function.prototype</code>ï¼Œç”±å›¾å¯çŸ¥ï¼ŒFoo çš„åŸå‹é“¾ä¸Šå¹¶æ²¡æœ‰ <code>Foo.prototype</code> ï¼Œå› æ­¤ <code>Foo instanceof Foo</code> ä¹Ÿå°±è¿”å› false ã€‚</p>
<p>æˆ‘ä»¬ç”¨ä»£ç ç®€å•çš„è¡¨ç¤ºä¸€ä¸‹</p>
<pre><code>leftValue =Foo, rightValue =Foo
leftValue =Foo.__proto =Function.prototype
rightValue =Foo.prototype
// ç¬¬ä¸€æ¬¡åˆ¤æ–­
leftValue != rightValue
leftValue =Function.prototype.__proto__ =Object.prototype
// ç¬¬äºŒæ¬¡åˆ¤æ–­
leftValue != rightValue
leftValue =Object.prototype =null
// ç¬¬ä¸‰æ¬¡åˆ¤æ–­
leftValue ===null
// è¿”å› false
</code></pre><p><code>Foo instanceof Object</code></p>
<pre><code>leftValue =Foo, rightValue =Object
leftValue =Foo.__proto__ =Function.prototype
rightValue =Object.prototype
// ç¬¬ä¸€æ¬¡åˆ¤æ–­
leftValue != rightValue
leftValue =Function.prototype.__proto__ =Object.prototype
// ç¬¬äºŒæ¬¡åˆ¤æ–­
leftValue === rightValue
// è¿”å› true 
</code></pre><p><code>Foo instanceof Function</code></p>
<pre><code>leftValue =Foo, rightValue =Function
leftValue =Foo.__proto__ =Function.prototype
rightValue =Function.prototype
// ç¬¬ä¸€æ¬¡åˆ¤æ–­
leftValue === rightValue
// è¿”å› true 
</code></pre><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>typeof</code> æ¥åˆ¤æ–­åŸºæœ¬æ•°æ®ç±»å‹æ˜¯ ok çš„ï¼Œä¸è¿‡éœ€è¦æ³¨æ„å½“ç”¨ <code>typeof</code> æ¥åˆ¤æ–­ <code>null</code> ç±»å‹æ—¶çš„é—®é¢˜ï¼Œå¦‚æœæƒ³è¦åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡çš„å…·ä½“ç±»å‹å¯ä»¥è€ƒè™‘ç”¨ <code>instanceof</code>ï¼Œä½†æ˜¯ <code>instanceof</code> ä¹Ÿå¯èƒ½åˆ¤æ–­ä¸å‡†ç¡®ï¼Œæ¯”å¦‚ä¸€ä¸ªæ•°ç»„ï¼Œä»–å¯ä»¥è¢« <code>instanceof</code> åˆ¤æ–­ä¸º Objectã€‚æ‰€ä»¥æˆ‘ä»¬è¦æƒ³æ¯”è¾ƒå‡†ç¡®çš„åˆ¤æ–­å¯¹è±¡å®ä¾‹çš„ç±»å‹æ—¶ï¼Œå¯ä»¥é‡‡å– <code>Object.prototype.toString.call</code> æ–¹æ³•ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/ä½ å¯èƒ½ä¼šå¿½ç•¥çš„vue-routeræŠ€å·§/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/ä½ å¯èƒ½ä¼šå¿½ç•¥çš„vue-routeræŠ€å·§/" itemprop="url">ä½ å¯èƒ½ä¼šå¿½ç•¥çš„vue-routeræŠ€å·§</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T12:50:52+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="è¯´åˆ°Vueæƒé™æ§åˆ¶ï¼Œä½ å¯èƒ½ä¼šç¬¬ä¸€ä¸ªæƒ³åˆ°"><a href="#è¯´åˆ°Vueæƒé™æ§åˆ¶ï¼Œä½ å¯èƒ½ä¼šç¬¬ä¸€ä¸ªæƒ³åˆ°" class="headerlink" title="è¯´åˆ°Vueæƒé™æ§åˆ¶ï¼Œä½ å¯èƒ½ä¼šç¬¬ä¸€ä¸ªæƒ³åˆ°"></a>è¯´åˆ°Vueæƒé™æ§åˆ¶ï¼Œä½ å¯èƒ½ä¼šç¬¬ä¸€ä¸ªæƒ³åˆ°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by superman on 17/2/16.</span><br><span class="line"> * httpé…ç½®</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">import axios from &apos;axios&apos;</span><br><span class="line">import store from &apos;./store/store&apos;</span><br><span class="line">import * as types from &apos;./store/types&apos;</span><br><span class="line">import router from &apos;./router&apos;</span><br><span class="line"></span><br><span class="line">// axios é…ç½®</span><br><span class="line">axios.defaults.timeout = 5000;</span><br><span class="line">axios.defaults.baseURL = &apos;https://api.github.com&apos;;</span><br><span class="line"></span><br><span class="line">// http request æ‹¦æˆªå™¨</span><br><span class="line">axios.interceptors.request.use(</span><br><span class="line">    config =&gt; &#123;</span><br><span class="line">        if (store.state.token) &#123;</span><br><span class="line">            config.headers.Authorization = `token $&#123;store.state.token&#125;`;</span><br><span class="line">        &#125;</span><br><span class="line">        return config;</span><br><span class="line">    &#125;,</span><br><span class="line">    err =&gt; &#123;</span><br><span class="line">        return Promise.reject(err);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">// http response æ‹¦æˆªå™¨</span><br><span class="line">axios.interceptors.response.use(</span><br><span class="line">    response =&gt; &#123;</span><br><span class="line">        return response;</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">        if (error.response) &#123;</span><br><span class="line">            switch (error.response.status) &#123;</span><br><span class="line">                case 401:</span><br><span class="line">                    // 401 æ¸…é™¤tokenä¿¡æ¯å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢</span><br><span class="line">                    store.commit(types.LOGOUT);</span><br><span class="line">                    router.replace(&#123;</span><br><span class="line">                        path: &apos;login&apos;,</span><br><span class="line">                        query: &#123;redirect: router.currentRoute.fullPath&#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // console.log(JSON.stringify(error));//console : Error: Request failed with status code 402</span><br><span class="line">        return Promise.reject(error.response.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">export default axios;</span><br></pre></td></tr></table></figure>
<h3 id="VueRouter"><a href="#VueRouter" class="headerlink" title="VueRouter"></a>VueRouter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const router = new VueRouter(&#123;</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.beforeEach((to, from, next) =&gt; &#123;</span><br><span class="line">    if (to.path == &apos;/login&apos;) &#123;</span><br><span class="line">         //æ¸…é™¤token</span><br><span class="line">         ...</span><br><span class="line">    &#125;</span><br><span class="line">    let token = get(&apos;token&apos;);   //è·å–token</span><br><span class="line">    if (!token &amp;&amp; to.path != &apos;/login&apos;) &#123;</span><br><span class="line">        next(&#123; path: &apos;/login&apos; &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="ä½†ä¸Šé¢çš„åªèƒ½å¯¹ç™»å½•æ‹¦æˆª-è·³è½¬æ‹¦æˆªï¼Œä¸èƒ½æ§åˆ¶useræƒé™ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯åŠ¨æ€æ³¨å…¥è·¯ç”±addRoutes"><a href="#ä½†ä¸Šé¢çš„åªèƒ½å¯¹ç™»å½•æ‹¦æˆª-è·³è½¬æ‹¦æˆªï¼Œä¸èƒ½æ§åˆ¶useræƒé™ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯åŠ¨æ€æ³¨å…¥è·¯ç”±addRoutes" class="headerlink" title="ä½†ä¸Šé¢çš„åªèƒ½å¯¹ç™»å½•æ‹¦æˆª,è·³è½¬æ‹¦æˆªï¼Œä¸èƒ½æ§åˆ¶useræƒé™ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯åŠ¨æ€æ³¨å…¥è·¯ç”±addRoutes"></a>ä½†ä¸Šé¢çš„åªèƒ½å¯¹ç™»å½•æ‹¦æˆª,è·³è½¬æ‹¦æˆªï¼Œä¸èƒ½æ§åˆ¶useræƒé™ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯åŠ¨æ€æ³¨å…¥è·¯ç”±<strong><font color="#dd0000">addRoutes</font></strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import router from &apos;./router&apos;</span><br><span class="line">router.addRoutes(routes)</span><br><span class="line">æˆ–è€…</span><br><span class="line">this.$router.addRoutes(routers)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/Vueæ‰‹åŠ¿åº“/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/Vueæ‰‹åŠ¿åº“/" itemprop="url">Vueæ‰‹åŠ¿åº“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T12:48:23+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">function vueTouch(el, binding, type) &#123;</span><br><span class="line">	var _this = this;</span><br><span class="line">	this.obj = el;</span><br><span class="line">	this.binding = binding;</span><br><span class="line">	this.touchType = type;</span><br><span class="line">	this.vueTouches = &#123;</span><br><span class="line">		x: 0,</span><br><span class="line">		y: 0</span><br><span class="line">	&#125;;</span><br><span class="line">	this.vueMoves = true;</span><br><span class="line">	this.vueLeave = true;</span><br><span class="line">	this.longTouch = true;</span><br><span class="line"></span><br><span class="line">	this.vueCallBack = typeof(binding.value) == &quot;object&quot; ? binding.value.fn : binding.value;</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchstart&quot;, function(e) &#123;</span><br><span class="line">		_this.start(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchmove&quot;, function(e) &#123;</span><br><span class="line">		_this.move(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchend&quot;, function(e) &#123;</span><br><span class="line">		_this.end(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line">&#125;;</span><br><span class="line">vueTouch.prototype = &#123;</span><br><span class="line">	start(e) &#123;</span><br><span class="line">		this.vueMoves = true;</span><br><span class="line">		this.vueLeave = true;</span><br><span class="line">		this.longTouch = true;</span><br><span class="line">		this.vueTouches = &#123;</span><br><span class="line">			x: e.changedTouches[0].pageX,</span><br><span class="line">			y: e.changedTouches[0].pageY</span><br><span class="line">		&#125;;</span><br><span class="line">		this.time = setTimeout(function() &#123;</span><br><span class="line">			if(this.vueLeave &amp;&amp; this.vueMoves) &#123;</span><br><span class="line">				this.touchType == &quot;longtap&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				this.longTouch = false;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;.bind(this), 1000);</span><br><span class="line">	&#125;,</span><br><span class="line">	end(e) &#123;</span><br><span class="line">		var disX = e.changedTouches[0].pageX - this.vueTouches.x;</span><br><span class="line">		var disY = e.changedTouches[0].pageY - this.vueTouches.y;</span><br><span class="line">		clearTimeout(this.time);</span><br><span class="line">		if(Math.abs(disX) &gt; 10 || Math.abs(disY) &gt; 100) &#123;</span><br><span class="line">			this.touchType == &quot;swipe&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">			if(Math.abs(disX) &gt; Math.abs(disY)) &#123;</span><br><span class="line">				if(disX &gt; 10) &#123;</span><br><span class="line">					this.touchType == &quot;swiperight&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">				if(disX &lt; -10) &#123;</span><br><span class="line">					this.touchType == &quot;swipeleft&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				if(disY &gt; 10) &#123;</span><br><span class="line">					this.touchType == &quot;swipedown&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">				if(disY &lt; -10) &#123;</span><br><span class="line">					this.touchType == &quot;swipeup&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if(this.longTouch &amp;&amp; this.vueMoves) &#123;</span><br><span class="line">				this.touchType == &quot;tap&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				this.vueLeave = false</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;,</span><br><span class="line">	move(e) &#123;</span><br><span class="line">		this.vueMoves = false;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vue.directive(&quot;tap&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;tap&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipe&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipe&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipeleft&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipeleft&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swiperight&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swiperight&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipedown&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipedown&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipeup&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipeup&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;longtap&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;longtap&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html id=&quot;html&quot;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">		&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no&quot; /&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;style&gt;</span><br><span class="line">			.box &#123;</span><br><span class="line">				width: 250px;</span><br><span class="line">				height: 250px;</span><br><span class="line">				background-color: red;</span><br><span class="line">				color: #FFFFFF;</span><br><span class="line">				text-align: center;</span><br><span class="line">				line-height: 250px;</span><br><span class="line">				font-size: 30px;</span><br><span class="line">				position: absolute;</span><br><span class="line">				margin: auto;</span><br><span class="line">				left: 0;</span><br><span class="line">				right: 0;</span><br><span class="line">				top: 0;</span><br><span class="line">				bottom: 0;</span><br><span class="line">			&#125;</span><br><span class="line">		&lt;/style&gt;</span><br><span class="line">		&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot; src=&quot;js/vue-touch.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot; class=&quot;box&quot; v-tap=&quot;&#123;fn:vuetap,name:&apos;ç‚¹å‡»&apos;&#125;&quot; v-longtap=&quot;&#123;fn:vuetap,name:&apos;é•¿æŒ‰&apos;&#125;&quot; v-swipeleft=&quot;&#123;fn:vuetap,name:&apos;å·¦æ»‘&apos;&#125;&quot; v-swiperight=&quot;&#123;fn:vuetap,name:&apos;å³æ»‘&apos;&#125;&quot; v-swipeup=&quot;&#123;fn:vuetap,name:&apos;ä¸Šæ»‘&apos;&#125;&quot; v-swipedown=&quot;&#123;fn:vuetap,name:&apos;ä¸‹æ»‘&apos;&#125;&quot;&gt;</span><br><span class="line">			&#123;&#123; name &#125;&#125;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;!--</span><br><span class="line">	vuetouchä¸ºå‡½æ•°åï¼Œå¦‚æ²¡æœ‰å‚æ•°ï¼Œå¯ç›´æ¥å†™å‡½æ•°å,æ¯”å¦‚ï¼šv-tap=&quot;vuetap&quot;</span><br><span class="line">	å¦‚æœæœ‰å‚æ•°ä»¥å¯¹è±¡å½¢å¼ä¼ ï¼Œfn ä¸ºå‡½æ•°å</span><br><span class="line">--&gt;</span><br><span class="line">		&lt;script&gt;</span><br><span class="line">			kim = new Vue(&#123;</span><br><span class="line">				el: &quot;#app&quot;,</span><br><span class="line">				data: &#123;</span><br><span class="line">					name: &quot;å¼€å§‹&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				methods: &#123;</span><br><span class="line">					vuetap: function(s, e) &#123;</span><br><span class="line">						console.log(e)</span><br><span class="line">						this.name = s.name;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/async-await-å°æŠ€å·§/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/async-await-å°æŠ€å·§/" itemprop="url">async/await å°æŠ€å·§</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T11:58:49+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="async-await-å°æŠ€å·§"><a href="#async-await-å°æŠ€å·§" class="headerlink" title="async/await å°æŠ€å·§"></a>async/await å°æŠ€å·§</h1><h2 id="sleep-å‡½æ•°"><a href="#sleep-å‡½æ•°" class="headerlink" title="sleep å‡½æ•°"></a>sleep å‡½æ•°</h2><p>ä»¥å‰åªæ¥ä½¿ç”¨ <code>setTimeout</code> å’Œå›è°ƒå‡½æ•°å®ç°ä¸€ä¸ª <code>sleep</code> ä¼šæœ‰å¾ˆå¤šçš„å‰¯ä½œç”¨ï¼Œç”¨èµ·æ¥å¾ˆä¸æ–¹ä¾¿ã€‚</p>
<p>æ‰€ä»¥è®© <code>setTimeout</code> æ­é…ä½¿ç”¨ <code>async/await</code></p>
<pre><code>constsleep=delay=&gt; {
  returnnewPromise(resolve=&gt; {
    setTimeout(resolve, delay)
  })
}

constfn=async_=&gt; {
  console.log(&apos;starting....&apos;)
  awaitsleep(1000)
  console.log(&apos;after sleeping for 1 second&apos;)
}
</code></pre><h2 id="æ­é…-map-å‡½æ•°"><a href="#æ­é…-map-å‡½æ•°" class="headerlink" title="æ­é… map() å‡½æ•°"></a>æ­é… map() å‡½æ•°</h2><p>åœ¨ <code>map</code> ä¸­å¼•å…¥å¼‚æ­¥å¤„ç†:</p>
<pre><code>constarr= [1,2,3,4,5]
constasyncFn=data=&gt; {
  // å¼‚æ­¥å¤„ç†å‡½æ•°
}

constresults=arr.map(asyncnum=&gt; {
  awaitasyncFn(num)
  return++num
})

console.log(results)
</code></pre><p>ä»£ç æ‰§è¡Œåçš„ç»“æœ <code>[Promise, Promise, Promise, Promise, Promise]</code> è€Œä¸” <code>map</code> å‡½æ•°å¹¶ä¸ä¼šç­‰å¼‚æ­¥å‡½æ•° <code>asyncFn</code> æ‰§è¡Œå®Œæ¯•åå†è¿”å›ç»“æœ</p>
<p>æ—¢ç„¶ <code>async</code> æ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ª <code>Promise</code> å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ <code>Promise.all</code> çš„çŠ¶æ€æ¥åˆ¤æ–­å¼‚æ­¥å‡½æ•°çš„çŠ¶æ€:</p>
<pre><code>constarr= [1,2,3,4,5]
constasyncFn=data=&gt; {
  // å¼‚æ­¥å¤„ç†å‡½æ•°
}
constp=arr.map(asyncnum=&gt; {
  awaitasyncFn(num)
  return++num
})

Promise.all(p).then(results=&gt; {
  console.log(results)
})
</code></pre><p>è¿™æ ·å°±èƒ½æ­£å¸¸è¿”å›ç»“æœ <code>[2, 3, 4, 5, 6]</code></p>
<h2 id="ä½¿ç”¨-await-ä»£æ›¿-then-å‡½æ•°"><a href="#ä½¿ç”¨-await-ä»£æ›¿-then-å‡½æ•°" class="headerlink" title="ä½¿ç”¨ await ä»£æ›¿ then() å‡½æ•°"></a>ä½¿ç”¨ await ä»£æ›¿ then() å‡½æ•°</h2><p>ä¸Šé¢çš„ä¾‹å­æœ€åä½¿ç”¨äº† <code>Promise.all</code>  è¿˜æ˜¯å›åˆ°äº†ä½¿ç”¨å›è°ƒå‡½æ•°çš„æ–¹å¼</p>
<p>è¿™ä¸ªä¹Ÿå¾ˆå¥½è§£å†³ï¼Œåªéœ€è¦åœ¨å¤–å±‚å†åŠ ä¸€ä¸ª <code>async</code> å‡½æ•°</p>
<pre><code>constmain=async_=&gt; {
  constresults=awaitPromise.all(arr.map(num=&gt; {
    awaitasyncFn()
    return++num
  }))
  console.log(results)
}

main()
</code></pre><h2 id="æ­é…-reduce-å‡½æ•°"><a href="#æ­é…-reduce-å‡½æ•°" class="headerlink" title="æ­é… reduce() å‡½æ•°"></a>æ­é… reduce() å‡½æ•°</h2><p>é€šè¿‡å¼•å…¥ <code>async/await</code> å¯ä»¥æŠŠ <code>reduce</code> æ‰©å±•æˆä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œå¼‚æ­¥å‡½æ•°çš„å·¥å…·</p>
<p><code>reduce</code> ç”¨èµ·æ¥å¾ˆç®€å•:</p>
<pre><code>constarr= [1,2,3,4,5]
constresult=arr.reduce((prev, next) =&gt; {
  return prev+next
}, 0)

console.log(result)
</code></pre><p>åƒ <code>map</code> å‡½æ•°ä¸€æ ·å¼•å…¥ <code>async/await</code> :</p>
<pre><code>constarr= [1,2,3,4,5]
constmain=async_=&gt; {
  constresult=awaitarr.reduce(async (prev, next) =&gt; {
    consttmp=await prev
    return tmp + next
  }, Promise.resolve(0))

  console.log(result)
}

main()
</code></pre><p>è€Œä¸”è¿˜å¯ä»¥åœ¨ <code>reduce</code> å†…éƒ¨åŠ å…¥å¼‚æ­¥å‡½æ•°:</p>
<pre><code>constarr= [1,2,3,4,5]
constmain=async_=&gt; {
  constresult=awaitarr.reduce(async (prev, next) =&gt; {
    consttmp=await prev

    // å¼‚æ­¥å¤„ç† æš‚åœ1sawaitsleep(1000)
    console.log(tmp + next)

    return tmp + next
  }, Promise.resolve(0))
}

main()
</code></pre><p>ä¸Šè¿°ä»£ç ä¼šæ¯éš”ä¸€ç§’ä¾æ¬¡æ‰“å‡º 1 3 6 10 15</p>
<p>å‚è€ƒè‡ª</p>
<blockquote>
<p><a href="http://2ality.com/2016/10/async-function-tips.html" target="_blank" rel="noopener">http://2ality.com/2016/10/async-function-tips.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/Event-Loop-å¿…çŸ¥å¿…ä¼šï¼ˆå…­é“é¢˜ï¼‰/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/Event-Loop-å¿…çŸ¥å¿…ä¼šï¼ˆå…­é“é¢˜ï¼‰/" itemprop="url">Event Loop å¿…çŸ¥å¿…ä¼šï¼ˆå…­é“é¢˜ï¼‰</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T11:48:09+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ä¸€ç›´æƒ³å†™ä¸€ç¯‡å…³äº Event Loop çš„æ–‡ç« ï¼Œå‰ä¸ä¹…å‘ç° CNode ä¸Šæœ‰ä½åŒå­¦å†™äº†ä¸€ç¯‡åŸç†åˆ†æçš„<a href="https://link.zhihu.com/?target=https%3A//cnodejs.org/topic/5a9108d78d6e16e56bb80882%235a98d9a2ce1c90bc44c445af" target="_blank" rel="noopener">æ–‡ç« </a>å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œæˆ‘å°±ä¸çŒ®ä¸‘äº†ã€‚æœ¬æ–‡å°±æ‹¿å‡ºå…­é“é¢˜æ¥è¡¥å……ä¸€ä¸‹ï¼Œæ”¾å‡ºä¸€å¼ æˆ‘è®¤ä¸ºéå¸¸ç›´è§‚çš„å›¾ã€‚<br><img src="https://pic4.zhimg.com/v2-3a59c624e6ff95a7e8c5a23c979f5abe_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-3a59c624e6ff95a7e8c5a23c979f5abe_hd.jpg" alt=""><br>ç»¿è‰²å°å—æ˜¯ macrotaskï¼ˆå®ä»»åŠ¡ï¼‰ï¼Œmacrotask ä¸­é—´çš„ç²‰çº¢ç®­å¤´æ˜¯ microtaskï¼ˆå¾®ä»»åŠ¡ï¼‰ã€‚</p>
<h2 id="é¢˜ç›®ä¸€"><a href="#é¢˜ç›®ä¸€" class="headerlink" title="é¢˜ç›®ä¸€"></a>é¢˜ç›®ä¸€</h2><pre><code>setTimeout(()=&gt;{console.log(&apos;setTimeout&apos;)},0)setImmediate(()=&gt;{console.log(&apos;setImmediate&apos;)})
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<pre><code>setImmediate
setTimeout
</code></pre><p>æˆ–è€…ï¼š</p>
<pre><code>setTimeout
setImmediate
</code></pre><p>ä¸ºä»€ä¹ˆç»“æœä¸ç¡®å®šå‘¢ï¼Ÿ</p>
<p>è§£é‡Šï¼šsetTimeout/setInterval çš„ç¬¬äºŒä¸ªå‚æ•°å–å€¼èŒƒå›´æ˜¯ï¼š[1, 2^31 - 1]ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªèŒƒå›´åˆ™ä¼šåˆå§‹åŒ–ä¸º 1ï¼Œå³ setTimeout(fn, 0) === setTimeout(fn, 1)ã€‚æˆ‘ä»¬çŸ¥é“ setTimeout çš„å›è°ƒå‡½æ•°åœ¨ timer é˜¶æ®µæ‰§è¡Œï¼ŒsetImmediate çš„å›è°ƒå‡½æ•°åœ¨ check é˜¶æ®µæ‰§è¡Œï¼Œevent loop çš„å¼€å§‹ä¼šå…ˆæ£€æŸ¥ timer é˜¶æ®µï¼Œä½†æ˜¯åœ¨å¼€å§‹ä¹‹å‰åˆ° timer é˜¶æ®µä¼šæ¶ˆè€—ä¸€å®šæ—¶é—´ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>timer å‰çš„å‡†å¤‡æ—¶é—´è¶…è¿‡ 1msï¼Œæ»¡è¶³  loop-&gt;time &gt;= 1ï¼Œåˆ™æ‰§è¡Œ timer é˜¶æ®µï¼ˆsetTimeoutï¼‰çš„å›è°ƒå‡½æ•°</li>
<li>timer å‰çš„å‡†å¤‡æ—¶é—´å°äº 1msï¼Œåˆ™å…ˆæ‰§è¡Œ check é˜¶æ®µï¼ˆsetImmediateï¼‰çš„å›è°ƒå‡½æ•°ï¼Œä¸‹ä¸€æ¬¡ event loop æ‰§è¡Œ timer é˜¶æ®µï¼ˆsetTimeoutï¼‰çš„å›è°ƒå‡½æ•°</li>
</ol>
<p>å†çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code>setTimeout(()=&gt;{console.log(&apos;setTimeout&apos;)},0)setImmediate(()=&gt;{console.log(&apos;setImmediate&apos;)})conststart=Date.now()while(Date.now()-start&lt;10);
</code></pre><p>è¿è¡Œç»“æœä¸€å®šæ˜¯ï¼š</p>
<pre><code>setTimeout
setImmediate
</code></pre><h2 id="é¢˜ç›®äºŒ"><a href="#é¢˜ç›®äºŒ" class="headerlink" title="é¢˜ç›®äºŒ"></a>é¢˜ç›®äºŒ</h2><pre><code>constfs=require(&apos;fs&apos;)fs.readFile(__filename,()=&gt;{setTimeout(()=&gt;{console.log(&apos;setTimeout&apos;)},0)setImmediate(()=&gt;{console.log(&apos;setImmediate&apos;)})})
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<pre><code>setImmediate
setTimeout
</code></pre><p>è§£é‡Šï¼šfs.readFile çš„å›è°ƒå‡½æ•°æ‰§è¡Œå®Œåï¼š</p>
<ol>
<li>æ³¨å†Œ setTimeout çš„å›è°ƒå‡½æ•°åˆ° timer é˜¶æ®µ</li>
<li>æ³¨å†Œ setImmediate çš„å›è°ƒå‡½æ•°åˆ° check é˜¶æ®µ</li>
<li>event loop ä» pool é˜¶æ®µå‡ºæ¥ç»§ç»­å¾€ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œï¼Œæ°å¥½æ˜¯ check é˜¶æ®µï¼Œæ‰€ä»¥ setImmediate çš„å›è°ƒå‡½æ•°å…ˆæ‰§è¡Œ</li>
<li>æœ¬æ¬¡ event loop ç»“æŸåï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡ event loopï¼Œæ‰§è¡Œ setTimeout çš„å›è°ƒå‡½æ•°</li>
</ol>
<p>æ‰€ä»¥ï¼Œåœ¨ I/O Callbacks ä¸­æ³¨å†Œçš„ setTimeout å’Œ setImmediateï¼Œæ°¸è¿œéƒ½æ˜¯ setImmediate å…ˆæ‰§è¡Œã€‚</p>
<h2 id="é¢˜ç›®ä¸‰"><a href="#é¢˜ç›®ä¸‰" class="headerlink" title="é¢˜ç›®ä¸‰"></a>é¢˜ç›®ä¸‰</h2><pre><code>setInterval(()=&gt;{console.log(&apos;setInterval&apos;)},100)process.nextTick(functiontick(){process.nextTick(tick)})
</code></pre><p>è¿è¡Œç»“æœï¼šsetInterval æ°¸è¿œä¸ä¼šæ‰“å°å‡ºæ¥ã€‚</p>
<p>è§£é‡Šï¼šprocess.nextTick ä¼šæ— é™å¾ªç¯ï¼Œå°† event loop é˜»å¡åœ¨ microtask é˜¶æ®µï¼Œå¯¼è‡´ event loop ä¸Šå…¶ä»– macrotask é˜¶æ®µçš„å›è°ƒå‡½æ•°æ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚</p>
<p>è§£å†³æ–¹æ³•é€šå¸¸æ˜¯ç”¨ setImmediate æ›¿ä»£ process.nextTickï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>setInterval(()=&gt;{console.log(&apos;setInterval&apos;)},100)setImmediate(functionimmediate(){setImmediate(immediate)})
</code></pre><p>è¿è¡Œç»“æœï¼šæ¯ 100ms æ‰“å°ä¸€æ¬¡ setIntervalã€‚</p>
<p>è§£é‡Šï¼šprocess.nextTick å†…æ‰§è¡Œ process.nextTick ä»ç„¶å°† tick å‡½æ•°æ³¨å†Œåˆ°å½“å‰ microtask çš„å°¾éƒ¨ï¼Œæ‰€ä»¥å¯¼è‡´ microtask æ°¸è¿œæ‰§è¡Œä¸å®Œï¼› setImmediate å†…æ‰§è¡Œ setImmediate ä¼šå°† immediate å‡½æ•°æ³¨å†Œåˆ°ä¸‹ä¸€æ¬¡ event loop çš„ check é˜¶æ®µï¼Œè€Œä¸æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„ check é˜¶æ®µï¼Œæ‰€ä»¥ç»™äº† event loop ä¸Šå…¶ä»– macrotask æ‰§è¡Œçš„æœºä¼šã€‚</p>
<p>å†çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code>setImmediate(()=&gt;{console.log(&apos;setImmediate1&apos;)setImmediate(()=&gt;{console.log(&apos;setImmediate2&apos;)})process.nextTick(()=&gt;{console.log(&apos;nextTick&apos;)})})setImmediate(()=&gt;{console.log(&apos;setImmediate3&apos;)})
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<pre><code>setImmediate1
setImmediate3
nextTick
setImmediate2
</code></pre><p>æ³¨æ„ï¼šå¹¶ä¸æ˜¯è¯´ setImmediate å¯ä»¥å®Œå…¨æ›¿ä»£ process.nextTickï¼Œprocess.nextTick åœ¨ç‰¹å®šåœºæ™¯ä¸‹è¿˜æ˜¯æ— æ³•è¢«æ›¿ä»£çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å°±æƒ³å°†ä¸€äº›æ“ä½œæ”¾åˆ°æœ€è¿‘çš„ microtask é‡Œæ‰§è¡Œã€‚</p>
<h2 id="é¢˜ç›®å››"><a href="#é¢˜ç›®å››" class="headerlink" title="é¢˜ç›®å››"></a>é¢˜ç›®å››</h2><pre><code>constpromise=Promise.resolve().then(()=&gt;{returnpromise})promise.catch(console.error)
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<pre><code>TypeError: Chaining cycle detected for promise #&lt;Promise&gt;
    at &lt;anonymous&gt;
    at process._tickCallback (internal/process/next_tick.js:188:7)
    at Function.Module.runMain (module.js:667:11)
    at startup (bootstrap_node.js:187:16)
    at bootstrap_node.js:607:3
</code></pre><p>è§£é‡Šï¼špromise.then ç±»ä¼¼äº process.nextTickï¼Œéƒ½ä¼šå°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ° microtask é˜¶æ®µã€‚ä¸Šé¢ä»£ç ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œç±»ä¼¼å‰é¢æåˆ°çš„ï¼š</p>
<pre><code>process.nextTick(functiontick(){process.nextTick(tick)})
</code></pre><p>å†çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code>constpromise=Promise.resolve()
promise.then(()=&gt;{
  console.log(&apos;promise&apos;)})
  process.nextTick(()=&gt;{
      console.log(&apos;nextTick&apos;)
  })
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<pre><code>nextTick
promise
</code></pre><p>è§£é‡Šï¼špromise.then è™½ç„¶å’Œ process.nextTick ä¸€æ ·ï¼Œéƒ½å°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ° microtaskï¼Œä½†ä¼˜å…ˆçº§ä¸ä¸€æ ·ã€‚process.nextTick çš„ microtask queue æ€»æ˜¯ä¼˜å…ˆäº promise çš„ microtask queue æ‰§è¡Œã€‚</p>
<h2 id="é¢˜ç›®äº”"><a href="#é¢˜ç›®äº”" class="headerlink" title="é¢˜ç›®äº”"></a>é¢˜ç›®äº”</h2><pre><code>setTimeout(()=&gt;{
    console.log(1)
},0)
newPromise((resolve,reject)=&gt;{
   console.log(2)
   for(leti=0;i&lt;10000;i++){
     i===9999&amp;&amp;resolve()
   }
   console.log(3)
}).then(()=&gt;{
   console.log(4)
})
console.log(5)
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<p>è§£é‡Šï¼šPromise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å…ˆæ‰“å° 2ã€3ï¼Œç„¶åæ‰“å° 5ï¼Œæ¥ä¸‹æ¥ event loop è¿›å…¥æ‰§è¡Œ microtask é˜¶æ®µï¼Œæ‰§è¡Œ promise.then çš„å›è°ƒå‡½æ•°æ‰“å°å‡º 4ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ª macrotaskï¼Œæ°å¥½æ˜¯ timer é˜¶æ®µçš„ setTimeout çš„å›è°ƒå‡½æ•°ï¼Œæ‰“å°å‡º 1ã€‚</p>
<h2 id="é¢˜ç›®å…­"><a href="#é¢˜ç›®å…­" class="headerlink" title="é¢˜ç›®å…­"></a>é¢˜ç›®å…­</h2><pre><code>setImmediate(()=&gt;{
    console.log(1)
    setTimeout(()=&gt;{
       console.log(2)
    },100)
    setImmediate(()=&gt;{
       console.log(3)
    })
    process.nextTick(
       ()=&gt;{console.log(4)})
     })
     process.nextTick(()=&gt;{
       console.log(5)
       setTimeout(()=&gt;{
        console.log(6)},100)
        setImmediate(()=&gt;{
        console.log(7)})
        process.nextTick(
        ()=&gt;{console.log(8)})
        })console.log(9)
</code></pre><p>è¿è¡Œç»“æœï¼š</p>
<p>process.nextTickã€setTimeout å’Œ setImmediate çš„ç»„åˆï¼Œè¯·è¯»è€…è‡ªå·±æ¨ç†å§ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul>
<li><a href="https://link.zhihu.com/?target=https%3A//medium.com/the-node-js-collection/what-you-should-know-to-really-understand-the-node-js-event-loop-and-its-metrics-c4907b19da4c" target="_blank" rel="noopener">https://medium.com/the-node-js-collection/what-you-should-know-to-really-understand-the-node-js-event-loop-and-its-metrics-c4907b19da4c</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//cnodejs.org/topic/57d68794cb6f605d360105bf" target="_blank" rel="noopener">https://cnodejs.org/topic/57d68794cb6f605d360105bf</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/ä½ ä¸çŸ¥é“çš„-Promise-å¯¹è±¡é»‘ç§‘æŠ€/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/ä½ ä¸çŸ¥é“çš„-Promise-å¯¹è±¡é»‘ç§‘æŠ€/" itemprop="url">ä½ ä¸çŸ¥é“çš„ Promise å¯¹è±¡é»‘ç§‘æŠ€</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T11:10:58+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Promise-å¿…çŸ¥å¿…ä¼šï¼ˆåé“é¢˜ï¼‰"><a href="#Promise-å¿…çŸ¥å¿…ä¼šï¼ˆåé“é¢˜ï¼‰" class="headerlink" title="Promise å¿…çŸ¥å¿…ä¼šï¼ˆåé“é¢˜ï¼‰"></a><a href="https://libin1991.github.io/2018/09/25/Promise-%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/" target="_blank" rel="noopener">Promise å¿…çŸ¥å¿…ä¼šï¼ˆåé“é¢˜ï¼‰</a></h2><h2 id="ä¸€ã€resolve-åçš„æ‰§è¡Œæƒ…å†µ"><a href="#ä¸€ã€resolve-åçš„æ‰§è¡Œæƒ…å†µ" class="headerlink" title="ä¸€ã€resolve åçš„æ‰§è¡Œæƒ…å†µ"></a>ä¸€ã€resolve åçš„æ‰§è¡Œæƒ…å†µ</h2><p>æ— è®ºæ˜¯ resolve, rejectï¼Œéƒ½ä¼šå°†å‡½æ•°å‰©ä½™çš„ä»£ç æ‰§è¡Œå®Œ</p>
<pre><code>const promise = new Promise((resolve, reject) =&gt; {
    console.log(&apos;mark 1&apos;);
    resolve(&apos;hello world&apos;);     // reject(&apos;hello world&apos;);
    console.log(&apos;mark 2&apos;);
});

promise.then(result =&gt; {
    console.log(result);
}).catch(err =&gt; {
    console.log(err);
});
</code></pre><p>ç›¸å½“äºï¼š</p>
<pre><code>const promise = new Promise((resolve, reject) =&gt; {
    console.log(&apos;mark 1&apos;);
    console.log(&apos;mark 2&apos;);
    resolve(&apos;hello world&apos;);     // reject(&apos;hello world&apos;);
});

promise.then(result =&gt; {
    console.log(result);
}).catch(err =&gt; {
    console.log(err);
});
</code></pre><p>å¦‚æœä½ ä¸æƒ³åœ¨ resolve æˆ– reject åæ‰§è¡Œå‰©ä¸‹çš„ä»£ç æ®µï¼Œå¯ä»¥åœ¨ resolve åå°†å…¶è¿”å›<br><img src="https://pic4.zhimg.com/v2-f5b865c8a9df8ce752d057fe177c855e_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-f5b865c8a9df8ce752d057fe177c855e_hd.jpg" alt=""></p>
<pre><code>const promise = new Promise((resolve, reject) =&gt; {
    console.log(&apos;mark 1&apos;);
    return resolve(&apos;hello world&apos;);     // reject(&apos;hello world&apos;);
    console.log(&apos;mark 2&apos;);             // never be here
});

promise.then(result =&gt; {
    console.log(result);
}).catch(err =&gt; {
    console.log(err);
});
</code></pre><h2 id="äºŒã€ä¸²è¡Œæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œï¼š"><a href="#äºŒã€ä¸²è¡Œæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œï¼š" class="headerlink" title="äºŒã€ä¸²è¡Œæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œï¼š"></a>äºŒã€ä¸²è¡Œæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œï¼š</h2><ol>
<li>ä¸²è¡Œæ‰§è¡Œï¼šæœ‰ä¸€å † Promise å¯¹è±¡ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯å›ºå®šçš„ï¼Œå‰ä¸€ä¸ª promise æ‰§è¡Œå®Œåï¼Œåä¸€ä¸ª promise æ‰å¼€å§‹æ‰§è¡Œï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢ï¼Œå®ƒä»¬å¾€å¾€æœ‰å‰åçš„å› æœå…³ç³»ã€‚</li>
<li>å¹¶è¡Œæ‰§è¡Œï¼šæœ‰ä¸€å † Promise å¯¹è±¡ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼Œæ²¡æœ‰å‰åå› æœå…³ç³»ï¼Œå¯ä»¥å¹¶å‘åœ°å»æ‰§è¡Œã€‚</li>
</ol>
<p>å¹¶è¡Œæ‰§è¡Œå¾ˆå¥½è§£å†³ï¼Œåœ¨ Promiseä¸­æœ‰ all è¿™ä¸ªå‡½æ•°æ”¯æŒ, Promise.all æ–¹æ³•ç”¨äºå°†å¤šä¸ª Promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚å½“å¤šä¸ª Promise å®ä¾‹æ‰§è¡Œå®Œåæ‰å»æ‰§è¡Œæœ€åæ–°çš„ Promise å®ä¾‹ã€‚</p>
<pre><code>const datum = [];
for(let i = 0; i &lt; 10; i++) {
    datum.push(i);
}

Promise.all(datum.map(i =&gt; {
    return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        console.log(i * 200 + &quot; ms åæ‰§è¡Œç»“æŸ&quot;);
        resolve(&quot;ç¬¬ &quot; + (i + 1) + &quot; ä¸ª Promise æ‰§è¡Œç»“æŸ&quot;);
    }, i * 200);
    })
})).then((data) =&gt; {
    console.log(data);
});
</code></pre><p>å¦‚æœä¸ä½¿ç”¨ Promise.all è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åƒ ES7 çš„ async/await</p>
<pre><code>const asyncFun = async () =&gt; {
    const datum = []
    for(let i = 0; i &lt; 10; i++) {
        datum.push(new Promise((resolve, reject) =&gt; {
            setTimeout(() =&gt; {
                console.log(i * 200 + &apos;ms åæ‰§è¡Œç»“æŸ&apos;)
                resolve(&apos;ç¬¬ &apos; + (i + 1) + &apos; ä¸ª Promise æ‰§è¡Œç»“æŸ&apos;)
            }, i * 200)
        }))
    }
    const result = []
    for(let promise of datum) {
        result.push(await promise)
    }
    console.log(result)
}
asyncFun()
</code></pre><p>ä¸²è¡Œæ‰§è¡Œï¼šè¿™é‡Œæä¾›ä¸¤ç§æ–¹å¼</p>
<pre><code>const datum = [];
for(let i = 0; i &lt; 10; i++) {
    datum.push(i);
}

let serial = Promise.resolve();

for(let i of datum) {
    serial = serial.then(data =&gt; {
        console.log(data);
    return new Promise((resolve, reject) =&gt; {
        setTimeout(() =&gt; {
        console.log(i * 200 + &quot; ms åæ‰§è¡Œç»“æŸ&quot;);
        resolve(&quot;ç¬¬ &quot; + (i + 1) + &quot; ä¸ª Promise æ‰§è¡Œç»“æŸ&quot;);
        }, i * 200);
    })    
    });
}
</code></pre><p>å¦å¤–å¯ä»¥ä½¿ç”¨ reduce æ¥ä¸²è¡Œï¼š</p>
<pre><code>const datum = [];
for(let i = 0; i &lt; 10; i++) {
    datum.push(i);
}

datum.reduce((prev, cur) =&gt; {
    return prev.then(data =&gt; {
    console.log(data);
    return new Promise((resolve, reject) =&gt; {
        setTimeout(() =&gt; {
        console.log(cur * 200 + &quot; ms åæ‰§è¡Œç»“æŸ&quot;);
        resolve(&quot;ç¬¬ &quot; + (cur + 1) + &quot; ä¸ª Promise æ‰§è¡Œç»“æŸ&quot;);
        }, cur * 200);
    })    
    })
}, Promise.resolve(true));
</code></pre><h2 id="ä¸‰ã€å€¼ç©¿é€é—®é¢˜ï¼š"><a href="#ä¸‰ã€å€¼ç©¿é€é—®é¢˜ï¼š" class="headerlink" title="ä¸‰ã€å€¼ç©¿é€é—®é¢˜ï¼š"></a>ä¸‰ã€å€¼ç©¿é€é—®é¢˜ï¼š</h2><pre><code>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        resolve(&apos;Hello World!&apos;);
    }, 1000)
});

promise.then(&apos;å‘µå‘µå“’&apos;).then((data) =&gt; {
    console.log(data);           // Hello World
})
</code></pre><p>è¿™æ˜¯ä¸€ç§å€¼ç©¿é€çš„æƒ…å†µï¼Œä¸€èˆ¬æœ‰ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š<br>promise å·²ç»æ˜¯ FULFILLED/REJECTED æ—¶ï¼Œé€šè¿‡ return this å®ç°çš„å€¼ç©¿é€ï¼š<br><img src="https://pic3.zhimg.com/v2-99374235673349f56d708c28511c27d2_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-99374235673349f56d708c28511c27d2_hd.jpg" alt=""></p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        resolve(&apos;Hello World!&apos;);
    }, 1000)
});

promise.then(() =&gt; {
    promise.then().then(null).then(&apos;å‘µå‘µå“’&apos;).then((res) =&gt; {
        console.log(res)
    })
    promise.catch().catch(null).then(&apos;å‘µå‘µå“’&apos;).then((res) =&gt; {
        console.log(res) 
    })
})
</code></pre><p>promise æ˜¯ PENDING æ—¶ï¼Œé€šè¿‡ç”Ÿæˆæ–°çš„ promise åŠ å…¥åˆ°çˆ¶ promise çš„ queueï¼Œçˆ¶ promise æœ‰å€¼æ—¶è°ƒç”¨ callFulfilled-&gt;doResolve æˆ– callRejected-&gt;doRejectï¼ˆå› ä¸º then/catch ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼‰è®¾ç½®å­ promise çš„çŠ¶æ€å’Œå€¼ä¸ºçˆ¶ promise çš„çŠ¶æ€å’Œå€¼ã€‚å¦‚ï¼š<br><img src="https://pic2.zhimg.com/v2-7d3d3728e3b1f90d905d4f4782c1f97a_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-7d3d3728e3b1f90d905d4f4782c1f97a_hd.jpg" alt=""></p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        resolve(&apos;Hello World!&apos;);
    }, 1000)
});

let a = promise.then(&apos;å‘µå‘µå“’&apos;);
a.then(res =&gt; {
    console.log(res);
});

let b = promise.catch(&apos;å‘µå‘µå“’&apos;);
b.then(res =&gt; {
    console.log(res);
})
</code></pre><p>æ€»è€Œè¨€ä¹‹ï¼Œå½“ä½ ç»™ then() ä¼ é€’ä¸€ä¸ªéå‡½æ•°ï¼ˆæ¯”å¦‚ä¸€ä¸ª promise ï¼‰å€¼çš„æ—¶å€™ï¼Œå®ƒå®é™…ä¸Šä¼šè§£é‡Šä¸º then(null) ï¼Œè¿™ä¼šå¯¼è‡´ä¹‹å‰çš„ promise çš„ç»“æœä¸¢å¤±ã€‚ä¾‹å¦‚:<br><img src="https://pic1.zhimg.com/v2-14fe675c00c5bc8154d161e3afed0f41_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-14fe675c00c5bc8154d161e3afed0f41_hd.jpg" alt=""></p>
<pre><code>Promise.resolve(&apos;First Value&apos;).then(Promise.resolve(&apos;Second Value&apos;)).then(null).then((value) =&gt; {
    console.log(value)    // First Value
})
</code></pre><h2 id="å››ã€ä¸è¦åœ¨å¼‚æ­¥å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨-throw-Error"><a href="#å››ã€ä¸è¦åœ¨å¼‚æ­¥å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨-throw-Error" class="headerlink" title="å››ã€ä¸è¦åœ¨å¼‚æ­¥å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ throw Error"></a>å››ã€ä¸è¦åœ¨å¼‚æ­¥å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ throw Error</h2><p>ä¸ä»… rejectï¼ŒæŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¼šè¢«ä½œä¸ºæ‹’ç»çŠ¶æ€è¢« Promise æ•è·</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    reject(&apos;This is an error&apos;);
});

promise.then(result =&gt; {
    console.log(result);
}).catch(error =&gt; {
    console.log(&apos;handle error: &apos;, error);  //handle error:  Error: This is an error
})
</code></pre><p>ä½†æ˜¯ï¼Œæ°¸è¿œä¸è¦åœ¨å›è°ƒé˜Ÿåˆ—ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºå›è°ƒé˜Ÿåˆ—è„±ç¦»äº†è¿è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¼‚å¸¸æ— æ³•è¢«å½“å‰ä½œç”¨åŸŸæ•è·ã€‚</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        throw Error(&apos;This is an error&apos;);
    });
});

promise.then(result =&gt; {
    console.log(result);
}).catch(error =&gt; {
    console.log(&apos;handle error: &apos;, error);  // Error: This is an error
});
</code></pre><p>ç®€å•è¯´æ¥ï¼Œå›è°ƒé˜Ÿåˆ—æŒ‡çš„æ˜¯ JS äº‹ä»¶å¾ªç¯ä¸­çš„ macrotask é˜Ÿåˆ—ï¼Œæ¯”å¦‚ setTimeout setInterval ä¼šæ’å…¥åˆ° macrotask ä¸­ã€‚å¦‚æœè¦åœ¨å›è°ƒå‡½æ•°ä¸­æ•è·å¼‚å¸¸ï¼Œè¯·ä½¿ç”¨ rejectï¼Œæ°¸è¿œä¸è¦ä½¿ç”¨ Errorã€‚<br>ä¸Šè¿°çš„ä»£ç åº”æ”¹æˆï¼š</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        reject(&apos;This is an error&apos;);
    });
});

promise.then(result =&gt; {
    console.log(result);
}).catch(error =&gt; {
    console.log(&apos;handle error: &apos;, error);  // Error: This is an error
});
</code></pre><h2 id="äº”ã€then-çš„ç¬¬äºŒä¸ªå‚æ•°è·Ÿ-catch-çš„åŒºåˆ«-ã€é¢è¯•å¸¸é—®ã€‘"><a href="#äº”ã€then-çš„ç¬¬äºŒä¸ªå‚æ•°è·Ÿ-catch-çš„åŒºåˆ«-ã€é¢è¯•å¸¸é—®ã€‘" class="headerlink" title="äº”ã€then çš„ç¬¬äºŒä¸ªå‚æ•°è·Ÿ catch çš„åŒºåˆ« ã€é¢è¯•å¸¸é—®ã€‘"></a>äº”ã€then çš„ç¬¬äºŒä¸ªå‚æ•°è·Ÿ catch çš„åŒºåˆ« ã€é¢è¯•å¸¸é—®ã€‘</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ then çš„ç¬¬äºŒå‚æ•°è·Ÿ catch ç”¨æ³•å¾ˆåƒï¼Œéƒ½æ˜¯ç”¨æ¥è¿›è¡Œé”™è¯¯å¤„ç†çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<pre><code>let promise1 = new Promise((resolve, reject) =&gt; {
    reject(&apos;this is an error&apos;);
});

promise1.then(data =&gt; {
    console.log(data);
}, err =&gt; {
    console.log(&apos;handle err:&apos;, err);    // handle err: this is an error
});

let promise2 = new Promise((resolve, reject) =&gt; {
    reject(&apos;this is an error&apos;);
});
promise2.then(data =&gt; {
    console.log(data);
}).catch(err =&gt; {
    console.log(&apos;handle err:&apos;, err);    // handle err: this is an error
});
</code></pre><p>å½“æ—¶è¿™ä¸¤è€…è¿˜æ˜¯åŒºåˆ«çš„ï¼ŒåŒºåˆ«äº then çš„ç¬¬äºŒå‚æ•°æ— æ³•å¤„ç†ç¬¬ä¸€å‚æ•°å‡½æ•°ä¸­çš„é”™è¯¯ã€‚</p>
<pre><code>let promise1 = Promise.resolve();
promise1.then(() =&gt; {
    throw Error(&apos;this is a error&apos;);   //UnhandledPromiseRejectionWarning: Unhandled promise rejection
}, err =&gt; {
    console.log(err);
})

let promise2 = Promise.resolve();

promise2.then(() =&gt; {
    throw Error(&apos;this is a error&apos;);  
}).catch(err =&gt; {
    console.log(&apos;handle err:&apos;, err);    //handle err: Error: this is a error
})
</code></pre><blockquote>
<p>å½“ä½ ä½¿ç”¨then( resolveHandler, rejectHandler)æ ¼å¼ï¼Œå¦‚æœ resolveHandler è‡ªå·±æŠ›å‡ºä¸€ä¸ªé”™è¯¯ rejectHandler å¹¶ä¸èƒ½æ•è·ã€‚ç¬¬ä¸€ä¸ª Promise å¯¹è±¡æ— æ³•å¤„ç†åŒçº§ then ä¸­çš„å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åç›´æ¥ä½¿ç”¨ catch æ¥è¿›è¡Œå¼‚å¸¸æ•è·æ¯”è¾ƒä¿é™©ã€‚</p>
</blockquote>
<h2 id="å…­ã€å¤„ç†æœ€å-catch-å‡½æ•°ä¸­çš„å¼‚å¸¸"><a href="#å…­ã€å¤„ç†æœ€å-catch-å‡½æ•°ä¸­çš„å¼‚å¸¸" class="headerlink" title="å…­ã€å¤„ç†æœ€å catch å‡½æ•°ä¸­çš„å¼‚å¸¸"></a>å…­ã€å¤„ç†æœ€å catch å‡½æ•°ä¸­çš„å¼‚å¸¸</h2><p>ä¸€èˆ¬æˆ‘ä»¬ç”¨ catch æ¥æ•æ‰å‰é¢æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä½†æ˜¯å¦‚æœè¯•æƒ³ä¸€ä¸‹å¦‚æœæœ€åä¸€ä¸ª catch å‡½æ•°ä¹ŸæŠ›å‡ºäº†å¼‚å¸¸ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢?</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    reject(&apos;Hello World&apos;)
});

promise.catch((err) =&gt; {
    throw(&apos;Unexpected Error&apos;);   // Uncaught (in promise) Unexpected Error
})
</code></pre><p>é¢å¯¹è¿™æ ·çš„é”™è¯¯ï¼Œä¸ç®¡ä»¥ then æ–¹æ³•æˆ– catch æ–¹æ³•ç»“å°¾ï¼Œè¦æ˜¯æœ€åä¸€ä¸ªæ–¹æ³•æŠ›å‡ºé”™è¯¯ï¼Œéƒ½æœ‰å¯èƒ½æ— æ³•æ•æ‰åˆ°ï¼ˆå› ä¸º Promise å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå†’æ³¡åˆ°å…¨å±€ï¼‰è¿™é‡Œæä¾›ä¸¤ç§æ€è·¯ï¼š</p>
<ul>
<li><p>æ‹“å±• Promise.prototype çš„æ–¹æ³•ï¼Œæ·»åŠ ä¸€ä¸ª done å‡½æ•°ï¼Œå°†é”™è¯¯æŠ›å‘å…¨å±€ã€‚</p>
<p>  window.onerror = (err) =&gt; {</p>
<pre><code>console.log(err);
</code></pre><p>  }<br>  Promise.prototype.done = function (onFulfilled, onRejected) {</p>
<pre><code>this.then(onFulfilled, onRejected)
  .catch(function (reason) {
    // æŠ›å‡ºä¸€ä¸ªå…¨å±€é”™è¯¯
    setTimeout(() =&gt; { throw reason }, 0);
  });
</code></pre><p>  };<br>  let promise = new Promise((resolve, reject) =&gt; {</p>
<pre><code>reject(&apos;Hello World&apos;)
</code></pre><p>  });</p>
<p>  promise.catch((err) =&gt; {</p>
<pre><code>throw(&apos;Unexpected Error&apos;);     // Uncaught Unexpected Error
</code></pre><p>  }).done()</p>
</li>
</ul>
<ul>
<li>åœ¨å…¨å±€æ·»åŠ  unhandledrejection äº‹ä»¶æ•è· Promise å¼‚å¸¸ã€‚</li>
</ul>
<p><img src="https://pic3.zhimg.com/v2-b512c7648df6d0d6fefb64d01009c175_b.jpg" alt=""></p>
<pre><code>window.addEventListener(&quot;unhandledrejection&quot;, (e) =&gt;{
    console.log(e.reason)
})    

let promise = new Promise((resolve, reject) =&gt; {
    reject(&apos;Hello World&apos;)
});

promise.catch((err) =&gt; {
    throw(&apos;Unexpected Error&apos;);     // Unexpected Error
})
</code></pre><h2 id="ä¸ƒã€æœªæ•è·çš„é”™è¯¯å¯ä»¥è¢«æ¢å¤"><a href="#ä¸ƒã€æœªæ•è·çš„é”™è¯¯å¯ä»¥è¢«æ¢å¤" class="headerlink" title="ä¸ƒã€æœªæ•è·çš„é”™è¯¯å¯ä»¥è¢«æ¢å¤"></a>ä¸ƒã€æœªæ•è·çš„é”™è¯¯å¯ä»¥è¢«æ¢å¤</h2><pre><code>let promise = new Promise((resolve, reject) =&gt; [
    reject(&apos;Hello world&apos;)
]).then(() =&gt; {
    console.log(&apos;resolve&apos;)
})

setTimeout(() =&gt; {
    promise.catch((e) =&gt; {
        console.log(e)
    }).then(() =&gt; {
        console.log(&apos;catch resolve&apos;)
    })
}, 1000)
</code></pre><h2 id="å…«ã€resolved-çŠ¶æ€çš„-Promise-ä¸ä¼šç«‹å³æ‰§è¡Œ"><a href="#å…«ã€resolved-çŠ¶æ€çš„-Promise-ä¸ä¼šç«‹å³æ‰§è¡Œ" class="headerlink" title="å…«ã€resolved çŠ¶æ€çš„ Promise ä¸ä¼šç«‹å³æ‰§è¡Œ"></a>å…«ã€resolved çŠ¶æ€çš„ Promise ä¸ä¼šç«‹å³æ‰§è¡Œ</h2><pre><code>let i = 0;
Promise.resolve(&apos;resolved promise&apos;).then(() =&gt; {
    i += 2
})
console.log(i)  // 0
</code></pre><p>å³ä½¿æ˜¯ resolve çš„ Promise è°ƒç”¨ then æ–¹æ³•ä¹Ÿæ˜¯å¼‚æ­¥æ‰§è¡Œã€‚</p>
<h2 id="ä¹ã€ç»“åˆ-async-await-ç¼–å†™åŒæ­¥ä»£ç "><a href="#ä¹ã€ç»“åˆ-async-await-ç¼–å†™åŒæ­¥ä»£ç " class="headerlink" title="ä¹ã€ç»“åˆ async/await ç¼–å†™åŒæ­¥ä»£ç "></a>ä¹ã€ç»“åˆ async/await ç¼–å†™åŒæ­¥ä»£ç </h2><ol>
<li>async/await å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å½»åº•æ‘†è„±å›è°ƒåœ°ç‹±çš„çƒ¦æ¼ï¼Œç”¨ä¸€ç§åŒæ­¥çš„æ–¹å¼æ¥ç¼–å†™å¼‚æ­¥å‡½æ•°ã€‚</li>
<li>await åé¢å¯ä»¥æ¥æ•°å€¼ï¼Œå¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚çš„è¯å¯ä»¥æ¥ Thunk å‡½æ•°å’Œ Promise å¯¹è±¡ã€‚</li>
</ol>
<p><img src="https://pic4.zhimg.com/v2-3ca5e16c6ba1743725cc92a7a8e5a7e2_b.jpg" alt=""></p>
<pre><code>const timeout = (ms) =&gt; {
    return new Promise((resolve) =&gt; {
        setTimeout(() =&gt; {
            resolve(ms + &apos; passed&apos;)
        }, ms)
    })
}

const asyncFunc =  async () =&gt; {
    const value1 = await timeout(2000)
    console.log(value1)
    const value2 = await timeout(2000)
    console.log(value2)
}

asyncFunc()
console.log(&apos;now&apos;)
</code></pre><h2 id="åã€è°ƒç”¨-then-æ–¹æ³•è¿”å›æ–°çš„-Promise-å¯¹è±¡"><a href="#åã€è°ƒç”¨-then-æ–¹æ³•è¿”å›æ–°çš„-Promise-å¯¹è±¡" class="headerlink" title="åã€è°ƒç”¨ then æ–¹æ³•è¿”å›æ–°çš„ Promise å¯¹è±¡"></a>åã€è°ƒç”¨ then æ–¹æ³•è¿”å›æ–°çš„ Promise å¯¹è±¡</h2><pre><code>let promise1 = new Promise((resolve) =&gt; {
    resolve(&apos;Hello world&apos;)
})

let promise2 = promise1.then()

console.log(promise1 === promise2)    // false
console.log(promise1 instanceof Promise)  // true
console.log(promise2 instanceof Promise)  // true
</code></pre><p>æ¯æ¬¡è°ƒç”¨ then æ–¹æ³•åéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯è¿”å›åŸæœ¬çš„ Promise å¯¹è±¡ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/æˆ‘ä¹Ÿæ¥å®ç°ä¸€æŠŠMVVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/æˆ‘ä¹Ÿæ¥å®ç°ä¸€æŠŠMVVM/" itemprop="url">æˆ‘ä¹Ÿæ¥å®ç°ä¸€æŠŠMVVM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-03T00:20:32+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>å¤§å®¶éƒ½çŸ¥é“ï¼Œvueæ˜¯ä¸ªMVVMæ¡†æ¶ï¼Œèƒ½å¤Ÿå®ç°viewå’Œmodelçš„åŒå‘ç»‘å®šï¼Œä¸åƒbackboneé‚£æ ·ï¼Œmodelæ”¹å˜éœ€è¦æ‰‹åŠ¨å»é€šçŸ¥viewæ›´æ–°ï¼Œè€Œvueå®ç°çš„åŸç†å°±æ˜¯é€šè¿‡Object.definePropertyå®ç°æ•°æ®æŒŸæŒï¼Œå®šä¹‰setterï¼Œç„¶åæ•°æ®æ”¹å˜çš„æ—¶å€™é€šçŸ¥è§†å›¾æ›´æ–°ã€‚</p>
<p>ä¸‹é¢æ˜¯ç½‘ä¸Švueçš„å®ç°åŸç†å›¾ï¼š</p>
<p> <img src="https://user-gold-cdn.xitu.io/2018/4/10/162ad3d5be3e5105?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p>
<h3 id="å®ç°æ•ˆæœ"><a href="#å®ç°æ•ˆæœ" class="headerlink" title="å®ç°æ•ˆæœ"></a>å®ç°æ•ˆæœ</h3><p><img src="https://user-gold-cdn.xitu.io/2018/8/15/1653b294cd1b80e3?imageslim" alt=""></p>
<h4 id="1ã€MVVM"><a href="#1ã€MVVM" class="headerlink" title="1ã€MVVM"></a>1ã€MVVM</h4><p>å…¥å£æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œå¯¹vueå½“ä¸­çš„$elã€methodsã€$dataè¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨observeréå†$dataçš„æ•°æ®å¹¶è¿›è¡ŒæŒŸæŒï¼Œè°ƒç”¨compileéå†$elä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£ææŒ‡ä»¤å’Œå–å€¼æ“ä½œã€‚éå†$dataçš„æ•°æ®ï¼Œé€šè¿‡Object.definePropertyçš„getterå’Œsetterå®ç°å¯¹$dataçš„ä»£ç†ã€‚</p>
<h4 id="2ã€Observer"><a href="#2ã€Observer" class="headerlink" title="2ã€Observer"></a>2ã€Observer</h4><p>éå†dataï¼Œé€šè¿‡Object.definePropertyè®¾ç½®getterå’Œsetterï¼Œåœ¨setterçŸ¥é“æ•°æ®å‘ç”Ÿäº†æ”¹å˜ï¼Œç„¶åé€šçŸ¥Wacherå»æ›´æ–°viewã€‚</p>
<h4 id="3ã€Compile"><a href="#3ã€Compile" class="headerlink" title="3ã€Compile"></a>3ã€Compile</h4><p>éå†$elä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£ææŒ‡ä»¤å’Œå–å€¼æ“ä½œç­‰ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹ç»‘å®šæ›´æ–°å‡½æ•°ï¼ˆä¸ºä»€ä¹ˆåœ¨compileè¿™é‡Œç»‘å®šå‘¢ï¼Ÿå› ä¸ºè¿™é‡Œåˆšå¥½æ˜¯éå†çš„èŠ‚ç‚¹â˜ºï¼‰ï¼Œç»‘å®šäº‹ä»¶å’Œmethodçš„å…³ç³»ï¼ŒåŒæ—¶ä¹Ÿæ·»åŠ è®¢é˜…è€…ï¼Œå½“æ¥å—åˆ°è§†å›¾æ›´æ–°çš„è®¢é˜…æ¶ˆæ¯åï¼Œè°ƒç”¨æ›´æ–°å‡½æ•°ï¼Œå®ç°è§†å›¾æ›´æ–°ã€‚åŒæ—¶åœ¨æ·»åŠ è®¢é˜…è€…çš„æ—¶å€™ï¼Œåˆå§‹åŒ–æ¸²æŸ“è§†å›¾ã€‚</p>
<h4 id="4ã€Watcher"><a href="#4ã€Watcher" class="headerlink" title="4ã€Watcher"></a>4ã€Watcher</h4><p>Watcherä½œä¸ºè®¢é˜…è€…ï¼Œå……å½“Observerå’ŒCompileçš„ä¸­é—´æ¡¥æ¢ï¼ŒåŒ…å«updateæ–¹æ³•ï¼Œupdateæ–¹æ³•è°ƒç”¨Compileä¸­ç»‘å®šçš„äº‹ä»¶æ›´æ–°å‡½æ•°ï¼Œå®ç°å¯¹è§†å›¾çš„åˆå§‹åŒ–å’Œæ›´æ–°æ“ä½œã€‚</p>
<h3 id="MVVMçš„å®ç°"><a href="#MVVMçš„å®ç°" class="headerlink" title="MVVMçš„å®ç°"></a>MVVMçš„å®ç°</h3><p>MVVMå®Œæˆåˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¸”è°ƒç”¨observerå’Œcompileã€‚å¯¹$dataè¿›è¡Œä»£ç†ï¼Œå¦‚æ­¤ä¾¿å¯ä»¥é€šè¿‡this.attributeæ¥ä»£ç†this.$data.attributeã€‚å› ä¸ºä¸€ä¸ªå±æ€§å¯èƒ½å¯¹åº”å¤šä¸ªæŒ‡ä»¤ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ª_bindingå±æ€§æ¥å­˜æ”¾å±æ€§å¯¹åº”çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œè¿™æ ·å±æ€§ä¸€æ”¹å˜ï¼Œå°±å¯ä»¥å–å‡ºæ‰€æœ‰çš„è®¢é˜…è€…å»æ›´æ–°è§†å›¾ã€‚</p>
<pre><code>function MVVM(options) {
  // åˆå§‹åŒ–
  this.$data = options.data;
  this.$methods = options.methods;
  this.$el = options.el;
  // ä¿å­˜dataçš„æ¯ä¸ªå±æ€§å¯¹åº”çš„æ‰€æœ‰watcher
  this._binding  = {};
  // è°ƒç”¨observerå’Œcompile
  this._observer(options.data);
  this._compile();
  // this.xxx ä»£ç†this.$data.xxx
  this.proxyAttribute();
}
</code></pre><h3 id="Observerçš„å®ç°"><a href="#Observerçš„å®ç°" class="headerlink" title="Observerçš„å®ç°"></a>Observerçš„å®ç°</h3><p>Observeréå†$dataï¼Œé€šè¿‡Object.definePropertyçš„setterçš„æŒŸæŒæ•°æ®æ”¹å˜ï¼Œç›‘å¬åˆ°æ•°æ®æ”¹å˜åå–å‡ºæ‰€æœ‰è¯¥å±æ€§å¯¹åº”çš„è®¢é˜…è€…ï¼Œç„¶åé€šçŸ¥æ›´æ–°å‡½æ•°æ›´æ–°è§†å›¾ã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œæœ‰å¾ªç¯ï¼Œä¸”é—­åŒ…ï¼ˆgetterå’Œsetterï¼‰é‡Œé¢éœ€è¦ä¾èµ–å¾ªç¯é¡¹ï¼ˆvalueå’Œkeyï¼‰ï¼Œæ‰€ä»¥ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°è§£å†³å¾ªç¯é¡¹è·å–ä¸å¯¹çš„é—®é¢˜ã€‚</p>
<pre><code>MVVM.prototype._observer = function(data) {
  var self = this;
  for(var key in this.$data) {
    if (this.$data.hasOwnProperty(key)) {
      // åˆå§‹åŒ–å±æ€§å¯¹åº”çš„è®¢é˜…è€…å®¹å™¨ï¼ˆæ•°ç»„ï¼‰
      this._binding[key] = {
        _directives: [],
        _texts: []
      };

      if(typeof this.$data[key] === &quot;object&quot;) {
        return this._observer(this.$data[key]);
      }
      var val = data[key];
      // ç«‹å³æ‰§è¡Œå‡½æ•°è·å–æ­£ç¡®çš„å¾ªç¯é¡¹
      (function(value, key) {
        Object.defineProperty(self.$data, key, {
          enumerable: true,
          configurable: true,
          get: function() {
            return value;
          },
          set(newval) {
            if(newval === value) {
              return;
            }
            value = newval;
            // ç›‘å¬åˆ°æ•°æ®æ”¹å˜åå–å‡ºæ‰€æœ‰è¯¥å±æ€§å¯¹åº”çš„è®¢é˜…è€…ï¼Œé€šçŸ¥viewæ›´æ–°-å±æ€§
            if(self._binding[key]._directives) {
              self._binding[key]._directives.forEach(function(watcher) {
                watcher.update();
              }, self);
            }
            // ç›‘å¬åˆ°æ•°æ®æ”¹å˜åå–å‡ºæ‰€æœ‰è¯¥å±æ€§å¯¹åº”çš„è®¢é˜…è€…ï¼Œé€šçŸ¥viewæ›´æ–°-æ–‡æœ¬
            if(self._binding[key]._texts) {
              self._binding[key]._texts.forEach(function(watcher) {
                watcher.update();
              }, self);
            }
          }
        });
      })(val, key);
    }
  }
}
</code></pre><h3 id="Compileçš„å®ç°"><a href="#Compileçš„å®ç°" class="headerlink" title="Compileçš„å®ç°"></a>Compileçš„å®ç°</h3><p>Compileéå†æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œè§£ææŒ‡ä»¤ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹ç»‘å®šæ›´æ–°å‡½æ•°ï¼Œä¸”æ·»åŠ è®¢é˜…è€…ï¼Œå½“è®¢é˜…è€…é€šçŸ¥viewæ›´æ–°çš„æ—¶å€™ï¼Œè°ƒç”¨æ›´æ–°å‡½æ•°ï¼Œå®ç°å¯¹è§†å›¾çš„æ›´æ–°ã€‚</p>
<p>è¿™é‡ŒåŒæ ·éœ€è¦ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°æ¥è§£å†³é—­åŒ…ä¾èµ–çš„å¾ªç¯é¡¹é—®é¢˜ã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦è§£å†³çš„æ˜¯ï¼Œå¦‚æœèŠ‚ç‚¹çš„innerTextä¾èµ–å¤šä¸ªå±æ€§çš„è¯ï¼Œå¦‚ä½•åšåˆ°åªæ›¿æ¢æ”¹å˜å±æ€§å¯¹åº”çš„æ–‡æœ¬é—®é¢˜ã€‚</p>
<p>æ¯”å¦‚ï¼šå·²ç»è¢«ç¼–è¯‘è§£ææˆâ€œæ¬¢è¿ï¼š é¸£äººâ€ï¼Œå¦‚æœmessageæ”¹å˜ä¸ºâ€œä½ å¥½â€ï¼Œæ€ä¹ˆè®©ä½¿å¾—â€œæ¬¢è¿ï¼šé¸£äººâ€æ”¹ä¸ºâ€œä½ å¥½ï¼šé¸£äººâ€ã€‚</p>
<pre><code>MVVM.prototype._compile = function() {
  var dom = document.querySelector(this.$el);
  var children = dom.children;
  var self = this;
  var i = 0, j = 0;
  // æ›´æ–°å‡½æ•°ï¼Œä½†observerä¸­modelçš„æ•°æ®æ”¹å˜çš„æ—¶å€™ï¼Œé€šè¿‡Watcherçš„updateè°ƒç”¨æ›´æ–°å‡½æ•°ï¼Œä»è€Œæ›´æ–°dom
  var updater = null;
  for(; i &lt; children.length; i++) {
    var node = children[i];
    (function(node) {
      // è§£æ{{}}é‡Œé¢çš„å†…å®¹
      // ä¿å­˜æŒ‡ä»¤åŸå§‹å†…å®¹ï¼Œä¸ç„¶æ•°æ®æ›´æ–°æ—¶æ— æ³•å®Œæˆæ›¿æ¢
      var text = node.innerText;
      var matches = text.match(/{{([^{}]+)}}/g);
      if(matches &amp;&amp; matches.length &gt; 0) {
        // ä¿å­˜å’Œnodeç»‘å®šçš„æ‰€æœ‰å±æ€§
        node.bindingAttributes = [];
        for(j = 0; j &lt; matches.length; j++) {
          // dataæŸä¸ªå±æ€§
          var attr = matches[j].match(/{{([^{}]+)}}/)[1];
          // å°†å’Œè¯¥nodeç»‘å®šçš„dataå±æ€§ä¿å­˜èµ·æ¥
          node.bindingAttributes.push(attr);
          (function(attr) {
            updater = function() {
              // æ”¹å˜çš„å±æ€§å€¼å¯¹åº”çš„æ–‡æœ¬è¿›è¡Œæ›¿æ¢
              var innerText = text.replace(new RegExp(&quot;{{" + attr + "}}&quot;, &quot;g&quot;), self.$data[attr]);
              // å¦‚æœè¯¥nodeç»‘å®šå¤šä¸ªå±æ€§ eg:&lt;div&gt;{{title}}{{description}}&lt;/div&gt;
              for(var k = 0; k &lt; node.bindingAttributes.length; k++) {
                if(node.bindingAttributes[k] !== attr) {
                  // æ¢å¤åŸæ¥æ²¡æ”¹å˜çš„å±æ€§å¯¹åº”çš„æ–‡æœ¬
                  innerText = innerText.replace(&quot;{{" + node.bindingAttributes[k] + "}}&quot;, self.$data[node.bindingAttributes[k]]);
                }
              }
              node.innerText = innerText;
            }
            self._binding[attr]._texts.push(new Watcher(self, attr, updater));
          })(attr);
        }
      }

      // è§£ævueæŒ‡ä»¤
      var attributes = node.getAttributeNames();
      for(j = 0; j &lt; attributes.length; j++) {
        // vueæŒ‡ä»¤
        var attribute = attributes[j];
        // DOM attribute
        var domAttr = null;
        // ç»‘å®šçš„dataå±æ€§
        var vmDataAttr = node.getAttribute(attribute);

        if(/v-bind:([^=]+)/.test(attribute)) {
          // è§£æv-bind
          domAttr = RegExp.$1;
          // æ›´æ–°å‡½æ•°
          updater = function(val) {
            node[domAttr] = val;
          }
          // dataå±æ€§ç»‘å®šå¤šä¸ªwatcher
          self._binding[vmDataAttr]._directives.push(
            new Watcher(self, vmDataAttr, updater)
          )
        } elseif(attribute === &quot;v-model&quot; &amp;&amp; (node.tagName = &apos;INPUT&apos; || node.tagName == &apos;TEXTAREA&apos;)) {
          // è§£æv-model
          // æ›´æ–°å‡½æ•°
          updater = function(val) {
            node.value = val;
          }
          // dataå±æ€§ç»‘å®šå¤šä¸ªwatcher
          self._binding[vmDataAttr]._directives.push(
            new Watcher(self, vmDataAttr, updater)
          )
          // ç›‘å¬input/textareaçš„æ•°æ®å˜åŒ–ï¼ŒåŒæ­¥åˆ°modelå»ï¼Œå®ç°åŒå‘ç»‘å®š
          node.addEventListener(&quot;input&quot;, function(evt) {
            var $el = evt.currentTarget;
            self.$data[vmDataAttr] = $el.value;
          });
        } elseif(/v-on:([^=]+)/.test(attribute)) {
          // è§£æv-on
          var event = RegExp.$1;
          var method = vmDataAttr;
          node.addEventListener(event, function(evt) {
            self.$methods[method] &amp;&amp; self.$methods[method].call(self, evt);
          });
        }
      }
    })(node);
  }

}
</code></pre><h3 id="Watcherçš„å®ç°"><a href="#Watcherçš„å®ç°" class="headerlink" title="Watcherçš„å®ç°"></a>Watcherçš„å®ç°</h3><p>Watcherå……å½“è®¢é˜…è€…çš„è§’è‰²ï¼Œæ¶èµ·äº†Observerå’ŒCompileçš„æ¡¥æ¢ï¼ŒObserverç›‘å¬åˆ°æ•°æ®å˜åŒ–åï¼Œé€šçŸ¥Wathceræ›´æ–°è§†å›¾(è°ƒç”¨Wathcerçš„updateæ–¹æ³•)ï¼ŒWatcherå†å‘Šè¯‰Compileå»è°ƒç”¨æ›´æ–°å‡½æ•°ï¼Œå®ç°domçš„æ›´æ–°ã€‚åŒæ—¶é¡µé¢çš„åˆå§‹åŒ–æ¸²æŸ“ä¹Ÿäº¤ç»™äº†Watcherï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ”¾åˆ°Compileè¿›è¡Œï¼‰ã€‚</p>
<pre><code>function Watcher(vm, attr, cb) {
  this.vm = vm; // viewmodel
  this.attr = attr; // dataçš„å±æ€§ï¼Œä¸€ä¸ªwatcherè®¢é˜…ä¸€ä¸ªdataå±æ€§
  this.cb = cb; // æ›´æ–°å‡½æ•°ï¼Œåœ¨compileé‚£è¾¹å®šä¹‰
  // åˆå§‹åŒ–æ¸²æŸ“è§†å›¾
  this.update();
}

Watcher.prototype.update = function() {
  // é€šçŸ¥comileä¸­çš„æ›´æ–°å‡½æ•°æ›´æ–°dom 
  this.cb(this.vm.$data[this.attr]);
}
</code></pre><h3 id="å…¨éƒ¨ä»£ç "><a href="#å…¨éƒ¨ä»£ç " class="headerlink" title="å…¨éƒ¨ä»£ç "></a>å…¨éƒ¨ä»£ç </h3><p>gitåœ°å€ï¼š<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2FVikiLee%2FMVVM.git" target="_blank" rel="noopener">github.com/VikiLee/MVVâ€¦</a></p>
<p>é¸£è°¢ï¼š<a href="https://link.juejin.im?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5acc17cb51882555745a03f8" target="_blank" rel="noopener">juejin.im/post/5acc17â€¦</a></p>
<h3 id="ä½¿ç”¨ä¾‹å­"><a href="#ä½¿ç”¨ä¾‹å­" class="headerlink" title="ä½¿ç”¨ä¾‹å­"></a>ä½¿ç”¨ä¾‹å­</h3><pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
  &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id=&quot;view&quot;&gt;
    &lt;div v-bind:id=&quot;id&quot;&gt;
      {{message}}:{{name}}
    &lt;/div&gt;
    &lt;input type=&quot;text&quot; v-model=&quot;name&quot;/&gt;
    &lt;button v-on:click=&quot;handleClick&quot;&gt;è·å–è¾“å…¥å€¼&lt;/button&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;script src=&quot;js/MVVM.js&quot;type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  var vue = new MVVM({
    el: &quot;#view&quot;,
    data: {
      message: &quot;æ¬¢è¿å…‰ä¸´&quot;,
      name: &quot;é¸£äºº&quot;,
      id: &quot;id&quot;
    },
    methods: {
      handleClick: function() {
        alert(this.message + &quot;:&quot; + this.name + &quot;, ç‚¹å‡»ç¡®å®šè·¯é£ä¼šå‡ºæ¥&quot;);
        this.name = &apos;è·¯é£&apos;;
      }
    }
  })

  setTimeout(function() {
    vue.message = &quot;ä½ å¥½&quot;;
  }, 1000);
&lt;/script&gt;
&lt;/html&gt;
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/01/ç®€å•ç†è§£asyncã€awaitè¯­æ³•å®ç°åŸç†/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/01/ç®€å•ç†è§£asyncã€awaitè¯­æ³•å®ç°åŸç†/" itemprop="url">ç®€å•ç†è§£asyncã€awaitè¯­æ³•å®ç°åŸç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-10-01T23:57:27+08:00">
                2018-10-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ç°åœ¨æœ€æ–°çš„å‰ç«¯æ¡†æ¶ç”Ÿæ€éƒ½å¼€å§‹ç”¨ä¸Šäº†Generatorå’Œyieldï¼Œ<br>æœ‰çš„ç”šè‡³å·²ç»å¼€å§‹ä½¿ç”¨æœ€æ–°çš„asyncã€awaitè¯­æ³•äº†ï¼Œ<br><strong>è¿™ä¸¤æ ·éƒ½æ˜¯åŸºäºGeneratorè‡ªåŠ¨æ‰§è¡Œçš„åŸç†ã€‚</strong></p>
<h2 id="é˜®ä¸€å³°-async-å‡½æ•°çš„å®ç°åŸç†"><a href="#é˜®ä¸€å³°-async-å‡½æ•°çš„å®ç°åŸç†" class="headerlink" title="é˜®ä¸€å³° async-å‡½æ•°çš„å®ç°åŸç†"></a>é˜®ä¸€å³° <a href="https://link.juejin.im?target=http%3A%2F%2Fes6.ruanyifeng.com%2F%23docs%2Fasync%23async-%25E5%2587%25BD%25E6%2595%25B0%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%25E5%258E%259F%25E7%2590%2586" target="_blank" rel="noopener">async-å‡½æ•°çš„å®ç°åŸç†</a></h2><h4 id="async-å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°†-Generator-å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚"><a href="#async-å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°†-Generator-å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚" class="headerlink" title="async å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚"></a>async å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async function fn(args) &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç­‰åŒäº</span><br><span class="line">function fn(args) &#123;</span><br><span class="line">  return spawn(function* () &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€æœ‰çš„asyncå‡½æ•°éƒ½å¯ä»¥å†™æˆä¸Šé¢çš„ç¬¬äºŒç§å½¢å¼ï¼Œå…¶ä¸­çš„spawnå‡½æ•°å°±æ˜¯è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºspawnå‡½æ•°çš„å®ç°ï¼ŒåŸºæœ¬å°±æ˜¯å‰æ–‡è‡ªåŠ¨æ‰§è¡Œå™¨çš„ç¿»ç‰ˆã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function spawn(genF) &#123;</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    const gen = genF();</span><br><span class="line">    function step(nextF) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      try &#123;</span><br><span class="line">        next = nextF();</span><br><span class="line">      &#125; catch(e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      if(next.done) &#123;</span><br><span class="line">        return resolve(next.value);</span><br><span class="line">      &#125;</span><br><span class="line">      Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">        step(function() &#123; return gen.next(v); &#125;);</span><br><span class="line">      &#125;, function(e) &#123;</span><br><span class="line">        step(function() &#123; return gen.throw(e); &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    step(function() &#123; return gen.next(undefined); &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			function timeout(ms) &#123;</span><br><span class="line">				return &#123;</span><br><span class="line">					text: &apos;done&apos;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function* start() &#123;</span><br><span class="line">				const res = yield timeout(1000);</span><br><span class="line">				return res;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		 </span><br><span class="line">             </span><br><span class="line"></span><br><span class="line">			function fn(args) &#123;</span><br><span class="line">				return spawn(start);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function spawn(genF) &#123;</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					const gen = genF();</span><br><span class="line">					function step(nextF) &#123;</span><br><span class="line">						let next;</span><br><span class="line">						try &#123;</span><br><span class="line">							next = nextF();</span><br><span class="line">						&#125; catch(e) &#123;</span><br><span class="line">							return reject(e);</span><br><span class="line">						&#125;</span><br><span class="line">						if(next.done) &#123;</span><br><span class="line">							return resolve(next.value);</span><br><span class="line">						&#125;</span><br><span class="line">						</span><br><span class="line">					</span><br><span class="line">						Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.next(v);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;, function(e) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.throw(e);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;);</span><br><span class="line">					&#125;</span><br><span class="line">					step(function() &#123;</span><br><span class="line">						return gen.next();</span><br><span class="line">					&#125;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			 fn().then((data)=&gt;&#123;</span><br><span class="line">				console.log(data)</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="çœ‹ä¸‹babelè½¬æ¢åçš„"><a href="#çœ‹ä¸‹babelè½¬æ¢åçš„" class="headerlink" title="çœ‹ä¸‹babelè½¬æ¢åçš„"></a>çœ‹ä¸‹babelè½¬æ¢åçš„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">async function fns(args) &#123;</span><br><span class="line">				const res = await fetch(&apos;google.com&apos;);</span><br><span class="line">				return res.text();</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line">    </span><br><span class="line">		var fns = function() &#123;</span><br><span class="line">			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(args) &#123;</span><br><span class="line">				var res;</span><br><span class="line">				return regeneratorRuntime.wrap(function _callee$(_context) &#123;</span><br><span class="line">					while(1) &#123;</span><br><span class="line">						switch(_context.prev = _context.next) &#123;</span><br><span class="line">							case 0:</span><br><span class="line">								_context.next = 2;</span><br><span class="line">								return fetch(&apos;google.com&apos;);</span><br><span class="line">    </span><br><span class="line">							case 2:</span><br><span class="line">								res = _context.sent;</span><br><span class="line">								return _context.abrupt(&apos;return&apos;, res.text());</span><br><span class="line">    </span><br><span class="line">							case 4:</span><br><span class="line">							case&apos;end&apos;:</span><br><span class="line">								return _context.stop();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;, _callee, this);</span><br><span class="line">			&#125;));</span><br><span class="line">    </span><br><span class="line">			returnfunction fns(_x) &#123;</span><br><span class="line">				return _ref.apply(this, arguments);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;();</span><br><span class="line">    </span><br><span class="line">		function _asyncToGenerator(fn) &#123;  //Generatorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œ</span><br><span class="line">			returnfunction() &#123;</span><br><span class="line">				var gen = fn.apply(this, arguments);</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					function step(key, arg) &#123;</span><br><span class="line">						try &#123;</span><br><span class="line">							var info = gen[key](arg);</span><br><span class="line">							var value = info.value;</span><br><span class="line">						&#125; catch(error) &#123;</span><br><span class="line">							reject(error);</span><br><span class="line">							return;</span><br><span class="line">						&#125;</span><br><span class="line">						if(info.done) &#123;</span><br><span class="line">							resolve(value);</span><br><span class="line">						&#125; else &#123;</span><br><span class="line">							return Promise.resolve(value).then(function(value) &#123;</span><br><span class="line">								step(&quot;next&quot;, value);</span><br><span class="line">							&#125;, function(err) &#123;</span><br><span class="line">								step(&quot;throw&quot;, err);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					return step(&quot;next&quot;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ã€thunkå‡½æ•°<br>thunkå‡½æ•°æŒ‡çš„æ˜¯èƒ½å°†æ‰§è¡Œç»“æœä¼ å…¥å›è°ƒå‡½æ•°ï¼Œå¹¶å°†è¯¥å›è°ƒå‡½æ•°è¿”å›çš„å‡½æ•°ã€‚<br>æ˜¯ä¸æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œä¸¾ä¸ªä¾‹å­:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var readFile = function (fileName) &#123;</span><br><span class="line">    returnfunction (callback) &#123;</span><br><span class="line">        return fs.readFile(fileName, callback)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹thunkå‡½æ•°æ€æ ·æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">readFile(&apos;./package.json&apos;)((err, str) =&gt; &#123;</span><br><span class="line">    console.log(str.toString())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>é—®: thunkçš„æ‰§è¡Œæ¯”æ™®é€šå‡½æ•°è¦éº»çƒ¦ä¸å°‘ï¼Œé‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ</p>
<h3 id="thunkå‡½æ•°çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å°†å¼‚æ­¥æ“ä½œè¿”å›ç»“æœçš„è·å–æƒäº¤ç»™thunkå‡½æ•°çš„è¿”å›å€¼ï¼Œ"><a href="#thunkå‡½æ•°çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å°†å¼‚æ­¥æ“ä½œè¿”å›ç»“æœçš„è·å–æƒäº¤ç»™thunkå‡½æ•°çš„è¿”å›å€¼ï¼Œ" class="headerlink" title="thunkå‡½æ•°çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å°†å¼‚æ­¥æ“ä½œè¿”å›ç»“æœçš„è·å–æƒäº¤ç»™thunkå‡½æ•°çš„è¿”å›å€¼ï¼Œ"></a>thunkå‡½æ•°çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å°†å¼‚æ­¥æ“ä½œè¿”å›ç»“æœçš„è·å–æƒäº¤ç»™thunkå‡½æ•°çš„è¿”å›å€¼ï¼Œ</h3><p>è€Œä¸æ˜¯å°†å¼‚æ­¥æ“ä½œç»“æœä¼ å…¥thunkå‡½æ•°æœ¬èº«çš„ä½œç”¨åŸŸå†…ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ<br>å› ä¸ºå®ƒèƒ½ç»“åˆGeneratorè¯­æ³•è®©Generatorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œ</p>
<p>äºŒã€Generator<br>es6çš„Generatorå‡½æ•°ï¼Œå…·ä½“è¯­æ³•è¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼Œ</p>
<p>æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªåŸºäºthunkå‡½æ•°çš„Generatorï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ¥æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªGenerator:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let g = gen()</span><br><span class="line">let r1 = g.next()</span><br><span class="line">r1.value(function (err, data) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        throw err</span><br><span class="line">    &#125;</span><br><span class="line">    let r2 = g.next(data)</span><br><span class="line">    r2.value(function (err, data) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            throw err</span><br><span class="line">        &#125;</span><br><span class="line">        g.next(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥æ³¨æ„åˆ°ï¼Œåœ¨æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡ŒåŸºäºthunkå‡½æ•°çš„Generatoræ—¶ï¼Œ<br>æœ‰å¾ˆå¤šä»£ç æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œ<br>æ²¡é”™ï¼Œæ‰€è°“çš„Generatorè‡ªåŠ¨æ‰§è¡Œå°±æ˜¯æŠŠè¿™äº›å¯å¤ç”¨çš„éƒ¨åˆ†å°è£…æˆå‡½æ•°ï¼Œ<br>ç„¶åè®©å®ƒä»¬é€’å½’æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰çš„yieldã€‚</p>
<p>ä¸‰ã€Generatorè‡ªåŠ¨æ‰§è¡Œå™¨<br>ä¸‹é¢å°±æ˜¯Generatorè‡ªåŠ¨æ‰§è¡Œçš„æ ¸å¿ƒä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function run(fn) &#123;</span><br><span class="line">    let gen = fn()</span><br><span class="line">    function next(err, data) &#123;</span><br><span class="line">        let result = gen.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        result.value(next)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°æ— éå°±æ˜¯æŠŠå¯å¤ç”¨çš„éƒ¨åˆ†å°è£…æˆnextå‡½æ•°ï¼Œç„¶åè®©å…¶<strong>é€’å½’</strong>æ‰§è¡Œï¼Œ<br>ç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰çš„yield</p>
<p>å…¶è°ƒç”¨ä»£ç ä¸º:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å°±å°†åŸæœ¬ç¹æ‚çš„å¼‚æ­¥æ“ä½œå°è£…çš„ååˆ†ç®€å•äº†</p>
<p>åŸºäºPromiseçš„Generatorçš„è‡ªåŠ¨æ‰§è¡Œ<br>ä¸Šé¢çš„ä¾‹å­æ˜¯åŸºäºthunkå‡½æ•°çš„ï¼Œè€Œå³å°†å‡ºç°çš„es7çš„asyncã€awaitè¯­æ³•æ˜¯åŸºäºPromiseçš„</p>
<p>è¿™é‡Œå†ä¸Šä¸€ä¸ªåŸºäºPromiseçš„Generatorçš„è‡ªåŠ¨æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//åŒ…è£…è¿”å›Promiseå¯¹è±¡çš„å‡½æ•°</span><br><span class="line">functionreadFile(fileName) &#123;</span><br><span class="line">    return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        fs.readFile(fileName, (error, data) =&gt; &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                reject(error)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// ç¼–å†™Generator</span><br><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç¼–å†™Generatoræ‰§è¡Œå™¨</span><br><span class="line">function run(gen) &#123;</span><br><span class="line">    let g = gen()</span><br><span class="line">    function next(data) &#123;</span><br><span class="line">        let result = g.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return result.value</span><br><span class="line">        &#125;</span><br><span class="line">        result.value.then((data) =&gt; next(data))</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ç”¨Generatoræ‰§è¡Œå™¨è‡ªåŠ¨æ‰§è¡Œ</span><br><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå’ŒåŸºäºthunkå‡½æ•°çš„å¤§åŒå°å¼‚ï¼Œåªæ˜¯æŠŠå‡½æ•°è¿”å›å€¼çš„è·å–æƒä»¥Promiseçš„æ–¹å¼äº¤å‡º</p>
<h4 id="å‚è€ƒ-ç®€å•ç†è§£Generatorè‡ªæ‰§è¡ŒåŠasyncã€awaitè¯­æ³•åŸç†"><a href="#å‚è€ƒ-ç®€å•ç†è§£Generatorè‡ªæ‰§è¡ŒåŠasyncã€awaitè¯­æ³•åŸç†" class="headerlink" title="å‚è€ƒ ç®€å•ç†è§£Generatorè‡ªæ‰§è¡ŒåŠasyncã€awaitè¯­æ³•åŸç†"></a>å‚è€ƒ <a href="https://link.juejin.im?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000008254704" target="_blank" rel="noopener">ç®€å•ç†è§£Generatorè‡ªæ‰§è¡ŒåŠasyncã€awaitè¯­æ³•åŸç†</a></h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/30/pm2-å¸¸ç”¨é…ç½®åŠå‘½ä»¤/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/30/pm2-å¸¸ç”¨é…ç½®åŠå‘½ä»¤/" itemprop="url">pm2 å¸¸ç”¨é…ç½®åŠå‘½ä»¤</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-09-30T12:11:05+08:00">
                2018-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>PM2</code> æ˜¯ <code>node</code> è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥ç®€åŒ–å¾ˆå¤š <code>node</code> åº”ç”¨ç®¡ç†çš„ç¹çä»»åŠ¡ï¼Œå¦‚æ€§èƒ½ç›‘æ§ã€è‡ªåŠ¨é‡å¯ã€è´Ÿè½½å‡è¡¡ç­‰ï¼Œè€Œä¸”ä½¿ç”¨éå¸¸ç®€å•ã€‚æœ¬æ–‡å°± <code>PM2</code> è¿›è¡Œå…¥é—¨æ€§çš„ä»‹ç»ï¼ŒåŸºæœ¬æ¶µç›–äº† <code>PM2</code> çš„å¸¸ç”¨çš„åŠŸèƒ½å’Œé…ç½®ã€‚</p>
<h2 id="å®‰è£…å®‰è£…"><a href="#å®‰è£…å®‰è£…" class="headerlink" title="#å®‰è£…å®‰è£…"></a><a href="#å®‰è£…">#å®‰è£…</a>å®‰è£…</h2><pre><code>npm install -g pm2
</code></pre><h2 id="å¸¸ç”¨å‘½ä»¤å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤å¸¸ç”¨å‘½ä»¤" class="headerlink" title="#å¸¸ç”¨å‘½ä»¤å¸¸ç”¨å‘½ä»¤"></a><a href="#å¸¸ç”¨å‘½ä»¤">#å¸¸ç”¨å‘½ä»¤</a>å¸¸ç”¨å‘½ä»¤</h2><pre><code>pm2 start [server.js]
# å¯åŠ¨æœåŠ¡
pm2 list
# æŸ¥çœ‹å½“å‰æ‰€è·‘æœåŠ¡çš„è¯¦æƒ…
pm2 show [name]
# æŸ¥çœ‹æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯è¿™ä¸ªå‘½ä»¤å¯æŸ¥çœ‹pm2é…ç½® åŒ…æ‹¬æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„ä½ç½®ç­‰
pm2 stop [id/name]
# å…³é—­æŸä¸ªæœåŠ¡
pm2 delete [id/name]
# åˆ é™¤æŸä¸ªæœåŠ¡
pm2 stop all
# å…³é—­æ‰€æœ‰æœåŠ¡
pm2 logs
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 restart [name]
# é‡æ–°å¯åŠ¨æœåŠ¡
</code></pre><h2 id="å¯åŠ¨å¯åŠ¨"><a href="#å¯åŠ¨å¯åŠ¨" class="headerlink" title="#å¯åŠ¨å¯åŠ¨"></a><a href="#å¯åŠ¨">#å¯åŠ¨</a>å¯åŠ¨</h2><p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><code>--watch</code>ï¼šç›‘å¬åº”ç”¨ç›®å½•çš„å˜åŒ–ï¼Œä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯ã€‚å¦‚æœè¦ç²¾ç¡®ç›‘å¬ã€ä¸è§å¬çš„ç›®å½•ï¼Œæœ€å¥½é€šè¿‡é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>-i --instances</code>ï¼šå¯ç”¨å¤šå°‘ä¸ªå®ä¾‹ï¼Œå¯ç”¨äºè´Ÿè½½å‡è¡¡ã€‚å¦‚æœ <code>-i 0</code> æˆ–è€… <code>-i max</code>ï¼Œåˆ™æ ¹æ®å½“å‰æœºå™¨æ ¸æ•°ç¡®å®šå®ä¾‹æ•°ç›®ã€‚</li>
<li><code>--ignore-watch</code>ï¼šæ’é™¤ç›‘å¬çš„ç›®å½•/æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯ç‰¹å®šçš„æ–‡ä»¶åï¼Œä¹Ÿå¯ä»¥æ˜¯æ­£åˆ™ã€‚æ¯”å¦‚ <code>--ignore-watch=&quot;test node_modules &quot;some scripts&quot;&quot;</code></li>
<li><code>-n --name</code>ï¼šåº”ç”¨çš„åç§°ã€‚æŸ¥çœ‹åº”ç”¨ä¿¡æ¯çš„æ—¶å€™å¯ä»¥ç”¨åˆ°ã€‚</li>
<li><code>-o --output &lt;path&gt;</code>ï¼šæ ‡å‡†è¾“å‡ºæ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ã€‚</li>
<li><code>-e --error &lt;path&gt;</code>ï¼šé”™è¯¯è¾“å‡ºæ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ã€‚</li>
</ul>
<h2 id="ç›‘å¬ç›‘å¬"><a href="#ç›‘å¬ç›‘å¬" class="headerlink" title="#ç›‘å¬ç›‘å¬"></a><a href="#ç›‘å¬">#ç›‘å¬</a>ç›‘å¬</h2><pre><code>pm2 start ./bin/www --watch
#æ³¨æ„ï¼Œè¿™é‡Œç”¨äº†--watchå‚æ•°ï¼Œæ„å‘³ç€å½“ä½ çš„åº”ç”¨ä»£ç å‘ç”Ÿå˜åŒ–æ—¶ï¼Œpm2ä¼šå¸®ä½ è‡ªåŠ¨é‡å¯æœåŠ¡
</code></pre><h2 id="é…ç½®åŠéƒ¨ç½²é…ç½®åŠéƒ¨ç½²"><a href="#é…ç½®åŠéƒ¨ç½²é…ç½®åŠéƒ¨ç½²" class="headerlink" title="#é…ç½®åŠéƒ¨ç½²é…ç½®åŠéƒ¨ç½²"></a><a href="#é…ç½®åŠéƒ¨ç½²">#é…ç½®åŠéƒ¨ç½²</a>é…ç½®åŠéƒ¨ç½²</h2><p>éƒ¨ç½²çš„é…ç½®æ–‡ä»¶ç¤ºä¾‹</p>
<pre><code>{
  // æ•°ç»„ä¸­æ”¾çš„æ˜¯éœ€è¦å‘å¸ƒçš„é¡¹ç›®ä¸€äº›å˜é‡çš„å®šä¹‰
  &quot;apps&quot;: [{
    &quot;name&quot;: &quot;xxx&quot;, //é¡¹ç›®åç§°
    &quot;script&quot;: &quot;server.js&quot;, //ç”¨æ¥å¯åŠ¨çš„è„šæœ¬
    // &quot;instances&quot;:2,
    // å¯åŠ¨é¡¹ç›®æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡
    &quot;env&quot;: {
      &quot;COMMON_VARIABLE&quot;: &quot;true&quot;, //è®¾ç½®ä¸ºtrue å¯ä»¥åœ¨å¯åŠ¨çš„æ—¶ä¼ å…¥å¤–éƒ¨çš„å˜é‡è¿›å»
    },
    &quot;env_production&quot;: {
      &quot;NODE_ENV&quot;: &quot;production&quot;
    }
  }],
  // éƒ¨ç½²
  &quot;deploy&quot;: {
    &quot;production&quot;: {
      &quot;user&quot;: &quot;root&quot;,
      &quot;host&quot;: &quot;0.0.0.0&quot;, //å¯ä»¥æ˜¯æ•°ç»„ éƒ¨ç½²åˆ°å¤šå°ä¸»æœº
      &quot;ref&quot;: &quot;origin/master&quot;, //é€‰æ‹©æ‹¿å“ªä¸ªä¸ªåˆ†æ”¯çš„ä»£ç 
      &quot;repo&quot;: &quot;git@github.com:ihoey/hitalk.git&quot;, //ä»“åº“åœ°å€
      &quot;path&quot;: &quot;/root/www/hitalk/production&quot;, //è¦å‘å¸ƒåˆ°æœåŠ¡å™¨ä¸Šå“ªä¸ªç›®å½•ä¸‹é¢
      &quot;ssh_options&quot;: &quot;StrictHostKeyChecking=no&quot;, //é¿å…keyéªŒè¯å¯¼è‡´ä»£ç æ›´æ–°åˆ°è¿œç¨‹ä»“åº“å¤±è´¥
      &quot;post-deploy&quot;: &quot;source ~/.nvm/nvm.sh &amp;&amp; pm2 startOrRestart ecosystem.json --env production&quot;, //å‘å¸ƒä¹‹åæ‰§è¡Œçš„åŠ¨ä½œ æ‰§è¡Œå¼€å¯æˆ–æ›´æ–°pm2è¿è¡Œçš„æœåŠ¡
      &quot;pre-deploy-local&quot;: &quot;echo &apos;Deploy Done!&apos;&quot;, //æœ¬åœ°å‘å¸ƒä¹‹å‰çš„åŠ¨ä½œ
      &quot;env&quot;: { //æŒ‡å®šéƒ¨ç½²åˆ°è¿œç¨‹çš„ä»“åº“çš„ç¯å¢ƒ æ˜¯productionç”Ÿäº§ç¯å¢ƒ
        &quot;NODE_ENV&quot;: &quot;production&quot;
      }
    }
  }
}
</code></pre><h3 id="åˆå§‹åŒ–é…ç½®åˆå§‹åŒ–é…ç½®"><a href="#åˆå§‹åŒ–é…ç½®åˆå§‹åŒ–é…ç½®" class="headerlink" title="#åˆå§‹åŒ–é…ç½®åˆå§‹åŒ–é…ç½®"></a><a href="#åˆå§‹åŒ–é…ç½®">#åˆå§‹åŒ–é…ç½®</a>åˆå§‹åŒ–é…ç½®</h3><p>ç¬¬ä¸€æ¬¡éƒ¨ç½²</p>
<pre><code>pm2 deploy ecosystem.json production setup
</code></pre><h3 id="éƒ¨ç½²éƒ¨ç½²"><a href="#éƒ¨ç½²éƒ¨ç½²" class="headerlink" title="#éƒ¨ç½²éƒ¨ç½²"></a><a href="#éƒ¨ç½²">#éƒ¨ç½²</a>éƒ¨ç½²</h3><pre><code>pm2 deploy ecosystem.json production
</code></pre><p>å¥½äº†ï¼Œå…ˆè®°å½•è¿™ä¹ˆå¤š~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/29/æµ…è¯´-XSS-å’Œ-CSRF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/29/æµ…è¯´-XSS-å’Œ-CSRF/" itemprop="url">æµ…è¯´ XSS å’Œ CSRF</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-09-29T12:06:38+08:00">
                2018-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åœ¨ Web å®‰å…¨é¢†åŸŸä¸­ï¼ŒXSS å’Œ CSRF æ˜¯æœ€å¸¸è§çš„æ”»å‡»æ–¹å¼ã€‚æœ¬æ–‡å°†ä¼šç®€å•ä»‹ç» XSS å’Œ CSRF çš„æ”»é˜²é—®é¢˜ã€‚</p>
<blockquote>
<p>å£°æ˜ï¼šæœ¬æ–‡çš„ç¤ºä¾‹ä»…ç”¨äºæ¼”ç¤ºç›¸å…³çš„æ”»å‡»åŸç†</p>
</blockquote>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>XSSï¼Œå³ Cross Site Scriptï¼Œä¸­è¯‘æ˜¯è·¨ç«™è„šæœ¬æ”»å‡»ï¼›å…¶åŸæœ¬ç¼©å†™æ˜¯ CSSï¼Œä½†ä¸ºäº†å’Œå±‚å æ ·å¼è¡¨(Cascading Style Sheet)æœ‰æ‰€åŒºåˆ†ï¼Œå› è€Œåœ¨å®‰å…¨é¢†åŸŸå«åš XSSã€‚</p>
<p>XSS æ”»å‡»æ˜¯æŒ‡æ”»å‡»è€…åœ¨ç½‘ç«™ä¸Šæ³¨å…¥æ¶æ„çš„å®¢æˆ·ç«¯ä»£ç ï¼Œé€šè¿‡æ¶æ„è„šæœ¬å¯¹å®¢æˆ·ç«¯ç½‘é¡µè¿›è¡Œç¯¡æ”¹ï¼Œä»è€Œåœ¨ç”¨æˆ·æµè§ˆç½‘é¡µæ—¶ï¼Œå¯¹ç”¨æˆ·æµè§ˆå™¨è¿›è¡Œæ§åˆ¶æˆ–è€…è·å–ç”¨æˆ·éšç§æ•°æ®çš„ä¸€ç§æ”»å‡»æ–¹å¼ã€‚</p>
<p>æ”»å‡»è€…å¯¹å®¢æˆ·ç«¯ç½‘é¡µæ³¨å…¥çš„æ¶æ„è„šæœ¬ä¸€èˆ¬åŒ…æ‹¬ JavaScriptï¼Œæœ‰æ—¶ä¹Ÿä¼šåŒ…å« HTML å’Œ Flashã€‚æœ‰å¾ˆå¤šç§æ–¹å¼è¿›è¡Œ XSS æ”»å‡»ï¼Œä½†å®ƒä»¬çš„å…±åŒç‚¹ä¸ºï¼šå°†ä¸€äº›éšç§æ•°æ®åƒ cookieã€session å‘é€ç»™æ”»å‡»è€…ï¼Œå°†å—å®³è€…é‡å®šå‘åˆ°ä¸€ä¸ªç”±æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ï¼Œåœ¨å—å®³è€…çš„æœºå™¨ä¸Šè¿›è¡Œä¸€äº›æ¶æ„æ“ä½œã€‚</p>
<p>XSSæ”»å‡»å¯ä»¥åˆ†ä¸º3ç±»ï¼šåå°„å‹ï¼ˆéæŒä¹…å‹ï¼‰ã€å­˜å‚¨å‹ï¼ˆæŒä¹…å‹ï¼‰ã€åŸºäºDOMã€‚</p>
<h4 id="åå°„å‹"><a href="#åå°„å‹" class="headerlink" title="åå°„å‹"></a>åå°„å‹</h4><p>åå°„å‹ XSS åªæ˜¯ç®€å•åœ°æŠŠç”¨æˆ·è¾“å…¥çš„æ•°æ® â€œåå°„â€ ç»™æµè§ˆå™¨ï¼Œè¿™ç§æ”»å‡»æ–¹å¼å¾€å¾€éœ€è¦æ”»å‡»è€…è¯±ä½¿ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªæ¶æ„é“¾æ¥ï¼Œæˆ–è€…æäº¤ä¸€ä¸ªè¡¨å•ï¼Œæˆ–è€…è¿›å…¥ä¸€ä¸ªæ¶æ„ç½‘ç«™æ—¶ï¼Œæ³¨å…¥è„šæœ¬è¿›å…¥è¢«æ”»å‡»è€…çš„ç½‘ç«™ã€‚</p>
<p>çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚æˆ‘å…ˆå‡†å¤‡ä¸€ä¸ªå¦‚ä¸‹çš„é™æ€é¡µï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42720000-30a9b93a-8752-11e8-879b-edd8519f4e3e.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42720000-30a9b93a-8752-11e8-879b-edd8519f4e3e.png" alt="åå°„å‹xss1"></a></p>
<p>æ¶æ„é“¾æ¥çš„åœ°å€æŒ‡å‘äº† <code>localhost:8001/?q=111&amp;p=222</code>ã€‚ç„¶åï¼Œæˆ‘å†å¯ä¸€ä¸ªç®€å•çš„ Node æœåŠ¡å¤„ç†æ¶æ„é“¾æ¥çš„è¯·æ±‚ï¼š</p>
<pre><code>consthttp=require(&apos;http&apos;);
functionhandleReequest(req, res) {
    res.setHeader(&apos;Access-Control-Allow-Origin&apos;, &apos;*&apos;);
    res.writeHead(200, {&apos;Content-Type&apos;:&apos;text/html; charset=UTF-8&apos;});
    res.write(&apos;&lt;script&gt;alert(&quot;åå°„å‹ XSS æ”»å‡»&quot;)&lt;/script&gt;&apos;);
    res.end();
}

constserver=newhttp.Server();
server.listen(8001, &apos;127.0.0.1&apos;);
server.on(&apos;request&apos;, handleReequest);
</code></pre><p>å½“ç”¨æˆ·ç‚¹å‡»æ¶æ„é“¾æ¥æ—¶ï¼Œé¡µé¢è·³è½¬åˆ°æ”»å‡»è€…é¢„å…ˆå‡†å¤‡çš„é¡µé¢ï¼Œä¼šå‘ç°åœ¨æ”»å‡»è€…çš„é¡µé¢æ‰§è¡Œäº† js è„šæœ¬ï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42720046-ee5a3f40-8752-11e8-8cc5-8b464414864a.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42720046-ee5a3f40-8752-11e8-8cc5-8b464414864a.png" alt="æ‰§è¡Œè„šæœ¬"></a></p>
<p>è¿™æ ·å°±äº§ç”Ÿäº†åå°„å‹ XSS æ”»å‡»ã€‚æ”»å‡»è€…å¯ä»¥æ³¨å…¥ä»»æ„çš„æ¶æ„è„šæœ¬è¿›è¡Œæ”»å‡»ï¼Œå¯èƒ½æ³¨å…¥æ¶ä½œå‰§è„šæœ¬ï¼Œæˆ–è€…æ³¨å…¥èƒ½è·å–ç”¨æˆ·éšç§æ•°æ®(å¦‚cookie)çš„è„šæœ¬ï¼Œè¿™å–å†³äºæ”»å‡»è€…çš„ç›®çš„ã€‚</p>
<h4 id="å­˜å‚¨å‹"><a href="#å­˜å‚¨å‹" class="headerlink" title="å­˜å‚¨å‹"></a>å­˜å‚¨å‹</h4><p>å­˜å‚¨å‹ XSS ä¼šæŠŠç”¨æˆ·è¾“å…¥çš„æ•°æ® â€œå­˜å‚¨â€ åœ¨æœåŠ¡å™¨ç«¯ï¼Œå½“æµè§ˆå™¨è¯·æ±‚æ•°æ®æ—¶ï¼Œè„šæœ¬ä»æœåŠ¡å™¨ä¸Šä¼ å›å¹¶æ‰§è¡Œã€‚è¿™ç§ XSS æ”»å‡»å…·æœ‰å¾ˆå¼ºçš„ç¨³å®šæ€§ã€‚</p>
<p>æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯æ˜¯æ”»å‡»è€…åœ¨ç¤¾åŒºæˆ–è®ºå›ä¸Šå†™ä¸‹ä¸€ç¯‡åŒ…å«æ¶æ„ JavaScript ä»£ç çš„æ–‡ç« æˆ–è¯„è®ºï¼Œæ–‡ç« æˆ–è¯„è®ºå‘è¡¨åï¼Œæ‰€æœ‰è®¿é—®è¯¥æ–‡ç« æˆ–è¯„è®ºçš„ç”¨æˆ·ï¼Œéƒ½ä¼šåœ¨ä»–ä»¬çš„æµè§ˆå™¨ä¸­æ‰§è¡Œè¿™æ®µæ¶æ„çš„ JavaScript ä»£ç ã€‚</p>
<p>ä¸¾ä¸€ä¸ªç¤ºä¾‹ã€‚</p>
<p>å…ˆå‡†å¤‡ä¸€ä¸ªè¾“å…¥é¡µé¢ï¼š</p>
<pre><code>&lt;input type=&quot;text&quot; id=&quot;input&quot;&gt;
&lt;button id=&quot;btn&quot;&gt;Submit&lt;/button&gt;   

&lt;script&gt;
    const input = document.getElementById(&apos;input&apos;);
    const btn = document.getElementById(&apos;btn&apos;);

    let val;

    input.addEventListener(&apos;change&apos;, (e) =&gt; {
        val = e.target.value;
    }, false);

    btn.addEventListener(&apos;click&apos;, (e) =&gt; {
        fetch(&apos;http://localhost:8001/save&apos;, {
            method: &apos;POST&apos;,
            body: val
        });
    }, false);
&lt;/script&gt;     
</code></pre><p>å¯åŠ¨ä¸€ä¸ª Node æœåŠ¡ç›‘å¬ <code>save</code> è¯·æ±‚ã€‚ä¸ºäº†ç®€åŒ–ï¼Œç”¨ä¸€ä¸ªå˜é‡æ¥ä¿å­˜ç”¨æˆ·çš„è¾“å…¥ï¼š</p>
<pre><code>consthttp=require(&apos;http&apos;);

let userInput =&apos;&apos;;

functionhandleReequest(req, res) {
    constmethod=req.method;
    res.setHeader(&apos;Access-Control-Allow-Origin&apos;, &apos;*&apos;);
    res.setHeader(&apos;Access-Control-Allow-Headers&apos;, &apos;Content-Type&apos;)

    if (method ===&apos;POST&apos;&amp;&amp;req.url===&apos;/save&apos;) {
        let body =&apos;&apos;;
        req.on(&apos;data&apos;, chunk=&gt; {
            body += chunk;
        });

        req.on(&apos;end&apos;, () =&gt; {
            if (body) {
                userInput = body;
            }
            res.end();
        });
    } else {
        res.writeHead(200, {&apos;Content-Type&apos;:&apos;text/html; charset=UTF-8&apos;});
        res.write(userInput);
        res.end();
    }
}

constserver=newhttp.Server();
server.listen(8001, &apos;127.0.0.1&apos;);

server.on(&apos;request&apos;, handleReequest);
</code></pre><p>å½“ç”¨æˆ·ç‚¹å‡»æäº¤æŒ‰é’®å°†è¾“å…¥ä¿¡æ¯æäº¤åˆ°æœåŠ¡ç«¯æ—¶ï¼ŒæœåŠ¡ç«¯é€šè¿‡ <code>userInput</code> å˜é‡ä¿å­˜äº†è¾“å…¥å†…å®¹ã€‚å½“ç”¨æˆ·é€šè¿‡ <code>http://localhost:8001/${id}</code> è®¿é—®æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›ä¸ <code>id</code> å¯¹åº”çš„å†…å®¹(æœ¬ç¤ºä¾‹ç®€åŒ–äº†å¤„ç†)ã€‚å¦‚æœç”¨æˆ·è¾“å…¥äº†æ¶æ„è„šæœ¬å†…å®¹ï¼Œåˆ™å…¶ä»–ç”¨æˆ·è®¿é—®è¯¥å†…å®¹æ—¶ï¼Œæ¶æ„è„šæœ¬å°±ä¼šåœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42720476-eb71a5c8-8759-11e8-8763-eb08b3480201.gif" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42720476-eb71a5c8-8759-11e8-8763-eb08b3480201.gif" alt="å­˜å‚¨å‹xss"></a></p>
<h4 id="åŸºäºDOM"><a href="#åŸºäºDOM" class="headerlink" title="åŸºäºDOM"></a>åŸºäºDOM</h4><p>åŸºäº DOM çš„ XSS æ”»å‡»æ˜¯æŒ‡é€šè¿‡æ¶æ„è„šæœ¬ä¿®æ”¹é¡µé¢çš„ DOM ç»“æ„ï¼Œæ˜¯çº¯ç²¹å‘ç”Ÿåœ¨å®¢æˆ·ç«¯çš„æ”»å‡»ã€‚</p>
<p>çœ‹å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code>&lt;h2&gt;XSS: &lt;/h2&gt;
&lt;inputtype=&quot;text&quot;id=&quot;input&quot;&gt;
&lt;buttonid=&quot;btn&quot;&gt;Submit&lt;/button&gt;
&lt;divid=&quot;div&quot;&gt;&lt;/div&gt;
&lt;script&gt;constinput=document.getElementById(&apos;input&apos;);constbtn=document.getElementById(&apos;btn&apos;);constdiv=document.getElementById(&apos;div&apos;);let val;input.addEventListener(&apos;change&apos;, (e) =&gt; {        val =e.target.value;    }, false);btn.addEventListener(&apos;click&apos;, () =&gt; {div.innerHTML=`&lt;ahref=${val}&gt;testLink&lt;/a&gt;`    }, false);&lt;/script&gt;
</code></pre><p>ç‚¹å‡» <code>Submit</code> æŒ‰é’®åï¼Œä¼šåœ¨å½“å‰é¡µé¢æ’å…¥ä¸€ä¸ªé“¾æ¥ï¼Œå…¶åœ°å€ä¸ºç”¨æˆ·çš„è¾“å…¥å†…å®¹ã€‚å¦‚æœç”¨æˆ·åœ¨è¾“å…¥æ—¶æ„é€ äº†å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre><code>&apos;&apos; onclick=alert(/xss/)
</code></pre><p>ç”¨æˆ·æäº¤ä¹‹åï¼Œé¡µé¢ä»£ç å°±å˜æˆäº†ï¼š</p>
<pre><code>&lt;ahrefonlick=&quot;alert(/xss/)&quot;&gt;testLink&lt;/a&gt;
</code></pre><p>æ­¤æ—¶ï¼Œç”¨æˆ·ç‚¹å‡»ç”Ÿæˆçš„é“¾æ¥ï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„è„šæœ¬ï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42721109-cb7ce572-8766-11e8-96d9-9ada8a787827.gif" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42721109-cb7ce572-8766-11e8-96d9-9ada8a787827.gif" alt="dom-xss"></a></p>
<h3 id="XSS-æ”»å‡»çš„é˜²èŒƒ"><a href="#XSS-æ”»å‡»çš„é˜²èŒƒ" class="headerlink" title="XSS æ”»å‡»çš„é˜²èŒƒ"></a>XSS æ”»å‡»çš„é˜²èŒƒ</h3><p>ç°åœ¨ä¸»æµçš„æµè§ˆå™¨å†…ç½®äº†é˜²èŒƒ XSS çš„æªæ–½ï¼Œä¾‹å¦‚ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" target="_blank" rel="noopener">CSP</a>ã€‚ä½†å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œä¹Ÿåº”è¯¥å¯»æ‰¾å¯é çš„è§£å†³æ–¹æ¡ˆæ¥é˜²æ­¢ XSS æ”»å‡»ã€‚</p>
<h4 id="HttpOnly-é˜²æ­¢åŠ«å–-Cookie"><a href="#HttpOnly-é˜²æ­¢åŠ«å–-Cookie" class="headerlink" title="HttpOnly é˜²æ­¢åŠ«å– Cookie"></a>HttpOnly é˜²æ­¢åŠ«å– Cookie</h4><p>HttpOnly æœ€æ—©ç”±å¾®è½¯æå‡ºï¼Œè‡³ä»Šå·²ç»æˆä¸ºä¸€ä¸ªæ ‡å‡†ã€‚æµè§ˆå™¨å°†ç¦æ­¢é¡µé¢çš„Javascript è®¿é—®å¸¦æœ‰ HttpOnly å±æ€§çš„Cookieã€‚</p>
<p>ä¸Šæ–‡æœ‰è¯´åˆ°ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„è„šæœ¬è·å–ç”¨æˆ·çš„ Cookie ä¿¡æ¯ã€‚é€šå¸¸ Cookie ä¸­éƒ½åŒ…å«äº†ç”¨æˆ·çš„ç™»å½•å‡­è¯ä¿¡æ¯ï¼Œæ”»å‡»è€…åœ¨è·å–åˆ° Cookie ä¹‹åï¼Œåˆ™å¯ä»¥å‘èµ· Cookie åŠ«æŒæ”»å‡»ã€‚æ‰€ä»¥ï¼Œä¸¥æ ¼æ¥è¯´ï¼ŒHttpOnly å¹¶éé˜»æ­¢ XSS æ”»å‡»ï¼Œè€Œæ˜¯èƒ½é˜»æ­¢ XSS æ”»å‡»åçš„ Cookie åŠ«æŒæ”»å‡»ã€‚</p>
<h4 id="è¾“å…¥æ£€æŸ¥"><a href="#è¾“å…¥æ£€æŸ¥" class="headerlink" title="è¾“å…¥æ£€æŸ¥"></a>è¾“å…¥æ£€æŸ¥</h4><p><strong>ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„ä»»ä½•è¾“å…¥ã€‚</strong> å¯¹äºç”¨æˆ·çš„ä»»ä½•è¾“å…¥è¦è¿›è¡Œæ£€æŸ¥ã€è¿‡æ»¤å’Œè½¬ä¹‰ã€‚å»ºç«‹å¯ä¿¡ä»»çš„å­—ç¬¦å’Œ HTML æ ‡ç­¾ç™½åå•ï¼Œå¯¹äºä¸åœ¨ç™½åå•ä¹‹åˆ—çš„å­—ç¬¦æˆ–è€…æ ‡ç­¾è¿›è¡Œè¿‡æ»¤æˆ–ç¼–ç ã€‚</p>
<p>åœ¨ XSS é˜²å¾¡ä¸­ï¼Œè¾“å…¥æ£€æŸ¥ä¸€èˆ¬æ˜¯æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¸­æ˜¯å¦åŒ…å« <code>&lt;</code>ï¼Œ<code>&gt;</code> ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè¿‡æ»¤æˆ–ç¼–ç ï¼Œè¿™ç§æ–¹å¼ä¹Ÿç§°ä¸º XSS Filterã€‚</p>
<p>è€Œåœ¨ä¸€äº›å‰ç«¯æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ä»½ <code>decodingMap</code>ï¼Œ ç”¨äºå¯¹ç”¨æˆ·è¾“å…¥æ‰€åŒ…å«çš„ç‰¹æ®Šå­—ç¬¦æˆ–æ ‡ç­¾è¿›è¡Œç¼–ç æˆ–è¿‡æ»¤ï¼Œå¦‚ <code>&lt;</code>ï¼Œ<code>&gt;</code>ï¼Œ<code>script</code>ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼š</p>
<pre><code>// vuejs ä¸­çš„ decodingMap
// åœ¨ vuejs ä¸­ï¼Œå¦‚æœè¾“å…¥å¸¦ script æ ‡ç­¾çš„å†…å®¹ï¼Œä¼šç›´æ¥è¿‡æ»¤æ‰
const decodingMap = {
  &apos;&amp;lt;&apos;: &apos;&lt;&apos;,
  &apos;&amp;gt;&apos;: &apos;&gt;&apos;,
  &apos;&amp;quot;&apos;: &apos;&quot;&apos;,
  &apos;&amp;amp;&apos;: &apos;&amp;&apos;,
  &apos;&amp;#10;&apos;: &apos;\n&apos;
}
</code></pre><h4 id="è¾“å‡ºæ£€æŸ¥"><a href="#è¾“å‡ºæ£€æŸ¥" class="headerlink" title="è¾“å‡ºæ£€æŸ¥"></a>è¾“å‡ºæ£€æŸ¥</h4><p>ç”¨æˆ·çš„è¾“å…¥ä¼šå­˜åœ¨é—®é¢˜ï¼ŒæœåŠ¡ç«¯çš„è¾“å‡ºä¹Ÿä¼šå­˜åœ¨é—®é¢˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé™¤å¯Œæ–‡æœ¬çš„è¾“å‡ºå¤–ï¼Œåœ¨å˜é‡è¾“å‡ºåˆ° HTML é¡µé¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç¼–ç æˆ–è½¬ä¹‰çš„æ–¹å¼æ¥é˜²å¾¡ XSS æ”»å‡»ã€‚ä¾‹å¦‚åˆ©ç”¨ <a href="https://github.com/punkave/sanitize-html" target="_blank" rel="noopener">sanitize-html</a> å¯¹è¾“å‡ºå†…å®¹è¿›è¡Œæœ‰è§„åˆ™çš„è¿‡æ»¤ä¹‹åå†è¾“å‡ºåˆ°é¡µé¢ä¸­ã€‚</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>CSRFï¼Œå³ Cross Site Request Forgeryï¼Œä¸­è¯‘æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œæ˜¯ä¸€ç§åŠ«æŒå—ä¿¡ä»»ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€éé¢„æœŸè¯·æ±‚çš„æ”»å‡»æ–¹å¼ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒCSRF æ”»å‡»æ˜¯æ”»å‡»è€…å€ŸåŠ©å—å®³è€…çš„ Cookie éª—å–æœåŠ¡å™¨çš„ä¿¡ä»»ï¼Œå¯ä»¥åœ¨å—å®³è€…æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»¥å—å®³è€…åä¹‰ä¼ªé€ è¯·æ±‚å‘é€ç»™å—æ”»å‡»æœåŠ¡å™¨ï¼Œä»è€Œåœ¨å¹¶æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œåœ¨æƒé™ä¿æŠ¤ä¹‹ä¸‹çš„æ“ä½œã€‚</p>
<p>åœ¨ä¸¾ä¾‹å­ä¹‹å‰ï¼Œå…ˆè¯´è¯´æµè§ˆå™¨çš„ Cookie ç­–ç•¥ã€‚</p>
<h3 id="æµè§ˆå™¨çš„-Cookie-ç­–ç•¥"><a href="#æµè§ˆå™¨çš„-Cookie-ç­–ç•¥" class="headerlink" title="æµè§ˆå™¨çš„ Cookie ç­–ç•¥"></a>æµè§ˆå™¨çš„ Cookie ç­–ç•¥</h3><p>Cookie æ˜¯æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨æœ¬åœ°çš„ä¸€å°å—æ•°æ®ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨ä¸‹æ¬¡å‘åŒä¸€æœåŠ¡å™¨å†å‘èµ·è¯·æ±‚æ—¶è¢«æºå¸¦å¹¶å‘é€åˆ°æœåŠ¡å™¨ä¸Šã€‚Cookie ä¸»è¦ç”¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€æ¸¸æˆåˆ†æ•°æˆ–å…¶å®ƒéœ€è¦è®°å½•çš„ä¿¡æ¯ï¼‰</li>
<li>ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜ç­‰ï¼‰</li>
<li>ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜ç­‰ï¼‰</li>
</ul>
<p>è€Œæµè§ˆå™¨æ‰€æŒæœ‰çš„ Cookie åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>Session Cookie(ä¼šè¯æœŸ Cookie)ï¼šä¼šè¯æœŸ Cookie æ˜¯æœ€ç®€å•çš„Cookieï¼Œå®ƒä¸éœ€è¦æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆExpiresï¼‰æˆ–è€…æœ‰æ•ˆæœŸï¼ˆMax-Ageï¼‰ï¼Œå®ƒä»…åœ¨ä¼šè¯æœŸå†…æœ‰æ•ˆï¼Œæµè§ˆå™¨å…³é—­ä¹‹åå®ƒä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li>
<li><p>Permanent Cookie(æŒä¹…æ€§ Cookie)ï¼šä¸ä¼šè¯æœŸ Cookie ä¸åŒçš„æ˜¯ï¼ŒæŒä¹…æ€§ Cookie å¯ä»¥æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„è¿‡æœŸæ—¶é—´ï¼ˆExpiresï¼‰æˆ–æœ‰æ•ˆæœŸï¼ˆMax-Ageï¼‰ã€‚</p>
<p>  res.setHeader(â€˜Set-Cookieâ€™, [â€˜mycookie=222â€™, â€˜test=3333; expires=Sat, 21 Jul 2018 00:00:00 GMT;â€™]);</p>
</li>
</ul>
<p>ä¸Šè¿°ä»£ç åˆ›å»ºäº†ä¸¤ä¸ª Cookieï¼š<code>mycookie</code> å’Œ <code>test</code>ï¼Œå‰è€…å±äºä¼šè¯æœŸ Cookieï¼Œåè€…åˆ™å±äºæŒä¹…æ€§ Cookieã€‚å½“æˆ‘ä»¬å»æŸ¥çœ‹ Cookie ç›¸å…³çš„å±æ€§æ—¶ï¼Œä¸åŒçš„æµè§ˆå™¨å¯¹ä¼šè¯æœŸ Cookie çš„ <code>Expires</code> å±æ€§å€¼ä¼šä¸ä¸€æ ·ï¼š</p>
<p>Firefoxï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42733717-fe5c16fe-8868-11e8-979b-37aaf8311375.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42733717-fe5c16fe-8868-11e8-979b-37aaf8311375.png" alt="firefox cookie"></a></p>
<p>Chrome:</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42733724-1e22c6ae-8869-11e8-9f84-0fbc2d2fdeb7.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42733724-1e22c6ae-8869-11e8-9f84-0fbc2d2fdeb7.png" alt="chrome cookie"></a></p>
<p>æ­¤å¤–ï¼Œæ¯ä¸ª Cookie éƒ½ä¼šæœ‰ä¸ä¹‹å…³è”çš„åŸŸï¼Œè¿™ä¸ªåŸŸçš„èŒƒå›´ä¸€èˆ¬é€šè¿‡ <code>donmain</code> å±æ€§æŒ‡å®šã€‚å¦‚æœ Cookie çš„åŸŸå’Œé¡µé¢çš„åŸŸç›¸åŒï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°è¿™ä¸ª Cookie ä¸ºç¬¬ä¸€æ–¹ Cookieï¼ˆfirst-party cookieï¼‰ï¼Œå¦‚æœ Cookie çš„åŸŸå’Œé¡µé¢çš„åŸŸä¸åŒï¼Œåˆ™ç§°ä¹‹ä¸ºç¬¬ä¸‰æ–¹ Cookieï¼ˆthird-party cookieï¼‰ã€‚ä¸€ä¸ªé¡µé¢åŒ…å«å›¾ç‰‡æˆ–å­˜æ”¾åœ¨å…¶ä»–åŸŸä¸Šçš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ï¼‰æ—¶ï¼Œç¬¬ä¸€æ–¹çš„ Cookie ä¹Ÿåªä¼šå‘é€ç»™è®¾ç½®å®ƒä»¬çš„æœåŠ¡å™¨ã€‚</p>
<h3 id="é€šè¿‡-Cookie-è¿›è¡Œ-CSRF-æ”»å‡»"><a href="#é€šè¿‡-Cookie-è¿›è¡Œ-CSRF-æ”»å‡»" class="headerlink" title="é€šè¿‡ Cookie è¿›è¡Œ CSRF æ”»å‡»"></a>é€šè¿‡ Cookie è¿›è¡Œ CSRF æ”»å‡»</h3><p>å‡è®¾æœ‰ä¸€ä¸ª bbs ç«™ç‚¹ï¼š<code>http://www.c.com</code>ï¼Œå½“ç™»å½•åçš„ç”¨æˆ·å‘èµ·å¦‚ä¸‹ GET è¯·æ±‚æ—¶ï¼Œä¼šåˆ é™¤ ID æŒ‡å®šçš„å¸–å­ï¼š</p>
<pre><code>http://www.c.com:8002/content/delete/:id
</code></pre><p>å¦‚å‘èµ· <code>http://www.c.com:8002/content/delete/87343</code> è¯·æ±‚æ—¶ï¼Œä¼šåˆ é™¤ id ä¸º 87343 çš„å¸–å­ã€‚å½“ç”¨æˆ·ç™»å½•ä¹‹åï¼Œä¼šè®¾ç½®å¦‚ä¸‹ cookieï¼š</p>
<pre><code>res.setHeader(&apos;Set-Cookie&apos;, [&apos;user=22333; expires=Sat, 21 Jul 2018 00:00:00 GMT;&apos;]);
</code></pre><p><a href="https://user-images.githubusercontent.com/7871813/42733982-62308f16-886e-11e8-9c59-c3b0352b0002.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42733982-62308f16-886e-11e8-9c59-c3b0352b0002.png" alt="user"></a></p>
<p><code>user</code> å¯¹åº”çš„å€¼æ˜¯ç”¨æˆ· IDã€‚ç„¶åæ„é€ ä¸€ä¸ªé¡µé¢ Aï¼š</p>
<pre><code>&lt;p&gt;CSRF æ”»å‡»è€…å‡†å¤‡çš„ç½‘ç«™ï¼š&lt;/p&gt;
&lt;img src=&quot;http://www.c.com:8002/content/delete/87343&quot;&gt;
</code></pre><p>é¡µé¢ A ä½¿ç”¨äº†ä¸€ä¸ª <code>img</code> æ ‡ç­¾ï¼Œå…¶åœ°å€æŒ‡å‘äº†åˆ é™¤ç”¨æˆ·å¸–å­çš„é“¾æ¥ï¼š</p>
<p><a href="https://user-images.githubusercontent.com/7871813/42734074-38bc206c-8870-11e8-8f93-2aa5c39d245e.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42734074-38bc206c-8870-11e8-8f93-2aa5c39d245e.png" alt="A"></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ç™»å½•ç”¨æˆ·è®¿é—®æ”»å‡»è€…çš„ç½‘ç«™æ—¶ï¼Œä¼šå‘ <code>www.c.com</code> å‘èµ·ä¸€ä¸ªåˆ é™¤ç”¨æˆ·å¸–å­çš„è¯·æ±‚ã€‚æ­¤æ—¶è‹¥ç”¨æˆ·åœ¨åˆ‡æ¢åˆ° <code>www.c.com</code> çš„å¸–å­é¡µé¢åˆ·æ–°ï¼Œä¼šå‘ç°ID ä¸º 87343 çš„å¸–å­å·²ç»è¢«åˆ é™¤ã€‚</p>
<p>ç”±äº Cookie ä¸­åŒ…å«äº†ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼Œå½“ç”¨æˆ·è®¿é—®æ”»å‡»è€…å‡†å¤‡çš„æ”»å‡»ç¯å¢ƒæ—¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥å¯¹æœåŠ¡å™¨å‘èµ· CSRF æ”»å‡»ã€‚åœ¨è¿™ä¸ªæ”»å‡»è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»è€…å€ŸåŠ©å—å®³è€…çš„ Cookie éª—å–æœåŠ¡å™¨çš„ä¿¡ä»»ï¼Œä½†å¹¶ä¸èƒ½æ‹¿åˆ° Cookieï¼Œä¹Ÿçœ‹ä¸åˆ° Cookie çš„å†…å®¹ã€‚è€Œå¯¹äºæœåŠ¡å™¨è¿”å›çš„ç»“æœï¼Œç”±äºæµè§ˆå™¨åŒæºç­–ç•¥çš„é™åˆ¶ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•è¿›è¡Œè§£æã€‚å› æ­¤ï¼Œæ”»å‡»è€…æ— æ³•ä»è¿”å›çš„ç»“æœä¸­å¾—åˆ°ä»»ä½•ä¸œè¥¿ï¼Œä»–æ‰€èƒ½åšçš„å°±æ˜¯ç»™æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»¥æ‰§è¡Œè¯·æ±‚ä¸­æ‰€æè¿°çš„å‘½ä»¤ï¼Œåœ¨æœåŠ¡å™¨ç«¯ç›´æ¥æ”¹å˜æ•°æ®çš„å€¼ï¼Œè€Œéçªƒå–æœåŠ¡å™¨ä¸­çš„æ•°æ®ã€‚</p>
<p>ä½†è‹¥ CSRF æ”»å‡»çš„ç›®æ ‡å¹¶ä¸éœ€è¦ä½¿ç”¨ Cookieï¼Œåˆ™ä¹Ÿä¸å¿…é¡¾è™‘æµè§ˆå™¨çš„ Cookie ç­–ç•¥äº†ã€‚</p>
<h3 id="CSRF-æ”»å‡»çš„é˜²èŒƒ"><a href="#CSRF-æ”»å‡»çš„é˜²èŒƒ" class="headerlink" title="CSRF æ”»å‡»çš„é˜²èŒƒ"></a>CSRF æ”»å‡»çš„é˜²èŒƒ</h3><p>å½“å‰ï¼Œå¯¹ CSRF æ”»å‡»çš„é˜²èŒƒæªæ–½ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ã€‚</p>
<h4 id="éªŒè¯ç "><a href="#éªŒè¯ç " class="headerlink" title="éªŒè¯ç "></a>éªŒè¯ç </h4><p>éªŒè¯ç è¢«è®¤ä¸ºæ˜¯å¯¹æŠ— CSRF æ”»å‡»æœ€ç®€æ´è€Œæœ‰æ•ˆçš„é˜²å¾¡æ–¹æ³•ã€‚</p>
<p>ä»ä¸Šè¿°ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼ŒCSRF æ”»å‡»å¾€å¾€æ˜¯åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ„é€ äº†ç½‘ç»œè¯·æ±‚ã€‚è€ŒéªŒè¯ç ä¼šå¼ºåˆ¶ç”¨æˆ·å¿…é¡»ä¸åº”ç”¨è¿›è¡Œäº¤äº’ï¼Œæ‰èƒ½å®Œæˆæœ€ç»ˆè¯·æ±‚ã€‚å› ä¸ºé€šå¸¸æƒ…å†µä¸‹ï¼ŒéªŒè¯ç èƒ½å¤Ÿå¾ˆå¥½åœ°éåˆ¶ CSRF æ”»å‡»ã€‚</p>
<p>ä½†éªŒè¯ç å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå› ä¸ºå‡ºäºç”¨æˆ·è€ƒè™‘ï¼Œä¸èƒ½ç»™ç½‘ç«™æ‰€æœ‰çš„æ“ä½œéƒ½åŠ ä¸ŠéªŒè¯ç ã€‚å› æ­¤ï¼ŒéªŒè¯ç åªèƒ½ä½œä¸ºé˜²å¾¡ CSRF çš„ä¸€ç§è¾…åŠ©æ‰‹æ®µï¼Œè€Œä¸èƒ½ä½œä¸ºæœ€ä¸»è¦çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h4 id="Referer-Check"><a href="#Referer-Check" class="headerlink" title="Referer Check"></a>Referer Check</h4><p>æ ¹æ® HTTP åè®®ï¼Œåœ¨ HTTP å¤´ä¸­æœ‰ä¸€ä¸ªå­—æ®µå« Refererï¼Œå®ƒè®°å½•äº†è¯¥ HTTP è¯·æ±‚çš„æ¥æºåœ°å€ã€‚é€šè¿‡ Referer Checkï¼Œå¯ä»¥æ£€æŸ¥è¯·æ±‚æ˜¯å¦æ¥è‡ªåˆæ³•çš„â€æºâ€ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¦‚æœç”¨æˆ·è¦åˆ é™¤è‡ªå·±çš„å¸–å­ï¼Œé‚£ä¹ˆå…ˆè¦ç™»å½• <code>www.c.com</code>ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„é¡µé¢ï¼Œå‘èµ·åˆ é™¤å¸–å­çš„è¯·æ±‚ã€‚æ­¤æ—¶ï¼ŒReferer çš„å€¼æ˜¯ <code>http://www.c.com</code>ï¼›å½“è¯·æ±‚æ˜¯ä» <code>www.a.com</code> å‘èµ·æ—¶ï¼ŒReferer çš„å€¼æ˜¯ <code>http://www.a.com</code> äº†ã€‚å› æ­¤ï¼Œè¦é˜²å¾¡ CSRF æ”»å‡»ï¼Œåªéœ€è¦å¯¹äºæ¯ä¸€ä¸ªåˆ å¸–è¯·æ±‚éªŒè¯å…¶ Referer å€¼ï¼Œå¦‚æœæ˜¯ä»¥ <code>www.c.com</code> å¼€å¤´çš„åŸŸåï¼Œåˆ™è¯´æ˜è¯¥è¯·æ±‚æ˜¯æ¥è‡ªç½‘ç«™è‡ªå·±çš„è¯·æ±‚ï¼Œæ˜¯åˆæ³•çš„ã€‚å¦‚æœ Referer æ˜¯å…¶ä»–ç½‘ç«™çš„è¯ï¼Œåˆ™æœ‰å¯èƒ½æ˜¯ CSRF æ”»å‡»ï¼Œå¯ä»¥æ‹’ç»è¯¥è¯·æ±‚ã€‚</p>
<p>é’ˆå¯¹ä¸Šæ–‡çš„ä¾‹å­ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯å¢åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code>if (req.headers.referer!==&apos;http://www.c.com:8002/&apos;) {
    res.write(&apos;csrf æ”»å‡»&apos;);
    return;
}
</code></pre><p><a href="https://user-images.githubusercontent.com/7871813/42734407-0f4c0728-8876-11e8-8565-21f89b01f6f0.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/7871813/42734407-0f4c0728-8876-11e8-8565-21f89b01f6f0.png" alt="referer check"></a></p>
<p>Referer Check ä¸ä»…èƒ½é˜²èŒƒ CSRF æ”»å‡»ï¼Œå¦ä¸€ä¸ªåº”ç”¨åœºæ™¯æ˜¯ â€œé˜²æ­¢å›¾ç‰‡ç›—é“¾â€ã€‚</p>
<h4 id="æ·»åŠ -token-éªŒè¯"><a href="#æ·»åŠ -token-éªŒè¯" class="headerlink" title="æ·»åŠ  token éªŒè¯"></a>æ·»åŠ  token éªŒè¯</h4><p>CSRF æ”»å‡»ä¹‹æ‰€ä»¥èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨ä¼ªé€ ç”¨æˆ·çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¸­æ‰€æœ‰çš„ç”¨æˆ·éªŒè¯ä¿¡æ¯éƒ½æ˜¯å­˜åœ¨äº Cookie ä¸­ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥åœ¨ä¸çŸ¥é“è¿™äº›éªŒè¯ä¿¡æ¯çš„æƒ…å†µä¸‹ç›´æ¥åˆ©ç”¨ç”¨æˆ·è‡ªå·±çš„ Cookie æ¥é€šè¿‡å®‰å…¨éªŒè¯ã€‚è¦æŠµå¾¡ CSRFï¼Œå…³é”®åœ¨äºåœ¨è¯·æ±‚ä¸­æ”¾å…¥æ”»å‡»è€…æ‰€ä¸èƒ½ä¼ªé€ çš„ä¿¡æ¯ï¼Œå¹¶ä¸”è¯¥ä¿¡æ¯ä¸å­˜åœ¨äº Cookie ä¹‹ä¸­ã€‚å¯ä»¥åœ¨ HTTP è¯·æ±‚ä¸­ä»¥å‚æ•°çš„å½¢å¼åŠ å…¥ä¸€ä¸ªéšæœºäº§ç”Ÿçš„ tokenï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯å»ºç«‹ä¸€ä¸ªæ‹¦æˆªå™¨æ¥éªŒè¯è¿™ä¸ª tokenï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ token æˆ–è€… token å†…å®¹ä¸æ­£ç¡®ï¼Œåˆ™è®¤ä¸ºå¯èƒ½æ˜¯ CSRF æ”»å‡»è€Œæ‹’ç»è¯¥è¯·æ±‚ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† XSS å’Œ CSRF çš„æ”»å‡»åŸç†å’Œé˜²å¾¡æªæ–½ã€‚å½“ç„¶ï¼Œåœ¨ Web å®‰å…¨é¢†åŸŸï¼Œé™¤äº†è¿™ä¸¤ç§å¸¸è§çš„æ”»å‡»æ–¹å¼ï¼Œä¹Ÿå­˜åœ¨è¿™ SQL æ³¨å…¥ç­‰å…¶å®ƒæ”»å‡»æ–¹å¼ï¼Œè¿™ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œå¦‚æœä½ å¯¹å…¶æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯»<a href="https://zhuanlan.zhihu.com/p/23569276" target="_blank" rel="noopener">SQLæ³¨å…¥æŠ€æœ¯ä¸“é¢˜</a>çš„ä¸“æ è¯¦ç»†äº†è§£ç›¸å…³ä¿¡æ¯ã€‚æœ€åï¼Œæ€»ç»“ä¸€ä¸‹ XSS æ”»å‡»å’Œ CSRF æ”»å‡»çš„å¸¸è§é˜²å¾¡æªæ–½ï¼š</p>
<ol>
<li>é˜²å¾¡ XSS æ”»å‡»</li>
</ol>
<ul>
<li>HttpOnly é˜²æ­¢åŠ«å– Cookie</li>
<li>ç”¨æˆ·çš„è¾“å…¥æ£€æŸ¥</li>
<li>æœåŠ¡ç«¯çš„è¾“å‡ºæ£€æŸ¥</li>
</ul>
<ol start="2">
<li>é˜²å¾¡ CSRF æ”»å‡»</li>
</ol>
<ul>
<li>éªŒè¯ç </li>
<li>Referer Check</li>
<li>Token éªŒè¯</li>
</ul>
<p>&lt;å®Œ&gt;</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Cross-site_scripting" target="_blank" rel="noopener">Cross-site scripting</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/web/1102_niugang_csrf/index.html" target="_blank" rel="noopener">CSRF æ”»å‡»çš„åº”å¯¹ä¹‹é“</a></li>
<li>ã€Šç™½å¸½å­è®² Web å®‰å…¨ã€‹</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/tx.jpg"
                alt="ææ–Œ" />
            
              <p class="site-author-name" itemprop="name">ææ–Œ</p>
              <p class="site-description motion-element" itemprop="description">æƒ³è¦é£å¾—é«˜ï¼Œé‚£å°±æŠŠåœ°å¹³çº¿å¿˜æ‰</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="3120217729@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ææ–Œ</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

