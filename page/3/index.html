<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="LuckDay">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="LuckDay">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LuckDay">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>LuckDay</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LuckDay</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/29/ä»Vue-jsæºç çœ‹nextTickæœºåˆ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/29/ä»Vue-jsæºç çœ‹nextTickæœºåˆ¶/" itemprop="url">ä»Vue.jsæºç çœ‹nextTickæœºåˆ¶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-07-29T22:30:13+08:00">
                2018-07-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://link.zhihu.com/?target=https%3A//chuckliu.me/%23%21/posts/58bd08a2b5187d2fb51c04f9" target="_blank" rel="noopener">Vueæºç è¯¦è§£ä¹‹nextTickï¼šMutationObserveråªæ˜¯æµ®äº‘ï¼Œmicrotaskæ‰æ˜¯æ ¸å¿ƒï¼</a></p>
<h2 id="å¯èƒ½ä¼šæœ‰ç†è§£å­˜åœ¨åå·®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§ç¥æ–§æ­£ï¼Œå…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚"><a href="#å¯èƒ½ä¼šæœ‰ç†è§£å­˜åœ¨åå·®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§ç¥æ–§æ­£ï¼Œå…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚" class="headerlink" title="å¯èƒ½ä¼šæœ‰ç†è§£å­˜åœ¨åå·®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§ç¥æ–§æ­£ï¼Œå…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚"></a>å¯èƒ½ä¼šæœ‰ç†è§£å­˜åœ¨åå·®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§ç¥æ–§æ­£ï¼Œå…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚</h2><h2 id="æ“ä½œDOM"><a href="#æ“ä½œDOM" class="headerlink" title="æ“ä½œDOM"></a>æ“ä½œDOM</h2><p>åœ¨ä½¿ç”¨vue.jsçš„æ—¶å€™ï¼Œæœ‰æ—¶å€™å› ä¸ºä¸€äº›ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸å¾—ä¸å»æ“ä½œDOMï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p>
<pre><code>&lt;template&gt;
  &lt;div&gt;
    &lt;div ref=&quot;test&quot;&gt;{{test}}&lt;/div&gt;
    &lt;button @click=&quot;handleClick&quot;&gt;tet&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
export default {
    data () {
        return {
            test: &apos;begin&apos;
        };
    },
    methods () {
        handleClick () {
            this.test = &apos;end&apos;;
            console.log(this.$refs.test.innerText);//æ‰“å°â€œbeginâ€
        }
    }
}
</code></pre><p>æ‰“å°çš„ç»“æœæ˜¯beginï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ˜æ˜å·²ç»å°†testè®¾ç½®æˆäº†â€œendâ€ï¼Œè·å–çœŸå®DOMèŠ‚ç‚¹çš„innerTextå´æ²¡æœ‰å¾—åˆ°æˆ‘ä»¬é¢„æœŸä¸­çš„â€œendâ€ï¼Œè€Œæ˜¯å¾—åˆ°ä¹‹å‰çš„å€¼â€œbeginâ€å‘¢ï¼Ÿ</p>
<h2 id="Watcheré˜Ÿåˆ—"><a href="#Watcheré˜Ÿåˆ—" class="headerlink" title="Watcheré˜Ÿåˆ—"></a>Watcheré˜Ÿåˆ—</h2><p>å¸¦ç€ç–‘é—®ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†Vue.jsæºç çš„Watchå®ç°ã€‚å½“æŸä¸ªå“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå®ƒçš„setterå‡½æ•°ä¼šé€šçŸ¥é—­åŒ…ä¸­çš„Depï¼ŒDepåˆ™ä¼šè°ƒç”¨å®ƒç®¡ç†çš„æ‰€æœ‰Watchå¯¹è±¡ã€‚è§¦å‘Watchå¯¹è±¡çš„updateå®ç°ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹updateçš„å®ç°ã€‚</p>
<pre><code>update () {
    /* istanbul ignore else */
    if (this.lazy) {
        this.dirty = true
    } else if (this.sync) {
        /*åŒæ­¥åˆ™æ‰§è¡Œrunç›´æ¥æ¸²æŸ“è§†å›¾*/
        this.run()
    } else {
        /*å¼‚æ­¥æ¨é€åˆ°è§‚å¯Ÿè€…é˜Ÿåˆ—ä¸­ï¼Œä¸‹ä¸€ä¸ªtickæ—¶è°ƒç”¨ã€‚*/
        queueWatcher(this)
    }
}
</code></pre><p>æˆ‘ä»¬å‘ç°Vue.jsé»˜è®¤æ˜¯ä½¿ç”¨<a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fcn.vuejs.org%252Fv2%252Fguide%252Freactivity.html%2523%25E5%25BC%2582%25E6%25AD%25A5%25E6%259B%25B4%25E6%2596%25B0%25E9%2598%259F%25E5%2588%2597" target="_blank" rel="noopener">å¼‚æ­¥æ‰§è¡ŒDOMæ›´æ–°</a>ã€‚<br>å½“å¼‚æ­¥æ‰§è¡Œupdateçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨queueWatcherå‡½æ•°ã€‚</p>
<pre><code>/*å°†ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡pushè¿›è§‚å¯Ÿè€…é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—ä¸­å·²ç»å­˜åœ¨ç›¸åŒçš„idåˆ™è¯¥è§‚å¯Ÿè€…å¯¹è±¡å°†è¢«è·³è¿‡ï¼Œé™¤éå®ƒæ˜¯åœ¨é˜Ÿåˆ—è¢«åˆ·æ–°æ—¶æ¨é€*/
export function queueWatcher (watcher: Watcher) {
  /*è·å–watcherçš„id*/
  const id = watcher.id
  /*æ£€éªŒidæ˜¯å¦å­˜åœ¨ï¼Œå·²ç»å­˜åœ¨åˆ™ç›´æ¥è·³è¿‡ï¼Œä¸å­˜åœ¨åˆ™æ ‡è®°å“ˆå¸Œè¡¨hasï¼Œç”¨äºä¸‹æ¬¡æ£€éªŒ*/
  if (has[id] == null) {
    has[id] = true
    if (!flushing) {
      /*å¦‚æœæ²¡æœ‰flushæ‰ï¼Œç›´æ¥pushåˆ°é˜Ÿåˆ—ä¸­å³å¯*/
      queue.push(watcher)
    } else {
      // if already flushing, splice the watcher based on its id
      // if already past its id, it will be run next immediately.
      let i = queue.length - 1
      while (i &gt;= 0 &amp;&amp; queue[i].id &gt; watcher.id) {
        i--
      }
      queue.splice(Math.max(i, index) + 1, 0, watcher)
    }
    // queue the flush
    if (!waiting) {
      waiting = true
      nextTick(flushSchedulerQueue)
    }
  }
}
</code></pre><p>æŸ¥çœ‹queueWatcherçš„æºç æˆ‘ä»¬å‘ç°ï¼ŒWatchå¯¹è±¡å¹¶ä¸æ˜¯ç«‹å³æ›´æ–°è§†å›¾ï¼Œè€Œæ˜¯è¢«pushè¿›äº†ä¸€ä¸ªé˜Ÿåˆ—queueï¼Œæ­¤æ—¶çŠ¶æ€å¤„äºwaitingçš„çŠ¶æ€ï¼Œè¿™æ—¶å€™ä¼šç»§ç»­ä¼šæœ‰Watchå¯¹è±¡è¢«pushè¿›è¿™ä¸ªé˜Ÿåˆ—queueï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªtickæ—¶ï¼Œè¿™äº›Watchå¯¹è±¡æ‰ä¼šè¢«éå†å–å‡ºï¼Œæ›´æ–°è§†å›¾ã€‚åŒæ—¶ï¼Œidé‡å¤çš„Watcherä¸ä¼šè¢«å¤šæ¬¡åŠ å…¥åˆ°queueä¸­å»ï¼Œå› ä¸ºåœ¨æœ€ç»ˆæ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæ•°æ®çš„æœ€ç»ˆç»“æœã€‚</p>
<p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯ä¸‹ä¸€ä¸ªtickï¼Ÿ</p>
<h2 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h2><p>vue.jsæä¾›äº†ä¸€ä¸ª<a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fcn.vuejs.org%252Fv2%252Fapi%252F%2523Vue-nextTick" target="_blank" rel="noopener">nextTick</a>å‡½æ•°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸Šé¢è°ƒç”¨çš„nextTickã€‚</p>
<p>nextTickçš„å®ç°æ¯”è¾ƒç®€å•ï¼Œæ‰§è¡Œçš„ç›®çš„æ˜¯åœ¨microtaskæˆ–è€…taskä¸­æ¨å…¥ä¸€ä¸ªfuntionï¼Œåœ¨å½“å‰æ ˆæ‰§è¡Œå®Œæ¯•ï¼ˆä¹Ÿè¡Œè¿˜ä¼šæœ‰ä¸€äº›æ’åœ¨å‰é¢çš„éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼‰ä»¥åæ‰§è¡ŒnextTickä¼ å…¥çš„funtionï¼Œçœ‹ä¸€ä¸‹æºç ï¼š</p>
<pre><code>/**
 * Defer a task to execute it asynchronously.
 */
 /*
    å»¶è¿Ÿä¸€ä¸ªä»»åŠ¡ä½¿å…¶å¼‚æ­¥æ‰§è¡Œï¼Œåœ¨ä¸‹ä¸€ä¸ªtickæ—¶æ‰§è¡Œï¼Œä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªfunction
    è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨taskæˆ–è€…microtaskä¸­æ¨å…¥ä¸€ä¸ªtimerFuncï¼Œ
    åœ¨å½“å‰è°ƒç”¨æ ˆæ‰§è¡Œå®Œä»¥åä»¥æ­¤æ‰§è¡Œç›´åˆ°æ‰§è¡Œåˆ°timerFunc
    ç›®çš„æ˜¯å»¶è¿Ÿåˆ°å½“å‰è°ƒç”¨æ ˆæ‰§è¡Œå®Œä»¥åæ‰§è¡Œ
*/
export const nextTick = (function () {
  /*å­˜æ”¾å¼‚æ­¥æ‰§è¡Œçš„å›è°ƒ*/
  const callbacks = []
  /*ä¸€ä¸ªæ ‡è®°ä½ï¼Œå¦‚æœå·²ç»æœ‰timerFuncè¢«æ¨é€åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»åˆ™ä¸éœ€è¦é‡å¤æ¨é€*/
  let pending = false
  /*ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°å°†è¢«æ¨é€åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°ä¸»çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ—¶ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„timerFuncè¢«è°ƒç”¨*/
  let timerFunc

  /*ä¸‹ä¸€ä¸ªtickæ—¶çš„å›è°ƒ*/
  function nextTickHandler () {
    /*ä¸€ä¸ªæ ‡è®°ä½ï¼Œæ ‡è®°ç­‰å¾…çŠ¶æ€ï¼ˆå³å‡½æ•°å·²ç»è¢«æ¨å…¥ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…ä¸»çº¿ç¨‹ï¼Œå·²ç»åœ¨ç­‰å¾…å½“å‰æ ˆæ‰§è¡Œå®Œæ¯•å»æ‰§è¡Œï¼‰ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨pushå¤šä¸ªå›è°ƒåˆ°callbacksæ—¶å°†timerFuncå¤šæ¬¡æ¨å…¥ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…ä¸»çº¿ç¨‹*/
    pending = false
    /*æ‰§è¡Œæ‰€æœ‰callback*/
    const copies = callbacks.slice(0)
    callbacks.length = 0
    for (let i = 0; i &lt; copies.length; i++) {
      copies[i]()
    }
  }

  // the nextTick behavior leverages the microtask queue, which can be accessed
  // via either native Promise.then or MutationObserver.
  // MutationObserver has wider support, however it is seriously bugged in
  // UIWebView in iOS &gt;= 9.3.3 when triggered in touch event handlers. It
  // completely stops working after triggering a few times... so, if native
  // Promise is available, we will use it:
  /* istanbul ignore if */

  /*
    è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸€å…±æœ‰Promiseã€MutationObserverä»¥åŠsetTimeoutä¸‰ç§å°è¯•å¾—åˆ°timerFuncçš„æ–¹æ³•
    ä¼˜å…ˆä½¿ç”¨Promiseï¼Œåœ¨Promiseä¸å­˜åœ¨çš„æƒ…å†µä¸‹ä½¿ç”¨MutationObserverï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåœ¨microtaskä¸­æ‰§è¡Œï¼Œä¼šæ¯”setTimeoutæ›´æ—©æ‰§è¡Œï¼Œæ‰€ä»¥ä¼˜å…ˆä½¿ç”¨ã€‚
    å¦‚æœä¸Šè¿°ä¸¤ç§æ–¹æ³•éƒ½ä¸æ”¯æŒçš„ç¯å¢ƒåˆ™ä¼šä½¿ç”¨setTimeoutï¼Œåœ¨taskå°¾éƒ¨æ¨å…¥è¿™ä¸ªå‡½æ•°ï¼Œç­‰å¾…è°ƒç”¨æ‰§è¡Œã€‚
    å‚è€ƒï¼šhttps://www.zhihu.com/question/55364497
  */
  if (typeof Promise !== &apos;undefined&apos; &amp;&amp; isNative(Promise)) {
    /*ä½¿ç”¨Promise*/
    var p = Promise.resolve()
    var logError = err =&gt; { console.error(err) }
    timerFunc = () =&gt; {
      p.then(nextTickHandler).catch(logError)
      // in problematic UIWebViews, Promise.then doesn&apos;t completely break, but
      // it can get stuck in a weird state where callbacks are pushed into the
      // microtask queue but the queue isn&apos;t being flushed, until the browser
      // needs to do some other work, e.g. handle a timer. Therefore we can
      // &quot;force&quot; the microtask queue to be flushed by adding an empty timer.
      if (isIOS) setTimeout(noop)
    }
  } else if (typeof MutationObserver !== &apos;undefined&apos; &amp;&amp; (
    isNative(MutationObserver) ||
    // PhantomJS and iOS 7.x
    MutationObserver.toString() === &apos;[object MutationObserverConstructor]&apos;
  )) {
    // use MutationObserver where native Promise is not available,
    // e.g. PhantomJS IE11, iOS7, Android 4.4
    /*æ–°å»ºä¸€ä¸ªtextNodeçš„DOMå¯¹è±¡ï¼Œç”¨MutationObserverç»‘å®šè¯¥DOMå¹¶æŒ‡å®šå›è°ƒå‡½æ•°ï¼Œåœ¨DOMå˜åŒ–çš„æ—¶å€™åˆ™ä¼šè§¦å‘å›è°ƒ,è¯¥å›è°ƒä¼šè¿›å…¥ä¸»çº¿ç¨‹ï¼ˆæ¯”ä»»åŠ¡é˜Ÿåˆ—ä¼˜å…ˆæ‰§è¡Œï¼‰ï¼Œå³textNode.data = String(counter)æ—¶ä¾¿ä¼šè§¦å‘å›è°ƒ*/
    var counter = 1
    var observer = new MutationObserver(nextTickHandler)
    var textNode = document.createTextNode(String(counter))
    observer.observe(textNode, {
      characterData: true
    })
    timerFunc = () =&gt; {
      counter = (counter + 1) % 2
      textNode.data = String(counter)
    }
  } else {
    // fallback to setTimeout
    /* istanbul ignore next */
    /*ä½¿ç”¨setTimeoutå°†å›è°ƒæ¨å…¥ä»»åŠ¡é˜Ÿåˆ—å°¾éƒ¨*/
    timerFunc = () =&gt; {
      setTimeout(nextTickHandler, 0)
    }
  }

  /*
    æ¨é€åˆ°é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªtickæ—¶æ‰§è¡Œ
    cb å›è°ƒå‡½æ•°
    ctx ä¸Šä¸‹æ–‡
  */
  return function queueNextTick (cb?: Function, ctx?: Object) {
    let _resolve
    /*cbå­˜åˆ°callbacksä¸­*/
    callbacks.push(() =&gt; {
      if (cb) {
        try {
          cb.call(ctx)
        } catch (e) {
          handleError(e, ctx, &apos;nextTick&apos;)
        }
      } else if (_resolve) {
        _resolve(ctx)
      }
    })
    if (!pending) {
      pending = true
      timerFunc()
    }
    if (!cb &amp;&amp; typeof Promise !== &apos;undefined&apos;) {
      return new Promise((resolve, reject) =&gt; {
        _resolve = resolve
      })
    }
  }
})()
</code></pre><p>å®ƒæ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°,è¿”å›ä¸€ä¸ªqueueNextTickæ¥å£ã€‚</p>
<p>ä¼ å…¥çš„cbä¼šè¢«pushè¿›callbacksä¸­å­˜æ”¾èµ·æ¥ï¼Œç„¶åæ‰§è¡ŒtimerFuncï¼ˆpendingæ˜¯ä¸€ä¸ªçŠ¶æ€æ ‡è®°ï¼Œä¿è¯timerFuncåœ¨ä¸‹ä¸€ä¸ªtickä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚</p>
<p>timerFuncæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>çœ‹äº†æºç å‘ç°timerFuncä¼šæ£€æµ‹å½“å‰ç¯å¢ƒè€Œä¸åŒå®ç°ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§Promiseï¼ŒMutationObserverï¼ŒsetTimeoutä¼˜å…ˆçº§ï¼Œå“ªä¸ªå­˜åœ¨ä½¿ç”¨å“ªä¸ªï¼Œæœ€ä¸æµçš„ç¯å¢ƒä¸‹ä½¿ç”¨setTimeoutã€‚</p>
<p>ä¸¤è€…çš„å…·ä½“å®ç°</p>
<ul>
<li>macrotasks: setTimeout ï¼ŒsetIntervalï¼Œ setImmediateï¼ŒrequestAnimationFrame, I/O ï¼ŒUIæ¸²æŸ“</li>
<li>microtasks: Promiseï¼Œ process.nextTickï¼Œ Object.observeï¼Œ MutationObserver</li>
</ul>
<p>å†ç®€å•ç‚¹å¯ä»¥æ€»ç»“ä¸ºï¼š<br><img src="https://pic1.zhimg.com/v2-e92a4f5f686d115832b63b9b9e3ac2cd_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-e92a4f5f686d115832b63b9b9e3ac2cd_hd.jpg" alt=""></p>
<ol>
<li>åœ¨ macrotask é˜Ÿåˆ—ä¸­æ‰§è¡Œæœ€æ—©çš„é‚£ä¸ª task ï¼Œç„¶åç§»å‡º</li>
<li>å†æ‰§è¡Œ microtask é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨çš„ä»»åŠ¡ï¼Œç„¶åç§»å‡º</li>
<li><p>ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª macrotask ä¸­çš„ä»»åŠ¡ (å†è·³åˆ°ç¬¬2æ­¥)</p>
<p>  è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸€å…±æœ‰Promiseã€MutationObserverä»¥åŠsetTimeoutä¸‰ç§å°è¯•å¾—åˆ°timerFuncçš„æ–¹æ³•ã€‚</p>
<pre><code>ä¼˜å…ˆä½¿ç”¨Promiseï¼Œåœ¨Promiseä¸å­˜åœ¨çš„æƒ…å†µä¸‹ä½¿ç”¨MutationObserverï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„å›è°ƒå‡½æ•°éƒ½ä¼šåœ¨microtaskä¸­æ‰§è¡Œï¼Œå®ƒä»¬ä¼šæ¯”setTimeoutæ›´æ—©æ‰§è¡Œï¼Œæ‰€ä»¥ä¼˜å…ˆä½¿ç”¨ã€‚
å¦‚æœä¸Šè¿°ä¸¤ç§æ–¹æ³•éƒ½ä¸æ”¯æŒçš„ç¯å¢ƒåˆ™ä¼šä½¿ç”¨setTimeoutï¼Œåœ¨taskå°¾éƒ¨æ¨å…¥è¿™ä¸ªå‡½æ•°ï¼Œç­‰å¾…è°ƒç”¨æ‰§è¡Œã€‚
</code></pre></li>
</ol>
<p>ä¸ºä»€ä¹ˆè¦ä¼˜å…ˆä½¿ç”¨microtaskï¼Ÿæˆ‘åœ¨é¡¾è½¶çµåœ¨çŸ¥ä¹çš„å›ç­”ä¸­å­¦ä¹ åˆ°ï¼š</p>
<blockquote>
<p>  JS çš„ event loop æ‰§è¡Œæ—¶ä¼šåŒºåˆ† task å’Œ microtaskï¼Œå¼•æ“åœ¨æ¯ä¸ª task æ‰§è¡Œå®Œæ¯•ï¼Œä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ª task æ¥æ‰§è¡Œä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œå®Œæ‰€æœ‰ microtask é˜Ÿåˆ—ä¸­çš„ microtaskã€‚<br>setTimeout å›è°ƒä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ªæ–°çš„ task ä¸­æ‰§è¡Œï¼Œè€Œ Promise çš„ resolverã€   MutationObserver çš„å›è°ƒéƒ½ä¼šè¢«å®‰æ’åˆ°ä¸€ä¸ªæ–°çš„ microtask ä¸­æ‰§è¡Œï¼Œä¼šæ¯” setTimeout äº§ç”Ÿçš„ task å…ˆæ‰§è¡Œã€‚<br>       è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ microtaskï¼Œä¼˜å…ˆä½¿ç”¨ Promiseï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒï¼Œå†å°è¯• MutationObserverã€‚<br>       å®åœ¨ä¸è¡Œï¼Œåªèƒ½ç”¨ setTimeout åˆ›å»º task äº†ã€‚<br>       ä¸ºå•¥è¦ç”¨ microtaskï¼Ÿ<br>       æ ¹æ® HTML Standardï¼Œåœ¨æ¯ä¸ª task è¿è¡Œå®Œä»¥åï¼ŒUI éƒ½ä¼šé‡æ¸²æŸ“ï¼Œé‚£ä¹ˆåœ¨ microtask ä¸­å°±å®Œæˆæ•°æ®æ›´æ–°ï¼Œå½“å‰ task ç»“æŸå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„ UI äº†ã€‚<br>       åä¹‹å¦‚æœæ–°å»ºä¸€ä¸ª task æ¥åšæ•°æ®æ›´æ–°ï¼Œé‚£ä¹ˆæ¸²æŸ“å°±ä¼šè¿›è¡Œä¸¤æ¬¡ã€‚</p>
</blockquote>
<p>é¦–å…ˆæ˜¯Promiseï¼Œ(Promise.resolve()).then()å¯ä»¥åœ¨microtaskä¸­åŠ å…¥å®ƒçš„å›è°ƒï¼Œ</p>
<p>MutationObserveræ–°å»ºä¸€ä¸ªtextNodeçš„DOMå¯¹è±¡ï¼Œç”¨MutationObserverç»‘å®šè¯¥DOMå¹¶æŒ‡å®šå›è°ƒå‡½æ•°ï¼Œåœ¨DOMå˜åŒ–çš„æ—¶å€™åˆ™ä¼šè§¦å‘å›è°ƒ,è¯¥å›è°ƒä¼šè¿›å…¥microtaskï¼Œå³textNode.data = String(counter)æ—¶ä¾¿ä¼šåŠ å…¥è¯¥å›è°ƒã€‚</p>
<p>è‡³äº MutationObserver å¦‚ä½•æ¨¡æ‹Ÿ nextTick è¿™ç‚¹ï¼Œç›´æ¥çœ‹æºç ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ª TextNode å¹¶ç›‘å¬å†…å®¹å˜åŒ–ï¼Œç„¶åè¦ nextTick çš„æ—¶å€™å»æ”¹ä¸€ä¸‹è¿™ä¸ªèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ï¼š    var counter = 1</p>
<pre><code>var observer = new MutationObserver(nextTickHandler)
    var textNode = document.createTextNode(String(counter))
    observer.observe(textNode, {
      characterData: true
    })
    timerFunc = () =&gt; {
      counter = (counter + 1) % 2
      textNode.data = String(counter)
    }
</code></pre><p>   setTimeoutæ˜¯æœ€åçš„ä¸€ç§å¤‡é€‰æ–¹æ¡ˆï¼Œå¹¶ä¸”é»˜è®¤æœ‰4mså»¶æ—¶ï¼ŒsetTimeoutå»¶æ—¶0ä¸ä¼šè€è€å®å®ç«‹å³æ‰§è¡Œï¼š</p>
<pre><code>setTimeout(function(){
    console.log(&quot;æˆ‘ä¸æ˜¯ç«‹å³æ‰§è¡Œçš„,ä¸€èˆ¬æˆ‘ä¼šå»¶æ—¶4ms,å“ˆå“ˆ&quot;);
},0);
</code></pre><p>å®ƒä¼šå°†å›è°ƒå‡½æ•°åŠ å…¥taskä¸­ï¼Œç­‰åˆ°æ‰§è¡Œã€‚<br><img src="https://pic2.zhimg.com/v2-59cf9f88d7daac690d39edfb9fffc8b8_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-59cf9f88d7daac690d39edfb9fffc8b8_hd.jpg" alt=""></p>
<pre><code>setTimeout(function(){console.log(4)},0);
new Promise(function(resolve){
    console.log(1)
    for( var i=0 ; i&lt;10000 ; i++ ){
        i==9999 &amp;&amp; resolve()
    }
    console.log(2)
}).then(function(){
    console.log(5)
});
console.log(3);
ç»“æœæ˜¯ï¼š
1,2,3,5,4
</code></pre><p>å†çœ‹è¿™ä¸ªï¼Œä¸¤ä¸ªè‡ªæ‰§è¡ŒåŒæ—¶æ‰§è¡Œï¼š</p>
<pre><code>&lt;script&gt;
(function test() {
  setTimeout(function () {
    console.log(4)
  }, 0);
  new Promise(function executor (resolve) {
    console.log(1);
    for(var i = 0; i &lt; 10000; i++) {
      i == 9999 &amp;&amp; resolve();
    }
    console.log(2);
  }).then(function() {
    console.log(5);
  });
  console.log(3);
})()

(function test2() {
  setTimeout(function () {
    console.log(42)
  }, 0);
  new Promise(function executor (resolve) {
    console.log(12);
    for(var i = 0; i &lt; 10000; i++) {
      i == 9999 &amp;&amp; resolve();
    }
    console.log(22);
  }).then(function() {
    console.log(52);
  });
  console.log(32);
})()
&lt;/script&gt;
</code></pre><p><img src="https://pic2.zhimg.com/v2-cd18c572eb05069895ede7e34388bb8d_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-cd18c572eb05069895ede7e34388bb8d_hd.jpg" alt=""><img src="https://pic3.zhimg.com/v2-afcb6fa6fb862818359f757107b769ab_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-afcb6fa6fb862818359f757107b769ab_hd.jpg" alt=""><br>æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€ä¸ª main thread ã€<a href="https://link.zhihu.com/?target=http%3A//www.baidu.com/link%3Furl%3DCV-egCVH8yK1w-ilUqGsztryG8s2mbuhAliIC_L1n_-BSZ_KJ16tAfaNkmbcRtU8" target="_blank" rel="noopener">ä¸»çº¿ç¨‹</a>ã€‘ ï¼Œä½†å¹¶ä¸æ„å‘³ç€å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªè‡ªæ‰§è¡Œåå†æ‰§è¡Œç¬¬äºŒä¸ªï¼Œå› ä¸ºä¸¤ä¸ªè‡ªæ‰§è¡Œä¸­çš„ <code>setTimeout</code> è¿›å…¥çš„æ˜¯åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ç­‰å¾…ï¼Œå› æ­¤ä»–ä¿©åœ¨æœ€ååˆ†åˆ«è¾“å‡ºäº†äº† 4 å’Œ 42ã€‚</p>
<pre><code>å½“ä¸€ä¸ªç¨‹åºæœ‰ï¼šsetTimeoutï¼Œ setInterval ï¼ŒsetImmediateï¼Œ I/Oï¼Œ UIæ¸²æŸ“ï¼ŒPromise ï¼Œprocess.nextTickï¼Œ Object.observeï¼Œ MutationObserverçš„æ—¶å€™ï¼š
</code></pre><p>   1.å…ˆæ‰§è¡Œ macrotasksï¼šI/O -ã€‹ UIæ¸²æŸ“</p>
<p>   2.å†æ‰§è¡Œ microtasks ï¼šprocess.nextTick  -ã€‹ Promise  -ã€‹MutationObserver -&gt;Object.observe</p>
<p>   3.å†æŠŠsetTimeout setInterval setImmediate å¡å…¥ä¸€ä¸ªæ–°çš„macrotasksï¼Œä¾æ¬¡ï¼š</p>
<p>setTimeout ï¼ŒsetInterval â€“ã€‹setImmediate</p>
<pre><code>  ç»¼ä¸Šï¼ŒnextTickçš„ç›®çš„å°±æ˜¯äº§ç”Ÿä¸€ä¸ªå›è°ƒå‡½æ•°åŠ å…¥taskæˆ–è€…microtaskä¸­ï¼Œå½“å‰æ ˆæ‰§è¡Œå®Œä»¥åï¼ˆå¯èƒ½ä¸­é—´è¿˜æœ‰åˆ«çš„æ’åœ¨å‰é¢çš„å‡½æ•°ï¼‰è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œèµ·åˆ°äº†å¼‚æ­¥è§¦å‘ï¼ˆå³ä¸‹ä¸€ä¸ªtickæ—¶è§¦å‘ï¼‰çš„ç›®çš„ã€‚

setImmediate(function(){
    console.log(1);
},0);
setTimeout(function(){
    console.log(2);
},0);
new Promise(function(resolve){
    console.log(3);
    resolve();
    console.log(4);
}).then(function(){
    console.log(5);
});
console.log(6);
process.nextTick(function(){
    console.log(7);
});
console.log(8);
ç»“æœæ˜¯ï¼š3 4 6 8 7 5 2 1
</code></pre><h2 id="flushSchedulerQueue"><a href="#flushSchedulerQueue" class="headerlink" title="flushSchedulerQueue"></a>flushSchedulerQueue</h2><pre><code>/*Github:https://github.com/answershuto*/
/**
 * Flush both queues and run the watchers.
 */
 /*nextTickçš„å›è°ƒå‡½æ•°ï¼Œåœ¨ä¸‹ä¸€ä¸ªtickæ—¶flushæ‰ä¸¤ä¸ªé˜Ÿåˆ—åŒæ—¶è¿è¡Œwatchers*/
function flushSchedulerQueue () {
  flushing = true
  let watcher, id

  // Sort queue before flush.
  // This ensures that:
  // 1. Components are updated from parent to child. (because parent is always
  //    created before the child)
  // 2. A component&apos;s user watchers are run before its render watcher (because
  //    user watchers are created before the render watcher)
  // 3. If a component is destroyed during a parent component&apos;s watcher run,
  //    its watchers can be skipped.
  /*
    ç»™queueæ’åºï¼Œè¿™æ ·åšå¯ä»¥ä¿è¯ï¼š
    1.ç»„ä»¶æ›´æ–°çš„é¡ºåºæ˜¯ä»çˆ¶ç»„ä»¶åˆ°å­ç»„ä»¶çš„é¡ºåºï¼Œå› ä¸ºçˆ¶ç»„ä»¶æ€»æ˜¯æ¯”å­ç»„ä»¶å…ˆåˆ›å»ºã€‚
    2.ä¸€ä¸ªç»„ä»¶çš„user watchersæ¯”render watcherå…ˆè¿è¡Œï¼Œå› ä¸ºuser watcherså¾€å¾€æ¯”render watcheræ›´æ—©åˆ›å»º
    3.å¦‚æœä¸€ä¸ªç»„ä»¶åœ¨çˆ¶ç»„ä»¶watcherè¿è¡ŒæœŸé—´è¢«é”€æ¯ï¼Œå®ƒçš„watcheræ‰§è¡Œå°†è¢«è·³è¿‡ã€‚
  */
  queue.sort((a, b) =&gt; a.id - b.id)

  // do not cache length because more watchers might be pushed
  // as we run existing watchers
  /*è¿™é‡Œä¸ç”¨index = queue.length;index &gt; 0; index--çš„æ–¹å¼å†™æ˜¯å› ä¸ºä¸è¦å°†lengthè¿›è¡Œç¼“å­˜ï¼Œå› ä¸ºåœ¨æ‰§è¡Œå¤„ç†ç°æœ‰watcherå¯¹è±¡æœŸé—´ï¼Œæ›´å¤šçš„watcherå¯¹è±¡å¯èƒ½ä¼šè¢«pushè¿›queue*/
  for (index = 0; index &lt; queue.length; index++) {
    watcher = queue[index]
    id = watcher.id
    /*å°†hasçš„æ ‡è®°åˆ é™¤*/
    has[id] = null
    /*æ‰§è¡Œwatcher*/
    watcher.run()
    // in dev build, check and stop circular updates.
    /*
      åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ£€æµ‹watchæ˜¯å¦åœ¨æ­»å¾ªç¯ä¸­
      æ¯”å¦‚è¿™æ ·ä¸€ç§æƒ…å†µ
      watch: {
        test () {
          this.test++;
        }
      }
      æŒç»­æ‰§è¡Œäº†ä¸€ç™¾æ¬¡watchä»£è¡¨å¯èƒ½å­˜åœ¨æ­»å¾ªç¯
    */
    if (process.env.NODE_ENV !== &apos;production&apos; &amp;&amp; has[id] != null) {
      circular[id] = (circular[id] || 0) + 1
      if (circular[id] &gt; MAX_UPDATE_COUNT) {
        warn(
          &apos;You may have an infinite update loop &apos; + (
            watcher.user
              ? `in watcher with expression &quot;${watcher.expression}&quot;`
              : `in a component render function.`
          ),
          watcher.vm
        )
        break
      }
    }
  }

  // keep copies of post queues before resetting state
  /**/
  /*å¾—åˆ°é˜Ÿåˆ—çš„æ‹·è´*/
  const activatedQueue = activatedChildren.slice()
  const updatedQueue = queue.slice()

  /*é‡ç½®è°ƒåº¦è€…çš„çŠ¶æ€*/
  resetSchedulerState()

  // call component updated and activated hooks
  /*ä½¿å­ç»„ä»¶çŠ¶æ€éƒ½æ”¹ç¼–æˆactiveåŒæ—¶è°ƒç”¨activatedé’©å­*/
  callActivatedHooks(activatedQueue)
  /*è°ƒç”¨updatedé’©å­*/
  callUpdateHooks(updatedQueue)

  // devtool hook
  /* istanbul ignore if */
  if (devtools &amp;&amp; config.devtools) {
    devtools.emit(&apos;flush&apos;)
  }
}
</code></pre><p>flushSchedulerQueueæ˜¯ä¸‹ä¸€ä¸ªtickæ—¶çš„å›è°ƒå‡½æ•°ï¼Œä¸»è¦ç›®çš„æ˜¯æ‰§è¡ŒWatcherçš„runå‡½æ•°ï¼Œç”¨æ¥æ›´æ–°è§†å›¾</p>
<h2 id="ä¸ºä»€ä¹ˆè¦å¼‚æ­¥æ›´æ–°è§†å›¾"><a href="#ä¸ºä»€ä¹ˆè¦å¼‚æ­¥æ›´æ–°è§†å›¾" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å¼‚æ­¥æ›´æ–°è§†å›¾"></a>ä¸ºä»€ä¹ˆè¦å¼‚æ­¥æ›´æ–°è§†å›¾</h2><p>æ¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸€æ®µä»£ç </p>
<pre><code>&lt;template&gt;
  &lt;div&gt;
    &lt;div&gt;{{test}}&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
export default {
    data () {
        return {
            test: 0
        };
    },
    created () {
      for(let i = 0; i &lt; 1000; i++) {
        this.test++;
      }
    }
}
</code></pre><p>ç°åœ¨æœ‰è¿™æ ·çš„ä¸€ç§æƒ…å†µï¼Œcreatedçš„æ—¶å€™testçš„å€¼ä¼šè¢«++å¾ªç¯æ‰§è¡Œ1000æ¬¡ã€‚<br>æ¯æ¬¡++æ—¶ï¼Œéƒ½ä¼šæ ¹æ®å“åº”å¼è§¦å‘setter-&gt;Dep-&gt;Watcher-&gt;update-&gt;patchã€‚<br>å¦‚æœè¿™æ—¶å€™æ²¡æœ‰å¼‚æ­¥æ›´æ–°è§†å›¾ï¼Œé‚£ä¹ˆæ¯æ¬¡++éƒ½ä¼šç›´æ¥æ“ä½œDOMæ›´æ–°è§†å›¾ï¼Œè¿™æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½çš„ã€‚<br>æ‰€ä»¥Vue.jså®ç°äº†ä¸€ä¸ªqueueé˜Ÿåˆ—ï¼Œåœ¨ä¸‹ä¸€ä¸ªtickçš„æ—¶å€™ä¼šç»Ÿä¸€æ‰§è¡Œqueueä¸­Watcherçš„runã€‚åŒæ—¶ï¼Œæ‹¥æœ‰ç›¸åŒidçš„Watcherä¸ä¼šè¢«é‡å¤åŠ å…¥åˆ°è¯¥queueä¸­å»ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ1000æ¬¡Watcherçš„runã€‚æœ€ç»ˆæ›´æ–°è§†å›¾åªä¼šç›´æ¥å°†testå¯¹åº”çš„DOMçš„0å˜æˆ1000ã€‚<br>ä¿è¯æ›´æ–°è§†å›¾æ“ä½œDOMçš„åŠ¨ä½œæ˜¯åœ¨å½“å‰æ ˆæ‰§è¡Œå®Œä»¥åä¸‹ä¸€ä¸ªtickçš„æ—¶å€™è°ƒç”¨ï¼Œå¤§å¤§ä¼˜åŒ–äº†æ€§èƒ½ã€‚</p>
<h2 id="è®¿é—®çœŸå®DOMèŠ‚ç‚¹æ›´æ–°åçš„æ•°æ®"><a href="#è®¿é—®çœŸå®DOMèŠ‚ç‚¹æ›´æ–°åçš„æ•°æ®" class="headerlink" title="è®¿é—®çœŸå®DOMèŠ‚ç‚¹æ›´æ–°åçš„æ•°æ®"></a>è®¿é—®çœŸå®DOMèŠ‚ç‚¹æ›´æ–°åçš„æ•°æ®</h2><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¿®æ”¹dataä¸­çš„æ•°æ®åè®¿é—®çœŸå®çš„DOMèŠ‚ç‚¹æ›´æ–°åçš„æ•°æ®ï¼Œåªéœ€è¦è¿™æ ·ï¼Œæˆ‘ä»¬æŠŠæ–‡ç« ç¬¬ä¸€ä¸ªä¾‹å­è¿›è¡Œä¿®æ”¹ã€‚</p>
<pre><code>&lt;template&gt;
  &lt;div&gt;
    &lt;div ref=&quot;test&quot;&gt;{{test}}&lt;/div&gt;
    &lt;button @click=&quot;handleClick&quot;&gt;tet&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
export default {
    data () {
        return {
            test: &apos;begin&apos;
        };
    },
    methods () {
        handleClick () {
            this.test = &apos;end&apos;;
            this.$nextTick(() =&gt; {
                console.log(this.$refs.test.innerText);//æ‰“å°&quot;end&quot;
            });
            console.log(this.$refs.test.innerText);//æ‰“å°â€œbeginâ€
        }
    }
}
</code></pre><p>ä½¿ç”¨Vue.jsçš„global APIçš„$nextTickæ–¹æ³•ï¼Œå³å¯åœ¨å›è°ƒä¸­è·å–å·²ç»æ›´æ–°å¥½çš„DOMå®ä¾‹äº†ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/CSS-deferå’Œasyncçš„åŒºåˆ«/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/26/CSS-deferå’Œasyncçš„åŒºåˆ«/" itemprop="url">CSS deferå’Œasyncçš„åŒºåˆ«</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-07-26T22:46:19+08:00">
                2018-07-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>å…ˆæ¥è¯•ä¸ªä¸€å¥è¯è§£é‡Šä»¨ï¼Œå½“æµè§ˆå™¨ç¢°åˆ° script è„šæœ¬çš„æ—¶å€™ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>æ²¡æœ‰ defer æˆ– asyncï¼Œæµè§ˆå™¨ä¼šç«‹å³åŠ è½½å¹¶æ‰§è¡ŒæŒ‡å®šçš„è„šæœ¬ï¼Œâ€œç«‹å³â€æŒ‡çš„æ˜¯åœ¨æ¸²æŸ“è¯¥ script æ ‡ç­¾ä¹‹ä¸‹çš„æ–‡æ¡£å…ƒç´ ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç­‰å¾…åç»­è½½å…¥çš„æ–‡æ¡£å…ƒç´ ï¼Œè¯»åˆ°å°±åŠ è½½å¹¶æ‰§è¡Œã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script async src=&quot;&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>æœ‰ asyncï¼ŒåŠ è½½å’Œæ¸²æŸ“åç»­æ–‡æ¡£å…ƒç´ çš„è¿‡ç¨‹å°†å’Œ script.js çš„åŠ è½½ä¸æ‰§è¡Œå¹¶è¡Œè¿›è¡Œï¼ˆå¼‚æ­¥ï¼‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script defer src=&quot;&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>æœ‰ deferï¼ŒåŠ è½½åç»­æ–‡æ¡£å…ƒç´ çš„è¿‡ç¨‹å°†å’Œ script.js çš„åŠ è½½å¹¶è¡Œè¿›è¡Œï¼ˆå¼‚æ­¥ï¼‰ï¼Œä½†æ˜¯ script.js çš„æ‰§è¡Œè¦åœ¨æ‰€æœ‰å…ƒç´ è§£æå®Œæˆä¹‹åï¼ŒDOMContentLoaded äº‹ä»¶è§¦å‘ä¹‹å‰å®Œæˆã€‚</p>
<p>ç„¶åä»å®ç”¨è§’åº¦æ¥è¯´å‘¢ï¼Œé¦–å…ˆæŠŠæ‰€æœ‰è„šæœ¬éƒ½ä¸¢åˆ°  ä¹‹å‰æ˜¯æœ€ä½³å®è·µï¼Œå› ä¸ºå¯¹äºæ—§æµè§ˆå™¨æ¥è¯´è¿™æ˜¯å”¯ä¸€çš„ä¼˜åŒ–é€‰æ‹©ï¼Œæ­¤æ³•å¯ä¿è¯éè„šæœ¬çš„å…¶ä»–ä¸€åˆ‡å…ƒç´ èƒ½å¤Ÿä»¥æœ€å¿«çš„é€Ÿåº¦å¾—åˆ°åŠ è½½å’Œè§£æã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€å¼ å›¾å’¯ï¼š</p>
<p><img src="https://pic3.zhimg.com/v2-256ddc294b88b9a082b3b2aafe193728_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-256ddc294b88b9a082b3b2aafe193728_hd.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/v2-244a0c3246f534e96ce88124e3978261_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-244a0c3246f534e96ce88124e3978261_hd.jpg" alt=""></p>
<h2 id="è“è‰²çº¿ä»£è¡¨ç½‘ç»œè¯»å–ï¼Œçº¢è‰²çº¿ä»£è¡¨æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¿©éƒ½æ˜¯é’ˆå¯¹è„šæœ¬çš„ï¼›ç»¿è‰²çº¿ä»£è¡¨-HTML-è§£æã€‚ã€JS-è§£æä¼šé˜»å¡HTMLè§£æã€‘"><a href="#è“è‰²çº¿ä»£è¡¨ç½‘ç»œè¯»å–ï¼Œçº¢è‰²çº¿ä»£è¡¨æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¿©éƒ½æ˜¯é’ˆå¯¹è„šæœ¬çš„ï¼›ç»¿è‰²çº¿ä»£è¡¨-HTML-è§£æã€‚ã€JS-è§£æä¼šé˜»å¡HTMLè§£æã€‘" class="headerlink" title="è“è‰²çº¿ä»£è¡¨ç½‘ç»œè¯»å–ï¼Œçº¢è‰²çº¿ä»£è¡¨æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¿©éƒ½æ˜¯é’ˆå¯¹è„šæœ¬çš„ï¼›ç»¿è‰²çº¿ä»£è¡¨ HTML è§£æã€‚ã€JS è§£æä¼šé˜»å¡HTMLè§£æã€‘"></a>è“è‰²çº¿ä»£è¡¨ç½‘ç»œè¯»å–ï¼Œçº¢è‰²çº¿ä»£è¡¨æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¿©éƒ½æ˜¯é’ˆå¯¹è„šæœ¬çš„ï¼›ç»¿è‰²çº¿ä»£è¡¨ HTML è§£æã€‚ã€JS è§£æä¼šé˜»å¡HTMLè§£æã€‘</h2><p>æ­¤å›¾å‘Šè¯‰æˆ‘ä»¬ä»¥ä¸‹å‡ ä¸ªè¦ç‚¹ï¼š</p>
<ol>
<li>defer å’Œ async åœ¨ç½‘ç»œè¯»å–ï¼ˆä¸‹è½½ï¼‰è¿™å—å„¿æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆç›¸è¾ƒäº HTML è§£æï¼‰</li>
<li>å®ƒä¿©çš„å·®åˆ«åœ¨äºè„šæœ¬ä¸‹è½½å®Œä¹‹åä½•æ—¶æ‰§è¡Œï¼Œæ˜¾ç„¶ defer æ˜¯æœ€æ¥è¿‘æˆ‘ä»¬å¯¹äºåº”ç”¨è„šæœ¬åŠ è½½å’Œæ‰§è¡Œçš„è¦æ±‚çš„</li>
<li>å…³äº deferï¼Œæ­¤å›¾æœªå°½ä¹‹å¤„åœ¨äºå®ƒæ˜¯æŒ‰ç…§åŠ è½½é¡ºåºæ‰§è¡Œè„šæœ¬çš„ï¼Œè¿™ä¸€ç‚¹è¦å–„åŠ åˆ©ç”¨</li>
<li>async åˆ™æ˜¯ä¸€ä¸ªä¹±åºæ‰§è¡Œçš„ä¸»ï¼Œåæ­£å¯¹å®ƒæ¥è¯´è„šæœ¬çš„åŠ è½½å’Œæ‰§è¡Œæ˜¯ç´§ç´§æŒ¨ç€çš„ï¼Œæ‰€ä»¥ä¸ç®¡ä½ å£°æ˜çš„é¡ºåºå¦‚ä½•ï¼Œåªè¦å®ƒåŠ è½½å®Œäº†å°±ä¼šç«‹åˆ»æ‰§è¡Œ</li>
<li>ä»”ç»†æƒ³æƒ³ï¼Œasync å¯¹äºåº”ç”¨è„šæœ¬çš„ç”¨å¤„ä¸å¤§ï¼Œå› ä¸ºå®ƒå®Œå…¨ä¸è€ƒè™‘ä¾èµ–ï¼ˆå“ªæ€•æ˜¯æœ€ä½çº§çš„é¡ºåºæ‰§è¡Œï¼‰ï¼Œä¸è¿‡å®ƒå¯¹äºé‚£äº›å¯ä»¥ä¸ä¾èµ–ä»»ä½•è„šæœ¬æˆ–ä¸è¢«ä»»ä½•è„šæœ¬ä¾èµ–çš„è„šæœ¬æ¥è¯´å´æ˜¯éå¸¸åˆé€‚çš„ï¼Œæœ€å…¸å‹çš„ä¾‹å­ï¼šGoogle Analytics</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/15/nodejså‡ ç§æ–‡ä»¶è·¯å¾„åŠpathæ¨¡å—/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/15/nodejså‡ ç§æ–‡ä»¶è·¯å¾„åŠpathæ¨¡å—/" itemprop="url">Node.jså‡ ç§æ–‡ä»¶è·¯å¾„åŠpathæ¨¡å—</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-07-15T22:24:49+08:00">
                2018-07-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘åœ¨å†™ä¸€ç¯‡weexçš„webpacké…ç½®ï¼Œåˆšåˆšè¸©å‘äº†ï¼Œweekpackä¸­ä¼šç”¨åˆ°pathæ¨¡å—ï¼Œè€Œå¯¹äºè¿™ä¸ªæ¨¡å—ï¼Œæˆ‘æƒ³æŠ½ç¦»å‡ºæ¥çœ‹ä¸€ä¸‹ï¼Œå› ä¸ºè¿™ä¸ªç”¨åˆ°çš„è¿˜æ˜¯æ¯”è¾ƒå¤šçš„,å–œæ¬¢çš„æœ‹å‹å¯ä»¥ç‚¹ä¸ªå–œæ¬¢ï¼Œæˆ–è€…å»æˆ‘çš„<a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fgithub.com%252Flaihuamin%252FJS-total" target="_blank" rel="noopener">github</a>ç‚¹ä¸ªstarä¹Ÿè¡Œï¼Œè°¢è°¢æ”¯æŒï¼Œä¸¾èµ·å°æ‰‹æŒ‡ç‚¹ä¸€ç‚¹å“¦ğŸ˜¯ï¼Œå†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œè¯„è®ºæ‹ç –ï¼Œè°¢è°¢ã€‚</p>
<h2 id="nodeä¸­çš„è·¯å¾„åˆ†ç±»"><a href="#nodeä¸­çš„è·¯å¾„åˆ†ç±»" class="headerlink" title="nodeä¸­çš„è·¯å¾„åˆ†ç±»"></a>nodeä¸­çš„è·¯å¾„åˆ†ç±»</h2><p>nodeä¸­çš„è·¯å¾„å¤§è‡´åˆ†5ç±»ï¼Œdirname,filename,process.cwd(),./,../,å…¶ä¸­å‰ä¸‰ä¸ªéƒ½æ˜¯ç»å¯¹è·¯å¾„</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•ç‚¹çš„ä¾‹å­</p>
<p>å‡å¦‚ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ–‡ä»¶çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code>editor/
  - dist/
  - src/
      - task.js
</code></pre><p>ç„¶åæˆ‘ä»¬åœ¨task.jsæ–‡ä»¶ä¸­å†™å…¥ä¸€ä¸‹ä»£ç </p>
<pre><code>const path = require(&apos;path&apos;);
console.log(__dirname);
console.log(__filename);
console.log(process.cwd());
console.log(path.resolve(&apos;./&apos;));
</code></pre><p>åœ¨editorç›®å½•ä¸‹è¿è¡Œnode src/task.jsï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>/Users/laihuamin/Documents/richEditor/editor/src
/Users/laihuamin/Documents/richEditor/editor/src/task.js
/Users/laihuamin/Documents/richEditor/editor
/Users/laihuamin/Documents/richEditor/editor
</code></pre><p>ç„¶åæˆ‘ä»¬æœ‰å¯ä»¥åœ¨srcç›®å½•ä¸‹è¿è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œnode task.js,è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>/Users/laihuamin/Documents/richEditor/editor/src
/Users/laihuamin/Documents/richEditor/editor/src/task.js
/Users/laihuamin/Documents/richEditor/editor/src
/Users/laihuamin/Documents/richEditor/editor/src
</code></pre><p>å¯¹æ¯”ä¸¤ä¸ªè¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å½’çº³ä¸€ä¸‹å‡ ç‚¹ï¼š</p>
<p>1.<strong>dirname:è¿”å›çš„æ˜¯è¿™ä¸ªæ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹çš„ä½ç½®<br>2.</strong>filename:ä½ è¿è¡Œå‘½ä»¤ä»£è¡¨çš„æ˜¯æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼Œä¸ç®¡ä½ è¿è¡Œä»€ä¹ˆå‘½ä»¤ï¼Œéƒ½æ˜¯æŒ‡å‘æ–‡ä»¶<br>3.process.cwd():ä½ è¿è¡Œnodeå‘½ä»¤æ‰€åœ¨æ–‡ä»¶å¤¹çš„ä½ç½®ï¼Œæ¯”å¦‚ä½ åœ¨srcç›®å½•ä¸‹è¿è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯è¾“å‡ºåˆ°srcä¸ºæ­¢ï¼Œä¸‹é¢çš„åŒç†ã€‚</p>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><p>è®²å®Œå‰é¢ä¸‰ä¸ªç»å¯¹è·¯å¾„ï¼Œæˆ‘å€’æ˜¯æŒºæƒ³æ¥èŠèŠpathè¿™ä¸ªæ¨¡å—çš„ï¼Œè¿™ä¸ªnodeæ¨¡å—åœ¨å¾ˆå¤šåœ°æ–¹éƒ½æœ‰åº”ç”¨ï¼Œæ‰€ä»¥ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼ŒæŒæ¡ä»–ï¼Œå¯¹æˆ‘ä»¬ä»¥åçš„å‘å±•æ›´æœ‰åˆ©ï¼Œä¸ç”¨æ¯æ¬¡çœ‹webpackçš„é…ç½®æ–‡ä»¶è¿˜è¦å»æŸ¥è¯¢ä¸€ä¸‹è¿™ä¸ªapiæ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Œå¾ˆå½±å“æˆ‘ä»¬çš„æ•ˆç‡</p>
<p><a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fnodejs.org%252Fapi%252Fpath.html" target="_blank" rel="noopener">nodeJS/path</a></p>
<p>ä¸Šé¢é‚£ä¸ªç½‘ç«™æœ‰è¯¦ç»†çš„apiï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¸ç”¨éƒ½æŒæ¡å§ï¼Œæˆ‘å°±è®²å‡ ä¸ªæˆ‘é‡åˆ°è¿‡çš„ï¼Œæˆ‘è§‰å¾—webpackç­‰å·¥ç¨‹é…ç½®ä¸­ä¼šç”¨åˆ°çš„</p>
<h2 id="path-normalize"><a href="#path-normalize" class="headerlink" title="path.normalize"></a>path.normalize</h2><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯æŠŠä¸è§„èŒƒçš„è·¯å¾„è§„èŒƒåŒ–ï¼Œæ¯”å¦‚çœ‹ä¸‹é¢çš„ä¾‹å­</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.normalize(&apos;/foo/bar//baz/asdf/quux/..&apos;));
</code></pre><p>è¾“å‡ºç»“æœï¼š</p>
<pre><code>/foo/bar/baz/asdf
</code></pre><h2 id="path-join"><a href="#path-join" class="headerlink" title="path.join"></a>path.join</h2><pre><code>const path = require(&apos;path&apos;);
console.log(path.join(&apos;src&apos;, &apos;task.js&apos;));

const path = require(&apos;path&apos;);
console.log(path.join(&apos;dist&apos;, &apos;task.js&apos;));

const path = require(&apos;path&apos;);
console.log(path.join(&apos;&apos;));
</code></pre><p>è¿™ä¹ˆä¸¤ä¸ªçš„è¾“å‡ºç»“æœæ˜¯ï¼š</p>
<pre><code>src/task.js
dist/task.js
.
</code></pre><p>ä»–çš„ä½œç”¨ä¹Ÿå°±æ˜¾è€Œæ˜“è§ï¼Œä»–æœ‰ä¸€ä¸‹å‡ æ¡è§„åˆ™ï¼š<br>1.ä¼ å…¥çš„å‚æ•°æ˜¯å­—ç¬¦ä¸²çš„è·¯å¾„ç‰‡æ®µï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ª</p>
<p>2.è¿”å›çš„æ˜¯ä¸€ä¸ªæ‹¼æ¥å¥½çš„è·¯å¾„ï¼Œä½†æ˜¯æ ¹æ®å¹³å°çš„ä¸åŒï¼Œä»–ä¼šå¯¹è·¯å¾„è¿›è¡Œä¸åŒçš„è§„èŒƒåŒ–ï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒUnixç³»ç»Ÿæ˜¯â€/â€œï¼ŒWindowsç³»ç»Ÿæ˜¯â€\â€œï¼Œé‚£ä¹ˆä½ åœ¨ä¸¤ä¸ªç³»ç»Ÿä¸‹çœ‹åˆ°çš„è¿”å›ç»“æœå°±ä¸ä¸€æ ·ã€‚</p>
<p>3.å¦‚æœè¿”å›çš„è·¯å¾„å­—ç¬¦ä¸²é•¿åº¦ä¸ºé›¶ï¼Œé‚£ä¹ˆä»–ä¼šè¿”å›ä¸€ä¸ªâ€™.â€™ï¼Œä»£è¡¨å½“å‰çš„æ–‡ä»¶å¤¹ã€‚</p>
<p>4.å¦‚æœä¼ å…¥çš„å‚æ•°ä¸­æœ‰ä¸æ˜¯å­—ç¬¦ä¸²çš„ï¼Œé‚£å°±ç›´æ¥ä¼šæŠ¥é”™</p>
<h2 id="path-parse"><a href="#path-parse" class="headerlink" title="path.parse"></a>path.parse</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼Œåœ¨srcç›®å½•ä¸‹çš„task.jså†™å…¥</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.parse(&apos;/Users/laihuamin/Documents/richEditor/editor&apos;));
</code></pre><p>ç„¶åè¿è¡Œnode src/task.jsä¹‹å,è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>{ 
  root: &apos;/&apos;,
  dir: &apos;/Users/laihuamin/Documents/richEditor&apos;,
  base: &apos;editor&apos;,
  ext: &apos;&apos;,
  name: &apos;editor&apos; 
}
</code></pre><p>ä»–è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥æŠŠè¿™ä¹ˆå‡ ä¸ªåè¯ç†Ÿæ‚‰ä¸€ä¸‹ï¼š</p>
<p><img src="https://pic3.zhimg.com/v2-b7c5d496b89fde98f097a4a6e2ba7d03_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-b7c5d496b89fde98f097a4a6e2ba7d03_hd.jpg" alt=""></p>
<p>è¿™ä¸ªè¡¨æ ¼åº”è¯¥å±•ç¤ºçš„å¾ˆå½¢è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æ¥è§£é‡Šä¸€ä¸‹è¿™äº›åè¯ï¼š<br>1.rootï¼šä»£è¡¨æ ¹ç›®å½•<br>2.dirï¼šä»£è¡¨æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹<br>3.baseï¼šä»£è¡¨æ•´ä¸€ä¸ªæ–‡ä»¶<br>4.nameï¼šä»£è¡¨æ–‡ä»¶å<br>5.ext: ä»£è¡¨æ–‡ä»¶çš„åç¼€å</p>
<p>é‚£æˆ‘ä»¬æ ¹æ®ä¸‹é¢çš„è§„åˆ™ï¼Œæ¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæœ€å¥½è‡ªå·±è„‘å­åšä¸€é</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.parse(&apos;/Users/laihuamin/Documents/richEditor/editor/src/task.js&apos;));
</code></pre><p>è¾“å‡ºçš„ç»“æœï¼š</p>
<pre><code>{ 
  root: &apos;/&apos;,
  dir: &apos;/Users/laihuamin/Documents/richEditor/editor/src&apos;,
  base: &apos;task.js&apos;,
  ext: &apos;.js&apos;,
  name: &apos;task&apos; 
}
</code></pre><p>ä½ åšå¯¹äº†ä¹ˆï¼Ÿ0.0</p>
<h2 id="path-basename"><a href="#path-basename" class="headerlink" title="path.basename"></a>path.basename</h2><p>é‚£æœ‰äº†å‰é¢è¿™ä¸ªé“ºå«ï¼Œæƒ³å¿…è¿™ä¸ªæ¥å£çŒœä¹Ÿèƒ½çŒœçš„åˆ°äº†ã€‚ã€‚ã€‚ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.basename(&apos;/Users/laihuamin/Documents/richEditor/editor/src/task.js&apos;));
</code></pre><p>è¾“å‡ºçš„ç»“æœæ˜¯ï¼š</p>
<pre><code>task.js
</code></pre><p>æˆ‘ä»¬è¿˜æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯path,è¿˜æœ‰ä¸€ä¸ªæ˜¯extï¼ˆå¯é€‰å‚æ•°ï¼‰.</p>
<pre><code>const path = require(&apos;path&apos;)
console.log(path.basename(&apos;/Users/laihuamin/Documents/richEditor/editor/src/task.js&apos;, &apos;.js&apos;));
</code></pre><p>è¾“å‡ºç»“æœ:</p>
<pre><code>task
</code></pre><h2 id="path-dirname"><a href="#path-dirname" class="headerlink" title="path.dirname"></a>path.dirname</h2><p>è¿™ä¸ªæ¥å£æ¯”basenameè¿˜è¦ç®€å•ï¼Œæˆ‘å°±ä¸å¤šè¯´äº†ï¼Œçœ‹ä¾‹å­ï¼Œçœ‹ç»“æœ</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.basename(&apos;/Users/laihuamin/Documents/richEditor/editor/src/task.js&apos;));
</code></pre><p>è¾“å‡ºçš„ç»“æœ:</p>
<pre><code>/Users/laihuamin/Documents/richEditor/editor/src
</code></pre><p>æ³¨æ„ä¸€ä¸‹ï¼Œæ¥æ”¶çš„å‚æ•°æ˜¯å­—ç¬¦ä¸²ç±»å‹</p>
<h2 id="path-extname"><a href="#path-extname" class="headerlink" title="path.extname"></a>path.extname</h2><p>è¿™ä¸ªå°±æ˜¯å±•ç¤ºæ–‡ä»¶çš„æ‰©å±•åï¼Œæˆ‘ä»¬å¾—æ³¨æ„å‡ ç§æƒ…å†µ</p>
<pre><code>const path = require(&apos;path&apos;);
path.extname(&apos;index.html&apos;);
path.extname(&apos;index.coffee.md&apos;);
path.extname(&apos;index.&apos;);
path.extname(&apos;index&apos;);
path.extname(&apos;.index&apos;);
</code></pre><p>è¾“å‡ºçš„ç»“æœæ˜¯ï¼š</p>
<pre><code>.html
.md
.
&apos;&apos;
&apos;&apos;
</code></pre><p>è‡ªå·±æ³¨æ„ä¸€ä¸‹è¿™å‡ ä¸ªæƒ…å†µ</p>
<h2 id="path-resolve"><a href="#path-resolve" class="headerlink" title="path.resolve"></a>path.resolve</h2><p>æˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™å‡ ä¸ªä¾‹å­å…ˆæ¥ç†Ÿæ‚‰ä¸€ä¸‹ï¼š</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.resolve(&apos;/foo/bar&apos;, &apos;/bar/faa&apos;, &apos;..&apos;, &apos;a/../c&apos;));
</code></pre><p>è¾“å‡ºçš„ç»“æœæ˜¯</p>
<pre><code>/bar/c
</code></pre><p>ä»–å°±ç›¸å½“äºä¸€å †cdæ“ä½œï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥çœ‹</p>
<pre><code>cd /foo/bar/    //è¿™æ˜¯ç¬¬ä¸€æ­¥, ç°åœ¨çš„ä½ç½®æ˜¯/foo/bar/
cd /bar/faa     //è¿™æ˜¯ç¬¬äºŒæ­¥ï¼Œè¿™é‡Œå’Œç¬¬ä¸€æ­¥æœ‰åŒºåˆ«ï¼Œä»–æ˜¯ä»/è¿›å…¥çš„ï¼Œä¹Ÿå°±æ—¶å€™æ ¹ç›®å½•ï¼Œç°åœ¨çš„ä½ç½®æ˜¯/bar/faa
cd ..       //ç¬¬ä¸‰æ­¥ï¼Œä»faaé€€å‡ºæ¥ï¼Œç°åœ¨çš„ä½ç½®æ˜¯ /bar
cd a/../c   //ç¬¬å››æ­¥ï¼Œè¿›å…¥aï¼Œç„¶ååœ¨æ¨å‡ºï¼Œåœ¨è¿›å…¥cï¼Œæœ€åä½ç½®æ˜¯/bar/c
</code></pre><p>ä½†æ˜¯è¿™ä¸ªæ“ä½œå’Œcdè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œè¿™ä¸ªè·¯å¾„ä¸ä¸€å®šè¦å­˜åœ¨ï¼Œè€Œä¸”æœ€åçš„å¯ä»¥æ˜¯æ–‡ä»¶</p>
<h2 id="path-relative"><a href="#path-relative" class="headerlink" title="path.relative"></a>path.relative</h2><p>è¿™ä¸ªè¿”å›çš„æ˜¯fromåˆ°toçš„ç›¸å¯¹è·¯å¾„ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­å°±çŸ¥é“äº†.</p>
<pre><code>const path = require(&apos;path&apos;);
console.log(path.relative(&apos;src/bar/baz&apos;, &apos;src/aaa/bbb&apos;));
</code></pre><p>è¾“å‡ºçš„ç»“æœæ˜¯ï¼š</p>
<pre><code>../../aaa/bbb
</code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™äº›æ¯”è¾ƒå®ç”¨çš„æ–¹æ³•ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼Œè‡ªå·±è¿˜æ˜¯è€è€å®å®å»çœ‹weektoolçš„webpackçš„é…ç½®æ–‡ä»¶äº†ï¼Œå–œæ¬¢çš„æœ‹å‹å¯ä»¥ç‚¹ä¸ªå–œæ¬¢ï¼Œæˆ–è€…å»æˆ‘çš„<a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fgithub.com%252Flaihuamin%252FJS-total" target="_blank" rel="noopener">github</a>ç‚¹ä¸ªstarä¹Ÿè¡Œï¼Œè°¢è°¢æ”¯æŒï¼Œä¸¾èµ·å°æ‰‹æŒ‡ç‚¹ä¸€ç‚¹å“¦ğŸ˜¯ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/02/Vueå®‰å…¨æƒé™æ§åˆ¶axiosæ‹¦æˆª/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/02/Vueå®‰å…¨æƒé™æ§åˆ¶axiosæ‹¦æˆª/" itemprop="url">Vueå®‰å…¨æƒé™æ§åˆ¶axiosæ‹¦æˆª</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-07-02T22:57:53+08:00">
                2018-07-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ä½•ä¸ºæƒé™æ§åˆ¶</p>
<pre><code>//è¯·æ±‚å¤±è´¥åçš„ç»Ÿä¸€æ‹¦æˆªï¼Œä»¥åŠajaxçš„åŸºæœ¬è®¾ç½®
import axios from &apos;axios&apos;;
import qs from &apos;qs&apos;;

function cleanRequest(req) {
  for (const i in req) {
    /* eslint guard-for-in: 0 */
    if (req[i] !== 0 &amp;&amp; !req[i]) {
      delete req[i];
    }
  }
}

axios.defaults.withCredentials = true;
axios.defaults.xsrfCookieName = null;
axios.defaults.headers.common[&apos;X-Requested-With&apos;] = &apos;XMLHttpRequest&apos;;
axios.defaults.headers.post[&apos;Content-Type&apos;] = &apos;application/x-www-form-urlencoded&apos;;
//ç³»ç»Ÿå¼¹å±‚
import Toast from &apos;mint-ui/lib/toast&apos;;
import &apos;mint-ui/lib/toast/style.css&apos;;

module.exports.install = function (Vue) {
  axios.defaults.baseURL=&quot;/&quot;;
  Vue.prototype.$http = axios;
  Vue.http = axios;

  axios.interceptors.request.use(
    function (request) {
      const params = request.params;
      if (params) {
        cleanRequest(params);
      }
      if (request.data) {
        cleanRequest(request.data);
        request.data=qs.stringify(Object.assign(request.data,Bus.movieConfig))
      }else{
        request.data=qs.stringify(Bus.movieConfig)
      }
      return request;
    },
    function (error) {
      return Promise.reject(error);
    }
  );

  // Add a response interceptor
  axios.interceptors.response.use(
    function (response) {
      return response;
    },
    function (error) {
      Toast(&apos;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•!&apos;);
      // Do something with response error
      return Promise.reject(error);
    }
  );
};
</code></pre><p>æƒé™æ§åˆ¶å¤§è‡´åˆ†ä¸ºä¸¤ä¸ªç»´åº¦:</p>
<ul>
<li>å‚ç›´ç»´åº¦: æ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›urlçš„æƒé™</li>
<li>æ°´å¹³ç»´åº¦: æ§åˆ¶ç”¨æˆ·è®¿é—®ç‰¹å®šurlï¼Œè·å–å“ªäº›æ•°æ®çš„æƒé™ï¼ˆe.g. æ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ã€è¶…çº§ç®¡ç†å‘˜è®¿é—®åŒä¸€urlï¼Œè·å–çš„æ•°æ®æ˜¯ä¸åŒçš„ï¼‰</li>
</ul>
<p>Webæƒé™æ§åˆ¶æ–¹æ¡ˆList</p>
<ul>
<li>å‰åç«¯ä¸åˆ†ç¦»ï¼šä»¥Javaä¸ºä¾‹ï¼Œåç«¯é€šè¿‡jspã€freemarkã€thmeleafç­‰æ¨¡æ¿æ¥æ¸²æŸ“ç›¸åº”æƒé™çš„æ•°æ®ï¼Œæ¸²æŸ“å®Œå‘ˆç°åœ¨æµè§ˆå™¨ç«¯</li>
<li>å‰åç«¯åˆ†ç¦»ï¼š<br>â–«SPAå•é¡µé¢åº”ç”¨ï¼Œè·¯ç”±ç”±å‰ç«¯æ§åˆ¶ï¼Œå‰ç«¯é€šè¿‡jsæ§åˆ¶hashè·¯ç”±çš„æƒé™<br>â–«SSRæœåŠ¡ç«¯æ¸²æŸ“ï¼ŒNodeä¸­é—´å±‚åšä»£ç†è·¯ç”±ï¼Œåˆ¤æ–­æƒé™æ¸²æŸ“ç‰¹å®šçš„è·¯ç”±è‡³æµè§ˆå™¨ç«¯</li>
</ul>
<p>SPAå‰ç«¯æƒé™æ§åˆ¶æ–¹æ¡ˆ</p>
<p>SPA: å•é¡µWebåº”ç”¨ï¼ˆsingle page web applicationï¼‰å°†æ‰€æœ‰webæ´»åŠ¨å±€é™äºä¸€ä¸ªhtmlé¡µé¢ä¸­ï¼Œåˆ©ç”¨jsé€šè¿‡hashæˆ–è€…æµè§ˆå™¨history apiæ¥å®ç°æ— åˆ·æ–°è·¯ç”±è·³è½¬ï¼Œå‰åç«¯é€šè¿‡ajaxæ•°æ®é€šä¿¡ï¼Œé¿å…äº†æµè§ˆå™¨çš„åˆ·æ–°é‡æ–°åŠ è½½ï¼Œä¸ºç”¨æˆ·æä¾›æµç¨‹çš„æ“ä½œä½“éªŒã€‚è¿™æ„å‘³ç€å‰ç«¯æ¥ç®¡äº†è·¯ç”±å±‚ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨å‰ç«¯è‡ªèº«çš„MVCæ¨¡å—ï¼Œæ¥æ¸²æŸ“ä¸åŒçš„é¡µé¢ã€‚</p>
<blockquote>
<p>Base onï¼š</p>
</blockquote>
<ul>
<li>Vue å‰ç«¯MVVMæ¡†æ¶</li>
<li>Vuex çŠ¶æ€ç®¡ç†æœº</li>
<li>Vue-router è·¯ç”±</li>
<li>Axios HTTPè¯·æ±‚åº“</li>
</ul>
<p>1.ç™»é™†äº‹ä»¶Login</p>
<pre><code>// 1.è§¦å‘ç™»é™†äº‹ä»¶
dispatch(&apos;login&apos;)

// actions
commit(types.LOGIN_SUCCESS, res.data.data)
...
</code></pre><p>2.è·å–Tokenï¼Œç»Base64ç¼–ç åå­˜è‡³sessionStorage</p>
<pre><code>// mutations
const mutations = {
    [types.LOGIN_SUCCESS] (state, data) {
        state.authlock = false
    // 2.ç™»é™†æˆåŠŸå›è°ƒæ‹¿åˆ°token,ç»Base64 ç¼–ç åå­˜å…¥æœ¬åœ°sessionStorage
        let token = Base64.encode(data + &apos;:HIKDATAE&apos;)
        sessionStorage.setItem(&apos;userToken&apos;, token)
    // è·¯ç”±è·³è½¬è‡³ç›®æ ‡é¡µé¢
        router.push({name: &apos;xxx&apos;})
    },
    [types.LOGOUT_SUCCESS] (state) {
        state.authlock = true
    // ç™»å‡ºæˆåŠŸå›è°ƒ,ç§»é™¤æœ¬åœ°token
        sessionStorage.removeItem(&apos;userToken&apos;)
        router.push({name: &apos;Login&apos;})
    }
}
</code></pre><p>3.æ‰€æœ‰HTTP Header Authorization åŠ ä¸Šç¼–ç åçš„token(å‰åç«¯å¯çº¦å®šè§„åˆ™)</p>
<pre><code>// Axios è¯·æ±‚é’©å­ï¼ˆrequestï¼‰
axios.interceptors.request.use(req =&gt; {
    let token = sessionStorage.getItem(&apos;user&apos;)     
    if (token) {         
        // 3.token å­˜åœ¨,åˆ™åœ¨ä¹‹åæ‰€æœ‰è¯·æ±‚çš„httpè¯·æ±‚å¤´ Authorization å¸¦ä¸Šbase64ç¼–ç åçš„token,åå°æ‹¿åˆ°tokenåè¿›è¡ŒéªŒè¯æƒé™         
        req.headers.Authorization = `Basic ${token}`     
    }
    req.data = qs.stringify(req.data)     
    return req 
}, error =&gt; {
    return Promise.reject(error) 
})
</code></pre><p>æµè§ˆå™¨http header<br><img src="https://pic4.zhimg.com/v2-48ee52913451d66397f33a47f6af3374_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-48ee52913451d66397f33a47f6af3374_hd.jpg" alt=""></p>
<p>4.è¯·æ±‚æ‹¦æˆªï¼šåå°æ‹¿åˆ°tokenåå¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œæ ¡éªŒï¼Œè‹¥æ ¡éªŒå¤±è´¥è¿”å›401ï¼Œå‰ç«¯responseé’©å­é‡Œç»Ÿä¸€catch error è·³è½¬è‡³ç™»é™†é¡µé¢ã€‚</p>
<pre><code>// Axios è¯·æ±‚é’©å­ï¼ˆresponseï¼‰
axios.interceptors.response.use(res =&gt; {
    return res
}, error =&gt; {
    if (error.response) {
        switch (error.response.status) {
        // 4.æ‰€æœ‰æ¥å£responseæ ¡éªŒé’©å­,è‹¥tokenæ£€éªŒå¤±è´¥,åå°è¿”å› 401 error code, æ¸…é™¤tokenä¿¡æ¯å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
            case 401:
                store.commit(types.LOGOUT)
                router.replace({
                    path: &apos;/login&apos;
        })
    }
    }
    return Promise.reject(error)
})
</code></pre><p>5.è·¯ç”±è·³è½¬æ‹¦æˆªï¼šä»»æ„è·¯ç”±è·³è½¬æ—¶ï¼Œåœ¨è·¯ç”±beforeEaché’©å­é‡Œæ ¡éªŒæœ¬åœ°æ˜¯å¦å­˜åœ¨tokenï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™è·³è½¬è‡³ç™»é™†é¡µé¢</p>
<pre><code>// è·¯ç”±é’©å­(æ¯ä¸ªè·¯ç”±è·³è½¬å‰è°ƒèµ·beforeEaché’©å­)
router.beforeEach((to, from, next) =&gt; {
  if (to.path === &apos;/login&apos;) {
    sessionStorage.removeItem(&apos;userToken&apos;)
  }
  let user = sessionStorage.getItem(&apos;userToken&apos;)
  if (!user &amp;&amp; to.path !== &apos;/login&apos;) {
    // è‹¥æœ¬åœ°tokenä¸å­˜åœ¨,åˆ™ä»»æ„è·¯ç”±è·³è½¬çš„æ—¶å€™,é‡å®šå‘è‡³login ç™»é™†é¡µé¢
    next({ path: &apos;/login&apos; })
  } else {
    next()
  }
})
</code></pre><p>6.ç™»å‡ºLogoutï¼šæ¸…æ¥šæœ¬åœ°sessionStorageçš„tokenä¿¡æ¯</p>
<pre><code>// mutations
const mutations = {
    ...
    [types.LOGOUT_SUCCESS] (state) {
        state.authlock = true
    // ç™»å‡ºæˆåŠŸå›è°ƒ,ç§»é™¤æœ¬åœ°token
        sessionStorage.removeItem(&apos;userToken&apos;)
    router.push({name: &apos;Login&apos;})
    }
}
</code></pre><p>æµç¨‹ç¤ºæ„å›¾å¦‚ä¸‹:<br><img src="https://pic2.zhimg.com/v2-064f7b05f15399ac9ff6aa03ee1cb710_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-064f7b05f15399ac9ff6aa03ee1cb710_hd.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/02/ES6-å®ç°è‡ªå·±çš„-Promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/02/ES6-å®ç°è‡ªå·±çš„-Promise/" itemprop="url">ES6å®ç°è‡ªå·±çš„ Promise</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-07-02T22:15:53+08:00">
                2018-07-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ä¸€ã€JavaScriptå¼‚æ­¥ç¼–ç¨‹èƒŒæ™¯"><a href="#ä¸€ã€JavaScriptå¼‚æ­¥ç¼–ç¨‹èƒŒæ™¯" class="headerlink" title="ä¸€ã€JavaScriptå¼‚æ­¥ç¼–ç¨‹èƒŒæ™¯"></a>ä¸€ã€JavaScriptå¼‚æ­¥ç¼–ç¨‹èƒŒæ™¯</h2><p>ä»å»å¹´ES2015å‘å¸ƒè‡³ä»Šï¼Œå·²ç»è¿‡å»äº†ä¸€å¹´å¤šï¼ŒES2015å‘å¸ƒçš„æ–°çš„è¯­è¨€ç‰¹æ€§ä¸­æœ€ä¸ºæµè¡Œçš„ä¹Ÿå°±è«è¿‡äºPromiseäº†ï¼ŒPromiseä½¿å¾—å¦‚ä»ŠJavaScriptå¼‚æ­¥ç¼–ç¨‹å¦‚æ­¤è½»æ¾æƒ¬æ„ï¼Œç”šè‡³æ…¢æ…¢é—å¿˜äº†æ›¾ç»é‚£ä¸å ªå›é¦–çš„ç—›æ¥šã€‚å…¶å®ä»JavaScriptè¯ç”Ÿï¼ŒJavaScriptä¸­çš„å¼‚æ­¥ç¼–ç¨‹å°±å·²ç»å‡ºç°ï¼Œä¾‹å¦‚ç‚¹å‡»é¼ æ ‡ã€æ•²å‡»é”®ç›˜è¿™äº›äº‹ä»¶çš„å¤„ç†å‡½æ•°éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ—¶é—´åˆ°äº†2009å¹´ï¼ŒNode.jsæ¨ªç©ºå‡ºä¸–ï¼Œåœ¨æ•´ä¸ªNode.jsçš„å®ç°ä¸­ï¼Œå°†å›è°ƒæ¨¡å¼çš„å¼‚æ­¥ç¼–ç¨‹æœºåˆ¶å‘æŒ¥çš„æ·‹æ¼“å°½è‡´ï¼ŒNodeçš„æµè¡Œä¹Ÿæ˜¯çš„è¶Šæ¥è¶Šå¤šçš„JavaScripterå¼€å§‹äº†å¼‚æ­¥ç¼–ç¨‹ï¼Œä½†æ˜¯å›è°ƒæ¨¡å¼çš„å‰¯ä½œç”¨ä¹Ÿæ…¢æ…¢å±•ç°åœ¨äººä»¬çœ¼å‰ï¼Œé”™è¯¯å¤„ç†ä¸å¤Ÿä¼˜é›…ä»¥åŠåµŒå¥—å›è°ƒå¸¦æ¥çš„â€œå›è°ƒåœ°ç‹±â€ã€‚è¿™äº›å‰¯ä½œç”¨ä½¿å¾—äººä»¬ä»å›è°ƒæ¨¡å¼çš„æ¸©æŸ”ä¹¡ä¸­æ…¢æ…¢æ¸…é†’è¿‡æ¥ï¼Œå¼€å§‹å¯»æ‰¾æ›´ä¸ºä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œè·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ã€å¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚æ—¶é—´åˆ°äº†2015å¹´ï¼ŒPromiseæ‹¯æ•‘é‚£äº›è‹¦è‹¦æ¢ç´¢çš„å…ˆé©±ã€‚è¡Œä½¿å®ƒå†å²ä½¿å‘½çš„æ—¶ä»£ä¼¼ä¹å·²ç»åˆ°æ¥ã€‚</p>
<p>æ¯ä¸ªäº‹ç‰©çš„è¯ç”Ÿæœ‰ä»–çš„å†å²ä½¿å‘½ï¼Œæ›´æœ‰å…¶å†å²æˆå› ï¼Œä¿ƒè¿›å…¶è¢«é‚£äº›æ¢ç´¢çš„å…ˆé©±ä»¬æ‰€å‘ç°ã€‚äº†è§£nodejsæˆ–è€…ç†Ÿæ‚‰æµè§ˆå™¨çš„äººéƒ½çŸ¥é“ï¼ŒJavaScriptå¼•æ“æ˜¯åŸºäºäº‹ä»¶å¾ªç¯æˆ–å•çº¿ç¨‹è¿™ä¸¤ä¸ªç‰¹æ€§çš„ã€‚æ›´ä¸ºç”šè€…åœ¨æµè§ˆå™¨ä¸­ï¼Œæ›´æ–°UI(ä¹Ÿå°±æ˜¯æµè§ˆå™¨é‡ç»˜ã€é‡æ‹é¡µé¢å¸ƒå±€)å’Œæ‰§è¡ŒJavaScriptä»£ç ä¹Ÿåœ¨ä¸€ä¸ªå•çº¿ç¨‹ä¸­ï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œä¸€ä¸ªçº¿ç¨‹å°±ç›¸å½“äºåªæœ‰ä¸€æ¡é©¬è·¯ï¼Œå¦‚æœä¸€è¾†é©¬è½¦æŠ›é”šåœ¨è·¯ä¸Šäº†é˜»å¡äº†é©¬è·¯ï¼Œé‚£ä¹ˆåˆ«çš„é©¬è½¦ä¹Ÿå°±æ‹¥å µåœ¨äº†é‚£å„¿ï¼Œè¿™ä¸ªå•çº¿ç¨‹å®¹æ˜“è¢«é˜»å¡æ˜¯ä¸€ä¸ªé“ç†ï¼Œå•çº¿ç¨‹ä¹Ÿåªèƒ½å…è®¸æŸä¸€æ—¶é—´ç‚¹åªèƒ½å¤Ÿæ‰§è¡Œä¸€æ®µä»£ç ã€‚åŒæ—¶ï¼ŒJavaScriptæ²¡æœ‰æƒ³å®ƒçš„å“¥å“¥å§å§ä»¬é‚£ä¹ˆè´¢å¤§æ°”ç²—ï¼ŒåƒJavaæˆ–è€…C++ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸å¤Ÿï¼Œé‚£ä¹ˆå†åŠ ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å°±èƒ½å¤ŸåŒæ—¶æ‰§è¡Œå¤šæ®µä»£ç äº†ï¼Œä½†æ˜¯è¿™æ ·å°±ä¼šå¸¦æ¥çš„éšæ‚£å°±æ˜¯çŠ¶æ€ä¸å®¹æ˜“ç»´æŠ¤ï¼ŒJavaScripté€‰æ‹©äº†å•çº¿ç¨‹éé˜»å¡å¼çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æ–¹å¼ï¼Œå°±åƒä¸Šé¢çš„é©¬è½¦æŠ›é”šåœ¨äº†è·¯ä¸Šï¼Œé‚£ä¹ˆæŠŠé©¬è½¦æ¨åˆ°è·¯è¾¹çš„ç»´ä¿®ç«™ï¼Œè®©å…¶ä»–é©¬è½¦å…ˆè¿‡å»ï¼Œç­‰é©¬è½¦ä¿®å¥½äº†å†å›åˆ°é©¬è·¯ä¸Šç»§ç»­è¡Œé©¶ï¼Œè¿™å°±æ˜¯å•çº¿ç¨‹éé˜»å¡æ–¹å¼ã€‚æ­£å¦‚Promiseçš„å·¥ä½œæ–¹å¼ä¸€æ ·ï¼Œé€šè¿‡Promiseå»å‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œæ¯•ç«Ÿè¯·æ±‚æœ‰ç½‘ç»œå¼€é”€ï¼Œä¸å¯èƒ½é©¬ä¸Šå°±è¿”å›è¯·æ±‚ç»“æœçš„ï¼Œè¿™ä¸ªæ—¶å€™Promiseå°±å¤„äºpendingçŠ¶æ€ï¼Œä½†æ˜¯å…¶å¹¶ä¸ä¼šé˜»å¡å…¶ä»–ä»£ç çš„æ‰§è¡Œï¼Œå½“è¯·æ±‚è¿”å›æ—¶ï¼Œä¿®æ”¹PromiseçŠ¶æ€ä¸ºfulfilledæˆ–è€…rejectedï¼ˆå¤±è´¥è¯·æ±‚ï¼‰ã€‚åŒæ—¶æ‰§è¡Œç»‘å®šåˆ°è¿™ä¸¤ä¸ªçŠ¶æ€ä¸Šé¢çš„â€œå¤„ç†å‡½æ•°â€ã€‚è¿™å°±æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯Promiseå…¢å…¢ä¸šä¸šçš„å·¥ä½œæ–¹å¼ï¼Œåœ¨ä¸‹é¢ä¸€ä¸ªéƒ¨åˆ†å°†è¯¦ç»†è®¨è®ºPromiseã€‚</p>
<h2 id="äºŒã€PromiseåŸºç¡€"><a href="#äºŒã€PromiseåŸºç¡€" class="headerlink" title="äºŒã€PromiseåŸºç¡€"></a>äºŒã€PromiseåŸºç¡€</h2><p>æ€ä¹ˆä¸€å¥è¯è§£é‡ŠPromiseå‘¢ï¼ŸPromiseå¯ä»¥ä»£æŒ‡é‚£äº›å°šæœªå®Œæˆçš„ä¸€äº›æ“ä½œï¼Œä½†æ˜¯å…¶åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ä¼šè¿”å›æŸä¸€ç‰¹å®šçš„ç»“æœã€‚</p>
<p>å½“åˆ›å»ºä¸€ä¸ªPromiseå®ä¾‹åï¼Œå…¶ä»£è¡¨ä¸€ä¸ªæœªçŸ¥çš„å€¼ï¼Œåœ¨å°†æ¥çš„æŸä¸ªæ—¶é—´ä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„è¿”å›å€¼ï¼Œæˆ–è€…å¤±è´¥çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¿™äº›è¿”å›å€¼æ·»åŠ å¤„ç†å‡½æ•°ï¼Œå½“å€¼è¿”å›æ—¶ï¼Œå¤„ç†å‡½æ•°è¢«è°ƒç”¨ã€‚Promiseæ€»æ˜¯å¤„äºä¸‹é¢ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>pendingï¼š Promiseçš„åˆå§‹çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æœªè¢«fulfilledæˆ–è€…rejectedçš„çŠ¶æ€ã€‚</li>
<li>fulfilledï¼š æ„å‘³ç€promiseä»£æŒ‡çš„æ“ä½œå·²ç»æˆåŠŸå®Œæˆã€‚</li>
<li>rejectedï¼šæ„å‘³ç€promiseä»£æŒ‡çš„æ“ä½œç”±äºæŸäº›åŸå› å¤±è´¥ã€‚</li>
</ul>
<p>ä¸€ä¸ªå¤„äºpendingçŠ¶æ€çš„promiseå¯èƒ½ç”±äºæŸä¸ªæˆåŠŸè¿”å›å€¼è€Œå‘å±•ä¸ºfulfilledçŠ¶æ€ï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸ºæŸäº›é”™è¯¯è€Œè¿›å…¥rejectedçŠ¶æ€ï¼Œæ— è®ºæ˜¯è¿›å…¥fulfilledçŠ¶æ€æˆ–è€…rejectedçŠ¶æ€ï¼Œç»‘å®šåˆ°è¿™ä¸¤ç§çŠ¶æ€ä¸Šé¢çš„å¤„ç†å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œã€‚å¹¶ä¸”è¿›å…¥fulfilledæˆ–è€…rejectedçŠ¶æ€ä¹Ÿå°±ä¸èƒ½å†è¿”å›pendingçŠ¶æ€äº†ã€‚<br><img src="https://pic4.zhimg.com/v2-cf3e4ae1a35caad7c2d8d7bdd8c763d2_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-cf3e4ae1a35caad7c2d8d7bdd8c763d2_hd.jpg" alt=""></p>
<h2 id="ä¸‰ã€è¾¹å­¦è¾¹å†™"><a href="#ä¸‰ã€è¾¹å­¦è¾¹å†™" class="headerlink" title="ä¸‰ã€è¾¹å­¦è¾¹å†™"></a>ä¸‰ã€è¾¹å­¦è¾¹å†™</h2><p>ä¸Šé¢è¯´äº†é‚£ä¹ˆå¤šï¼Œå…¶å®éƒ½æ˜¯é“ºå«ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹å®ç°è‡ªå·±çš„Promiseå¯¹è±¡ã€‚go go goï¼ï¼ï¼</p>
<h2 id="ç¬¬ä¸€æ­¥ï¼šPromiseæ„é€ å‡½æ•°"><a href="#ç¬¬ä¸€æ­¥ï¼šPromiseæ„é€ å‡½æ•°" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šPromiseæ„é€ å‡½æ•°"></a>ç¬¬ä¸€æ­¥ï¼šPromiseæ„é€ å‡½æ•°</h2><p>Promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼Œpendingã€fulfilledã€rejectedã€‚</p>
<pre><code>const PENDING = &apos;PENDING&apos; // Promise çš„ åˆå§‹çŠ¶æ€
const FULFILLED = &apos;FULFILLED&apos; // Promise æˆåŠŸè¿”å›åçš„çŠ¶æ€
const REJECTED = &apos;REJECTED&apos; // Promise å¤±è´¥åçš„çŠ¶æ€
</code></pre><p>æœ‰äº†ä¸‰ç§çŠ¶æ€åï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåˆ›å»ºä¸€ä¸ªPromiseå®ä¾‹å‘¢ï¼Ÿ</p>
<blockquote>
<p>const promise = new Promise(executor) // åˆ›å»ºPromiseçš„è¯­æ³•</p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢ç”Ÿæˆpromiseè¯­æ³•æˆ‘ä»¬çŸ¥é“ï¼ŒPromiseå®ä¾‹æ˜¯è°ƒç”¨Promiseæ„é€ å‡½æ•°é€šè¿‡newæ“ä½œç¬¦ç”Ÿæˆçš„ã€‚è¿™ä¸ªæ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥å…ˆè¿™æ ·å†™ï¼š</p>
<pre><code>class Promise {
    constructor(executor) {
        this.status = PENDING // åˆ›å»ºä¸€ä¸ªpromiseæ—¶ï¼Œé¦–å…ˆè¿›è¡ŒçŠ¶æ€åˆå§‹åŒ–ã€‚pending
        this.result = undefined // resultå±æ€§ç”¨æ¥ç¼“å­˜promiseçš„è¿”å›ç»“æœï¼Œå¯ä»¥æ˜¯æˆåŠŸçš„è¿”å›ç»“æœï¼Œæˆ–å¤±è´¥çš„è¿”å›ç»“æœ
    }
}
</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢æ„é€ å‡½æ•°æ¥å—çš„å‚æ•°executorã€‚å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”æ¥å—å…¶ä»–ä¸¤ä¸ªå‡½æ•°ï¼ˆresolveå’Œrejectï¼‰ä½œä¸ºå‚æ•°ï¼Œå½“resolveå‡½æ•°è°ƒç”¨åï¼Œpromiseçš„çŠ¶æ€è½¬åŒ–ä¸ºfulfilledï¼Œå¹¶ä¸”æ‰§è¡ŒæˆåŠŸè¿”å›çš„å¤„ç†å‡½æ•°ï¼ˆä¸ç”¨ç€æ€¥åé¢ä¼šè¯´åˆ°æ€ä¹ˆæ·»åŠ å¤„ç†å‡½æ•°ï¼‰ã€‚å½“rejectå‡½æ•°è°ƒç”¨åï¼ŒpromiseçŠ¶æ€è½¬åŒ–ä¸ºrejectedï¼Œå¹¶ä¸”æ‰§è¡Œå¤±è´¥è¿”å›çš„å¤„ç†å‡½æ•°ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çš„ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code>class Promise {
    constructor(executor) {
        this.status = PENDING 
        this.result = undefined
        executor(data =&gt; resolveProvider(this, data), err =&gt; rejectProvider(this, err))
    }
}

function resolveProvider(promise, data) {
    if (promise.status !== PENDING) return false
    promise.status = FULFILLED
}
function rejectProvider(promise, data) {
    if (promise.status !== PENDING) return false
    promise.status = FULFILLED
}
</code></pre><p>Dont Repeat Yourseltï¼ï¼ï¼æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç åé¢ä¸¤ä¸ªå‡½æ•°åŸºæœ¬ç›¸åŒï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ•´åˆæˆä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ç»“åˆé«˜é˜¶å‡½æ•°çš„ä½¿ç”¨ã€‚</p>
<pre><code>const statusProvider = (promise, status) =&gt; data =&gt; {
    if (promise.status !== PENDING) return false
    promise.status = status
    promise.result = data
}
class Promise {
    constructor(executor) {
        this.status = PENDING 
        this.result = undefined
        executor(statusProvider(this, FULFILLED), statusProvider(this, REJECTED))
    }
}
</code></pre><p>ç°åœ¨æˆ‘ä»¬çš„ä»£ç å°±çœ‹ä¸Šå»ç®€æ´å¤šäº†ã€‚</p>
<h2 id="ç¬¬äºŒæ­¥ï¼šä¸ºPromiseæ·»åŠ å¤„ç†å‡½æ•°"><a href="#ç¬¬äºŒæ­¥ï¼šä¸ºPromiseæ·»åŠ å¤„ç†å‡½æ•°" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šä¸ºPromiseæ·»åŠ å¤„ç†å‡½æ•°"></a>ç¬¬äºŒæ­¥ï¼šä¸ºPromiseæ·»åŠ å¤„ç†å‡½æ•°</h2><p>å…¶å®é€šè¿‡ <code>new Promise(executor)</code>å·²ç»å¯ä»¥ç”Ÿæˆä¸€ä¸ªPromiseå®ä¾‹äº†ï¼Œç”šè‡³æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ é€’åˆ°executorä¸­çš„resolveå’Œrejectæ–¹æ³•æ¥æ”¹å˜promiseçŠ¶æ€ï¼Œä½†æ˜¯ï¼ç°åœ¨çš„promiseä¾ç„¶æ²¡å•¥åµç”¨ï¼ï¼ï¼å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ç»™å®ƒæ·»åŠ æˆåŠŸå’Œå¤±è´¥è¿”å›çš„å¤„ç†å‡½æ•°ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç»™æˆ‘ä»¬çš„promiseå¢åŠ ä¸¤ä¸ªå±æ€§ï¼ŒsuccessListenerå’ŒfailureListenerç”¨æ¥åˆ†åˆ«ç¼“å­˜æˆåŠŸå¤„ç†å‡½æ•°å’Œå¤±è´¥å¤„ç†å‡½æ•°ã€‚</p>
<pre><code>class Promise {
    constructor(executor) {
        this.status = PENDING
         this.successListener = []
         this.failureListener = []
        this.result = undefined
        executor(statusProvider(this, FULFILLED), statusProvider(this, REJECTED))
    }
}
</code></pre><p>æ€ä¹ˆæ·»åŠ å¤„ç†å‡½æ•°å‘¢ï¼ŸECMASCRIPTæ ‡å‡†ä¸­è¯´åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡promiseåŸå‹ä¸Šé¢çš„thenæ–¹æ³•ä¸ºpromiseæ·»åŠ æˆåŠŸå¤„ç†å‡½æ•°å’Œå¤±è´¥å¤„ç†å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡catchæ–¹æ³•ä¸ºpromiseæ·»åŠ å¤±è´¥å¤„ç†å‡½æ•°ã€‚</p>
<pre><code>const statusProvider = (promise, status) =&gt; data =&gt; {
    if (promise.status !== PENDING) return false
    promise.status = status
    promise.result = data
    switch(status) {
        case FULFILLED: return promise.successListener.forEach(fn =&gt; fn(data))
        case REJECTED: return promise.failurelistener.forEach(fn =&gt; fn(data))
    }
}
class Promise {
    constructor(executor) {
        this.status = PENDING
        this.successListener = []
        this.failurelistener = []
        this.result = undefined
        executor(statusProvider(this, FULFILLED), statusProvider(this, REJECTED))
    }
    /**
     * PromiseåŸå‹ä¸Šé¢çš„æ–¹æ³•
     */
    then(...args) {
        switch (this.status) {
            case PENDING: {
                this.successListener.push(args[0])
                this.failurelistener.push(args[1])
                break
            }
            case FULFILLED: {
                args[0](this.result)
                break
            }
            case REJECTED: {
                args[1](this.result)
            }
        }
    }
    catch(arg) {
        return this.then(undefined, arg)
    }
}
</code></pre><p>æˆ‘ä»¬ç°åœ¨çš„PromiseåŸºæœ¬åˆå…·é›å½¢äº†ã€‚ç”šè‡³å¯ä»¥è¿ç”¨åˆ°ä¸€äº›ç®€å•çš„åœºæ™¯ä¸­äº†ã€‚ä¸¾ä¸ªä¾‹å­ã€‚</p>
<pre><code>/*åˆ›å»ºä¸€ä¸ªå»¶æ—¶resolveçš„pormise*/
new Promise((resolve, reject) =&gt; {setTimeout(() =&gt; resolve(5), 2000)}).then(data =&gt; console.log(data)) // 5
/*åˆ›å»ºä¸€ä¸ªåŠæ—¶resolveçš„promise*/
new Promise((resolve, reject) =&gt; resolve(5)).then(data =&gt; console.log(data)) // 5
/*é“¾å¼è°ƒç”¨thenæ–¹æ³•è¿˜ä¸èƒ½å¤Ÿä½¿ç”¨ï¼*/
new Promise(resolve=&gt; resolve(5)).then(data =&gt; data).then(data =&gt; console.log(data))
// Uncaught TypeError: Cannot read property &apos;then&apos; of undefined
</code></pre><h2 id="ç¬¬ä¸‰æ­¥ï¼šPromiseçš„é“¾å¼è°ƒç”¨"><a href="#ç¬¬ä¸‰æ­¥ï¼šPromiseçš„é“¾å¼è°ƒç”¨" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šPromiseçš„é“¾å¼è°ƒç”¨"></a>ç¬¬ä¸‰æ­¥ï¼šPromiseçš„é“¾å¼è°ƒç”¨</h2><p>Promiseéœ€è¦å®ç°é“¾å¼è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡å›é¡¾ä¸‹thenæ–¹æ³•çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>thenæ–¹æ³•ä¸ºpormiseæ·»åŠ æˆåŠŸå’Œå¤±è´¥çš„å¤„ç†å‡½æ•°ï¼ŒåŒæ—¶thenæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡ï¼Œè¿™ä¸ªæ–°çš„promiseå¯¹è±¡resolveå¤„ç†å‡½æ•°çš„è¿”å›å€¼ï¼Œæˆ–è€…å½“æ²¡æœ‰æä¾›å¤„ç†å‡½æ•°æ—¶ç›´æ¥resolveåŸå§‹çš„å€¼ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºï¼Œpromiseèƒ½å¤Ÿé“¾å¼è°ƒç”¨å½’åŠŸäºthenæ–¹æ³•è¿”å›ä¸€ä¸ªå…¨æ–°çš„promiseï¼Œå¹¶ä¸”resolveå¤„ç†å‡½æ•°çš„è¿”å›å€¼ï¼Œå½“ç„¶ï¼Œå¦‚æœthenæ–¹æ³•çš„å¤„ç†å‡½æ•°æœ¬èº«å°±è¿”å›ä¸€ä¸ªpromiseï¼Œé‚£ä¹ˆä¹…ä¸ç”¨æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸ªpromiseäº†ã€‚äº†è§£äº†è¿™äº›ï¼Œå°±å¼€å§‹åŠ¨æ‰‹å†™ä»£ç äº†ã€‚</p>
<pre><code>const isPromise = object =&gt; object &amp;&amp; object.then &amp;&amp; typeof object.then === &apos;function&apos;
const noop = () =&gt; {}

const statusProvider = (promise, status) =&gt; data =&gt; {
    // åŒä¸Šé¢ä»£ç 
}

class Promise {
    constructor(executor) {
        // åŒä¸Šé¢ä»£ç 
    }
    then(...args) {
        const child = new this.constructor(noop)

        const handler = fn =&gt; data =&gt; {
            if (typeof fn === &apos;function&apos;) {
                const result = fn(data)
                if (isPromise(result)) {
                    Object.assign(child, result)
                } else {
                    statusProvider(child, FULFILLED)(result)
                }   
            } else if(!fn) {
                statusProvider(child, this.status)(data)
            }
        }
        switch (this.status) {
            case PENDING: {
                this.successListener.push(handler(args[0]))
                this.failurelistener.push(handler(args[1]))
                break
            }
            case FULFILLED: {
                handler(args[0])(this.result)
                break
            }
            case REJECTED: {
                handler(args[1])(this.result)
                break
            }
        }
        return child
    }
    catch(arg) {
        return this.then(undefined, arg)
    }
}
</code></pre><p>é¦–å…ˆæˆ‘ä»¬å†™äº†ä¸€ä¸ªisPromiseæ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯promiseã€‚å°±æ˜¯åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰ä¸€ä¸ª<code>then</code>æ–¹æ³•ï¼Œå…è´£å£°æ˜ä¸ºäº†å®ç°ä¸Šçš„ç®€å•ï¼Œæˆ‘ä»¬ä¸åŒºåˆ†thenableå’Œpromiseçš„åŒºåˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥æ˜¯çŸ¥é“ã€‚æ‰€æœ‰çš„promiseéƒ½æ˜¯thenableçš„ï¼Œè€Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„thenableå¯¹è±¡éƒ½æ˜¯promiseã€‚ï¼ˆthenableå¯¹è±¡æ˜¯æŒ‡å¸¦æœ‰ä¸€ä¸ªthenæ–¹æ³•çš„å¯¹è±¡ï¼Œè¯¥thenæ–¹æ³•å…¶å®å°±æ˜¯ä¸€ä¸ªexecutorã€‚ï¼‰isPromiseçš„ä½œç”¨å°±æ˜¯ç”¨äºåˆ¤æ–­thenæ–¹æ³•è¿”å›å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªpromiseï¼Œå¦‚æœæ˜¯promiseï¼Œå°±ç›´æ¥è¿”å›è¯¥promiseï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±æ–°ç”Ÿæˆä¸€ä¸ªpromiseå¹¶è¿”å›è¯¥promiseã€‚</p>
<p>ç”±äºéœ€è¦é“¾å¼è°ƒç”¨ï¼Œæˆ‘ä»¬å¯¹successListenerå’ŒfailureListenerä¸­å¤„ç†å‡½æ•°è¿›è¡Œäº†é‡å†™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥pushè¿›å»thenæ–¹æ³•æ¥å—çš„å‚æ•°å‡½æ•°äº†ï¼Œå› ä¸ºthenæ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªpromiseï¼Œæ‰€ä»¥å½“thenæ–¹æ³•é‡Œé¢çš„å¤„ç†å‡½æ•°è¢«æ‰§è¡Œçš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹thenæ–¹æ³•è¿”å›çš„è¿™ä¸ªpromiseè¿›è¡Œå¤„ç†ï¼Œè¦ä¹ˆresolveï¼Œè¦ä¹ˆrejectæ‰ã€‚å½“ç„¶ï¼Œå¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯éœ€è¦resolveæ‰çš„ï¼Œåªæœ‰å½“thenæ–¹æ³•æ²¡æœ‰æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°å‡½æ•°ï¼ŒåŒæ—¶è°ƒç”¨thenæ–¹æ³•çš„promiseå°±æ˜¯rejectedçš„æ—¶å€™ï¼Œæ‰éœ€è¦æŠŠthenæ–¹æ³•è¿”å›çš„pormiseè¿›è¡Œrejectå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>statusProvider(child, REJECTED)(data)</code>.</p>
<p>toy Promiseå®ç°çš„å®Œæ•´ä»£ç ï¼š</p>
<pre><code>const PENDING = &apos;PENDING&apos; // Promise çš„ åˆå§‹çŠ¶æ€
const FULFILLED = &apos;FULFILLED&apos; // Promise æˆåŠŸè¿”å›åçš„çŠ¶æ€
const REJECTED = &apos;REJECTED&apos; // Promise å¤±è´¥åçš„çŠ¶æ€

const isPromise = object =&gt; object &amp;&amp; object.then &amp;&amp; typeof object.then === &apos;function&apos;
const noop = () =&gt; {}

const statusProvider = (promise, status) =&gt; data =&gt; {
    if (promise.status !== PENDING) return false
    promise.status = status
    promise.result = data
    switch(status) {
        case FULFILLED: return promise.successListener.forEach(fn =&gt; fn(data))
        case REJECTED: return promise.failurelistener.forEach(fn =&gt; fn(data))
    }
}

class Promise {
    constructor(executor) {
        this.status = PENDING
        this.successListener = []
        this.failurelistener = []
        this.result = undefined 
        executor(statusProvider(this, FULFILLED), statusProvider(this, REJECTED))
    }
    /**
     * PromiseåŸå‹ä¸Šé¢çš„æ–¹æ³•
     */
    then(...args) {
        const child = new this.constructor(noop)

        const handler = fn =&gt; data =&gt; {
            if (typeof fn === &apos;function&apos;) {
                const result = fn(data)
                if (isPromise(result)) {
                    Object.assign(child, result)
                } else {
                    statusProvider(child, FULFILLED)(result)
                }   
            } else if(!fn) {
                statusProvider(child, this.status)(data)
            }
        }
        switch (this.status) {
            case PENDING: {
                this.successListener.push(handler(args[0]))
                this.failurelistener.push(handler(args[1]))
                break
            }
            case FULFILLED: {
                handler(args[0])(this.result)
                break
            }
            case REJECTED: {
                handler(args[1])(this.result)
                break
            }
        }
        return child
    }
    catch(arg) {
        return this.then(undefined, arg)
    }
}
</code></pre><h2 id="å››ã€æ€ä¹ˆè®©æˆ‘ä»¬çš„toy-Promiseå˜å¼ºå¥"><a href="#å››ã€æ€ä¹ˆè®©æˆ‘ä»¬çš„toy-Promiseå˜å¼ºå¥" class="headerlink" title="å››ã€æ€ä¹ˆè®©æˆ‘ä»¬çš„toy Promiseå˜å¼ºå¥"></a>å››ã€æ€ä¹ˆè®©æˆ‘ä»¬çš„toy Promiseå˜å¼ºå¥</h2><ol>
<li>åœ¨ECMAScriptæ ‡å‡†ä¸­ï¼ŒPromiseæ„é€ å‡½æ•°ä¸Šé¢è¿˜æä¾›äº†ä¸€äº›é™æ€æ–¹æ³•ï¼Œæ¯”å¦‚<code>Promise.resolve</code>ã€<code>Promise.reject</code>ã€<code>Promsie.all</code>ã€<code>Promise.race</code>ã€‚å½“æˆ‘ä»¬æœ‰äº†ä¸Šé¢çš„åŸºç¡€å®ç°åï¼Œä¸ºæˆ‘ä»¬çš„toy Promiseæ·»åŠ ä¸Šé¢è¿™äº›æ–°çš„åŠŸèƒ½ä¸€å®šèƒ½è®©å…¶æ›´åŠ å®ç”¨ã€‚</li>
<li>åœ¨æˆ‘ä»¬çš„åŸºæœ¬å®ç°ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åŒºåˆ†thenableå¯¹è±¡ï¼Œå…¶å®<code>Promise.resolve</code>å’Œ<code>then</code>æ–¹æ³•éƒ½å¯ä»¥æ¥å—ä¸€ä¸ªthenableå¯¹è±¡ï¼Œå¹¶æŠŠè¯¥thenableå¯¹è±¡è½¬åŒ–ä¸ºä¸€ä¸ªpromiseå¯¹è±¡ï¼Œå¦‚æœæƒ³è®©æˆ‘ä»¬çš„toy Promiseç”¨äºç”Ÿäº§çš„è¯ï¼Œè¿™ä¹Ÿæ˜¯è¦è€ƒè™‘çš„ã€‚</li>
<li>ä¸ºäº†è®©æˆ‘ä»¬çš„toy Promiseå˜å¾—æ›´å¼ºå£®ï¼Œæˆ‘ä»¬éœ€è¦æ‹¥æœ‰å¼ºå¥çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæ¯”å¦‚éªŒè¯executorå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ã€thenæ–¹æ³•çš„å‚æ•°åªèƒ½æ˜¯å‡½æ•°æˆ–è€…undefinedæˆ–nullï¼Œåˆæ¯”å¦‚executorå’Œthenæ–¹æ³•ä¸­æŠ›å‡ºçš„é”™è¯¯å¹¶ä¸èƒ½å¤Ÿè¢«window.onerrorç›‘æµ‹åˆ°ï¼Œè€Œåªèƒ½å¤Ÿé€šè¿‡é”™è¯¯å¤„ç†å‡½æ•°æ¥å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„å› ç´ ã€‚</li>
<li>å¦‚æœæˆ‘ä»¬çš„Promise polyfillæ˜¯è€ƒè™‘æ”¯æŒå¤šå¹³å°ï¼Œé‚£ä¹ˆé¦–è¦è€ƒè™‘çš„å°±æ˜¯æµè§ˆå™¨ç¯å¢ƒæˆ–Node.jsç¯å¢ƒï¼Œå…¶å®åœ¨è¿™ä¸¤ä¸ªå¹³å°ï¼ŒåŸç”ŸPromiseéƒ½æ˜¯æ”¯æŒä¸¤ä¸ªäº‹ä»¶çš„ã€‚å°±æ‹¿æµè§ˆå™¨ç«¯ä¸¾ä¾‹ï¼š</li>
</ol>
<ul>
<li><code>unhandledrejection</code>: åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰å¯¹promiseè¿”å›çš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨windowå¯¹è±¡ä¸Šé¢è§¦å‘è¯¥äº‹ä»¶ã€‚</li>
<li><code>rejectionhandled</code>:å¦‚æœåœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯åï¼Œæˆ‘ä»¬æ‰å»å¯¹promiseè¿”å›çš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨windowå¯¹è±¡ä¸Šé¢ç›‘å¬åˆ°æ­¤äº‹ä»¶ã€‚</li>
</ul>
<p>å…³äºè¿™ä¸¤ä¸ªäº‹ä»¶ä»¥åŠnode.jså¹³å°ä¸Šé¢ç±»ä¼¼çš„äº‹ä»¶è¯·å‚è€ƒNicholas C. Zakasæ–°ä¹¦</p>
<p>Promiseèƒ½å¤Ÿå¾ˆæ£’çš„å¤„ç†å¼‚æ­¥ç¼–ç¨‹ï¼Œè¦æƒ³å­¦å¥½å®ƒæˆ‘è®¤ä¸ºæœ€å¥½çš„æ–¹æ³•å°±æ˜¯äº²è‡ªåŠ¨æ‰‹å»å®ç°ä¸€ä¸ªè‡ªå·±çš„Promiseã€‚</p>
<p>å®Œæ•´codeï¼š</p>
<pre><code>/**
 * 2016.09.19
 */
const PENDING = &apos;PENDING&apos; // Promise çš„åˆå§‹çŠ¶æ€
const FULFILLED = &apos;FULFILLED&apos; // Promise æˆåŠŸè¿”å›åçš„çŠ¶æ€
const REJECTED = &apos;REJECTED&apos; // Promise å¤±è´¥åçš„çŠ¶æ€

const isThenable = data =&gt; data &amp;&amp; data.then &amp;&amp; typeof data.then === &apos;function&apos;
const isPromise = object =&gt; isThenable(object) &amp;&amp; (&apos;catch&apos; in object) &amp;&amp; typeof object.catch === &apos;function&apos;
const noop = () =&gt; {}
const range = n =&gt; n === 0 ? [] : [n, ...range(n - 1)]

// resolve function
const statusProvider = (promise, status) =&gt; data =&gt; {
    if (promise.status !== PENDING) return false
    promise.status = status
    promise.result = data
    promise.listeners[status].forEach(fn =&gt; fn(data))
}

class APromise {
    constructor(executor) {
        if (typeof executor !== &apos;function&apos;) {
            throw new TypeError(`Promise resolver ${executor.toString()} is not a function`)
        }
        this.status = PENDING
        this.listeners = {
            FULFILLED: [],
            REJECTED: []
        }
        this.result = undefined

        try {
            executor(statusProvider(this, FULFILLED), statusProvider(this, REJECTED))
        } catch (e) {
            statusProvider(this, REJECTED)(e)
        }
    }
    // prototype method
    then(...args) {
        const child = new this.constructor(noop)

        const handler = fn =&gt; data =&gt; {
            if (typeof fn === &apos;function&apos;) {
                try {
                    const result = fn(data)
                    if (isThenable(result)) {
                        isPromise(result) ? Object.assign(child, result) : Object.assign(child, new this.constructor(result.then))
                    } else {
                        statusProvider(child, FULFILLED)(result)
                    }
                } catch (e) {
                    statusProvider(child, REJECTED)(e)
                }
            } else if (!fn) {
                statusProvider(child, this.status)(data)
            }
        }
        switch (this.status) {
            case PENDING: {
                this.listeners[FULFILLED].push(handler(args[0]))
                this.listeners[REJECTED].push(handler(args[1]))
                break
            }
            case FULFILLED: {
                handler(args[0])(this.result)
                break
            }
            case REJECTED: {
                handler(args[1])(this.result)
                break
            }
        }
        return child
    }

    catch(arg) {
        return this.then(undefined, arg)
    }
}

APromise.resolve = data =&gt; {
    if (isPromise(data)) return data
    return isThenable(data) ? new APromise(data.then) : new APromise((resolve, reject) =&gt; resolve(data))
}

APromise.reject = err =&gt; new APromise((resolve, reject) =&gt; reject(err))

APromise.all = promises =&gt; {
    const length = promises.length
    const result = new APromise(noop)
    let count = 0
    const values = range(length)

    promises.forEach((p, i) =&gt; {
        p.then(data =&gt; {
            values[i] = data
            count++
            if (count === length) statusProvider(result, FULFILLED)(values)
        }, statusProvider(result, REJECTED))
    })
    return result
}

APromise.race = promises =&gt; {
    const result = new APromise(noop)
    promises.forEach((p, i) =&gt; {
        p.then(statusProvider(result, FULFILLED), statusProvider(result, REJECTED))
    })
    return result
}

export default APromise
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/v-for-å¾ªç¯-indexçš„ä¼ å€¼é—®é¢˜/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/24/v-for-å¾ªç¯-indexçš„ä¼ å€¼é—®é¢˜/" itemprop="url">v-for å¾ªç¯ indexçš„ä¼ å€¼é—®é¢˜</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-06-24T23:02:54+08:00">
                2018-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>&lt;el-submenu :index=&quot;index&quot; v-for=&quot;(item,index) in menuList&quot;&gt;

    &lt;el-menu-item :index=&quot;index&quot; 
       v-for=&quot;(subItem,subindex) in item.subMenuList&quot;&gt;
        {{index}}-{{subItem.subMenuName}}&lt;/el-menu-item&gt;

&lt;/el-submenu&gt;
</code></pre><p>å‘ç°å­ç»„ä»¶è·å–åˆ°çš„indexä¸€ç›´éƒ½æ˜¯undefinedã€‚</p>
<p>ä¿®æ”¹åŠæ³•ï¼š</p>
<pre><code>&lt;el-menu-item :index=&quot;&apos;&apos;+index&quot; 
     v-for=&quot;(subItem,subindex) in item.subMenuList&quot;&gt;
  {{index}}-{{subItem.subMenuName}}
&lt;/el-menu-item&gt;
</code></pre><p>å°† :index çš„åˆ¶æ”¹ä¸ºâ€™â€™+indexï¼Œä¸€å®šæ˜¯å•å¼•å·â€™â€™ ï¼Œå­ç»„ä»¶è·å–çš„åˆ°çš„å°±å˜æˆå­—ç¬¦ä¸²â€0,â€â€1â€â€¦..</p>
<p>å°†å­—ç¬¦ä¸²â€0â€å˜æˆæ•´æ•°   +â€0â€ å³å¯ï¼</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/03/JavaScriptçš„äº‹ä»¶å¾ªç¯/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/03/JavaScriptçš„äº‹ä»¶å¾ªç¯/" itemprop="url">JavaScriptçš„äº‹ä»¶å¾ªç¯</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-06-03T11:15:38+08:00">
                2018-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Node-js-äº‹ä»¶å¾ªç¯ä¸€-æµ…æ"><a href="#Node-js-äº‹ä»¶å¾ªç¯ä¸€-æµ…æ" class="headerlink" title="Node.js äº‹ä»¶å¾ªç¯ä¸€: æµ…æ"></a>Node.js äº‹ä»¶å¾ªç¯ä¸€: æµ…æ</h2><blockquote>
<p>ç†è§£äº‹ä»¶å¾ªç¯ç³»åˆ—ç¬¬ä¸€æ­¥ æµ…æå’Œæ€»è§ˆ</p>
</blockquote>
<p>å¤šæ•°çš„ç½‘ç«™ä¸éœ€è¦å¤§é‡è®¡ç®—ï¼Œç¨‹åºèŠ±è´¹çš„æ—¶é—´ä¸»è¦é›†ä¸­åœ¨ç£ç›˜ I/O å’Œç½‘ç»œ I/O ä¸Šé¢</p>
<p>SSDè¯»å–å¾ˆå¿«ï¼Œä½†å’ŒCPUå¤„ç†æŒ‡ä»¤çš„é€Ÿåº¦æ¯”èµ·æ¥ä¹Ÿä¸åœ¨ä¸€ä¸ªæ•°é‡çº§ä¸Šï¼Œè€Œä¸”ç½‘ç»œä¸Šä¸€ä¸ªæ•°æ®åŒ…æ¥å›çš„æ—¶é—´æ›´æ…¢ï¼š</p>
<p><img src="https://pic1.zhimg.com/v2-67a42368c7dffa3348730760c9c0b907_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-67a42368c7dffa3348730760c9c0b907_hd.jpg" alt=""></p>
<p>ä¸€ä¸ªæ•°æ®åŒ…æ¥å›çš„å»¶è¿Ÿå¹³å‡320ms(æˆ‘ç½‘é€Ÿæ…¢ï¼Œpingå›½å†…ç½‘ç«™ä¼šæ›´å¿«)ï¼Œè¿™æ®µæ—¶é—´å†…ä¸€ä¸ªæ™®é€š cpu æ‰§è¡Œå‡ åƒä¸‡ä¸ªå‘¨æœŸåº”è¯¥æ²¡é—®é¢˜</p>
<p>å› æ­¤å¼‚æ­¥IOå°±è¦å‘æŒ¥ä½œç”¨äº†ï¼Œæ¯”å¦‚ç”¨å¤šçº¿ç¨‹ï¼Œå¦‚æœç”¨ Java å»è¯»ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„æ“ä½œï¼Œåœ¨ç­‰å¾…æ•°æ®è¿”å›çš„è¿‡ç¨‹ä¸­ä»€ä¹ˆä¹Ÿå¹²ä¸äº†ï¼Œå› æ­¤å°±å¼€ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†æ–‡ä»¶è¯»å–ï¼Œè¯»å–æ“ä½œç»“æŸåå†å»é€šçŸ¥ä¸»çº¿ç¨‹ã€‚</p>
<p>è¿™æ ·è™½ç„¶è¡Œå¾—é€šï¼Œä½†æ˜¯ä»£ç å†™èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚åƒ Node.js V8 è¿™ç§æ— æ³•å¼€ä¸€ä¸ªçº¿ç¨‹çš„æ€ä¹ˆåŠï¼Ÿ</p>
<p>å…ˆçœ‹ä¸‹é¢å‡½æ•°æ‰§è¡Œè¿‡ç¨‹</p>
<h2 id="æ ˆ-Stack"><a href="#æ ˆ-Stack" class="headerlink" title="æ ˆ Stack"></a>æ ˆ Stack</h2><p>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„åœ°å€ã€å‚æ•°ã€å±€éƒ¨å˜é‡éƒ½ä¼šå‹å…¥åˆ°ä¸€ä¸ª stack ä¸­</p>
<pre><code>function fire() {
    const result = sumSqrt(3, 4)
    console.log(result);
}
function sumSqrt(x, y) {
    const s1 = square(x)
    const s2 = square(y)
    const sum = s1 + s2;
    return Math.sqrt(sum)
}
function square(x) {
    return x * x;
}

fire()
</code></pre><blockquote>
<p>ä¸‹é¢çš„å›¾éƒ½æ˜¯ç”¨ keynote åšçš„ <a href="https://link.zhihu.com/?target=https%3A//github.com/ccforward/cc/blob/master/Blog/pic/event-loop.key" target="_blank" rel="noopener">keynoteåœ°å€</a></p>
</blockquote>
<p>å‡½æ•° <code>fire</code> é¦–å…ˆè¢«è°ƒç”¨</p>
<p><img src="https://pic3.zhimg.com/v2-a3840ed51ad7ccaedb915e05b087e1e4_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-a3840ed51ad7ccaedb915e05b087e1e4_hd.jpg" alt=""></p>
<p><code>fire</code> è°ƒç”¨ <code>sumSqrt</code> å‡½æ•° å‚æ•°ä¸º3å’Œ4</p>
<p><img src="https://pic4.zhimg.com/v2-5871549477044a0e7a657f9a16e9367c_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-5871549477044a0e7a657f9a16e9367c_hd.jpg" alt=""></p>
<p>ä¹‹åè°ƒç”¨ <code>square</code> å‚æ•°ä¸º x, x==3</p>
<p><img src="https://pic2.zhimg.com/v2-ced7e64c06861509c593cdb0cfbc594e_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-ced7e64c06861509c593cdb0cfbc594e_hd.jpg" alt=""></p>
<p>å½“ <code>square</code> æ‰§è¡Œç»“æŸè¿”å›æ—¶ï¼Œä» stack ä¸­å¼¹å‡ºï¼Œå¹¶å°†è¿”å›å€¼èµ‹å€¼ç»™ s1<br>s1åŠ å…¥åˆ° sumSqrt çš„ stack frame ä¸­</p>
<p><img src="https://pic2.zhimg.com/v2-0f214a42ee6c2226c343edb7431116be_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-0f214a42ee6c2226c343edb7431116be_hd.jpg" alt=""></p>
<p>ä»¥åŒæ ·çš„æ–¹å¼è°ƒç”¨ä¸‹ä¸€ä¸ª <code>square</code> å‡½æ•°</p>
<p><img src="https://pic4.zhimg.com/v2-6488db685f7ba396d9bb72b80daf0465_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-6488db685f7ba396d9bb72b80daf0465_hd.jpg" alt=""></p>
<p><img src="https://pic1.zhimg.com/v2-4900e4ce2e398d085ceb6f2ea31ad6d9_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-4900e4ce2e398d085ceb6f2ea31ad6d9_hd.jpg" alt=""></p>
<p>åœ¨ä¸‹ä¸€è¡Œçš„è¡¨è¾¾å¼ä¸­è®¡ç®—å‡º s1+s2 å¹¶èµ‹å€¼ç»™ sum</p>
<p><img src="https://pic3.zhimg.com/v2-0045b1427a3fd41aa31cbac4271b6200_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-0045b1427a3fd41aa31cbac4271b6200_hd.jpg" alt=""></p>
<p>ä¹‹åè°ƒç”¨ <code>Math.sqrt</code> å‚æ•°ä¸ºsum</p>
<p><img src="https://pic4.zhimg.com/v2-89dc079ce6308a32fbf78c29b67c4985_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-89dc079ce6308a32fbf78c29b67c4985_hd.jpg" alt=""></p>
<p>ç°åœ¨å°±å‰©ä¸‹ <code>sumSqrt</code> å‡½æ•°è¿”å›è®¡ç®—ç»“æœäº†</p>
<p><img src="https://pic2.zhimg.com/v2-3fe1e6705f665c11f3c350bdd4f643c9_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-3fe1e6705f665c11f3c350bdd4f643c9_hd.jpg" alt=""></p>
<p>è¿”å›å€¼èµ‹å€¼ç»™ result</p>
<p><img src="https://pic4.zhimg.com/v2-d55914f97f05518c2f31b10909efb4f4_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-d55914f97f05518c2f31b10909efb4f4_hd.jpg" alt=""></p>
<p>åœ¨ console ä¸­æ‰“å°å‡º result</p>
<p><img src="https://pic3.zhimg.com/v2-99d7b0ece63e888549b258944fe0e1e4_b.jpg" alt=""><img src="https://pic3.zhimg.com/80/v2-99d7b0ece63e888549b258944fe0e1e4_hd.jpg" alt=""></p>
<p>æœ€ç»ˆ <code>fire</code> æ²¡æœ‰ä»»ä½•è¿”å›å€¼ ä»stackä¸­å¼¹å‡º stackä¹Ÿæ¸…ç©ºäº†</p>
<p><img src="https://pic4.zhimg.com/v2-bd4e4983cbba11fe080913f2a1d0ef43_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-bd4e4983cbba11fe080913f2a1d0ef43_hd.jpg" alt=""></p>
<p>å½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åæœ¬åœ°å˜é‡ä¼šä» stack ä¸­å¼¹å‡ºï¼Œè¿™åªæœ‰åœ¨ä½¿ç”¨ numbers string boolean è¿™ç§åŸºæœ¬æ•°æ®ç±»å‹æ—¶æ‰ä¼šå‘ç”Ÿã€‚è€Œå¯¹è±¡ã€æ•°ç»„çš„å€¼æ˜¯å­˜åœ¨äº heap(å †) ä¸­çš„ï¼Œstack åªå­˜æ”¾äº†ä»–ä»¬å¯¹åº”çš„æŒ‡é’ˆã€‚</p>
<p>å½“å‡½æ•°ä¹‹è¡Œç»“æŸä» stack ä¸­å¼¹å‡ºæ¥æ—¶ï¼Œåªæœ‰å¯¹è±¡çš„æŒ‡é’ˆè¢«å¼¹å‡ºï¼Œè€ŒçœŸæ­£çš„å€¼ä¾ç„¶å­˜åœ¨ heap ä¸­ï¼Œç„¶åç”±åƒåœ¾å›æ”¶å™¨è‡ªåŠ¨çš„æ¸…ç†å›æ”¶ã€‚</p>
<h2 id="äº‹ä»¶å¾ªç¯"><a href="#äº‹ä»¶å¾ªç¯" class="headerlink" title="äº‹ä»¶å¾ªç¯"></a>äº‹ä»¶å¾ªç¯</h2><p>é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£å‡½æ•°çš„æ‰§è¡Œé¡ºåº</p>
<pre><code>&apos;use strict&apos;

const express = require(&apos;express&apos;)
const superagent = require(&apos;superagent&apos;)
const app = express()

app.get(&apos;/&apos;, getArticle)

function getArticle(req, res) {
    fetchArticle(req, res)
    print()
}

const aids = [4564824, 4506868, 4767667, 4856099, 7456996];

function fetchArticle(req, res) {
    const aid = aids[Math.floor(Math.random() * aids.length)]
    superagent.get(`http://news-at.zhihu.com/api/4/news/${aid}`)
        .end((err, res) =&gt; {
            if(err) {
                console.log(&apos;error ......&apos;);
                return res.status(500).send(&apos;an error ......&apos;)
            }
            const article = res.body
            res.send(article)
            console.log(&apos;Got an article&apos;)
        })

    console.log(&apos;Now is fetching an article&apos;)
}

function print(){
    console.log(&apos;Print something&apos;)
}


app.listen(&apos;5000&apos;)
</code></pre><p>è¯·æ±‚ <code>http://localhost:5000/</code> åæ‰“å°å‡º</p>
<pre><code>Now is fetching an article

Print something

Got an article
</code></pre><p>è™½ç„¶ V8 æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†åº•å±‚çš„ C++ API å´ä¸æ˜¯ã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬æ‰§è¡Œä¸€äº›éé˜»å¡çš„æ“ä½œï¼ŒNodeä¼šè°ƒç”¨ä¸€äº›ä»£ç ï¼Œä¸å¼•æ“é‡Œçš„jsä»£ç åŒæ—¶æ‰§è¡Œã€‚ä¸€æ—¦è¿™ä¸ªéšè—çš„çº¿ç¨‹æ”¶åˆ°äº†ç­‰å¾…çš„è¿”å›å€¼æˆ–è€…æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¹‹å‰æä¾›çš„å›è°ƒå‡½æ•°å°±ä¼šæ‰§è¡Œã€‚</p>
<p>ä¸Šé¢çš„è¯´çš„Nodeè°ƒç”¨çš„ä¸€äº›ä»£ç å…¶å®å°±æ˜¯ <a href="https://link.zhihu.com/?target=https%3A//github.com/libuv/libuv" target="_blank" rel="noopener">libuv</a>ï¼Œä¸€ä¸ªå¼€æºçš„è·¨å¹³å°çš„å¼‚æ­¥ I/O ã€‚æœ€åˆå°±æ˜¯ä¸º Node.js å¼€å‘çš„ï¼Œç°åœ¨<a href="https://link.zhihu.com/?target=https%3A//github.com/libuv/libuv/wiki/Projects-that-use-libuv" target="_blank" rel="noopener">å¾ˆå¤šé¡¹ç›®</a>éƒ½åœ¨ç”¨</p>
<h2 id="ä»»åŠ¡é˜Ÿåˆ—"><a href="#ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡é˜Ÿåˆ—"></a>ä»»åŠ¡é˜Ÿåˆ—</h2><p>javascript æ˜¯å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨çš„è¯­è¨€ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç»™æ—¶é—´æ·»åŠ ç›‘å¬å™¨ï¼Œå½“äº‹ä»¶è§¦å‘æ—¶ï¼Œç›‘å¬å™¨å°±èƒ½æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</p>
<p>å½“æˆ‘ä»¬å»è°ƒç”¨ <code>setTimeout`</code>http.get<code></code>fs.readFile`, Node.js ä¼šæŠŠè¿™äº›å®šæ—¶å™¨ã€httpã€IOæ“ä½œå‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä»¥ä¿è¯V8ç»§ç»­æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ã€‚</p>
<p>ç„¶è€Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹å’Œä¸€ä¸ª call-stack ï¼Œè¿™æ ·å½“ä¸€ä¸ªè¯»å–æ–‡ä»¶çš„æ“ä½œè¿˜åœ¨æ‰§è¡Œæ—¶ï¼Œæœ‰ä¸€ä¸ªç½‘ç»œè¯·æ±‚requestè¿‡æ¥ï¼Œé‚£è¿™æ—¶ä»–çš„å›è°ƒå°±éœ€è¦ç­‰stackå˜ç©ºæ‰èƒ½æ‰§è¡Œã€‚</p>
<p>å›è°ƒå‡½æ•°æ­£åœ¨ç­‰å¾…è½®åˆ°è‡ªå·±æ‰§è¡Œæ‰€æ’çš„é˜Ÿå°±è¢«ç§°ä¸ºä»»åŠ¡é˜Ÿåˆ—(æˆ–è€…äº‹ä»¶é˜Ÿåˆ—ã€æ¶ˆæ¯é˜Ÿåˆ—)ã€‚æ¯å½“ä¸»çº¿ç¨‹å®Œæˆå‰ä¸€ä¸ªä»»åŠ¡ï¼Œå›è°ƒå‡½æ•°å°±ä¼šåœ¨ä¸€ä¸ªæ— é™å¾ªç¯åœˆé‡Œè¢«è°ƒç”¨ï¼Œå› æ­¤è¿™ä¸ªåœˆè¢«ç§°ä¸ºäº‹ä»¶å¾ªç¯ã€‚</p>
<p>æˆ‘ä»¬å‰é¢é‚£ä¸ªè·å–æ–‡ç« çš„ä¾‹å­çš„æ‰§è¡Œé¡ºåºå°±ä¼šå¦‚ä¸‹ï¼š</p>
<ol>
<li>express ç»™ request äº‹ä»¶æ³¨å†Œäº†ä¸€ä¸ª handlerï¼Œå¹¶ä¸”å½“è¯·æ±‚åˆ°è¾¾è·¯å¾„ â€˜/â€˜ æ—¶æ¥è§¦å‘handler</li>
<li>è°ƒè¿‡å„ä¸ªå‡½æ•°å¹¶ä¸”åœ¨ç«¯å£ 5000 ä¸Šå¯åŠ¨ç›‘å¬</li>
<li>stack ä¸ºç©ºï¼Œç­‰å¾… <code>request</code> äº‹ä»¶è§¦å‘</li>
<li>æ ¹æ®ä¼ å…¥çš„è¯·æ±‚ï¼Œäº‹ä»¶è§¦å‘ï¼Œexpress è°ƒç”¨ä¹‹å‰æä¾›çš„å‡½æ•° <code>getArticle</code></li>
<li><code>getArticle</code> å‹å…¥(push) stack</li>
<li><code>fetchArticle</code> è¢«è°ƒç”¨ åŒæ—¶å‹å…¥ stack</li>
<li><code>Math.floor</code> å’Œ <code>Math.random</code> è¢«è°ƒç”¨å‹å…¥ stack ç„¶åå† å¼¹å‡º(pop), ä» aids é‡Œé¢å–å‡ºçš„ä¸€ä¸ªå€¼è¢«èµ‹å€¼ç»™å˜é‡ aid</li>
<li><code>superagent.get</code> è¢«æ‰§è¡Œï¼Œå‚æ•°ä¸º <code>&#39;http://news-at.zhihu.com/api/4/news/${aid}&#39;</code> ,å¹¶ä¸”å›è°ƒå‡½æ•°æ³¨å†Œç»™äº† <code>end</code> äº‹ä»¶</li>
<li>åˆ° <code>http://news-at.zhihu.com/api/4/news/${aid}</code> çš„HTTPè¯·æ±‚è¢«å‘é€åˆ°åå°çº¿ç¨‹ï¼Œç„¶åå‡½æ•°ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li><code>&#39;Now is fetching an article&#39;</code> æ‰“å°åœ¨ console ä¸­ã€‚ å‡½æ•° <code>fetchArticle</code> è¿”å›</li>
<li><code>print</code> å‡½æ•°è¢«è°ƒç”¨, <code>&#39;Print something&#39;</code> æ‰“å°åœ¨ console ä¸­</li>
<li>å‡½æ•° <code>getArticle</code> è¿”å›ï¼Œå¹¶ä» stack ä¸­å¼¹å‡ºï¼Œ stack ä¸ºç©º</li>
<li>ç­‰å¾… <code>http://news-at.zhihu.com/api/4/news/${aid}</code> å‘é€ç›¸åº”ä¿¡æ¯</li>
<li>å“åº”ä¿¡æ¯åˆ°è¾¾ï¼Œ<code>end</code> äº‹ä»¶è¢«è§¦å‘</li>
<li>æ³¨å†Œç»™ <code>end</code> äº‹ä»¶çš„åŒ¿åå›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°å’Œä»–é—­åŒ…ä¸­çš„æ‰€æœ‰å˜é‡å‹å…¥ stackï¼Œè¿™æ„å‘³ç€è¿™ä¸ªåŒ¿åå‡½æ•°å¯ä»¥è®¿é—®å¹¶ä¿®æ”¹ <code>express</code>, <code>superagent</code>, <code>app</code>, <code>aids</code>, <code>req</code>, <code>res</code>, <code>aid</code> çš„å€¼ä»¥åŠä¹‹å‰æ‰€æœ‰å·²ç»å®šä¹‰çš„å‡½æ•°</li>
<li>å‡½æ•° <code>res.send()</code> ä¼´éšç€ 200 æˆ– 500 çš„çŠ¶æ€ç è¢«æ‰§è¡Œï¼Œä½†åŒæ—¶åˆè¢«æ”¾å…¥åˆ°åå°çº¿ç¨‹ä¸­ï¼Œå› æ­¤ å“åº”æµ ä¸ä¼šé˜»å¡æˆ‘ä»¬å‡½æ•°çš„æ‰§è¡Œã€‚åŒ¿åå‡½æ•°ä¹Ÿè¢« pop å‡º stackã€‚</li>
</ol>
<h2 id="Microtasks-Macrotasks"><a href="#Microtasks-Macrotasks" class="headerlink" title="Microtasks Macrotasks"></a>Microtasks Macrotasks</h2><p>ä»»åŠ¡é˜Ÿåˆ—ä¸æ­¢ä¸€ä¸ªï¼Œè¿˜æœ‰ microtasks å’Œ macrotasks</p>
<p>microtasks:</p>
<ul>
<li>process.nextTick</li>
<li>promise</li>
<li>Object.observe</li>
</ul>
<p>macrotasks:</p>
<ul>
<li>setTimeout</li>
<li>setInterval</li>
<li>setImmediate</li>
<li>I/O</li>
</ul>
<p>è¿™ä¸¤ä¸ªçš„è¯¦ç»†åŒºåˆ«ä¸‹ä¸€ç¯‡å†å†™ï¼Œå…ˆçœ‹ä¸€æ®µä»£ç </p>
<pre><code>console.log(&apos;start&apos;)

const interval = setInterval(() =&gt; {  
  console.log(&apos;setInterval&apos;)
}, 0)

setTimeout(() =&gt; {  
  console.log(&apos;setTimeout 1&apos;)
  Promise.resolve()
      .then(() =&gt; {
        console.log(&apos;promise 3&apos;)
      })
      .then(() =&gt; {
        console.log(&apos;promise 4&apos;)
      })
      .then(() =&gt; {
        setTimeout(() =&gt; {
          console.log(&apos;setTimeout 2&apos;)
          Promise.resolve()
              .then(() =&gt; {
                console.log(&apos;promise 5&apos;)
              })
              .then(() =&gt; {
                console.log(&apos;promise 6&apos;)
              })
              .then(() =&gt; {
                clearInterval(interval)
              })
        }, 0)
      })
}, 0)

Promise.resolve()
    .then(() =&gt; {  
        console.log(&apos;promise 1&apos;)
    })
    .then(() =&gt; {
        console.log(&apos;promise 2&apos;)
    })
</code></pre><p>ç†è§£äº†nodeçš„äº‹ä»¶å¾ªç¯è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“å¾—å‡ºç­”æ¡ˆçš„ï¼š</p>
<pre><code>start
promise 1
promise 2
setInterval
setTimeout 1
promise 3
promise 4
setInterval
setTimeout 2
promise 5
promise 6
</code></pre><p>æ ¹æ® <a href="https://link.zhihu.com/?target=https%3A//html.spec.whatwg.org/multipage/webappapis.html%23task-queue" target="_blank" rel="noopener">WHATVG</a> çš„è¯´æ˜ï¼Œåœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„å‘¨æœŸ(cycle)ä¸­ä¸€ä¸ª (macro)task åº”è¯¥ä» macrotask é˜Ÿåˆ—å¼€å§‹æ‰§è¡Œã€‚å½“è¿™ä¸ª macrotask ç»“æŸåï¼Œæ‰€æœ‰çš„ microtasks å°†åœ¨åŒä¸€ä¸ª cycle ä¸­æ‰§è¡Œã€‚åœ¨ microtasks æ‰§è¡Œæ—¶è¿˜å¯ä»¥åŠ å…¥æ›´å¤šçš„ microtaskï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œï¼Œç›´åˆ° microtask é˜Ÿåˆ—æ¸…ç©ºã€‚</p>
<p>è§„èŒƒç†è§£èµ·æ¥æœ‰ç‚¹æ™¦æ¶©ï¼Œæ¥çœ‹ä¸‹ä¸Šé¢çš„ä¾‹å­</p>
<h2 id="Cycle-1"><a href="#Cycle-1" class="headerlink" title="Cycle 1"></a>Cycle 1</h2><p>1)<code>setInterval</code> è¢«åˆ—ä¸º task</p>
<p>2)<code>setTimeout 1</code> è¢«åˆ—ä¸º task</p>
<p>3)<code>Promise.resolve 1</code> ä¸­ä¸¤ä¸ª <code>then</code> è¢«åˆ—ä¸º microtask</p>
<p>4) stack æ¸…ç©º microtasks æ‰§è¡Œ</p>
<p>ä»»åŠ¡é˜Ÿåˆ—ï¼š <code>setInterval`</code>setTimeout 1`</p>
<h2 id="Cycle-2"><a href="#Cycle-2" class="headerlink" title="Cycle 2"></a>Cycle 2</h2><p>5) microtasks é˜Ÿåˆ—æ¸…ç©º <code>setInteval</code> çš„å›è°ƒå¯ä»¥æ‰§è¡Œã€‚å¦ä¸€ä¸ª <code>setInterval</code> è¢«åˆ—ä¸º task , ä½äº <code>setTimeout 1</code>åé¢</p>
<p>ä»»åŠ¡é˜Ÿåˆ—ï¼š <code>setTimeout 1`</code>setInterval`</p>
<h2 id="Cycle-3"><a href="#Cycle-3" class="headerlink" title="Cycle 3"></a>Cycle 3</h2><p>6) microtask é˜Ÿåˆ—æ¸…ç©ºï¼Œ<code>setTimeout 1</code> çš„å›è°ƒå¯ä»¥æ‰§è¡Œï¼Œ<code>promise 3</code> å’Œ <code>promise 4</code> è¢«åˆ—ä¸º microtasks</p>
<p>7)<code>promise 3</code> å’Œ <code>promise 4</code> æ‰§è¡Œã€‚ <code>setTimeout 2</code> è¢«åˆ—ä¸º task</p>
<p>ä»»åŠ¡é˜Ÿåˆ— <code>setInterval`</code>setTimeout 2`</p>
<h2 id="Cycle-4"><a href="#Cycle-4" class="headerlink" title="Cycle 4"></a>Cycle 4</h2><p>8) microtask é˜Ÿåˆ—æ¸…ç©º <code>setInteval</code> çš„å›è°ƒå¯ä»¥æ‰§è¡Œã€‚ç„¶åå¦ä¸€ä¸ª <code>setInterval</code> è¢«åˆ—ä¸º task ï¼Œä½äº <code>setTimeout 2</code> åé¢</p>
<p>ä»»åŠ¡é˜Ÿåˆ—ï¼š <code>setTimeout 2`</code>setInterval`</p>
<p>9)<code>setTimeout 2</code> çš„å›è°ƒæ‰§è¡Œï¼Œ <code>promise 5</code> å’Œ <code>promise 6</code> è¢«åˆ—ä¸º microtasks</p>
<p>ç°åœ¨ <code>promise 5</code> å’Œ <code>promise 6</code> çš„å›è°ƒåº”è¯¥æ‰§è¡Œï¼Œå¹¶ä¸” clear æ‰ <code>interval</code>ã€‚ ä½†æœ‰çš„æ—¶å€™ä¸çŸ¥é“ä¸ºä»€ä¹ˆ <code>setInterval</code> è¿˜ä¼šåœ¨æ‰§è¡Œä¸€éï¼Œå˜æˆä¸‹é¢ç»“æœ</p>
<pre><code>...
setTimeout 2
setInterval
promise 5
promise 6
</code></pre><p>ä½†æ˜¯æŠŠä¸Šé¢çš„ä»£ç æ”¾å…¥ chrome console ä¸­æ‰§è¡Œå´æ²¡æœ‰é—®é¢˜ã€‚è¿™ä¸€ç‚¹è¿˜è¦å†æ ¹æ®ä¸åŒçš„ nodeç‰ˆæœ¬ æŸ¥ä¸€ä¸‹ã€‚</p>
<h2 id="å…³äº-macrotask-å’Œ-microtask"><a href="#å…³äº-macrotask-å’Œ-microtask" class="headerlink" title="å…³äº macrotask å’Œ microtask"></a>å…³äº macrotask å’Œ microtask</h2><p>ç”¨ä¾‹å­ç®€å•ç†è§£äº†ä¸‹ macrotask å’Œ microtask</p>
<p>è¿™é‡Œå†è¯¦ç»†çš„æ€»ç»“ä¸‹ä¸¤è€…çš„åŒºåˆ«å’Œä½¿ç”¨</p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä¸€ä¸ªäº‹ä»¶å¾ªç¯(EventLoop)ä¸­ä¼šæœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡(Task)ï¼Œè€Œè¿™ä¸ªä»»åŠ¡å°±æ˜¯ä» macrotask é˜Ÿåˆ—ä¸­æ¥çš„ã€‚åœ¨<a href="https://link.zhihu.com/?target=https%3A//html.spec.whatwg.org/multipage/webappapis.html%23task-queue" target="_blank" rel="noopener">whatwgè§„èŒƒ</a>ä¸­æœ‰ queue å°±æ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚å½“è¿™ä¸ª macrotask æ‰§è¡Œç»“æŸåæ‰€æœ‰å¯ç”¨çš„ microtask å°†ä¼šåœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œï¼Œå½“è¿™äº› microtask æ‰§è¡Œç»“æŸåè¿˜èƒ½ç»§ç»­æ·»åŠ  microtask ä¸€ç›´åˆ°çœŸä¸ª microtask é˜Ÿåˆ—æ‰§è¡Œç»“æŸã€‚</p>
<h2 id="æ€ä¹ˆç”¨"><a href="#æ€ä¹ˆç”¨" class="headerlink" title="æ€ä¹ˆç”¨"></a>æ€ä¹ˆç”¨</h2><p>åŸºæœ¬æ¥è¯´ï¼Œå½“æˆ‘ä»¬æƒ³ä»¥åŒæ­¥çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥ä»»åŠ¡æ—¶å€™å°±ç”¨ microtaskï¼ˆæ¯”å¦‚æˆ‘ä»¬éœ€è¦ç›´æ¥åœ¨æŸæ®µä»£ç åå°±å»æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œå°±åƒPromiseä¸€æ ·ï¼‰ã€‚</p>
<p>å…¶ä»–æƒ…å†µå°±ç›´æ¥ç”¨ macrotaskã€‚</p>
<h2 id="ä¸¤è€…çš„å…·ä½“å®ç°"><a href="#ä¸¤è€…çš„å…·ä½“å®ç°" class="headerlink" title="ä¸¤è€…çš„å…·ä½“å®ç°"></a>ä¸¤è€…çš„å…·ä½“å®ç°</h2><ul>
<li>macrotasks: setTimeout setInterval setImmediate I/O UIæ¸²æŸ“</li>
<li>microtasks: Promise process.nextTick Object.observe MutationObserver</li>
</ul>
<h2 id="ä»è§„èŒƒä¸­ç†è§£"><a href="#ä»è§„èŒƒä¸­ç†è§£" class="headerlink" title="ä»è§„èŒƒä¸­ç†è§£"></a>ä»è§„èŒƒä¸­ç†è§£</h2><p>whatwgè§„èŒƒï¼š<a href="https://link.zhihu.com/?target=https%3A//html.spec.whatwg.org/multipage/webappapis.html%23task-queue" target="_blank" rel="noopener">https://html.spec.whatwg.org/multipage/webappapis.html#task-queue</a></p>
<ul>
<li>ä¸€ä¸ªäº‹ä»¶å¾ªç¯(event loop)ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—(task queue) task queue å°±æ˜¯ macrotask queue</li>
<li>æ¯ä¸€ä¸ª event loop éƒ½æœ‰ä¸€ä¸ª microtask queue</li>
<li>task queue == macrotask queue != microtask queue</li>
<li>ä¸€ä¸ªä»»åŠ¡ task å¯ä»¥æ”¾å…¥ macrotask queue ä¹Ÿå¯ä»¥æ”¾å…¥ microtask queue ä¸­</li>
<li>å½“ä¸€ä¸ª task è¢«æ”¾å…¥é˜Ÿåˆ— queue(macroæˆ–micro) é‚£è¿™ä¸ª task å°±å¯ä»¥è¢«ç«‹å³æ‰§è¡Œäº†</li>
</ul>
<p>å†æ¥å›é¡¾ä¸‹äº‹ä»¶å¾ªç¯å¦‚ä½•æ‰§è¡Œä¸€ä¸ªä»»åŠ¡çš„æµç¨‹</p>
<p>å½“æ‰§è¡Œæ ˆ(call stack)ä¸ºç©ºçš„æ—¶å€™ï¼Œå¼€å§‹ä¾æ¬¡æ‰§è¡Œï¼š</p>
<ol>
<li>æŠŠæœ€æ—©çš„ä»»åŠ¡(task A)æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—</li>
<li>å¦‚æœ task A ä¸ºnull (é‚£ä»»åŠ¡é˜Ÿåˆ—å°±æ˜¯ç©º)ï¼Œç›´æ¥è·³åˆ°ç¬¬6æ­¥</li>
<li>å°† currently running task è®¾ç½®ä¸º task A</li>
<li>æ‰§è¡Œ task A (ä¹Ÿå°±æ˜¯æ‰§è¡Œå›è°ƒå‡½æ•°)</li>
<li>å°† currently running task è®¾ç½®ä¸º null å¹¶ç§»å‡º task A</li>
<li>æ‰§è¡Œ microtask é˜Ÿåˆ—</li>
</ol>
<ul>
<li>a: åœ¨ microtask ä¸­é€‰å‡ºæœ€æ—©çš„ä»»åŠ¡ task X</li>
<li>b: å¦‚æœ task X ä¸ºnull (é‚£ microtask é˜Ÿåˆ—å°±æ˜¯ç©º)ï¼Œç›´æ¥è·³åˆ° g</li>
<li>c: å°† currently running task è®¾ç½®ä¸º task X</li>
<li>d: æ‰§è¡Œ task X</li>
<li>e: å°† currently running task è®¾ç½®ä¸º null å¹¶ç§»å‡º task X</li>
<li>f: åœ¨ microtask ä¸­é€‰å‡ºæœ€æ—©çš„ä»»åŠ¡ , è·³åˆ° b</li>
<li>g: ç»“æŸ microtask é˜Ÿåˆ—</li>
</ul>
<ol>
<li>è·³åˆ°ç¬¬ä¸€æ­¥</li>
</ol>
<p>ä¸Šé¢å°±ç®—æ˜¯ä¸€ä¸ªç®€å•çš„ event-loop æ‰§è¡Œæ¨¡å‹</p>
<p>å†ç®€å•ç‚¹å¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<ol>
<li>åœ¨ macrotask é˜Ÿåˆ—ä¸­æ‰§è¡Œæœ€æ—©çš„é‚£ä¸ª task ï¼Œç„¶åç§»å‡º</li>
<li>æ‰§è¡Œ microtask é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨çš„ä»»åŠ¡ï¼Œç„¶åç§»å‡º</li>
<li>ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª macrotask ä¸­çš„ä»»åŠ¡ (å†è·³åˆ°ç¬¬2æ­¥)</li>
</ol>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ul>
<li>å½“ä¸€ä¸ªtask(åœ¨ macrotask é˜Ÿåˆ—ä¸­)æ­£å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰æ–°çš„äº‹ä»¶è¢«æ³¨å†Œï¼Œé‚£å°±ä¼šæœ‰æ–°çš„ task è¢«åˆ›å»ºã€‚æ¯”å¦‚ä¸‹é¢ä¸¤ä¸ª</li>
</ul>
<ol>
<li>promiseA.then() çš„å›è°ƒå°±æ˜¯ä¸€ä¸ª task</li>
</ol>
<ul>
<li>promiseA æ˜¯ resolvedæˆ–rejected: é‚£è¿™ä¸ª task å°±ä¼šæ”¾å…¥å½“å‰äº‹ä»¶å¾ªç¯å›åˆçš„ microtask queue</li>
<li>promiseA æ˜¯ pending: è¿™ä¸ª task å°±ä¼šæ”¾å…¥ äº‹ä»¶å¾ªç¯çš„æœªæ¥çš„æŸä¸ª(å¯èƒ½ä¸‹ä¸€ä¸ª)å›åˆçš„ microtask queue ä¸­</li>
<li><p>setTimeout çš„å›è°ƒä¹Ÿæ˜¯ä¸ª task ï¼Œå®ƒä¼šè¢«æ”¾å…¥ macrotask queue å³ä½¿æ˜¯ 0ms çš„æƒ…å†µ</p>
</li>
<li><p>microtask queue ä¸­çš„ task ä¼šåœ¨äº‹ä»¶å¾ªç¯çš„å½“å‰å›åˆä¸­æ‰§è¡Œï¼Œå› æ­¤ macrotask queue ä¸­çš„ task å°±åªèƒ½ç­‰åˆ°äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€ä¸ªå›åˆä¸­æ‰§è¡Œäº†</p>
</li>
<li>click ajax setTimeout çš„å›è°ƒæ˜¯éƒ½æ˜¯ task, åŒæ—¶ï¼ŒåŒ…è£¹åœ¨ä¸€ä¸ª script æ ‡ç­¾ä¸­çš„jsä»£ç ä¹Ÿæ˜¯ä¸€ä¸ª task ç¡®åˆ‡è¯´æ˜¯ macrotaskã€‚</li>
</ul>
<p>ä¸¤è€…çš„å…·ä½“å®ç°</p>
<ul>
<li>macrotasks: setTimeout ï¼ŒsetIntervalï¼Œ setImmediateï¼Œ I/O ï¼ŒUIæ¸²æŸ“ï¼ŒrequestAnimationFrame</li>
<li>microtasks: Promiseï¼Œ process.nextTickï¼Œ Object.observeï¼Œ MutationObserver</li>
</ul>
<p>å†ç®€å•ç‚¹å¯ä»¥æ€»ç»“ä¸ºï¼š<br><img src="https://pic1.zhimg.com/v2-e92a4f5f686d115832b63b9b9e3ac2cd_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-e92a4f5f686d115832b63b9b9e3ac2cd_hd.jpg" alt=""></p>
<ol>
<li>åœ¨ macrotask é˜Ÿåˆ—ä¸­æ‰§è¡Œæœ€æ—©çš„é‚£ä¸ª task ï¼Œç„¶åç§»å‡º</li>
<li>å†æ‰§è¡Œ microtask é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨çš„ä»»åŠ¡ï¼Œç„¶åç§»å‡º</li>
<li>ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª macrotask ä¸­çš„ä»»åŠ¡ (å†è·³åˆ°ç¬¬2æ­¥)</li>
</ol>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸€å…±æœ‰Promiseã€MutationObserverä»¥åŠsetTimeoutä¸‰ç§å°è¯•å¾—åˆ°timerFuncçš„æ–¹æ³•ã€‚<br>ä¼˜å…ˆä½¿ç”¨Promiseï¼Œåœ¨Promiseä¸å­˜åœ¨çš„æƒ…å†µä¸‹ä½¿ç”¨MutationObserverï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„å›è°ƒå‡½æ•°éƒ½ä¼šåœ¨microtaskä¸­æ‰§è¡Œï¼Œå®ƒä»¬ä¼šæ¯”setTimeoutæ›´æ—©æ‰§è¡Œï¼Œæ‰€ä»¥ä¼˜å…ˆä½¿ç”¨ã€‚<br>å¦‚æœä¸Šè¿°ä¸¤ç§æ–¹æ³•éƒ½ä¸æ”¯æŒçš„ç¯å¢ƒåˆ™ä¼šä½¿ç”¨setTimeoutï¼Œåœ¨taskå°¾éƒ¨æ¨å…¥è¿™ä¸ªå‡½æ•°ï¼Œç­‰å¾…è°ƒç”¨æ‰§è¡Œã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦ä¼˜å…ˆä½¿ç”¨microtaskï¼Ÿæˆ‘åœ¨é¡¾è½¶çµåœ¨çŸ¥ä¹çš„å›ç­”ä¸­å­¦ä¹ åˆ°ï¼š</p>
<blockquote>
<p>JS çš„ event loop æ‰§è¡Œæ—¶ä¼šåŒºåˆ† task å’Œ microtaskï¼Œå¼•æ“åœ¨æ¯ä¸ª task æ‰§è¡Œå®Œæ¯•ï¼Œä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ª task æ¥æ‰§è¡Œä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œå®Œæ‰€æœ‰ microtask é˜Ÿåˆ—ä¸­çš„ microtaskã€‚<br>setTimeout å›è°ƒä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ªæ–°çš„ task ä¸­æ‰§è¡Œï¼Œè€Œ Promise çš„ resolverã€ MutationObserver çš„å›è°ƒéƒ½ä¼šè¢«å®‰æ’åˆ°ä¸€ä¸ªæ–°çš„ microtask ä¸­æ‰§è¡Œï¼Œä¼šæ¯” setTimeout äº§ç”Ÿçš„ task å…ˆæ‰§è¡Œã€‚<br>è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ microtaskï¼Œä¼˜å…ˆä½¿ç”¨ Promiseï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒï¼Œå†å°è¯• MutationObserverã€‚<br>å®åœ¨ä¸è¡Œï¼Œåªèƒ½ç”¨ setTimeout åˆ›å»º task äº†ã€‚<br>ä¸ºå•¥è¦ç”¨ microtaskï¼Ÿ<br>æ ¹æ® HTML Standardï¼Œåœ¨æ¯ä¸ª task è¿è¡Œå®Œä»¥åï¼ŒUI éƒ½ä¼šé‡æ¸²æŸ“ï¼Œé‚£ä¹ˆåœ¨ microtask ä¸­å°±å®Œæˆæ•°æ®æ›´æ–°ï¼Œå½“å‰ task ç»“æŸå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„ UI äº†ã€‚<br>åä¹‹å¦‚æœæ–°å»ºä¸€ä¸ª task æ¥åšæ•°æ®æ›´æ–°ï¼Œé‚£ä¹ˆæ¸²æŸ“å°±ä¼šè¿›è¡Œä¸¤æ¬¡ã€‚</p>
</blockquote>
<p>é¦–å…ˆæ˜¯Promiseï¼Œ(Promise.resolve()).then()å¯ä»¥åœ¨microtaskä¸­åŠ å…¥å®ƒçš„å›è°ƒï¼Œ</p>
<p>MutationObserveræ–°å»ºä¸€ä¸ªtextNodeçš„DOMå¯¹è±¡ï¼Œç”¨MutationObserverç»‘å®šè¯¥DOMå¹¶æŒ‡å®šå›è°ƒå‡½æ•°ï¼Œåœ¨DOMå˜åŒ–çš„æ—¶å€™åˆ™ä¼šè§¦å‘å›è°ƒ,è¯¥å›è°ƒä¼šè¿›å…¥microtaskï¼Œå³textNode.data = String(counter)æ—¶ä¾¿ä¼šåŠ å…¥è¯¥å›è°ƒã€‚</p>
<p>setTimeoutæ˜¯æœ€åçš„ä¸€ç§å¤‡é€‰æ–¹æ¡ˆï¼Œå¹¶ä¸”é»˜è®¤æœ‰4mså»¶æ—¶ï¼ŒsetTimeoutå»¶æ—¶0ä¸ä¼šè€è€å®å®ç«‹å³æ‰§è¡Œï¼š</p>
<pre><code>setTimeout(function(){
    console.log(&quot;æˆ‘ä¸æ˜¯ç«‹å³æ‰§è¡Œçš„,ä¸€èˆ¬æˆ‘ä¼šå»¶æ—¶4ms,å“ˆå“ˆ&quot;);
},0);
</code></pre><p>å®ƒä¼šå°†å›è°ƒå‡½æ•°åŠ å…¥taskä¸­ï¼Œç­‰åˆ°æ‰§è¡Œã€‚<br><img src="https://pic2.zhimg.com/v2-59cf9f88d7daac690d39edfb9fffc8b8_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-59cf9f88d7daac690d39edfb9fffc8b8_hd.jpg" alt=""></p>
<pre><code>setTimeout(function(){console.log(4)},0);
new Promise(function(resolve){
    console.log(1)
    for( var i=0 ; i&lt;10000 ; i++ ){
        i==9999 &amp;&amp; resolve()
    }
    console.log(2)
}).then(function(){
    console.log(5)
});
console.log(3);
ç»“æœæ˜¯ï¼š
1,2,3,5,4
</code></pre><p>å†çœ‹è¿™ä¸ªï¼Œä¸¤ä¸ªè‡ªæ‰§è¡ŒåŒæ—¶æ‰§è¡Œï¼š</p>
<pre><code>&lt;script&gt;
(function test() {
  setTimeout(function () {
    console.log(4)
  }, 0);
  new Promise(function executor (resolve) {
    console.log(1);
    for(var i = 0; i &lt; 10000; i++) {
      i == 9999 &amp;&amp; resolve();
    }
    console.log(2);
  }).then(function() {
    console.log(5);
  });
  console.log(3);
})()

(function test2() {
  setTimeout(function () {
    console.log(42)
  }, 0);
  new Promise(function executor (resolve) {
    console.log(12);
    for(var i = 0; i &lt; 10000; i++) {
      i == 9999 &amp;&amp; resolve();
    }
    console.log(22);
  }).then(function() {
    console.log(52);
  });
  console.log(32);
})()
&lt;/script&gt;
</code></pre><p><img src="https://pic2.zhimg.com/v2-cd18c572eb05069895ede7e34388bb8d_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-cd18c572eb05069895ede7e34388bb8d_hd.jpg" alt=""><img src="https://pic3.zhimg.com/v2-afcb6fa6fb862818359f757107b769ab_b.jpg" alt=""><br>æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€ä¸ª main thread ã€<a href="https://link.zhihu.com/?target=http%3A//www.baidu.com/link%3Furl%3DCV-egCVH8yK1w-ilUqGsztryG8s2mbuhAliIC_L1n_-BSZ_KJ16tAfaNkmbcRtU8" target="_blank" rel="noopener">ä¸»çº¿ç¨‹</a>ã€‘ ï¼Œä½†å¹¶ä¸æ„å‘³ç€å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªè‡ªæ‰§è¡Œåå†æ‰§è¡Œç¬¬äºŒä¸ªï¼Œå› ä¸ºä¸¤ä¸ªè‡ªæ‰§è¡Œä¸­çš„<code>setTimeout</code>è¿›å…¥çš„æ˜¯åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ç­‰å¾…ï¼Œå› æ­¤ä»–ä¿©åœ¨æœ€ååˆ†åˆ«è¾“å‡ºäº†äº† 4 å’Œ 42ã€‚</p>
<p>å½“ä¸€ä¸ªç¨‹åºæœ‰ï¼šsetTimeoutï¼Œ setInterval ï¼ŒsetImmediateï¼Œ I/Oï¼Œ UIæ¸²æŸ“ï¼ŒPromise ï¼Œprocess.nextTickï¼Œ Object.observeï¼Œ MutationObserverçš„æ—¶å€™ï¼š</p>
<p>1.å…ˆæ‰§è¡Œ macrotasksï¼šI/O -ã€‹ UIæ¸²æŸ“</p>
<p>2.å†æ‰§è¡Œ microtasks ï¼šprocess.nextTick -ã€‹ Promise -ã€‹MutationObserver -&gt;Object.observe</p>
<p>3.å†æŠŠsetTimeout setInterval setImmediate å¡å…¥ä¸€ä¸ªæ–°çš„macrotasksï¼Œä¾æ¬¡ï¼š</p>
<p>setTimeout ï¼ŒsetInterval â€“ã€‹setImmediate</p>
<p>ç»¼ä¸Šï¼ŒnextTickçš„ç›®çš„å°±æ˜¯äº§ç”Ÿä¸€ä¸ªå›è°ƒå‡½æ•°åŠ å…¥taskæˆ–è€…microtaskä¸­ï¼Œå½“å‰æ ˆæ‰§è¡Œå®Œä»¥åï¼ˆå¯èƒ½ä¸­é—´è¿˜æœ‰åˆ«çš„æ’åœ¨å‰é¢çš„å‡½æ•°ï¼‰è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œèµ·åˆ°äº†å¼‚æ­¥è§¦å‘ï¼ˆå³ä¸‹ä¸€ä¸ªtickæ—¶è§¦å‘ï¼‰çš„ç›®çš„ã€‚</p>
<pre><code>setImmediate(function(){
    console.log(1);
},0);
setTimeout(function(){
    console.log(2);
},0);
new Promise(function(resolve){
    console.log(3);
    resolve();
    console.log(4);
}).then(function(){
    console.log(5);
});
console.log(6);
process.nextTick(function(){
    console.log(7);
});
console.log(8);
ç»“æœæ˜¯ï¼š3 4 6 8 7 5 2 1 
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/01/ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€.../">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/01/ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€.../" itemprop="url">ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€....</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-06-01T18:35:10+08:00">
                2018-06-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€â€¦"><a href="#ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€â€¦" class="headerlink" title="ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€â€¦"></a><a href="https://zhuanlan.zhihu.com/p/30621272" target="_blank" rel="noopener">ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€â€¦</a></h2><p>æˆ‘ä»¬åœ¨é¢è¯•çš„æ—¶å€™æˆ–è®¸ç»å¸¸ä¼šè¢«é—®åˆ°ï¼š</p>
<blockquote>
<p>ä»ä½ åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªç½‘å€åˆ°ç½‘é¡µå†…å®¹å®Œå…¨è¢«å±•ç¤ºçš„è¿™æ®µæ—¶é—´å†…ï¼Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p>
</blockquote>
<p>ç¡®å®æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œä½†é—®é¢˜çš„ç­”æ¡ˆå¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œæˆ–è®¸åœ¨ä¸‰äº”å¹´å‰ï¼Œè¿™ä¸ªé—®é¢˜è¿˜ä¼šæœ‰ä¸€ä¸ªã€Œç›¸å¯¹ã€æ ‡å‡†çš„ç­”æ¡ˆã€‚</p>
<ol>
<li>æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚æ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œé¦–å…ˆè¦åˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯å¦ä¸ºåˆæ³•æˆ–åˆç†çš„ URL åœ°å€ï¼Œæ˜¯å¦ä¸º HTTP åè®®è¯·æ±‚ï¼Œå¦‚æœæ˜¯é‚£å°±è¿›å…¥ä¸‹ä¸€æ­¥</li>
<li>æµè§ˆå™¨çš„æµè§ˆå™¨å¼•æ“å°†å¯¹æ­¤ URL è¿›è¡Œåˆ†æåŠ è½½</li>
<li>é€šè¿‡ DNS è§£æåŸŸåè·å–è¯¥ç½‘ç«™åœ°å€å¯¹åº”çš„ IP åœ°å€ï¼ŒæŸ¥è¯¢å®Œæˆåè¿åŒæµè§ˆå™¨çš„ Cookieã€ userAgent ç­‰ä¿¡æ¯å‘ç½‘ç«™ç›®çš„ IP å‘å‡º GET è¯·æ±‚ã€‚</li>
<li>æ¥ä¸‹æ¥å°±æ˜¯ç»å…¸çš„ã€Œä¸‰æ¬¡æ¡æ‰‹ã€ï¼ŒHTTP åè®®ä¼šè¯ï¼Œæµè§ˆå™¨å®¢æˆ·ç«¯å‘ Web æœåŠ¡å™¨å‘é€æŠ¥æ–‡ï¼Œè¿›è¡Œé€šè®¯å’Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>è¿›å…¥ç½‘ç«™çš„åç«¯æœåŠ¡ï¼Œå¦‚ Tomcatã€Apache ç­‰ï¼Œè¿˜æœ‰è¿‘å‡ å¹´æµè¡Œçš„ Node.js æœåŠ¡å™¨ï¼Œè¿™äº›æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç€åº”ç”¨ä»£ç ï¼Œè¯­è¨€æœ‰å¾ˆå¤šï¼Œå¦‚ Javaã€ PHPã€ C++ã€ C# å’Œ Javascript ç­‰ã€‚</li>
<li>æœåŠ¡å™¨æ ¹æ® URL æ‰§è¡Œç›¸åº”çš„åç«¯åº”ç”¨é€»è¾‘ï¼Œæ•´ç†æ•°æ®ç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„ HTML æ•°æ®è¿”å›ç»™æµè§ˆå™¨ï¼ŒæœŸé—´ä¼šä½¿ç”¨åˆ°ã€ŒæœåŠ¡å™¨ç¼“å­˜ã€æˆ–ã€Œæ•°æ®åº“ã€å†…çš„å†…å®¹ã€‚</li>
<li>æµè§ˆå™¨æ¥æ”¶åˆ°è¿”å›ä¿¡æ¯åå…ˆåˆ¤è¯»æ­¤ HTML æ–‡ä»¶æ˜¯å¦å­˜åœ¨æœ¬åœ°ç¼“å­˜ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–ä¸å¯ç”¨ï¼Œåˆ™ä¸‹è½½æ­¤ HTML æ–‡ä»¶ï¼ˆ200çŠ¶æ€ç ï¼‰ï¼Œå¦‚æœå¯ç”¨ï¼ˆæœªè¿‡æœŸï¼‰ï¼Œåˆ™èµ°æµè§ˆå™¨ç¼“å­˜ï¼ˆ304è¿”å›ç ï¼‰ã€‚ã€Œå¼ºç¼“å­˜ï¼ˆ200è¿”å›ç ï¼‰ä¸åœ¨è€ƒè™‘èŒƒå›´ã€</li>
<li>æµè§ˆå™¨çš„æ¸²æŸ“å¼•æ“åœ¨æ‹¿åˆ° HTML æ–‡ä»¶åï¼Œä¾¿å¼€å§‹è§£ææ„å»º DOM æ•°ï¼Œå¹¶æ ¹æ® HTML ä¸­çš„æ ‡è®°è¯·æ±‚ä¸‹è½½æŒ‡å®šçš„ MIME ç±»å‹æ–‡ä»¶ï¼ˆå¦‚ CSSã€ JavaScript è„šæœ¬ç­‰ï¼‰ï¼ŒåŒæ—¶ä½¿ç”¨&amp;è®¾ç½®ç¼“å­˜ç­‰å†…å®¹ã€‚</li>
<li>æ¸²æŸ“å¼•æ“æ ¹æ® CSS æ ·å¼è§„åˆ™å°† DOM æ ‘æ‰©å……ä¸ºæ¸²æŸ“æ ‘ï¼Œç„¶åè¿›è¡Œé‡æ’ã€é‡ç»˜ã€‚</li>
<li>å¦‚æœå«æœ‰ JS æ–‡ä»¶å°†ä¼šæ‰§è¡Œï¼Œè¿›è¡Œ Dom æ“ä½œã€ç¼“å­˜è¯»å­˜ã€æ—¶é—´ç»‘å®šç­‰æ“ä½œã€‚æœ€ç»ˆé¡µé¢å°†è¢«å±•ç¤ºåœ¨æµè§ˆå™¨ä¸Šã€‚</li>
</ol>
<p>æ­¤ç­”æ¡ˆç²¾ç®€çš„æ¦‚æ‹¬äº†ã€Œåç«¯ä¸ºä¸»çš„ MVC æ¨¡å¼ã€åŠæ—©æœŸ Web åº”ç”¨çš„æµè§ˆå™¨ç›¸åº”çš„å…¨è¿‡ç¨‹ã€‚é‚£ï¼Œå‰ç«¯æŠ€æœ¯å‘å±•åˆ°ç°åœ¨ï¼Œã€Œå‰åç«¯åˆ†ç¦»ã€ã€Œä¸­é—´ä»¶ç›´å‡ºã€å’Œã€ŒMNV*æ¨¡å¼ã€ä¹Ÿå·²é—®ä¸–ï¼Œå†è°ˆåŠæ­¤é—®é¢˜ï¼Œç­”æ¡ˆä¼šæœ‰ä¸åŒã€‚</p>
<p>å°±ä»¥ã€Œå‰åç«¯åˆ†ç¦»ã€ä¸ºä¾‹ï¼Œåœ¨ä¸Šæ–¹ç­”æ¡ˆçš„ç¬¬4æ­¥åï¼Œç´§æ¥ç€å°±ä¸ä¼šç›´æ¥è¿›å…¥åç«¯æœåŠ¡å™¨äº†ã€‚è€Œä¼šè¢« HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¦‚ Ngnixï¼Œä»£æ›¿ã€‚</p>
<ul>
<li>å‰ç½®æ­¥éª¤1ã€2ã€3ã€4</li>
<li>Ngnix åœ¨æ¥æ”¶åˆ° HTTPï¼ˆ80ç«¯å£ï¼‰æˆ– HTTPSï¼ˆ443ç«¯å£ï¼‰åï¼Œæ ¹æ® URL åšæœåŠ¡å™¨åˆ†å‘ï¼Œåˆ†å‘ï¼ˆrewriteï¼‰åˆ°åç«¯æœåŠ¡å™¨æˆ–é™æ€èµ„æºæœåŠ¡å™¨ï¼Œé¦–é¡µè¯·æ±‚åŸºæœ¬æ˜¯é™æ€æœåŠ¡å™¨ï¼Œè¿”å›ä¸€ä¸ªé™æ€çš„ HTML æ–‡ä»¶</li>
<li>æ­¥éª¤7ã€8ã€9</li>
<li>æ‰§è¡Œ JS è„šæœ¬ï¼Œå¼‚æ­¥ ajaxã€ fetch å‘èµ· POSTã€ GET è¯·æ±‚ï¼Œé‡æ–°è¿›å…¥ Ngnix åˆ†å‘ï¼Œæ­¤æ¬¡åˆ†å‘åˆ°åç«¯æœåŠ¡å™¨ï¼Œæ­¥éª¤5ã€6ï¼Œç„¶åè¿”å›ä¸€ä¸ª xml æˆ– json æ ¼å¼çš„ä¿¡æ¯ï¼Œä¸€èˆ¬å«æœ‰ codeï¼ˆè¿”å›ç ï¼‰ã€resultï¼ˆä¾èµ–ä¿¡æ¯ï¼‰</li>
<li>æœ€åæ ¹æ®è¿”å›ç æ‰§è¡Œä¸åŒçš„ js é€»è¾‘ï¼Œå¢åˆ æ”¹é¡µé¢å…ƒç´ ï¼Œæ­¤æ—¶å¯èƒ½ä¼šå‘ç”Ÿé‡æ’æˆ–é‡æ±‡ã€‚é¦–é¡µåŠ è½½ç»“æŸã€‚</li>
</ul>
<p>ä»¥ä¸Šæ­¥éª¤å¯ä»¥å‘ç°ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šè§¦å‘é‡ç»˜ä¸¤æ¬¡ï¼Œææ˜“å‘ç”Ÿã€Œç™½å±ã€æˆ–ã€Œé¡µé¢æŠ–åŠ¨ã€ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€Œä¸­é—´ä»¶ç›´å‡ºã€çš„æ¨¡å¼åº”è¿è€Œç”Ÿã€‚å¦å¤–ä¸ºäº†æ‰©å……å¤§å‰ç«¯çš„é˜µè¥ï¼Œå¸çº³ IOS å’Œ Androidï¼ŒGoogleåˆè®¾è®¡äº†ã€ŒMNV*æ¨¡å¼ã€ï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯ ReactNativeï¼Œä½†æ­¤æ¨¡å¼å·²ç»è„±ç¦»äº†æµè§ˆå™¨çš„èŒƒç•´ï¼Œæ­¤å¤„å°±ä¸å†åšæ‰©å±•ã€‚</p>
<p>ä»¥ä¸Šè®¨è®ºçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°äº†è¾ƒå¤šçš„æµè§ˆå™¨åŠŸèƒ½ï¼Œå¦‚ç”¨æˆ·åœ°å€æ è¾“å…¥æ¡†ã€ç½‘ç»œè¯·æ±‚ã€æµè§ˆå™¨æ–‡æ¡£è§£æã€æ¸²æŸ“å¼•æ“æ¸²æŸ“ç½‘é¡µã€ JavaScript å¼•æ“æ‰§è¡Œjsè„šæœ¬ã€å®¢æˆ·ç«¯å­˜å‚¨ç­‰ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸‹æµè§ˆå™¨çš„åŸºæœ¬ç»“æ„ç»„æˆã€‚</p>
<h2 id="æµè§ˆå™¨çš„ç»“æ„ç»„æˆ"><a href="#æµè§ˆå™¨çš„ç»“æ„ç»„æˆ" class="headerlink" title="æµè§ˆå™¨çš„ç»“æ„ç»„æˆ"></a>æµè§ˆå™¨çš„ç»“æ„ç»„æˆ</h2><p>æµè§ˆå™¨ä¸€èˆ¬ç”±ä¸ƒä¸ªæ¨¡å—ç»„æˆï¼ŒUser Interfaceï¼ˆç”¨æˆ·ç•Œé¢ï¼‰ã€Browser engineï¼ˆæµè§ˆå™¨å¼•æ“ï¼‰ã€Rendering engineï¼ˆæ¸²æŸ“å¼•æ“ï¼‰ã€Networkingï¼ˆç½‘ç»œï¼‰ã€JavaScript Interpreterï¼ˆjsè§£é‡Šå™¨ï¼‰ã€UI Backendï¼ˆUI åç«¯ï¼‰ã€Date Persistenceï¼ˆæ•°æ®æŒä¹…åŒ–å­˜å‚¨ï¼‰ å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://pic1.zhimg.com/v2-47101c25a44a21a25f3123a88c623b15_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-47101c25a44a21a25f3123a88c623b15_hd.jpg" alt=""></p>
<ul>
<li>ç”¨æˆ·ç•Œé¢ï¼åŒ…æ‹¬åœ°å€æ ã€åé€€/å‰è¿›æŒ‰é’®ã€ä¹¦ç­¾ç›®å½•ç­‰ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰€çœ‹åˆ°çš„é™¤äº†é¡µé¢æ˜¾ç¤ºçª—å£ä¹‹å¤–çš„å…¶ä»–éƒ¨åˆ†</li>
<li>æµè§ˆå™¨å¼•æ“ï¼å¯ä»¥åœ¨ç”¨æˆ·ç•Œé¢å’Œæ¸²æŸ“å¼•æ“ä¹‹é—´ä¼ é€æŒ‡ä»¤æˆ–åœ¨å®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜ä¸­è¯»å†™æ•°æ®ç­‰ï¼Œæ˜¯æµè§ˆå™¨ä¸­å„ä¸ªéƒ¨åˆ†ä¹‹é—´ç›¸äº’é€šä¿¡çš„æ ¸å¿ƒ</li>
<li>æ¸²æŸ“å¼•æ“ï¼è§£æDOMæ–‡æ¡£å’ŒCSSè§„åˆ™å¹¶å°†å†…å®¹æ’ç‰ˆåˆ°æµè§ˆå™¨ä¸­æ˜¾ç¤ºæœ‰æ ·å¼çš„ç•Œé¢ï¼Œä¹Ÿæœ‰äººç§°ä¹‹ä¸ºæ’ç‰ˆå¼•æ“ï¼Œæˆ‘ä»¬å¸¸è¯´çš„æµè§ˆå™¨å†…æ ¸ä¸»è¦æŒ‡çš„å°±æ˜¯æ¸²æŸ“å¼•æ“</li>
<li>ç½‘ç»œï¼ç”¨æ¥å®Œæˆç½‘ç»œè°ƒç”¨æˆ–èµ„æºä¸‹è½½çš„æ¨¡å—</li>
<li>UI åç«¯ï¼ç”¨æ¥ç»˜åˆ¶åŸºæœ¬çš„æµè§ˆå™¨çª—å£å†…æ§ä»¶ï¼Œå¦‚è¾“å…¥æ¡†ã€æŒ‰é’®ã€å•é€‰æŒ‰é’®ç­‰ï¼Œæ ¹æ®æµè§ˆå™¨ä¸åŒç»˜åˆ¶çš„æ•ˆæœä¹Ÿä¸åŒ</li>
<li>JSè§£é‡Šå™¨ï¼ç”¨æ¥è§£é‡Šæ‰§è¡ŒJSè„šæœ¬çš„æ¨¡å—ï¼Œå¦‚ V8 å¼•æ“</li>
<li>æ•°æ®å­˜å‚¨ï¼æµè§ˆå™¨åœ¨ç¡¬ç›˜ä¸­ä¿å­˜ cookieã€localStorageç­‰å„ç§æ•°æ®ï¼Œå¯é€šè¿‡æµè§ˆå™¨å¼•æ“æä¾›çš„APIè¿›è¡Œè°ƒç”¨</li>
</ul>
<p>ä½œä¸ºå‰ç«¯å¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹ç†è§£æ¸²æŸ“å¼•æ“çš„å·¥ä½œåŸç†ï¼Œçµæ´»åº”ç”¨æ•°æ®å­˜å‚¨æŠ€æœ¯ï¼Œåœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ä¼šç»å¸¸æ¶‰åŠåˆ°è¿™ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå°¤å…¶æ˜¯åœ¨åšé¡¹ç›®æ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œç†è§£æµè§ˆå™¨æ¸²æŸ“å¼•æ“å°¤ä¸ºé‡è¦ã€‚è€Œå…¶ä»–éƒ¨åˆ†åˆ™æ˜¯ç”±å„ç§æµè§ˆå™¨è‡ªè¡Œç®¡ç†çš„ï¼Œå¼€å‘è€…èƒ½æ§åˆ¶çš„åœ°æ–¹è¾ƒå°‘ã€‚ä»Šå¤©æˆ‘ä»¬å°±å›´ç»•è¿™ä¸¤ä¸ªé‡ç‚¹å…¶ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ã€Œæµè§ˆå™¨æ¸²æŸ“å¼•æ“ã€è¿›è¡Œå±•å¼€</p>
<h2 id="æµè§ˆå™¨æ¸²æŸ“å¼•æ“"><a href="#æµè§ˆå™¨æ¸²æŸ“å¼•æ“" class="headerlink" title="æµè§ˆå™¨æ¸²æŸ“å¼•æ“"></a>æµè§ˆå™¨æ¸²æŸ“å¼•æ“</h2><p>æµè§ˆå™¨æ¸²æŸ“å¼•æ“æ˜¯ç”±å„å¤§æµè§ˆå™¨å‚å•†ä¾ç…§ W3C æ ‡å‡†è‡ªè¡Œå®ç°çš„ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºã€Œæµè§ˆå™¨å†…æ ¸ã€ã€‚</p>
<p>ç›®å‰ï¼Œå¸‚é¢ä¸Šä½¿ç”¨çš„ä¸»æµæµè§ˆå™¨å†…æ ¸æœ‰5ç±»ï¼šTridentã€Geckoã€Prestoã€Webkitã€Blinkã€‚</p>
<p>Tridentï¼šä¿—ç§° IE å†…æ ¸ï¼Œä¹Ÿè¢«å«åš MSHTML å¼•æ“ï¼Œç›®å‰åœ¨ä½¿ç”¨çš„æµè§ˆå™¨ä¸º IE11-ï¼Œä»¥åŠå„ç§å›½äº§å¤šæ ¸æµè§ˆå™¨ä¸­çš„IEå…¼å®¹æ¨¡å¼ã€‚å¦å¤–Edge æµè§ˆå™¨ä¸å†ä½¿ç”¨ MSHTML å¼•æ“ï¼Œè€Œæ˜¯ä½¿ç”¨ç±»å…¨æ–°çš„å¼•æ“ EdgeHTMLã€‚</p>
<p>Geckoï¼šä¿—ç§° Firefox å†…æ ¸ï¼ŒNetscape6å¼€å§‹é‡‡ç”¨çš„å†…æ ¸ï¼Œåæ¥çš„Mozilla FireFox(ç«ç‹æµè§ˆå™¨) ä¹Ÿé‡‡ç”¨äº†è¯¥å†…æ ¸ï¼ŒGeckoçš„ç‰¹ç‚¹æ˜¯ä»£ç å®Œå…¨å…¬å¼€ï¼Œå› æ­¤ï¼Œå…¶å¯å¼€å‘ç¨‹åº¦å¾ˆé«˜ï¼Œå…¨ä¸–ç•Œçš„ç¨‹åºå‘˜éƒ½å¯ä»¥ä¸ºå…¶ç¼–å†™ä»£ç ï¼Œå¢åŠ åŠŸèƒ½ã€‚å› ä¸ºè¿™æ˜¯ä¸ªå¼€æºå†…æ ¸ï¼Œå› æ­¤å—åˆ°è®¸å¤šäººçš„é’çï¼ŒGeckoå†…æ ¸çš„æµè§ˆå™¨ä¹Ÿå¾ˆå¤šï¼Œè¿™ä¹Ÿæ˜¯Geckoå†…æ ¸è™½ç„¶å¹´è½»ä½†å¸‚åœºå æœ‰ç‡èƒ½å¤Ÿè¿…é€Ÿæé«˜çš„é‡è¦åŸå› ã€‚</p>
<p>Prestoï¼šOpera å‰å†…æ ¸ï¼Œä¸ºå•¥è¯´æ˜¯å‰å†…æ ¸å‘¢ï¼Ÿå› ä¸º Opera12.17 ä»¥åä¾¿æ‹¥æŠ±äº† Google Chrome çš„ Blink å†…æ ¸ï¼Œæ­¤å†…æ ¸å°±æ²¡äº†å¯„æ‰˜</p>
<p>Webkitï¼šSafari å†…æ ¸ä¹Ÿæ˜¯ Chrome å†…æ ¸åŸå‹ï¼Œä¸»è¦æ˜¯ Safari æµè§ˆå™¨åœ¨ä½¿ç”¨çš„å†…æ ¸ï¼Œä¹Ÿæ˜¯ç‰¹æ€§ä¸Šè¡¨ç°è¾ƒå¥½çš„æµè§ˆå™¨å†…æ ¸ã€‚ä¹Ÿè¢«å¤§é‡ä½¿ç”¨åœ¨ç§»åŠ¨ç«¯æµè§ˆå™¨ä¸Šã€‚</p>
<p>Blinkï¼š ç”±Googleå’ŒOpera Softwareå¼€å‘çš„æµè§ˆå™¨æ’ç‰ˆå¼•æ“ï¼Œåœ¨Chromeï¼ˆ28åŠå¾€åç‰ˆæœ¬ï¼‰ã€Operaï¼ˆ15åŠå¾€åç‰ˆæœ¬ï¼‰å’ŒYandexæµè§ˆå™¨ ä¸­ä½¿ç”¨ã€‚Blink å…¶å®æ˜¯ WebKit çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæ·»åŠ äº†ä¸€äº›ä¼˜åŒ–çš„æ–°ç‰¹æ€§ï¼Œä¾‹å¦‚è·¨è¿›ç¨‹çš„ iframeï¼Œå°† DOM ç§»å…¥ JavaScript ä¸­æ¥æé«˜ JavaScript å¯¹ DOM çš„è®¿é—®é€Ÿåº¦ç­‰ï¼Œç›®å‰è¾ƒå¤šçš„ç§»åŠ¨ç«¯åº”ç”¨å†…åµŒçš„æµè§ˆå™¨å†…æ ¸ä¹Ÿæ¸æ¸å¼€å§‹é‡‡ç”¨ Blinkã€‚</p>
<h2 id="æ¸²æŸ“å¼•æ“çš„å·¥ä½œæµç¨‹"><a href="#æ¸²æŸ“å¼•æ“çš„å·¥ä½œæµç¨‹" class="headerlink" title="æ¸²æŸ“å¼•æ“çš„å·¥ä½œæµç¨‹"></a>æ¸²æŸ“å¼•æ“çš„å·¥ä½œæµç¨‹</h2><p>æµè§ˆå™¨æ¸²æŸ“å¼•æ“é‡è¦çš„å·¥ä½œå°±æ˜¯å°† HTML å’Œ CSS æ–‡æ¡£è§£æç»„åˆæœ€ç»ˆæ¸²æŸ“åˆ°æµè§ˆå™¨çª—å£ä¸Šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¸²æŸ“å¼•æ“åœ¨æ¥å—åˆ° HTML æ–‡ä»¶åä¸»è¦è¿›è¡Œäº†ä»¥ä¸‹æ“ä½œï¼šè§£æ HTML æ„å»º DOM æ ‘ -&gt; æ„å»ºæ¸²æŸ“æ ‘ -&gt; æ¸²æŸ“æ ‘å¸ƒå±€ -&gt; æ¸²æŸ“æ ‘ç»˜åˆ¶ã€‚</p>
<p><img src="https://pic2.zhimg.com/v2-898d192f36fcc9c8843ec9d89f112bde_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-898d192f36fcc9c8843ec9d89f112bde_hd.jpg" alt=""></p>
<p>è§£æ HTML æ„å»º DOM æ ‘æ—¶æ¸²æŸ“å¼•æ“ä¼šå°† HTML æ–‡ä»¶çš„ä¾¿ç­¾å…ƒç´ è§£ææˆå¤šä¸ª DOM å…ƒç´ å¯¹è±¡èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†è¿™äº›å¯¹è±¡æ ¹æ®çˆ¶å­å…³ç³»ç»„æˆä¸€ä¸ªæ ‘ç»“æ„ã€‚åŒæ—¶ CSS æ–‡ä»¶è¢«è§£ææˆ CSSè§„åˆ™è¡¨ï¼Œç„¶åå°†æ¯æ¡ CSS è§„åˆ™æŒ‰ç…§ã€Œä»å³å‘å·¦ã€çš„æ–¹å¼åœ¨ DOM æ ‘ä¸Šè¿›è¡Œé€†å‘åŒ¹é…ï¼Œç”Ÿæˆä¸€ä¸ªå…·æœ‰æ ·å¼è§„åˆ™æè¿°çš„ DOM æ¸²æŸ“æ ‘ã€‚æ¥ä¸‹æ¥å°±æ˜¯å°†æ¸²æŸ“æ ‘è¿›è¡Œå¸ƒå±€ã€ç»˜åˆ¶çš„è¿‡ç¨‹ã€‚é¦–å…ˆæ ¹æ® DOM æ¸²æŸ“æ ‘ä¸Šçš„æ ·å¼è§„åˆ™ï¼Œå¯¹ DOM å…ƒç´ è¿›è¡Œå¤§å°å’Œä½ç½®çš„å®šä½ï¼Œå…³é”®å±æ€§å¦‚<code>position;width;margin;padding;top;border;...</code>ï¼Œæ¥ä¸‹æ¥åœ¨æ ¹æ®å…ƒç´ æ ·å¼è§„åˆ™ä¸­çš„<code>color;background;shadow;...</code>è§„åˆ™è¿›è¡Œ DOM çš„ç»˜åˆ¶ã€‚</p>
<p>å¦å¤–ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€æ­¥å®Œæˆçš„ï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œæ¸²æŸ“å¼•æ“å°†ä¼šå°½å¯èƒ½æ—©çš„å°†å†…å®¹å‘ˆç°åˆ°å±å¹•ä¸Šï¼Œå¹¶ä¸ä¼šç­‰åˆ°æ‰€æœ‰çš„htmléƒ½è§£æå®Œæˆä¹‹åå†å»æ„å»ºå’Œå¸ƒå±€renderæ ‘ã€‚å®ƒæ˜¯è§£æå®Œä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¾ç¤ºä¸€éƒ¨åˆ†å†…å®¹ï¼ŒåŒæ—¶ï¼Œå¯èƒ½è¿˜åœ¨é€šè¿‡ç½‘ç»œä¸‹è½½å…¶ä½™å†…å®¹ã€‚</p>
<p>å†è€…ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨æ¸²æŸ“å®Œé¦–å±é¡µé¢åï¼Œå¦‚æœå¯¹ DOM è¿›è¡Œæ“ä½œä¼šå¼•èµ·æµè§ˆå™¨å¼•æ“å¯¹ DOM æ¸²æŸ“æ ‘çš„é‡æ–°å¸ƒå±€å’Œé‡æ–°ç»˜åˆ¶ï¼Œæˆ‘ä»¬å«åšã€Œé‡æ’ã€å’Œã€Œé‡ç»˜ã€ï¼Œç”±äºé‡æ’å’Œé‡ç»˜æ˜¯å‰åä¾èµ–çš„å…³ç³»ï¼Œæ‰€ä»¥é‡ç»˜å‘ç”Ÿæ—¶æœªå¿…ä¼šè§¦å‘æ¸²æŸ“å¼•æ“çš„é‡æ’ï¼Œä½†æ˜¯å¦‚æœå‘ç”Ÿäº†é‡æ’å°±å¿…ç„¶ä¼šè§¦å‘é‡ç»˜æ“ä½œï¼Œè¿™æ ·å¸¦æ¥çš„æ€§èƒ½æŸå®³å°±æ˜¯å·¨å¤§çš„ã€‚å› æ­¤æˆ‘ä»¬åœ¨åšæ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™åº”è¯¥éµå¾ªã€Œé¿å…é‡æ’ï¼›å‡å°‘é‡ç»˜ã€çš„åŸåˆ™ã€‚</p>
<h2 id="ä¸åŒæµè§ˆå™¨å†…æ ¸é—´çš„å·®å¼‚"><a href="#ä¸åŒæµè§ˆå™¨å†…æ ¸é—´çš„å·®å¼‚" class="headerlink" title="ä¸åŒæµè§ˆå™¨å†…æ ¸é—´çš„å·®å¼‚"></a>ä¸åŒæµè§ˆå™¨å†…æ ¸é—´çš„å·®å¼‚</h2><p>åœ¨ä¸åŒçš„æµè§ˆå™¨å†…æ ¸ä¸‹ï¼Œ æµè§ˆå™¨é¡µé¢æ¸²æŸ“çš„æµç¨‹ç•¥æœ‰ä¸åŒ</p>
<p><img src="https://pic2.zhimg.com/v2-d29985fb1443ee3dc499a2b974f52c0e_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-d29985fb1443ee3dc499a2b974f52c0e_hd.jpg" alt=""></p>
<p><img src="https://pic2.zhimg.com/v2-17090b8745e504fd6877dfa6f5950422_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-17090b8745e504fd6877dfa6f5950422_hd.jpg" alt=""></p>
<p>ä¸Šé¢ä¸¤å¹…å›¾åˆ†åˆ«æ˜¯ Webkit å’Œ Geoko å†…æ ¸æ¸²æŸ“ DOM çš„å·¥ä½œæµç¨‹ï¼Œå¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼Œä¸¤è€…æµç¨‹çš„åŒºåˆ«ä¸»è¦åœ¨äº CSS æ ·å¼è¡¨çš„è§£ææ—¶æœºï¼ŒWebkit å†…æ ¸ä¸‹ï¼ŒHTML å’Œ CSS æ–‡ä»¶çš„è§£ææ˜¯åŒæ­¥çš„ï¼Œè€Œ Geoko å†…æ ¸ä¸‹ï¼ŒCSS æ–‡ä»¶éœ€è¦ç­‰åˆ° HTML æ–‡ä»¶è§£ææˆå†…å®¹ Sink åæ‰è¿›è¡Œè§£æã€‚</p>
<p>å¦å¤–ä¸¤è€…çš„ä¸åŒè¿˜æœ‰æè¿°æœ¯è¯­ï¼Œé™¤æ­¤ä¹‹å¤–ä¸¤è€…çš„æµç¨‹å°±åŸºæœ¬ç›¸åŒäº†ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸‰ä¸ªéƒ¨åˆ†å°±æ˜¯ ã€ŒHTML çš„è§£æã€ã€ŒCSS çš„è§£æã€ã€Œæ¸²æŸ“æ ‘çš„ç”Ÿæˆã€ã€‚è¿™ä¸‰ä¸ªéƒ¨åˆ†çš„åŸç†å†…å®¹å°±æ¯”è¾ƒæ·±ï¼Œæ¶‰åŠåˆ°ã€Œè¯æ³•åˆ†æã€ã€Œè¯­æ³•åˆ†æã€ã€Œè½¬æ¢ã€ã€Œè§£é‡Šã€ç­‰æ•°æ®ç»“æ„çš„å†…å®¹ï¼Œæ¯”è¾ƒæ¯ç‡¥ï¼Œä¸€èˆ¬æˆ‘ä»¬äº†è§£åˆ°è¿™é‡Œå°±å¤Ÿäº†ï¼Œä¸è¿‡æƒ³æ·±å…¥äº†è§£çš„åŒå­¦å¯ä»¥é˜…è¯»æ­¤ç¯‡è¯‘æ–‡ï¼Œ<a href="https://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttp%253A%252F%252Fblog.csdn.net%252Fu010794365%252Farticle%252Fdetails%252F77982768" target="_blank" rel="noopener">æµè§ˆå™¨çš„å·¥ä½œåŸç†</a>ï¼Œé‡Œé¢è¯¦ç»†çš„è§£é‡Šäº†ä»¥ä¸Šä¸‰ä¸ªéƒ¨åˆ†çš„æµç¨‹å’Œå…³ç³»ã€‚æ­¤å¤„å°±ä¸å†å¤šåšèµ˜è¿°äº†ã€‚</p>
<h2 id="å…³äº-CSS-è§„åˆ™çš„åŒ¹é…"><a href="#å…³äº-CSS-è§„åˆ™çš„åŒ¹é…" class="headerlink" title="å…³äº CSS è§„åˆ™çš„åŒ¹é…"></a>å…³äº CSS è§„åˆ™çš„åŒ¹é…</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œ CSS è§„åˆ™æ˜¯æŒ‰ç…§ã€Œä»å³å‘å·¦ã€çš„æ–¹å¼åœ¨ DOM æ ‘ä¸Šè¿›è¡Œé€†å‘åŒ¹é…çš„ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå…·æœ‰æ ·å¼è§„åˆ™æè¿°çš„ DOM æ¸²æŸ“æ ‘ã€‚</p>
<p>ä½†æ˜¯ä½ çŸ¥é“ä¸ºä»€ä¹ˆè¦ã€Œä»å³å‘å·¦ã€åšé€†å‘åŒ¹é…ç ï¼Ÿ</p>
<p>æˆ‘ä»¬é‡æ–°å›åˆ°ã€webkit å†…æ ¸å·¥ä½œæµç¨‹ã€‘å›¾</p>
<p><img src="https://pic2.zhimg.com/v2-d29985fb1443ee3dc499a2b974f52c0e_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-d29985fb1443ee3dc499a2b974f52c0e_hd.jpg" alt=""></p>
<p>CSS è§„åˆ™åŒ¹é…æ˜¯å‘ç”Ÿåœ¨webkitå¼•æ“çš„ã€ŒAttachmentã€è¿‡ç¨‹ä¸­ï¼Œæµè§ˆå™¨è¦ä¸ºæ¯ä¸ª DOM Tree ä¸­çš„å…ƒç´ æ‰©å…… CSS æ ·å¼è§„åˆ™ï¼ˆåŒ¹é… Style Rulesï¼‰ã€‚å¯¹äºæ¯ä¸ª DOM å…ƒç´ ï¼Œå¿…é¡»åœ¨æ‰€æœ‰ Style Rules ä¸­æ‰¾åˆ°ç¬¦åˆçš„ selector å¹¶å°†å¯¹åº”çš„è§„åˆ™è¿›è¡Œåˆå¹¶ã€‚é€‰æ‹©å™¨çš„ã€Œè§£æã€å®é™…æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ï¼Œåœ¨éå† DOM Tree æ—¶ï¼Œä» Style Rules ä¸­å»å¯»æ‰¾å¯¹åº”çš„ selectorã€‚</p>
<p>æˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªæœ€ç®€å•çš„æ —å­ï¼š</p>
<pre><code>&lt;template&gt;
&lt;div&gt;
  &lt;div class=&quot;t&quot;&gt;
    &lt;span&gt;test&lt;/span&gt;
    &lt;p&gt;test&lt;/p&gt;
  &lt;div&gt;
&lt;/div&gt;
&lt;/template&gt;

&lt;style&gt;
div{ color: #000; }
div .t span{ color: red; }
div .t p{color: blue; }
&lt;/style&gt;
</code></pre><p>æ­¤å¤„æˆ‘ä»¬æœ‰ä¸€ä¸ª html å…ƒç´  å’Œä¸€ä¸ª style å…ƒç´ ï¼Œä¸¤è€…éœ€è¦åšéå†åŒ¹é…</p>
<p><img src="https://pic1.zhimg.com/v2-727bdb01745d4f9692a5f7a8678e62e2_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-727bdb01745d4f9692a5f7a8678e62e2_hd.jpg" alt=""></p>
<p>æ­¤å¤„ä¼šæœ‰ 4*3 ä¸ªåŒ¹é…é¡¹ï¼Œå¦‚æœåšæ­£å‘åŒ¹é…ï¼Œåœ¨é‡åˆ° <code>&lt;span&gt;</code> æ ‡ç­¾åŒ¹é… <code>div .t p{ color: red; }</code>åˆ°åŒ¹é…é¡¹æ—¶ï¼Œæ˜¾ç„¶æ—¶ä¸é€šè¿‡åˆ°ï¼Œè®¡ç®—æœºé¦–å…ˆè¦æ‰¾åˆ°<code>&lt;span&gt;</code> æ ‡ç­¾åˆ°çˆ¶æ ‡ç­¾å’Œç¥–çˆ¶æ ‡ç­¾ï¼Œåˆ¤æ–­ä»–ä»¬æ˜¯å¦æ»¡è¶³<code>div .t</code>çš„è§„åˆ™ï¼Œç„¶ååœ¨åŒ¹é…<code>&lt;span&gt;</code>æ˜¯å¦ä¸º<code>p</code>æ ‡ç­¾ï¼Œæ­¤å¤„åŒ¹é…ä¸æˆåŠŸï¼Œæ­¤å¤„å°±äº§ç”Ÿäº†ä¸‰æ¬¡æµªè´¹ã€‚</p>
<p>å¦‚æœæ—¶é€†å‘åŒ¹é…ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡å¯¹æ¯”<code>&lt;span&gt;</code>æ˜¯å¦ä¸º<code>p</code>æ ‡ç­¾ä¾¿å¯æ’é™¤æ­¤è§„åˆ™ï¼Œæ•ˆç‡æ›´é«˜ã€‚</p>
<p>å¦‚æœå°† HTML ç»“æ„å˜å¤æ‚ï¼ŒCSS è§„åˆ™è¡¨å˜åºå¤§ï¼Œé‚£ä¹ˆï¼Œã€Œé€†å‘åŒ¹é…ã€çš„ä¼˜åŠ¿å°±è¿œå¤§äºã€Œæ­£å‘åŒ¹é…ã€äº†ï¼Œå› ä¸ºåŒ¹é…çš„æƒ…å†µè¿œè¿œä½äºä¸åŒ¹é…çš„æƒ…å†µã€‚åŒæ—¶å¦‚æœåœ¨é€‰æ‹©å™¨ç»“å°¾åŠ ä¸Šé€šé…ç¬¦ã€Œ*ã€ï¼Œé‚£ä¹ˆã€Œé€†å‘åŒ¹é…ã€çš„ä¼˜åŠ¿å°±å¤§æ‰“æŠ˜æ‰£ï¼Œè¿™ä¹Ÿå°±æ˜¯å¾ˆå¤šä¼˜åŒ–åŸåˆ™æåˆ°çš„å°½é‡é¿å…åœ¨é€‰æ‹©å™¨æœ«å°¾æ·»åŠ é€šé…ç¬¦çš„åŸå› ã€‚</p>
<p>æé™äº†æƒ³ï¼Œå¦‚æœæˆ‘ä»¬çš„æ ·å¼è¡¨ä¸å­˜åœ¨åµŒå¥—å…³ç³»ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>&lt;template&gt;
&lt;div&gt;
  &lt;div&gt;
    &lt;span class=&quot;div_t_span&quot;&gt;test&lt;/span&gt;
    &lt;p class=&quot;div_t_p&quot;&gt;test&lt;/p&gt;
  &lt;div&gt;
&lt;/div&gt;
&lt;/template&gt;

&lt;style&gt;
div{ color: #000; }
.div_t_span{ color: red; }
.div_t_p{color: blue; }
&lt;/style
</code></pre><p>é‚£ä¹ˆå¼•æ“çš„ã€ŒAttachmentã€è¿‡ç¨‹å°†å¾—åˆ°æå¤§çš„ç²¾ç®€ï¼Œæ•ˆç‡ä¹Ÿæ˜¯å¯æƒ³è€ŒçŸ¥çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆã€Œå¾®ä¿¡å°ç¨‹åºã€æ ·å¼è¡¨ä¸å»ºè®®ä½¿ç”¨å…³ç³»è¡Œå†™æ³•çš„åŸå› ã€‚</p>
<h2 id="ç›¸å…³çš„æ€§èƒ½ä¼˜åŒ–"><a href="#ç›¸å…³çš„æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ç›¸å…³çš„æ€§èƒ½ä¼˜åŒ–"></a>ç›¸å…³çš„æ€§èƒ½ä¼˜åŒ–</h2><p>ç”±ä»¥ä¸Šä»‹ç»ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥åœ¨æ¡ˆä¾‹ä¸­çœ‹åˆ°åŒæµè§ˆå™¨æ¸²æŸ“å¼•æ“ç›¸å…³çš„å¯è¡Œä¼˜åŒ–ç‚¹ã€‚</p>
<p>å¤§è‡´ä¸ºä»¥ä¸‹å‡ ç§</p>
<ol>
<li>å‡å°‘ JS åŠ è½½å¯¹ Dom æ¸²æŸ“çš„å½±å“ï¼šå°† JS æ–‡ä»¶æ”¾åœ¨ HTML æ–‡æ¡£ååŠ è½½ï¼Œæˆ–è€…ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼åŠ è½½ JS ä»£ç </li>
<li>é¿å…é‡æ’ï¼Œå‡å°‘é‡ç»˜ï¼šåœ¨åšcssåŠ¨ç”»çš„æ—¶å€™å‡å°‘ä½¿ç”¨ widthã€ marginã€ paddingç­‰å½±å“ CSS å¸ƒå±€å¯¹è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ CSS3 çš„ transform ä»£æ›¿</li>
<li>å‡å°‘ä½¿ç”¨å…³ç³»å‹æ ·å¼è¡¨çš„å†™æ³•ï¼šç›´æ¥ä½¿ç”¨å”¯ä¸€çš„ç±»åå³å¯æœ€å¤§é™åº¦çš„æå‡æ¸²æŸ“æ•ˆç‡</li>
<li>å‡å°‘ DOM çš„å±‚çº§ï¼šå‡å°‘æ— æ„ä¹‰çš„dom å±‚çº§å¯ä»¥å‡å°‘ æ¸²æŸ“å¼•æ“ Attachment è¿‡ç¨‹ä¸­çš„åŒ¹é…è®¡ç®—é‡</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/30/æ·±å…¥ç†è§£ES6  Async Functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/æ·±å…¥ç†è§£ES6  Async Functions/" itemprop="url">æ·±å…¥ç†è§£ES6 Async Functions (å¼‚æ­¥å‡½æ•°)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-05-30T18:35:10+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h2 id="async-å¼‚æ­¥-å‡½æ•°å˜ä½“"><a href="#async-å¼‚æ­¥-å‡½æ•°å˜ä½“" class="headerlink" title="async(å¼‚æ­¥) å‡½æ•°å˜ä½“"></a>async(å¼‚æ­¥) å‡½æ•°å˜ä½“</h2><p>ä»¥ä¸‹æ˜¯å·²ç»å­˜åœ¨çš„å¼‚æ­¥å‡½æ•°å˜ä½“ã€‚è¯·æ³¨æ„æ— å¤„ä¸åœ¨çš„ <code>async</code> å…³é”®å­—ã€‚</p>
<ul>
<li>å¼‚æ­¥å‡½æ•°å£°æ˜ï¼š <code>async function foo() {}</code></li>
<li>å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼ï¼š <code>const foo = async function () {};</code></li>
<li>å¼‚æ­¥å‡½æ•°å®šä¹‰ï¼š<code>let obj = { async foo() {} }</code></li>
<li>å¼‚æ­¥ç®­å¤´å‡½æ•°ï¼š <code>const foo = async () =&gt; {};</code></li>
</ul>
<h2 id="async-å¼‚æ­¥-å‡½æ•°æ€»æ˜¯è¿”å›-Promises"><a href="#async-å¼‚æ­¥-å‡½æ•°æ€»æ˜¯è¿”å›-Promises" class="headerlink" title="async(å¼‚æ­¥) å‡½æ•°æ€»æ˜¯è¿”å› Promises"></a>async(å¼‚æ­¥) å‡½æ•°æ€»æ˜¯è¿”å› Promises</h2><p>async(å¼‚æ­¥) å‡½æ•°çš„ Promise å®ŒæˆçŠ¶æ€ï¼š</p>
<pre><code>async function asyncFunc() {
return 123;
}

asyncFunc()
.then(x =&gt; console.log(x));
// 123
</code></pre><p>async(å¼‚æ­¥) å‡½æ•°çš„ Promise æ‹’ç»çŠ¶æ€ï¼š</p>
<pre><code>async function asyncFunc() {
throw new Error(&apos;Problem!&apos;);
}

asyncFunc()
.catch(err =&gt; console.log(err));
// Error: Problem!
</code></pre><h2 id="é€šè¿‡-await-å¤„ç†-async-å¼‚æ­¥-è®¡ç®—çš„ç»“æœå’Œé”™è¯¯"><a href="#é€šè¿‡-await-å¤„ç†-async-å¼‚æ­¥-è®¡ç®—çš„ç»“æœå’Œé”™è¯¯" class="headerlink" title="é€šè¿‡ await å¤„ç† async(å¼‚æ­¥) è®¡ç®—çš„ç»“æœå’Œé”™è¯¯"></a>é€šè¿‡ <code>await</code> å¤„ç† async(å¼‚æ­¥) è®¡ç®—çš„ç»“æœå’Œé”™è¯¯</h2><p><code>await</code>ï¼ˆåªå…è®¸åœ¨ async(å¼‚æ­¥) å‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼‰ç­‰å¾…å…¶æ“ä½œå¯¹è±¡ Promise è¿”å›ï¼š</p>
<ul>
<li>å¦‚æœ Promise æ˜¯å®ŒæˆçŠ¶æ€ï¼Œ<code>await</code> çš„ç»“æœæ˜¯å®Œæˆæ€çš„å€¼ã€‚</li>
<li>å¦‚æœ Promise æ˜¯æ‹’ç»çŠ¶æ€ï¼Œ<code>await</code> ä¼šæŠ›å‡ºæ‹’ç»å€¼ã€‚</li>
</ul>
<p>å¤„ç†å•ä¸ª async(å¼‚æ­¥) è¿”å›å€¼ï¼š</p>
<pre><code>async function asyncFunc() {
const result = await otherAsyncFunc();
   console.log(result);
}

// ç­‰ä»·äº:
function asyncFunc() {
return otherAsyncFunc()
.then(result =&gt; {
       console.log(result);
});
}
</code></pre><p>æŒ‰é¡ºåºå¤„ç†å¤šä¸ª async(å¼‚æ­¥) è¿”å›å€¼ï¼š</p>
<pre><code>async function asyncFunc() {
const result1 = await otherAsyncFunc1();
   console.log(result1);
const result2 = await otherAsyncFunc2();
   console.log(result2);
}

// ç­‰ä»·äº:
function asyncFunc() {
return otherAsyncFunc1()
.then(result1 =&gt; {
       console.log(result1);
return otherAsyncFunc2();
})
.then(result2 =&gt; {
       console.log(result2);
});
}
</code></pre><p>å¹¶è¡Œå¤„ç†å¤šä¸ª async(å¼‚æ­¥) è¿”å›å€¼ï¼š</p>
<pre><code>async function asyncFunc() {
const [result1, result2] = await Promise.all([
       otherAsyncFunc1(),
       otherAsyncFunc2(),
]);
   console.log(result1, result2);
}

// ç­‰ä»·äº:
function asyncFunc() {
return Promise.all([
       otherAsyncFunc1(),
       otherAsyncFunc2(),
])
.then([result1, result2] =&gt; {
       console.log(result1, result2);
});
}
</code></pre><p>é”™è¯¯å¤„ç†ï¼š</p>
<pre><code>async function asyncFunc() {
try {
await otherAsyncFunc();
} catch (err) {
       console.error(err);
}
}

// ç­‰ä»·äº:
function asyncFunc() {
return otherAsyncFunc()
.catch(err =&gt; {
       console.error(err);
});
}
</code></pre><h2 id="ç†è§£-async-å¼‚æ­¥-å‡½æ•°"><a href="#ç†è§£-async-å¼‚æ­¥-å‡½æ•°" class="headerlink" title="ç†è§£ async(å¼‚æ­¥) å‡½æ•°"></a>ç†è§£ async(å¼‚æ­¥) å‡½æ•°</h2><p>åœ¨æˆ‘è§£é‡Š async(å¼‚æ­¥) å‡½æ•°ä¹‹å‰ï¼Œæˆ‘éœ€è¦è§£é‡Šä¸€ä¸‹å¦‚ä½•ç»„åˆä½¿ç”¨ Promises å’Œ Generator ï¼Œé€šè¿‡çœ‹èµ·æ¥åŒæ­¥çš„ä»£ç æ¥æ‰§è¡Œ async(å¼‚æ­¥) æ“ä½œã€‚</p>
<p>å¯¹äºèƒ½å¤Ÿ async(å¼‚æ­¥) è®¡ç®—å…¶ä¸€æ¬¡æ€§ç»“æœçš„å‡½æ•°ï¼Œä½œä¸º ES6 ä¸€éƒ¨åˆ†çš„ Promises å·²ç»å˜å¾—æµè¡Œèµ·æ¥ã€‚ä¸€ä¸ªä¾‹å­æ˜¯ <a href="https://link.zhihu.com/?target=https%3A//fetch.spec.whatwg.org/%23concept-request" target="_blank" rel="noopener">å®¢æˆ·ç«¯ fetch API</a> ï¼Œå®ƒæ˜¯ XMLHttpRequest è·å–æ•°æ®çš„æ›¿ä»£æ–¹æ³•ã€‚ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code>function fetchJson(url) {
return fetch(url)
.then(request =&gt; request.text())
.then(text =&gt; {
return JSON.parse(text);
})
.catch(error =&gt; {
       console.log(`ERROR: ${error.stack}`);
});
}
fetchJson(&apos;http://example.com/some_file.json&apos;)
.then(obj =&gt; console.log(obj));
</code></pre><h2 id="é€šè¿‡-generator-æ¥ç¼–å†™å¼‚æ­¥ä»£ç "><a href="#é€šè¿‡-generator-æ¥ç¼–å†™å¼‚æ­¥ä»£ç " class="headerlink" title="é€šè¿‡ generator æ¥ç¼–å†™å¼‚æ­¥ä»£ç "></a>é€šè¿‡ generator æ¥ç¼–å†™å¼‚æ­¥ä»£ç </h2><p>co æ˜¯ä¸€ä¸ªä½¿ç”¨ Promise å’Œ generator æ¥å®ç°çœ‹ä¼¼åŒæ­¥ç¼–ç çš„åº“ï¼Œä½†ä¸ä¸Šä¸€ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ ·å¼ç›¸åŒï¼š</p>
<pre><code>const fetchJson = co.wrap(function* (url) {
try {
let request = yield fetch(url);
let text = yield request.text();
return JSON.parse(text);
}
catch (error) {
       console.log(`ERROR: ${error.stack}`);
}
});
</code></pre><p>æ¯æ¬¡å›è°ƒå‡½æ•°ï¼ˆ generator å‡½æ•°ï¼‰äº§ç”Ÿä¸€ä¸ª Promise å¯¹è±¡ç»™ co ï¼Œå›è°ƒä¼šè¢«æš‚åœï¼Œåªæœ‰å½“ Promise æ‰§è¡Œå®Œæˆåï¼Œco æ‰ä¼šç»§ç»­æ‰§è¡Œå›è°ƒ ã€‚ å¦‚æœ Promise å¤„äºå®ŒæˆçŠ¶æ€ï¼Œ<code>yield</code> è¿”å›å®ŒæˆçŠ¶æ€çš„å€¼ï¼Œå¦‚æœå¤„äºæ‹’ç»çŠ¶æ€ï¼Œ<code>yield</code> æŠ›å‡ºæ‹’ç»çŠ¶æ€çš„é”™è¯¯ã€‚æ­¤å¤–ï¼Œco ä¿è¯ç»“æœæ˜¯é€šè¿‡å›è°ƒæ‰§è¡Œå®Œæˆæ‰è¿”å›çš„ï¼ˆç±»ä¼¼äº <code>then()</code> æ‰€åšçš„å·¥ä½œï¼‰ã€‚</p>
<h2 id="é€šè¿‡-async-å¼‚æ­¥-å‡½æ•°æ¥ç¼–å†™å¼‚æ­¥ä»£ç "><a href="#é€šè¿‡-async-å¼‚æ­¥-å‡½æ•°æ¥ç¼–å†™å¼‚æ­¥ä»£ç " class="headerlink" title="é€šè¿‡ async(å¼‚æ­¥) å‡½æ•°æ¥ç¼–å†™å¼‚æ­¥ä»£ç "></a>é€šè¿‡ async(å¼‚æ­¥) å‡½æ•°æ¥ç¼–å†™å¼‚æ­¥ä»£ç </h2><p>async(å¼‚æ­¥) å‡½æ•°ç”¨çš„ç‰¹å®šè¯­æ³•åŸºæœ¬ä¸Šå’Œ co ç±»ä¼¼ï¼š</p>
<pre><code>async function fetchJson(url) {
try {
let request = await fetch(url);
let text = await request.text();
return JSON.parse(text);
}
catch (error) {
       console.log(`ERROR: ${error.stack}`);
}
}
</code></pre><p>åœ¨å†…éƒ¨ï¼Œå¼‚æ­¥å‡½æ•°å†™æ³•æ›´ç±»ä¼¼äº generators ã€‚</p>
<h2 id="ä»¥åŒæ­¥å¼€å§‹ï¼Œå¼‚æ­¥å¤„ç†çš„-async-å¼‚æ­¥-å‡½æ•°"><a href="#ä»¥åŒæ­¥å¼€å§‹ï¼Œå¼‚æ­¥å¤„ç†çš„-async-å¼‚æ­¥-å‡½æ•°" class="headerlink" title="ä»¥åŒæ­¥å¼€å§‹ï¼Œå¼‚æ­¥å¤„ç†çš„ async(å¼‚æ­¥) å‡½æ•°"></a>ä»¥åŒæ­¥å¼€å§‹ï¼Œå¼‚æ­¥å¤„ç†çš„ async(å¼‚æ­¥) å‡½æ•°</h2><p>ä»¥ä¸‹æ˜¯ async(å¼‚æ­¥)å‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p>
<ol>
<li>async(å¼‚æ­¥) å‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ <code>p</code> ã€‚Promise å¯¹è±¡åœ¨ async(å¼‚æ­¥) å‡½æ•°å¼€å§‹æ‰§è¡Œæ—¶è¢«åˆ›å»ºã€‚</li>
<li>å‡½æ•°ä½“æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>return</code> æˆ– <code>throw</code> ç»ˆæ­¢æ‰§è¡Œã€‚æˆ–è€…é€šè¿‡ <code>await</code> æš‚åœæ‰§è¡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šåœ¨ä»¥åç»§ç»­æ‰§è¡Œã€‚</li>
<li>è¿”å› Promise å¯¹è±¡ <code>p</code>ã€‚</li>
</ol>
<p>å½“æ‰§è¡Œ async(å¼‚æ­¥) å‡½æ•°çš„å‡½æ•°ä½“æ—¶ï¼Œ<code>return x</code> ä¸­çš„ <code>x</code> æ˜¯ Promise å¯¹è±¡ <code>p</code> çš„å®ŒæˆçŠ¶æ€çš„ç»“æœï¼Œè€Œ <code>throw err</code> æ˜¯ <code>p</code> çš„æ‹’ç»çŠ¶æ€çš„ç»“æœã€‚æ‰§è¡Œç»“æœæ˜¯å¼‚æ­¥è¿”å›çš„ã€‚æ¢å¥è¯è¯´ï¼š<code>then()</code> å’Œ <code>catch()</code> çš„å›è°ƒæ€»æ˜¯åœ¨å½“å‰ä»£ç å®Œæˆåæ‰§è¡Œã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä»£ç ç¤ºä¾‹ï¼š</p>
<pre><code>async function asyncFunc() {
   console.log(&apos;asyncFunc()&apos;); // (A)
return &apos;abc&apos;;
}
asyncFunc().
then(x =&gt; console.log(`Resolved: ${x}`)); // (B)
console.log(&apos;main&apos;); // (C)

// Output:
// asyncFunc()
// main
// Resolved: abc
</code></pre><p>æ‚¨å¯ä»¥è®¤ä¸ºæ˜¯ä»¥ä¸‹çš„æ‰§è¡Œé¡ºåºï¼š</p>
<ol>
<li>è¡ŒAï¼šasync(å¼‚æ­¥) å‡½æ•°ä»¥åŒæ­¥å¼€å§‹ã€‚async(å¼‚æ­¥) å‡½æ•°çš„ Promise é€šè¿‡ <code>return</code> æ¥è¿”å›å®ŒæˆçŠ¶æ€çš„ç»“æœã€‚</li>
<li>è¡ŒCï¼šæ‰§è¡Œç»§ç»­ã€‚</li>
<li>è¡ŒBï¼šPromise å®ŒæˆçŠ¶æ€é€šçŸ¥æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ã€‚</li>
</ol>
<h2 id="è¿”å›ä¸è¢«åŒ…è£¹çš„-Promise-å¯¹è±¡"><a href="#è¿”å›ä¸è¢«åŒ…è£¹çš„-Promise-å¯¹è±¡" class="headerlink" title="è¿”å›ä¸è¢«åŒ…è£¹çš„ Promise å¯¹è±¡"></a>è¿”å›ä¸è¢«åŒ…è£¹çš„ Promise å¯¹è±¡</h2><p>Promise çš„ resolve æ˜¯ä¸€é¡¹æ ‡å‡†æ“ä½œã€‚ <code>return</code> å°±æ˜¯ä½¿ç”¨å®ƒæ¥ resolve async(å¼‚æ­¥) å‡½æ•°çš„ Promise <code>p</code> çš„ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ol>
<li>è¿”å›ä¸€ä¸ªé Promise å€¼ï¼Œè¯¥å€¼å°†è¢«å¤„ç†æˆ <code>p</code> çš„å®ŒæˆçŠ¶æ€å€¼ã€‚</li>
<li>è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ä¹ˆ <code>p</code> æ­¤æ—¶ç›¸å½“äºæ˜¯è¯¥ Promise çš„çŠ¶æ€ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œæ‚¨å¯ä»¥è¿”å›ä¸€ä¸ª Promise ï¼Œå¹¶ä¸”è¿™ä¸ª Promise ä¸ä¼šåŒ…è£¹åœ¨åˆ«çš„ Promise ä¸­ï¼š</p>
<pre><code>async function asyncFunc() {
return Promise.resolve(123);
}
asyncFunc()
.then(x =&gt; console.log(x)) // 123
</code></pre><p>æœ‰è¶£çš„æ˜¯ï¼Œè¿”å›ä¸€ä¸ªæ‹’ç»çŠ¶æ€ï¼ˆrejectï¼‰çš„ Promise å¯¹è±¡ä¼šå¯¼è‡´ async(å¼‚æ­¥) å‡½æ•°è¢«æ‹’ç»ï¼ˆrejectï¼‰ï¼ˆé€šå¸¸ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>throw</code> ï¼‰ï¼š</p>
<pre><code>async function asyncFunc() {
return Promise.reject(new Error(&apos;Problem!&apos;));
}
asyncFunc()
.catch(err =&gt; console.error(err)); // Error: Problem!
</code></pre><p>è¿™ä¸ Promise è§£å†³æ–¹æ¡ˆçš„å·¥ä½œæ–¹å¼æ˜¯ä¸€è‡´çš„ã€‚ ä½¿ä½ èƒ½å¤Ÿåœ¨ä¸ä½¿ç”¨ <code>await</code> çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…¶ä»– async(å¼‚æ­¥) è®¡ç®—æ¥æ‰§è¡Œå®Œæˆå’Œæ‹’ç»å¤„ç†ï¼š</p>
<pre><code>async function asyncFunc() {
return anotherAsyncFunc();
}
</code></pre><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹å’Œä¸‹é¢çš„ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”ä¸‹é¢çš„æ›´é«˜æ•ˆã€‚ï¼ˆä»¥ä¸‹ä»£ç ç¤ºä¾‹æ²¡æœ‰åŒ…è£¹ <code>anotherAsyncFunc()</code> çš„ Promise ï¼Œè€Œæ˜¯åŒ…è£¹ <code>anotherAsyncFunc()</code> æœ¬èº« ï¼‰ï¼š</p>
<pre><code>async function asyncFunc() {
return await anotherAsyncFunc();
}
</code></pre><h2 id="ä½¿ç”¨-await-å°è´´å£«"><a href="#ä½¿ç”¨-await-å°è´´å£«" class="headerlink" title="ä½¿ç”¨ await å°è´´å£«"></a>ä½¿ç”¨ <code>await</code> å°è´´å£«</h2><h2 id="ä¸è¦å¿˜è®°ä½¿ç”¨-await"><a href="#ä¸è¦å¿˜è®°ä½¿ç”¨-await" class="headerlink" title="ä¸è¦å¿˜è®°ä½¿ç”¨ await"></a>ä¸è¦å¿˜è®°ä½¿ç”¨ <code>await</code></h2><p>åœ¨ async(å¼‚æ­¥) å‡½æ•°ä¸­å®¹æ˜“çŠ¯çš„ä¸€ä¸ªé”™è¯¯å°±æ˜¯åœ¨è°ƒç”¨ async(å¼‚æ­¥) å‡½æ•°æ—¶å¿˜è®°ä½¿ç”¨ <code>await</code> ï¼š</p>
<pre><code>async function asyncFunc() {
const value = otherAsyncFunc(); // missing `await`!
Â·Â·Â·
}
</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ–¹æ³•æ‰§è¡Œè¿”å›çš„ Promise å¯¹è±¡èµ‹å€¼ç»™äº† <code>value</code> ï¼Œå®ƒé€šå¸¸ä¸æ˜¯ä½ åœ¨ async(å¼‚æ­¥) å‡½æ•°ä¸­æƒ³è¦çš„ç»“æœã€‚</p>
<p>await ç”šè‡³å¯ä»¥åœ¨ async(å¼‚æ­¥) å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼çš„æƒ…å†µä¸‹èµ·ä½œç”¨ã€‚å®ƒçš„ Promise åªæ˜¯ç”¨æ¥å‘Šè¯‰è°ƒç”¨è€…å®ŒæˆçŠ¶æ€ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code>async function foo() {
await step1(); // (A)
Â·Â·Â·
}
</code></pre><p>è¡ŒAä¸­çš„ <code>await</code> ç¡®ä¿åœ¨æ‰§è¡Œ <code>foo()</code> å‰©ä½™éƒ¨åˆ†ä¹‹å‰ï¼Œ <code>step1()</code> å·²ç»æ‰§è¡Œå®Œæˆã€‚</p>
<h2 id="ä¸éœ€è¦ä½¿ç”¨-await-çš„æƒ…å†µ"><a href="#ä¸éœ€è¦ä½¿ç”¨-await-çš„æƒ…å†µ" class="headerlink" title="ä¸éœ€è¦ä½¿ç”¨ await çš„æƒ…å†µ"></a>ä¸éœ€è¦ä½¿ç”¨ await çš„æƒ…å†µ</h2><p>æœ‰æ—¶ï¼Œä½ åªæƒ³è§¦å‘å¼‚æ­¥è®¡ç®—ï¼Œå¹¶ä¸”ä¸éœ€è¦å…³æ³¨å®ƒä»€ä¹ˆæ—¶å€™å®Œæˆã€‚ä»¥ä¸‹æ˜¯ä»£ç ç¤ºä¾‹ï¼š</p>
<pre><code>async function asyncFunc() {
const writer = openFile(&apos;someFile.txt&apos;);
   writer.write(&apos;hello&apos;); // donâ€™t wait
   writer.write(&apos;world&apos;); // donâ€™t wait
await writer.close(); // wait for file to close
}
</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå•ä¸ªçš„å†™å…¥æ“ä½œæ˜¯å¦å®Œæˆï¼Œåªéœ€è¦ä»–ä»¬ä»¥æ­£ç¡®çš„é¡ºåºæ‰§è¡Œ (APIå¿…é¡»ä¿è¯ï¼Œä½†è¿™æ˜¯ç”± async(å¼‚æ­¥) å‡½æ•°çš„æ‰§è¡Œæ¨¡å‹æ‰€é¼“åŠ±çš„ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€è§)ã€‚</p>
<p><code>asyncFunc()</code> å‡½æ•°æœ€åä¸€è¡Œçš„ <code>await</code> ç¡®ä¿è¯¥å‡½æ•°ä»…åœ¨æ–‡ä»¶å†™å…¥å…³é—­åæ‰ä¼šæ‰§è¡Œã€‚</p>
<p>ç”±äºè¿”å›çš„ Promises æ²¡æœ‰è¢«å…¶ä»– async(å¼‚æ­¥) å‡½æ•°åŒ…è£¹ï¼Œæ‰€ä»¥ä½ å¯ä»¥ç”¨ <code>return</code> æ›¿æ¢ <code>await writer.close()</code> ï¼š</p>
<pre><code>async function asyncFunc() {
const writer = openFile(&apos;someFile.txt&apos;);
   writer.write(&apos;hello&apos;);
   writer.write(&apos;world&apos;);
return writer.close();
}
</code></pre><p>è¿™ä¸¤ä¸ªç‰ˆæœ¬å„æœ‰åˆ©å¼Šï¼Œ<code>await</code> ç‰ˆæœ¬å¯èƒ½ç¨å¾®æ›´å®¹æ˜“ç†è§£ã€‚</p>
<h2 id="await-æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼ŒPromise-all-æ˜¯å¹¶è¡Œçš„"><a href="#await-æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼ŒPromise-all-æ˜¯å¹¶è¡Œçš„" class="headerlink" title="await æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼ŒPromise.all() æ˜¯å¹¶è¡Œçš„"></a>await æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼ŒPromise.all() æ˜¯å¹¶è¡Œçš„</h2><p>ä¸‹é¢çš„ä»£ç è°ƒç”¨äº†ä¸¤ä¸ª async(å¼‚æ­¥) å‡½æ•°ï¼Œ <code>asyncFunc1()</code> å’Œ <code>asyncFunc1()</code> ã€‚</p>
<pre><code>async function foo() {
const result1 = await asyncFunc1();
const result2 = await asyncFunc2();
}
</code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°è°ƒç”¨é¡ºåºæ‰§è¡Œã€‚ä½†æ˜¯å¹¶è¡Œæ‰§è¡Œå®ƒä»¬å¾€å¾€ä¼šåŠ å¿«é€Ÿåº¦ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Promise.all() ï¼š</p>
<pre><code>async function foo() {
const [result1, result2] = await Promise.all([
       asyncFunc1(),
       asyncFunc2(),
]);
}
</code></pre><p>æˆ‘ä»¬ç°åœ¨æ­£åœ¨ç­‰å¾…ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„çš„ Promise ï¼Œè€Œä¸æ˜¯ç­‰å¾…ä¸¤ä¸ª Promiseã€‚</p>
<h2 id="å¼‚æ­¥å‡½æ•°å’Œå›è°ƒ"><a href="#å¼‚æ­¥å‡½æ•°å’Œå›è°ƒ" class="headerlink" title="å¼‚æ­¥å‡½æ•°å’Œå›è°ƒ"></a>å¼‚æ­¥å‡½æ•°å’Œå›è°ƒ</h2><p>async(å¼‚æ­¥) å‡½æ•°çš„ä¸€ä¸ªé™åˆ¶æ˜¯ <code>await</code>(ç­‰å¾…) åªå½±å“ç›´æ¥ç›¸å…³çš„ async(å¼‚æ­¥) å‡½æ•°ã€‚å› æ­¤ï¼Œasync(å¼‚æ­¥) å‡½æ•°æ— æ³•åœ¨å›è°ƒï¼ˆä½†æ˜¯ï¼Œå›è°ƒå¯ä»¥æ˜¯ async(å¼‚æ­¥) å‡½æ•°æœ¬èº«ï¼Œç¨åæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ï¼‰ä¸­ä½¿ç”¨ <code>await</code>(ç­‰å¾…)ã€‚è¿™ä½¿å¾—åŸºäºå›è°ƒçš„å®ç”¨å‡½æ•°å’Œæ–¹æ³•éš¾ä»¥ä½¿ç”¨ã€‚ä¾‹å­ä¸­æˆ‘ä»¬å°†ä½¿ç”¨æ•°ç»„æ–¹æ³• <code>map()</code> å’Œ <code>forEach()</code>ã€‚</p>
<h2 id="Array-prototype-map"><a href="#Array-prototype-map" class="headerlink" title="Array.prototype.map()"></a>Array.prototype.map()</h2><p>æˆ‘ä»¬ä»æ•°ç»„æ–¹æ³• <code>map()</code> å¼€å§‹è®²è§£ã€‚åœ¨ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åŠ è½½ç”± URLs æ•°ç»„æŒ‡å‘çš„æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬è¿”å›åˆ°æ•°ç»„ä¸­ã€‚</p>
<pre><code>async function downloadContent(urls) {
return urls.map(url =&gt; {
// é”™è¯¯çš„è¯­æ³•!
const content = await httpGet(url);
return content;
});
}
</code></pre><p>è¿™ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºåœ¨æ­£å¸¸ç®­å¤´å‡½æ•°ä¸­ <code>await</code> è¯­æ³•ä¸Šæ˜¯éæ³•çš„(æ„šäººç å¤´æ³¨ï¼š <code>await</code>(ç­‰å¾…) åªå½±å“ç›´æ¥ç›¸å…³çš„ async(å¼‚æ­¥) å‡½æ•°)ã€‚é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å¼‚æ­¥çš„ç®­å¤´å‡½æ•°å‘¢ï¼Ÿ</p>
<pre><code>async function downloadContent(urls) {
return urls.map(async (url) =&gt; { // æ³¨æ„è¿™ä¸€è¡Œä¸­çš„ async ;
const content = await httpGet(url);
return content;
});
}
</code></pre><p>è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ç°åœ¨è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ª Promises å¯¹è±¡çš„æ•°ç»„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ•°ç»„ã€‚</li>
<li>ä¸€æ—¦ <code>map()</code> æ‰§è¡Œå®Œæˆï¼Œå›è°ƒæ‰§è¡Œçš„å·¥ä½œå¹¶ä¸èƒ½åŒæ—¶å®Œæˆï¼Œå› ä¸º <code>await</code> åªæš‚åœäº†åŒ…è£¹å®ƒçš„ç®­å¤´å‡½æ•° å’Œ <code>httpGet()</code> å¼‚æ­¥æ‰§è¡Œè¾¾åˆ°å®ŒæˆçŠ¶æ€ã€‚è¿™æ„å‘³ç€ä½ ä¸èƒ½ä½¿ç”¨ <code>await</code>ï¼Œæ¥ç­‰å¾… <code>downloadContent()</code> æ‰§è¡Œç»“æŸã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Promise.all()</code> æ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œ<code>Promise.all()</code> å¯ä»¥å°†ä¸€ç³»åˆ—çš„ Promise è½¬æ¢ä¸ºä¸€ä¸ª Promise æ•°ç»„ï¼ˆæ‰€æœ‰å€¼éƒ½æ˜¯ç»è¿‡ Promise å®Œæˆå¹¶è¿”å›ï¼‰ï¼š</p>
<pre><code>async function downloadContent(urls) {
const promiseArray = urls.map(async (url) =&gt; {
const content = await httpGet(url);
return content;
});
return await Promise.all(promiseArray);
}
</code></pre><p><code>map()</code> çš„å›è°ƒå¹¶ä¸å¯¹ <code>httpGet()</code> çš„ç»“æœèµ·ä½œç”¨ï¼Œåªæ˜¯èµ·åˆ°ä¸æ–­æ‰§è¡Œçš„ä½œç”¨ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªå¼‚æ­¥çš„ç®­å¤´å‡½æ•°ï¼Œåªéœ€è¦ä¸€ä¸ªæ™®é€šçš„ç®­å¤´å‡½æ•°å°±èƒ½è¾¾åˆ°ç›¸åŒçš„ç»“æœã€‚</p>
<pre><code>async function downloadContent(urls) {
const promiseArray = urls.map(
       url =&gt; httpGet(url));
return await Promise.all(promiseArray);
}
</code></pre><p>æˆ‘ä»¬ä»ç„¶å¯ä»¥åšä¸€ä¸ªå°çš„æ”¹è¿›ï¼šè¿™ä¸ªå¼‚æ­¥å‡½æ•°ç¨å¾®æœ‰ç‚¹ä½æ•ˆ â€“ é¦–å…ˆé€šè¿‡ <code>await</code> æ¥è§£å¼€ <code>Promise.all()</code> çš„ç»“æœï¼Œç„¶åé€šè¿‡ <code>return</code> å†æ¬¡åŒ…è£¹å®ƒã€‚ å‡è®¾ <code>return</code> ä¸åŒ…è£¹ Promisesï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿”å› <code>Promise.all()</code> çš„ç»“æœï¼š</p>
<pre><code>async function downloadContent(urls) {
const promiseArray = urls.map(
       url =&gt; httpGet(url));
return Promise.all(promiseArray);
}
</code></pre><h2 id="Array-prototype-forEach"><a href="#Array-prototype-forEach" class="headerlink" title="Array.prototype.forEach()"></a>Array.prototype.forEach()</h2><p>æˆ‘ä»¬ä½¿ç”¨æ•°ç»„çš„ forEach() æ–¹æ³•åœ¨æ§åˆ¶å°ä¸­æ‰“å°å‡ ä¸ªé€šè¿‡ URLs åŠ è½½çš„æ–‡ä»¶çš„å†…å®¹ï¼š</p>
<pre><code>async function logContent(urls) {
   urls.forEach(url =&gt; {
// Wrong syntax
const content = await httpGet(url);
       console.log(content);
});
}
</code></pre><p>åŒæ ·çš„ï¼Œè¿™é‡Œçš„ä»£ç ä¼šäº§ç”Ÿä¸€ä¸ªè¯­æ³•é”™è¯¯ï¼Œå› ä¸ºä½ ä¸èƒ½åœ¨é€šå¸¸çš„ç®­å¤´å‡½æ•°å†…éƒ¨ä½¿ç”¨ <code>await</code> ã€‚</p>
<p>æˆ‘ä»¬æ¢ä½œå¼‚æ­¥ç®­å¤´å‡½æ•°ï¼š</p>
<pre><code>async function logContent(urls) {
   urls.forEach(async url =&gt; {
const content = await httpGet(url);
       console.log(content);
});
// Not finished here
}
</code></pre><p>è¿™æ®µä»£ç èµ·ä½œç”¨äº†ï¼Œä½†æ˜¯ä¼šå‡ºç°ä¸€ä¸ªè­¦å‘Šï¼š<code>httpGet()</code> è¿”å›çš„ Promise å¯¹è±¡æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€å½“ <code>forEach()</code> è¿”å›çš„æ—¶å€™å›è°ƒå¯èƒ½è¿˜æ²¡æœ‰ç»“æŸï¼Œå› æ­¤ä½ æ— æ³•ç­‰åˆ° <code>logContent()</code> åªèƒ½ç»“æŸã€‚</p>
<p>å¦‚æœä½ å¹¶ä¸æƒ³è¦è¿™ä¸ªç»“æœï¼Œä½ å¯ä»¥å°† <code>forEach()</code> è½¬æ¢ä¸º <code>for-of</code> å¾ªç¯ã€‚</p>
<pre><code>async function logContent(urls) {
for (const url of urls) {
const content = await httpGet(url);
       console.log(content);
}
}
</code></pre><p>ç°åœ¨ä¸€åˆ‡éƒ½åœ¨ <code>for-of</code> å¾ªç¯å®Œæˆåå®Œæˆã€‚ä½†æ˜¯ï¼Œå¤„ç†æ­¥éª¤ä¾æ¬¡å‘ç”Ÿï¼š<code>httpGet()</code> åªæ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨å®Œæˆåå†æ¬¡è°ƒç”¨ã€‚å¦‚æœæ‚¨å¸Œæœ›å¤„ç†æ­¥éª¤å¹¶è¡Œæ‰§è¡Œï¼Œä½ å¿…é¡»ä½¿ç”¨ <code>Promise.all()</code>ï¼š</p>
<pre><code>async function logContent(urls) {
await Promise.all(urls.map(
async url =&gt; {
const content = await httpGet(url);
           console.log(content);
}));
}
</code></pre><p><code>map()</code> ç”¨äºåˆ›å»ºä¸€ä¸ª Promises æ•°ç»„ã€‚ æˆ‘ä»¬å¯¹ä»–ä»¬çš„å®Œæˆç»“æœå¹¶ä¸æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬åªè¦ <code>await</code>(ç­‰å¾…) æ‰€æœ‰æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¸Œæœ›çš„æ˜¯åœ¨ async(å¼‚æ­¥) å‡½æ•°å®Œæˆä¹‹åæ‰€æœ‰çš„æ‰§è¡Œéƒ½å·²ç»å®Œæˆã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿”å› <code>Promise.all()</code> ï¼Œä½†æ˜¯è¯¥å‡½æ•°çš„ç»“æœæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶å…ƒç´ éƒ½æ˜¯æœªå®ŒæˆçŠ¶æ€çš„ã€‚</p>
<h2 id="ä½¿ç”¨å¼‚æ­¥å‡½æ•°å°è´´å£«"><a href="#ä½¿ç”¨å¼‚æ­¥å‡½æ•°å°è´´å£«" class="headerlink" title="ä½¿ç”¨å¼‚æ­¥å‡½æ•°å°è´´å£«"></a>ä½¿ç”¨å¼‚æ­¥å‡½æ•°å°è´´å£«</h2><h2 id="äº†è§£ä½ çš„-Promises"><a href="#äº†è§£ä½ çš„-Promises" class="headerlink" title="äº†è§£ä½ çš„ Promises"></a>äº†è§£ä½ çš„ Promises</h2><p>async(å¼‚æ­¥) å‡½æ•°çš„åŸºç¡€å°±æ˜¯ <a href="https://link.zhihu.com/?target=http%3A//exploringjs.com/es6/ch_promises.html" target="_blank" rel="noopener">Promises</a> å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆç†è§£ Promises å¯¹äºç†è§£ async(å¼‚æ­¥) å‡½æ•°è‡³å…³é‡è¦ã€‚ç‰¹åˆ«æ˜¯å½“é‡åˆ°ä¸æ˜¯åŸºäº Promises çš„è€ä»£ç æ¥å®ç° async(å¼‚æ­¥) å‡½æ•°æ—¶ï¼Œä½ é€šå¸¸åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½ç”¨ Promise æ¥é‡æ„ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œè¿™é‡Œæœ‰ä¸ª â€œpromisifiedâ€ ç‰ˆæœ¬çš„ <code>XMLHttpRequest</code> ï¼š</p>
<pre><code>function httpGet(url, responseType=&quot;&quot;) {
return new Promise(
function (resolve, reject) {
const request = new XMLHttpRequest();
           request.onload = function () {
if (this.status === 200) {
// Success
                   resolve(this.response);
} else {
// Something went wrong (404 etc.)
                   reject(new Error(this.statusText));
}
};
           request.onerror = function () {
               reject(new Error(
&apos;XMLHttpRequest Error: &apos;+this.statusText));
};
           request.open(&apos;GET&apos;, url);
           xhr.responseType = responseType;
           request.send();
});
}
</code></pre><p>XMLHttpRequest çš„ API æ˜¯åŸºäºå›è°ƒçš„ã€‚é€šè¿‡ä¸€ä¸ª async(å¼‚æ­¥) å‡½æ•°æ¥å®ç°å®ƒï¼Œæ„å‘³ç€ä½ å¿…é¡»åœ¨å›è°ƒä¸­è¿”å› Promise çš„å®Œæˆ(fulfill) æˆ–æ‹’ç»(reject) çŠ¶æ€ã€‚è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä½ åªèƒ½é€šè¿‡ <code>return</code> æˆ–è€… <code>throw</code> æ¥å®Œæˆè¿™æ ·çš„æ“ä½œã€‚ä½ ä¸èƒ½ä»å›è°ƒå‡½æ•°å†…éƒ¨ <code>return</code> ä¸€ä¸ªå‡½æ•°çš„ç»“æœã€‚<code>throw</code>ä¹Ÿæœ‰ç±»ä¼¼çš„çº¦æŸã€‚</p>
<p>å› æ­¤ï¼Œå¼‚æ­¥å‡½æ•°çš„é€šç”¨ç¼–ç é£æ ¼æ˜¯ï¼š</p>
<ul>
<li>ç›´æ¥ä½¿ç”¨ Promise å¯¹è±¡æ¥æ„å»ºå¼‚æ­¥åŸè¯­ã€‚</li>
<li>ç”¨å¼‚æ­¥å‡½æ•°æ¥ä½¿ç”¨è¿™äº›åŸè¯­ã€‚</li>
</ul>
<p>æ‰©å±•é˜…è¯»ï¼šâ€œExploring ES6â€ ä¸­çš„ â€œ<a href="https://link.zhihu.com/?target=http%3A//exploringjs.com/es6/ch_promises.html" target="_blank" rel="noopener">å¼‚æ­¥ç¼–ç¨‹ä¸­çš„ Promises å¯¹è±¡</a>â€ ç« èŠ‚</p>
<h2 id="ç«‹å³è°ƒç”¨å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼"><a href="#ç«‹å³è°ƒç”¨å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼" class="headerlink" title="ç«‹å³è°ƒç”¨å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼"></a>ç«‹å³è°ƒç”¨å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼</h2><p>æœ‰æ—¶ï¼Œå¦‚æœä½ å¯ä»¥åœ¨æ¨¡å—æˆ–è„šæœ¬çš„é¡¶å±‚ä½¿ç”¨ await ï¼Œé‚£å°†æ˜¯ä¸€ç§å¾ˆå¥½çš„é€‰æ‹©ã€‚å½“ç„¶ï¼Œå®ƒåªèƒ½åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•° <code>main()</code> å¹¶ç«‹å³è°ƒç”¨å®ƒï¼š</p>
<pre><code>async function main() {
   console.log(await asyncFunction());
}
main();
</code></pre><p>æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ç«‹å³è°ƒç”¨å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼ï¼š</p>
<pre><code>(async function () {
   console.log(await asyncFunction());
})();
</code></pre><p>å¦ä¸€ä¸ªé€‰æ‹©æ˜¯ç«‹å³è°ƒç”¨å¼‚æ­¥ç®­å¤´å‡½æ•°ï¼š</p>
<pre><code>(async () =&gt; {
   console.log(await asyncFunction());
})();
</code></pre><h2 id="ç”¨å¼‚æ­¥å‡½æ•°è¿›è¡Œå•å…ƒæµ‹è¯•"><a href="#ç”¨å¼‚æ­¥å‡½æ•°è¿›è¡Œå•å…ƒæµ‹è¯•" class="headerlink" title="ç”¨å¼‚æ­¥å‡½æ•°è¿›è¡Œå•å…ƒæµ‹è¯•"></a>ç”¨å¼‚æ­¥å‡½æ•°è¿›è¡Œå•å…ƒæµ‹è¯•</h2><p>ä»¥ä¸‹ä»£ç ä½¿ç”¨ <a href="https://link.zhihu.com/?target=https%3A//mochajs.org/" target="_blank" rel="noopener">æµ‹è¯•æ¡†æ¶ mocha</a> å¯¹å¼‚æ­¥å‡½æ•° asyncFun1() å’Œ asyncFun2() æ¥è¿›è¡Œå•å…ƒæµ‹è¯•ï¼š</p>
<pre><code>import assert from &apos;assert&apos;;

// Bug: the following test always succeeds
test(&apos;Testing async code&apos;, function () {
   asyncFunc1() // (A)
.then(result1 =&gt; {
assert.strictEqual(result1, &apos;a&apos;); // (B)
return asyncFunc2();
})
.then(result2 =&gt; {
assert.strictEqual(result2, &apos;b&apos;); // (C)
});
});
</code></pre><p>ç„¶è€Œï¼Œè¿™ä¸ªæµ‹è¯•æ€»æ˜¯æˆåŠŸçš„ï¼Œå› ä¸º mocha ä¸ä¼šç­‰å¾… B è¡Œå’Œ C è¡Œæ–­è¨€æ‰§è¡Œå®Œæˆã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡è¿”å›é“¾å¼è°ƒç”¨çš„ Promise æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º mocha ä¼šè¯†åˆ«ä¸€ä¸ªæµ‹è¯•æ˜¯å¦è¿”å›ä¸€ä¸ª Promise ï¼Œç„¶åç­‰å¾…è¯¥ Promise å®Œæˆ å†è¿›è¡Œä¸‹ä¸€æ­¥ï¼ˆé™¤éè¶…æ—¶ï¼‰ã€‚</p>
<pre><code>return asyncFunc1() // (A)
</code></pre><p>å¼‚æ­¥å‡½æ•°æ€»æ˜¯è¿”å› Promises ï¼Œè¿™ä½¿å¾—å®ƒä»¬èƒ½æ–¹ä¾¿çš„ã€å®Œç¾çš„æ¥è¿›è¡Œè¿™ç§å•å…ƒæµ‹è¯•ï¼š</p>
<pre><code>import assert from &apos;assert&apos;;
test(&apos;Testing async code&apos;, async function () {
const result1 = await asyncFunc1();
assert.strictEqual(result1, &apos;a&apos;);
const result2 = await asyncFunc2();
assert.strictEqual(result2, &apos;b&apos;);
});
</code></pre><p>åœ¨ mocha ä¸­ä½¿ç”¨å¼‚æ­¥å•å…ƒæµ‹è¯•å¼‚æ­¥å‡½æ•°æœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼šä»£ç æ›´ç®€æ´ï¼Œèƒ½å¤Ÿå‡†ç¡®å¤„ç†è¿”å›çš„ Promise å¯¹è±¡ã€‚</p>
<h2 id="ä¸è¦æ‹…å¿ƒæ²¡æœ‰å¤„ç†çš„æ‹’ç»æ‹’æ€"><a href="#ä¸è¦æ‹…å¿ƒæ²¡æœ‰å¤„ç†çš„æ‹’ç»æ‹’æ€" class="headerlink" title="ä¸è¦æ‹…å¿ƒæ²¡æœ‰å¤„ç†çš„æ‹’ç»æ‹’æ€"></a>ä¸è¦æ‹…å¿ƒæ²¡æœ‰å¤„ç†çš„æ‹’ç»æ‹’æ€</h2><p>å½“å‰çš„ JavaScript å¼•æ“å¯ä»¥åœ¨æ‹’ç»æ€æœªå¤„ç†çš„æƒ…å†µä¸‹æå‡ºè­¦å‘Šã€‚ä»¥ä¸‹ä»£ç åœ¨è¿‡å»ä¼šç»å¸¸æ‰§è¡Œå¤±è´¥ï¼Œä½†æ˜¯å½“å‰çš„ JavaScript å¼•æ“å¯ä»¥è¿›è¡Œè­¦å‘Šï¼š</p>
<pre><code>JavaScript ä»£ç :
async function foo() {
throw new Error(&apos;Problem!&apos;);
}
foo();
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/è·¨åŸŸï¼Œä½ éœ€è¦çŸ¥é“çš„å…¨åœ¨è¿™é‡Œ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ææ–Œ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuckDay">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/21/è·¨åŸŸï¼Œä½ éœ€è¦çŸ¥é“çš„å…¨åœ¨è¿™é‡Œ/" itemprop="url">è·¨åŸŸï¼Œä½ éœ€è¦çŸ¥é“çš„å…¨åœ¨è¿™é‡Œ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-05-21T11:05:10+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ€è¿‘åœ¨é¢è¯•çš„æ—¶å€™å¸¸è¢«é—®åˆ°å¦‚ä½•è§£å†³è·¨åŸŸçš„é—®é¢˜ï¼Œçœ‹äº†ç½‘ä¸Šçš„ä¸€äº›æ–‡ç« åï¼Œè®¸å¤šæ–‡ç« å¹¶æ²¡æœ‰ä»‹ç»æ¸…æ¥šï¼Œç»å¸¸ä½¿è¯»è€…(æˆ‘)æ„Ÿåˆ°å›°æƒ‘ï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘æ•´ç†ä¸€ä¸‹å¸¸ç”¨çš„è·¨åŸŸæŠ€å·§ï¼Œå†™è¿™ç¯‡å…³äºè·¨åŸŸçš„æ–‡ç« ç›®çš„åœ¨äºï¼š</p>
<ol>
<li>ä»‹ç»å¸¸è§çš„è·¨åŸŸçš„è§£å†³æ–¹æ¡ˆä»¥åŠå…¶ä¼˜ç¼ºç‚¹</li>
<li>æ¨¡æ‹Ÿå®é™…çš„è·¨åŸŸåœºæ™¯ï¼Œåœ¨æ¯ç§æ–¹æ¡ˆåç»™å‡ºä¸€ä¸ªç®€å•çš„å®ä¾‹ï¼Œèƒ½å¤Ÿè®©è¯»è€…å’Œæˆ‘ä¸€èµ·æ•²ä»£ç ï¼Œç›´è§‚åœ°ç†è§£è¿™äº›è·¨åŸŸæŠ€å·§</li>
</ol>
<p>å¦‚æœè§‰å¾—æœ¬æ–‡æœ‰å¸®åŠ©ï¼Œå¯ä»¥ç‚¹ star é¼“åŠ±ä¸‹ï¼Œæœ¬æ–‡æ‰€æœ‰ä»£ç éƒ½å¯ä»¥ä» github ä»“åº“ä¸‹è½½ï¼Œè¯»è€…å¯ä»¥æŒ‰ç…§ä¸‹è¿°æ‰“å¼€:</p>
<pre><code>git clone https://github.com/happylindz/blog.git
cd blog/code/crossOrigin/
yarn
</code></pre><p>å»ºè®®ä½  clone ä¸‹æ¥ï¼Œæ–¹ä¾¿ä½ é˜…è¯»ä»£ç ï¼Œè·Ÿæˆ‘ä¸€èµ·æµ‹è¯•ã€‚</p>
<h2 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h2><p>ä½¿ç”¨è¿‡ Ajax çš„åŒå­¦éƒ½çŸ¥é“å…¶ä¾¿åˆ©æ€§ï¼Œå¯ä»¥åœ¨ä¸å‘æœåŠ¡ç«¯æäº¤å®Œæ•´é¡µé¢çš„æƒ…å†µä¸‹ï¼Œå®ç°å±€éƒ¨åˆ·æ–°ï¼Œåœ¨å½“ä»Š SPA åº”ç”¨æ™®éä½¿ç”¨ï¼Œä½†æ˜¯æµè§ˆå™¨å¤„äºå¯¹å®‰å…¨æ–¹é¢çš„è€ƒè™‘ï¼Œä¸å…è®¸è·¨åŸŸè°ƒç”¨å…¶å®ƒé¡µé¢çš„å¯¹è±¡ï¼Œè¿™å¯¹äºæˆ‘ä»¬åœ¨æ³¨å…¥ iframe æˆ–æ˜¯ ajax åº”ç”¨ä¸Šå¸¦æ¥ä¸å°‘éº»çƒ¦ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œåªæœ‰å½“åè®®ï¼ŒåŸŸåï¼Œç«¯å£å·ç›¸åŒçš„æ—¶å€™æ‰ç®—æ˜¯åŒä¸€ä¸ªåŸŸåï¼Œå¦åˆ™ï¼Œå‡è®¤ä¸ºéœ€è¦åšè·¨åŸŸå¤„ç†ã€‚</p>
<p><img src="https://pic4.zhimg.com/v2-5fa29773fc875bf58e4513fdba402bf0_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-5fa29773fc875bf58e4513fdba402bf0_hd.jpg" alt=""></p>
<h2 id="è·¨åŸŸæ–¹æ³•"><a href="#è·¨åŸŸæ–¹æ³•" class="headerlink" title="è·¨åŸŸæ–¹æ³•"></a>è·¨åŸŸæ–¹æ³•</h2><p>ä»Šå¤©ä¸€å…±ä»‹ç»ä¸ƒç§å¸¸ç”¨çš„è·¨åŸŸæŠ€å·§ï¼Œå…³äºè·¨åŸŸæŠ€å·§å¤§è‡´å¯ä»¥åˆ†ä¸º iframe è·¨åŸŸå’Œ API è·¨åŸŸè¯·æ±‚ã€‚</p>
<p>ä¸‹é¢å°±å…ˆä»‹ç»ä¸‰ç§ API è·¨åŸŸçš„æ–¹æ³•:</p>
<h2 id="1-JSONPï¼š"><a href="#1-JSONPï¼š" class="headerlink" title="1. JSONPï¼š"></a>1. JSONPï¼š</h2><p>åªè¦è¯´åˆ°è·¨åŸŸï¼Œå°±å¿…é¡»èŠåˆ° JSONPï¼ŒJSONP å…¨ç§°ä¸ºï¼šJSON with paddingï¼Œå¯ç”¨äºè§£å†³è€ç‰ˆæœ¬æµè§ˆå™¨çš„è·¨åŸŸæ•°æ®è®¿é—®é—®é¢˜ã€‚</p>
<p>ç”±äº web é¡µé¢ä¸Šè°ƒç”¨ js æ–‡ä»¶ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œæ‰€ä»¥é€šè¿‡ script æ ‡ç­¾å¯ä»¥è¿›è¡Œè·¨åŸŸè¯·æ±‚ï¼š</p>
<ol>
<li>é¦–å…ˆå‰ç«¯éœ€è¦å…ˆè®¾ç½®å¥½å›è°ƒå‡½æ•°ï¼Œå¹¶å°†å…¶ä½œä¸º url çš„å‚æ•°ã€‚</li>
<li>æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡è¯¥å‚æ•°è·å–åˆ°å›è°ƒå‡½æ•°åï¼Œå¹¶å°†æ•°æ®æ”¾åœ¨å‚æ•°ä¸­å°†å…¶è¿”å›</li>
<li>æ”¶åˆ°ç»“æœåå› ä¸ºæ˜¯ script æ ‡ç­¾ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šå½“åšæ˜¯è„šæœ¬è¿›è¡Œè¿è¡Œï¼Œä»è€Œè¾¾åˆ°è·¨åŸŸè·å–æ•°æ®çš„ç›®çš„</li>
</ol>
<p>jsonp ä¹‹æ‰€ä»¥èƒ½å¤Ÿè·¨åŸŸçš„å…³é”®åœ¨äºé¡µé¢è°ƒç”¨ JS è„šæœ¬æ˜¯ä¸å—åŒæºç­–ç•¥çš„å½±å“ï¼Œç›¸å½“äºå‘åç«¯å‘èµ·ä¸€æ¡ http è¯·æ±‚ï¼Œè·Ÿåç«¯çº¦å®šå¥½å‡½æ•°åï¼Œåç«¯æ‹¿åˆ°å‡½æ•°åï¼ŒåŠ¨æ€è®¡ç®—å‡ºè¿”å›ç»“æœå¹¶è¿”å›ç»™å‰ç«¯æ‰§è¡Œ JS è„šæœ¬ï¼Œç›¸å½“äºæ˜¯ä¸€ç§ â€œåŠ¨æ€ JS è„šæœ¬â€</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥å°è¯•ï¼š</p>
<p>åç«¯é€»è¾‘ï¼š</p>
<pre><code>// jsonp/server.js
const url = require(&apos;url&apos;);

require(&apos;http&apos;).createServer((req, res) =&gt; {
    const data = {
        x: 10
    };
    // æ‹¿åˆ°å›è°ƒå‡½æ•°å
    const callback = url.parse(req.url, true).query.callback;
    console.log(callback);
    res.writeHead(200);
    res.end(`${callback}(${JSON.stringify(data)})`);

}).listen(3000, &apos;127.0.0.1&apos;);

console.log(&apos;å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬ 127.0.0.1:3000&apos;);
</code></pre><p>å‰ç«¯é€»è¾‘ï¼š</p>
<pre><code>// jsonp/index.html
&lt;script&gt;
    function jsonpCallback(data) {
        alert(&apos;è·å¾— X æ•°æ®:&apos; + data.x);
    }
&lt;/script&gt;
&lt;script src=&quot;http://127.0.0.1:3000?callback=jsonpCallback&quot;&gt;&lt;/script&gt;
</code></pre><p>ç„¶ååœ¨ç»ˆç«¯å¼€å¯æœåŠ¡ï¼š</p>
<p>ä¹‹æ‰€ä»¥èƒ½ç”¨è„šæœ¬æŒ‡ä»¤ï¼Œæ˜¯å› ä¸ºæˆ‘åœ¨ package.json é‡Œé¢è®¾ç½®å¥½äº†è„šæœ¬å‘½ä»¤ï¼š</p>
<pre><code>{
  // è¾“å…¥ yarn jsonp ç­‰äº &quot;node ./jsonp/server.js &amp; http-server ./jsonp&quot;
  &quot;scripts&quot;: {
    &quot;jsonp&quot;: &quot;node ./jsonp/server.js &amp; http-server ./jsonp&quot;,
    &quot;cors&quot;: &quot;node ./cors/server.js &amp; http-server ./cors&quot;,
    &quot;proxy&quot;: &quot;node ./serverProxy/server.js&quot;,
    &quot;hash&quot;: &quot;http-server ./hash/client/ -p 8080 &amp; http-server ./hash/server/ -p 8081&quot;,
    &quot;name&quot;: &quot;http-server ./name/client/ -p 8080 &amp; http-server ./name/server/ -p 8081&quot;,
    &quot;postMessage&quot;: &quot;http-server ./postMessage/client/ -p 8080 &amp; http-server ./postMessage/server/ -p 8081&quot;,
    &quot;domain&quot;: &quot;http-server ./domain/client/ -p 8080 &amp; http-server ./domain/server/ -p 8081&quot;
  },
  // ...
}

yarn jsonp
// å› ä¸ºç«¯å£ 3000 å’Œ 8080 åˆ†åˆ«å±äºä¸åŒåŸŸåä¸‹
// åœ¨ localhost:3000 æŸ¥çœ‹æ•ˆæœï¼Œå³å¯æ”¶åˆ°åå°è¿”å›çš„æ•°æ® 10
</code></pre><p>æ‰“å¼€æµè§ˆå™¨è®¿é—® <code>localhost:8080</code> å³å¯çœ‹åˆ°è·å–åˆ°çš„æ•°æ®ã€‚</p>
<p><img src="https://pic2.zhimg.com/v2-1bd48c160110899a8ad7e08e56d36560_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-1bd48c160110899a8ad7e08e56d36560_hd.jpg" alt=""></p>
<p>è‡³æ­¤ï¼Œé€šè¿‡ JSONP è·¨åŸŸè·å–æ•°æ®å·²ç»æˆåŠŸäº†ï¼Œä½†æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨ç€ä¸€å®šçš„ä¼˜ç¼ºç‚¹ï¼š</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li>å®ƒä¸åƒXMLHttpRequest å¯¹è±¡å®ç° Ajax è¯·æ±‚é‚£æ ·å—åˆ°åŒæºç­–ç•¥çš„é™åˆ¶</li>
<li>å…¼å®¹æ€§å¾ˆå¥½ï¼Œåœ¨å¤è€çš„æµè§ˆå™¨ä¹Ÿèƒ½å¾ˆå¥½çš„è¿è¡Œ</li>
<li>ä¸éœ€è¦ XMLHttpRequest æˆ– ActiveX çš„æ”¯æŒï¼›å¹¶ä¸”åœ¨è¯·æ±‚å®Œæ¯•åå¯ä»¥é€šè¿‡è°ƒç”¨ callback çš„æ–¹å¼å›ä¼ ç»“æœã€‚</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>å®ƒæ”¯æŒ GET è¯·æ±‚è€Œä¸æ”¯æŒ POST ç­‰å…¶å®ƒç±»è¡Œçš„ HTTP è¯·æ±‚ã€‚</li>
<li>å®ƒåªæ”¯æŒè·¨åŸŸ HTTP è¯·æ±‚è¿™ç§æƒ…å†µï¼Œä¸èƒ½è§£å†³ä¸åŒåŸŸçš„ä¸¤ä¸ªé¡µé¢æˆ– iframe ä¹‹é—´è¿›è¡Œæ•°æ®é€šä¿¡çš„é—®é¢˜</li>
<li>æ— æ³•æ•è· Jsonp è¯·æ±‚æ—¶çš„è¿æ¥å¼‚å¸¸ï¼Œåªèƒ½é€šè¿‡è¶…æ—¶è¿›è¡Œå¤„ç†</li>
</ol>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS:"></a>CORS:</h2><p>CORS æ˜¯ä¸€ä¸ª W3C æ ‡å‡†ï¼Œå…¨ç§°æ˜¯â€è·¨åŸŸèµ„æºå…±äº«â€ï¼ˆCross-origin resource sharingï¼‰å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡º XMLHttpRequest è¯·æ±‚ï¼Œä»è€Œå…‹æœäº† ajax åªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚</p>
<p>CORS éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒæ‰å¯ä»¥ç”Ÿæ•ˆï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORS é€šä¿¡ä¸åŒæºçš„ ajax é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç° ajax è¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚</p>
<p>å› æ­¤ï¼Œå®ç° CORS é€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº† CORS æ¥å£ï¼Œå°±å¯ä»¥è·¨åŸŸé€šä¿¡ã€‚</p>
<p>å‰ç«¯é€»è¾‘å¾ˆç®€å•ï¼Œåªè¦æ­£å¸¸å‘èµ· ajax è¯·æ±‚å³å¯:</p>
<pre><code>// cors/index.html
&lt;script&gt;
    const xhr = new XMLHttpRequest();
    xhr.open(&apos;GET&apos;, &apos;http://127.0.0.1:3000&apos;, true);
    xhr.onreadystatechange = function() {
        if(xhr.readyState === 4 &amp;&amp; xhr.status === 200) {
            alert(xhr.responseText);
        }
    }
    xhr.send(null);
&lt;/script&gt;
</code></pre><p>è¿™ä¼¼ä¹è·Ÿä¸€æ¬¡æ­£å¸¸çš„å¼‚æ­¥ ajax è¯·æ±‚æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå…³é”®æ˜¯åœ¨æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åçš„å¤„ç†ï¼š</p>
<pre><code>// cors/server.js
require(&apos;http&apos;).createServer((req, res) =&gt; {

    res.writeHead(200, {
        &apos;Access-Control-Allow-Origin&apos;: &apos;http://localhost:8080&apos;,
        &apos;Content-Type&apos;: &apos;text/html;charset=utf-8&apos;,
    });
    res.end(&apos;è¿™æ˜¯ä½ è¦çš„æ•°æ®ï¼š1111&apos;);

}).listen(3000, &apos;127.0.0.1&apos;);

console.log(&apos;å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬ 127.0.0.1:3000&apos;);
</code></pre><p>å…³é”®æ˜¯åœ¨äºè®¾ç½®ç›¸åº”å¤´ä¸­çš„ Access-Control-Allow-Originï¼Œè¯¥å€¼è¦ä¸è¯·æ±‚å¤´ä¸­ Origin ä¸€è‡´æ‰èƒ½ç”Ÿæ•ˆï¼Œå¦åˆ™å°†è·¨åŸŸå¤±è´¥ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤ï¼š<code>yarn cors</code> æ‰“å¼€æµè§ˆå™¨è®¿é—® <code>localhost:3000</code> å³å¯çœ‹åˆ°æ•ˆæœï¼š</p>
<p><img src="https://pic2.zhimg.com/v2-13ee0a40a998948019749da80e1d259a_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-13ee0a40a998948019749da80e1d259a_hd.jpg" alt=""></p>
<p>æˆåŠŸçš„å…³é”®åœ¨äº Access-Control-Allow-Origin æ˜¯å¦åŒ…å«è¯·æ±‚é¡µé¢çš„åŸŸåï¼Œå¦‚æœä¸åŒ…å«çš„è¯ï¼Œæµè§ˆå™¨å°†è®¤ä¸ºè¿™æ˜¯ä¸€æ¬¡å¤±è´¥çš„å¼‚æ­¥è¯·æ±‚ï¼Œå°†ä¼šè°ƒç”¨ xhr.onerror ä¸­çš„å‡½æ•°ã€‚</p>
<p>CORS çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨ç®€å•æ–¹ä¾¿ï¼Œæ›´ä¸ºå®‰å…¨</li>
<li>æ”¯æŒ POST è¯·æ±‚æ–¹å¼</li>
<li>CORS æ˜¯ä¸€ç§æ–°å‹çš„è·¨åŸŸé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå­˜åœ¨å…¼å®¹é—®é¢˜ï¼Œä»…æ”¯æŒ IE 10 ä»¥ä¸Š</li>
</ol>
<p>è¿™é‡Œåªæ˜¯å¯¹ CORS åšä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œå¦‚æœæƒ³æ›´è¯¦ç»†åœ°äº†è§£å…¶åŸç†çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š</p>
<p><a href="https://link.zhihu.com/?target=http%3A//www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—</a></p>
<h2 id="3-æœåŠ¡ç«¯ä»£ç†ï¼š"><a href="#3-æœåŠ¡ç«¯ä»£ç†ï¼š" class="headerlink" title="3. æœåŠ¡ç«¯ä»£ç†ï¼š"></a>3. æœåŠ¡ç«¯ä»£ç†ï¼š</h2><p>æœåŠ¡å™¨ä»£ç†ï¼Œé¡¾åæ€ä¹‰ï¼Œå½“ä½ éœ€è¦æœ‰è·¨åŸŸçš„è¯·æ±‚æ“ä½œæ—¶å‘é€è¯·æ±‚ç»™åç«¯ï¼Œè®©åç«¯å¸®ä½ ä»£ä¸ºè¯·æ±‚ï¼Œç„¶åæœ€åå°†è·å–çš„ç»“æœå‘é€ç»™ä½ ã€‚</p>
<p>å‡è®¾æœ‰è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼Œä½ çš„é¡µé¢éœ€è¦è·å– <a href="https://link.zhihu.com/?target=https%3A//cnodejs.org/api" target="_blank" rel="noopener">CNodeï¼šNode.jsä¸“ä¸šä¸­æ–‡ç¤¾åŒº</a> è®ºå›ä¸Šä¸€äº›æ•°æ®ï¼Œå¦‚é€šè¿‡ <code>https://cnodejs.org/api/v1/topics</code>ï¼Œå½“æ—¶å› ä¸ºä¸åŒåŸŸï¼Œæ‰€ä»¥ä½ å¯ä»¥å°†è¯·æ±‚åç«¯ï¼Œè®©å…¶å¯¹è¯¥è¯·æ±‚ä»£ä¸ºè½¬å‘ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>// serverProxy/server.js
const url = require(&apos;url&apos;);
const http = require(&apos;http&apos;);
const https = require(&apos;https&apos;);

const server = http.createServer((req, res) =&gt; {
    const path = url.parse(req.url).path.slice(1);
    if(path === &apos;topics&apos;) {
        https.get(&apos;https://cnodejs.org/api/v1/topics&apos;, (resp) =&gt; {
            let data = &quot;&quot;;
            resp.on(&apos;data&apos;, chunk =&gt; {
                data += chunk;
            });
            resp.on(&apos;end&apos;, () =&gt; {
                res.writeHead(200, {
                    &apos;Content-Type&apos;: &apos;application/json; charset=utf-8&apos;
                });
                res.end(data);
            });
        })        
    }
}).listen(3000, &apos;127.0.0.1&apos;);
console.log(&apos;å¯åŠ¨æœåŠ¡ï¼Œç›‘å¬ 127.0.0.1:3000&apos;);
</code></pre><p>é€šè¿‡ä»£ç ä½ å¯ä»¥çœ‹å‡ºï¼Œå½“ä½ è®¿é—® <code>http://127.0.0.1:3000/topics</code> çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ï¼Œä¼šä»£ä½ å‘é€è¯·æ±‚ <code>https://cnodejs.org/api/v1/topics</code> æœ€åå°†è·å–åˆ°çš„æ•°æ®å‘é€ç»™æµè§ˆå™¨ã€‚</p>
<p>å¯åŠ¨æœåŠ¡ <code>yarn proxy</code> å¹¶è®¿é—® <code>http://localhost:3000/topics</code> å³å¯çœ‹åˆ°æ•ˆæœï¼š<br><img src="https://pic1.zhimg.com/v2-a14f2dd5cfd124187cabff0fdfabe5a9_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-a14f2dd5cfd124187cabff0fdfabe5a9_hd.jpg" alt=""></p>
<p>è·¨åŸŸè¯·æ±‚æˆåŠŸã€‚çº¯ç²¹çš„è·å–è·¨åŸŸè·å–åç«¯æ•°æ®çš„è¯·æ±‚çš„æ–¹å¼å·²ç»ä»‹ç»å®Œäº†ï¼Œå¦å¤–ä»‹ç»å››ç§é€šè¿‡ iframe è·¨åŸŸä¸å…¶å®ƒé¡µé¢é€šä¿¡çš„æ–¹å¼ã€‚</p>
<h2 id="location-hashï¼š"><a href="#location-hashï¼š" class="headerlink" title="location.hashï¼š"></a>location.hashï¼š</h2><p>åœ¨ url ä¸­ï¼Œ<code>http://www.baidu.com#helloworld</code> çš„ â€œ#helloworldâ€ å°±æ˜¯ location.hashï¼Œæ”¹å˜ hash å€¼ä¸ä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ hash å€¼æ¥è¿›è¡Œæ•°æ®çš„ä¼ é€’ï¼Œå½“ç„¶æ•°æ®é‡æ˜¯æœ‰é™çš„ã€‚</p>
<p>å‡è®¾ <code>localhost:8080</code> ä¸‹æœ‰æ–‡ä»¶ index.html è¦å’Œ <code>localhost:8081</code> ä¸‹çš„ data.html ä¼ é€’æ¶ˆæ¯ï¼Œindex.html é¦–å…ˆåˆ›å»ºä¸€ä¸ªéšè—çš„ iframeï¼Œiframe çš„ src æŒ‡å‘ <code>localhost:8081/data.html</code>ï¼Œè¿™æ—¶çš„ hash å€¼å°±å¯ä»¥åšå‚æ•°ä¼ é€’ã€‚</p>
<pre><code>// hash/client/index.html å¯¹åº” localhost:8080/index.html
&lt;script&gt;
    let ifr = document.createElement(&apos;iframe&apos;);
    ifr.style.display = &apos;none&apos;;
    ifr.src = &quot;http://localhost:8081/data.html#data&quot;;
    document.body.appendChild(ifr);

    function checkHash() {
        try {
            let data = location.hash ? location.hash.substring(1) : &apos;&apos;;
            console.log(&apos;è·å¾—åˆ°çš„æ•°æ®æ˜¯ï¼š&apos;, data);
        }catch(e) {

        }
    }
    window.addEventListener(&apos;hashchange&apos;, function(e) {
        console.log(&apos;è·å¾—çš„æ•°æ®æ˜¯ï¼š&apos;, location.hash.substring(1));
    });
&lt;/script&gt;
</code></pre><p>data.html æ”¶åˆ°æ¶ˆæ¯åé€šè¿‡ parent.location.hash å€¼æ¥ä¿®æ”¹ index.html çš„ hash å€¼ï¼Œä»è€Œè¾¾åˆ°æ•°æ®ä¼ é€’ã€‚</p>
<pre><code>// hash/server/data.html å¯¹åº” localhost:8081/data.html
&lt;script&gt;
    switch(location.hash) {
        case &quot;#data&quot;:
            callback();
            break;
    }
    function callback() {
        const data = &quot;data.html çš„æ•°æ®&quot;
        try {
            parent.location.hash = data;
        }catch(e) {
            // ie, chrome ä¸‹çš„å®‰å…¨æœºåˆ¶æ— æ³•ä¿®æ”¹ parent.location.hash
            // æ‰€ä»¥è¦åˆ©ç”¨ä¸€ä¸ªä¸­é—´çš„ä»£ç† iframe 
            var ifrproxy = document.createElement(&apos;iframe&apos;);
            ifrproxy.style.display = &apos;none&apos;;
            ifrproxy.src = &apos;http://localhost:8080/proxy.html#&apos; + data;     // è¯¥æ–‡ä»¶åœ¨ client åŸŸåçš„åŸŸä¸‹
            document.body.appendChild(ifrproxy);
        }
    }
&lt;/script&gt;
</code></pre><p>ç”±äºä¸¤ä¸ªé¡µé¢ä¸åœ¨åŒä¸€ä¸ªåŸŸä¸‹ IEã€Chrome ä¸å…è®¸ä¿®æ”¹ parent.location.hash çš„å€¼ï¼Œæ‰€ä»¥è¦å€ŸåŠ©äº <code>localhost:8080</code> åŸŸåä¸‹çš„ä¸€ä¸ªä»£ç† iframe çš„ proxy.html é¡µé¢</p>
<pre><code>// hash/client/proxy.html å¯¹åº” localhost:8080/proxy.html
&lt;script&gt;
    parent.parent.location.hash = self.location.hash.substring(1);
&lt;/script&gt;
</code></pre><p>ä¹‹åå¯åŠ¨æœåŠ¡ <code>yarn hash</code>ï¼Œå³å¯åœ¨ <code>localhost:8080</code> ä¸‹è§‚å¯Ÿåˆ°ï¼š</p>
<p><img src="https://pic2.zhimg.com/v2-278b33c730dc9aaf499f172424adde00_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-278b33c730dc9aaf499f172424adde00_hd.jpg" alt=""></p>
<p>å½“ç„¶è¿™ç§æ–¹æ³•å­˜åœ¨ç€è¯¸å¤šçš„ç¼ºç‚¹ï¼š</p>
<ol>
<li>æ•°æ®ç›´æ¥æš´éœ²åœ¨äº† url ä¸­</li>
<li>æ•°æ®å®¹é‡å’Œç±»å‹éƒ½æœ‰é™ç­‰ç­‰</li>
</ol>
<h2 id="window-name"><a href="#window-name" class="headerlink" title="window.name:"></a>window.name:</h2><p>window.nameï¼ˆä¸€èˆ¬åœ¨ js ä»£ç é‡Œå‡ºç°ï¼‰çš„å€¼ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„å…¨å±€å˜é‡ï¼Œè€Œæ˜¯å½“å‰çª—å£çš„åå­—ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯æ¯ä¸ª iframe éƒ½æœ‰åŒ…è£¹å®ƒçš„ windowï¼Œè€Œè¿™ä¸ª window æ˜¯ top window çš„å­çª—å£ï¼Œè€Œå®ƒè‡ªç„¶ä¹Ÿæœ‰ window.name çš„å±æ€§ï¼Œwindow.name å±æ€§çš„ç¥å¥‡ä¹‹å¤„åœ¨äº name å€¼åœ¨ä¸åŒçš„é¡µé¢ï¼ˆç”šè‡³ä¸åŒåŸŸåï¼‰åŠ è½½åä¾æ—§å­˜åœ¨ï¼ˆå¦‚æœæ²¡ä¿®æ”¹åˆ™å€¼ä¸ä¼šå˜åŒ–ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒéå¸¸é•¿çš„ name å€¼ï¼ˆ2MBï¼‰ã€‚</p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<p>ä½ åœ¨æŸä¸ªé¡µé¢çš„æ§åˆ¶å°è¾“å…¥ï¼š</p>
<pre><code>window.name = &quot;Hello World&quot;
window.location = &quot;http://www.baidu.com&quot;
</code></pre><p>é¡µé¢è·³è½¬åˆ°äº†ç™¾åº¦é¦–é¡µï¼Œä½†æ˜¯ window.name å´è¢«ä¿å­˜äº†ä¸‹æ¥ï¼Œè¿˜æ˜¯ Hello Worldï¼Œè·¨åŸŸè§£å†³æ–¹æ¡ˆä¼¼ä¹å¯ä»¥å‘¼ä¹‹æ¬²å‡ºäº†ï¼š</p>
<p>å‰ç«¯é€»è¾‘ï¼š</p>
<pre><code>// name/client/index.html å¯¹åº” localhost:8080/index.html 
&lt;script&gt;
    let data = &apos;&apos;;
    const ifr = document.createElement(&apos;iframe&apos;);
    ifr.src = &quot;http://localhost:8081/data.html&quot;;
    ifr.style.display = &apos;none&apos;;
    document.body.appendChild(ifr);
    ifr.onload = function() {
        ifr.onload = function() {
            data = ifr.contentWindow.name;
            console.log(&apos;æ”¶åˆ°æ•°æ®:&apos;, data);
        }
        ifr.src = &quot;http://localhost:8080/proxy.html&quot;;
    }
&lt;/script&gt;
</code></pre><p>æ•°æ®é¡µé¢ï¼š</p>
<pre><code>// name/server/data.html å¯¹åº” localhost:8081/data.html
&lt;script&gt;
    window.name = &quot;data.html çš„æ•°æ®!&quot;;
&lt;/script&gt;
</code></pre><p><code>localhost:8080index.html</code> åœ¨è¯·æ±‚æ•°æ®ç«¯ <code>localhost:8081/data.html</code> æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥é¡µé¢æ–°å»ºä¸€ä¸ª iframeï¼Œè¯¥ iframe çš„ src æŒ‡å‘æ•°æ®ç«¯åœ°å€(åˆ©ç”¨ iframe æ ‡ç­¾çš„è·¨åŸŸèƒ½åŠ›)ï¼Œæ•°æ®ç«¯æ–‡ä»¶è®¾ç½®å¥½ window.name çš„å€¼ã€‚</p>
<p>ä½†æ˜¯ç”±äº index.html é¡µé¢ä¸è¯¥é¡µé¢ iframe çš„ src å¦‚æœä¸åŒæºçš„è¯ï¼Œåˆ™æ— æ³•æ“ä½œ iframe é‡Œçš„ä»»ä½•ä¸œè¥¿ï¼Œæ‰€ä»¥å°±å–ä¸åˆ° iframe çš„ name å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ data.html åŠ è½½å®Œåé‡æ–°æ¢ä¸ª src å»æŒ‡å‘ä¸€ä¸ªåŒæºçš„ html æ–‡ä»¶ï¼Œæˆ–è€…è®¾ç½®æˆ â€˜about:blank;â€™ éƒ½è¡Œï¼Œè¿™æ—¶å€™æˆ‘åªè¦åœ¨ index.html ç›¸åŒç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª proxy.html çš„ç©ºé¡µé¢å³å¯ã€‚å¦‚æœä¸é‡æ–°æŒ‡å‘ src çš„è¯ç›´æ¥è·å–çš„ window.name çš„è¯ä¼šæŠ¥é”™ï¼š</p>
<p><img src="https://pic2.zhimg.com/v2-7bd77f4df4565cd258bbeeed28515152_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-7bd77f4df4565cd258bbeeed28515152_hd.jpg" alt=""></p>
<p>ä¹‹åè¿è¡Œ <code>yarn name</code> å³å¯çœ‹åˆ°æ•ˆæœï¼š</p>
<p><img src="https://pic4.zhimg.com/v2-4dcf4a5d25982ce71bdbe6f14af4620c_b.jpg" alt=""><img src="https://pic4.zhimg.com/80/v2-4dcf4a5d25982ce71bdbe6f14af4620c_hd.jpg" alt=""></p>
<h2 id="6-postMessage"><a href="#6-postMessage" class="headerlink" title="6.postMessage"></a>6.postMessage</h2><p>postMessage æ˜¯ HTML5 æ–°å¢åŠ çš„ä¸€é¡¹åŠŸèƒ½ï¼Œè·¨æ–‡æ¡£æ¶ˆæ¯ä¼ è¾“(Cross Document Messaging)ï¼Œç›®å‰ï¼šChrome 2.0+ã€Internet Explorer 8.0+, Firefox 3.0+, Opera 9.6+, å’Œ Safari 4.0+ éƒ½æ”¯æŒè¿™é¡¹åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿç‰¹åˆ«ç®€å•ã€‚</p>
<p>å‰ç«¯é€»è¾‘ï¼š</p>
<pre><code>// postMessage/client/index.html å¯¹åº” localhost:8080/index.html
&lt;iframe src=&quot;http://localhost:8081/data.html&quot; style=&apos;display: none;&apos;&gt;&lt;/iframe&gt;
&lt;script&gt;
    window.onload = function() {
        let targetOrigin = &apos;http://localhost:8081&apos;;
        window.frames[0].postMessage(&apos;index.html çš„ data!&apos;, targetOrigin);
    }
    window.addEventListener(&apos;message&apos;, function(e) {
        console.log(&apos;index.html æ¥æ”¶åˆ°çš„æ¶ˆæ¯:&apos;, e.data);
    });
&lt;/script&gt;
</code></pre><p>åˆ›å»ºä¸€ä¸ª iframeï¼Œä½¿ç”¨ iframe çš„ä¸€ä¸ªæ–¹æ³• postMessage å¯ä»¥æƒ³ <code>http://localhost:8081/data.html</code> å‘é€æ¶ˆæ¯ï¼Œç„¶åç›‘å¬ messageï¼Œå¯ä»¥è·å¾—å…¶æ–‡æ¡£å‘æ¥çš„æ¶ˆæ¯ã€‚</p>
<p>æ•°æ®ç«¯é€»è¾‘ï¼š</p>
<pre><code>// postMessage/server/data.html å¯¹åº” localhost:8081/data.html
&lt;script&gt;
    window.addEventListener(&apos;message&apos;, function(e) {
        if(e.source != window.parent) {
            return;
        }
        let data = e.data;
        console.log(&apos;data.html æ¥æ”¶åˆ°çš„æ¶ˆæ¯:&apos;, data);
        parent.postMessage(&apos;data.html çš„ data!&apos;, e.origin);
    });
&lt;/script&gt;
</code></pre><p>å¯åŠ¨æœåŠ¡ï¼š<code>yarn postMessage</code> å¹¶æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š</p>
<p><img src="https://pic1.zhimg.com/v2-62c2ff153980a18ddd08110cd41cfde4_b.jpg" alt=""><img src="https://pic1.zhimg.com/80/v2-62c2ff153980a18ddd08110cd41cfde4_hd.jpg" alt=""></p>
<p>å¯¹ postMessage æ„Ÿå…´è¶£çš„è¯¦ç»†å†…å®¹å¯ä»¥çœ‹çœ‹æ•™ç¨‹ï¼š</p>
<p><a href="https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/PostMessage/6373972%3Ffr%3Daladdin" target="_blank" rel="noopener">PostMessage_ç™¾åº¦ç™¾ç§‘</a><a href="https://link.zhihu.com/?target=https%3A//developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">Window.postMessage()</a></p>
<h2 id="7-document-domain"><a href="#7-document-domain" class="headerlink" title="7.document.domain"></a>7.document.domain</h2><p>å¯¹äºä¸»åŸŸç›¸åŒè€Œå­åŸŸä¸åŒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® document.domain çš„åŠæ³•æ¥è§£å†³ï¼Œå…·ä½“åšæ³•æ˜¯å¯ä»¥åœ¨ <code>http://www.example.com/index.html</code> å’Œ <code>http://sub.example.com/data.html</code> ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«åŠ ä¸Š <code>document.domain = &quot;example.com&quot;</code> ç„¶åé€šè¿‡ index.html æ–‡ä»¶åˆ›å»ºä¸€ä¸ª iframeï¼Œå»æ§åˆ¶ iframe çš„ windowï¼Œä»è€Œè¿›è¡Œäº¤äº’ï¼Œå½“ç„¶è¿™ç§æ–¹æ³•åªèƒ½è§£å†³ä¸»åŸŸç›¸åŒè€ŒäºŒçº§åŸŸåä¸åŒçš„æƒ…å†µï¼Œå¦‚æœä½ å¼‚æƒ³å¤©å¼€çš„æŠŠ script.example.com çš„ domain è®¾ä¸º qq.com æ˜¾ç„¶æ˜¯æ²¡ç”¨çš„ï¼Œé‚£ä¹ˆå¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ</p>
<p>æµ‹è¯•çš„æ–¹å¼ç¨å¾®å¤æ‚ç‚¹ï¼Œéœ€è¦å®‰è£… nginx åšåŸŸåæ˜ å°„ï¼Œå¦‚æœä½ ç”µè„‘æ²¡æœ‰å®‰è£… nginxï¼Œè¯·å…ˆå»å®‰è£…ä¸€ä¸‹: <a href="https://link.zhihu.com/?target=http%3A//nginx.org/" target="_blank" rel="noopener">nginx</a></p>
<p>å‰ç«¯é€»è¾‘ï¼š</p>
<pre><code>// domain/client/index.html å¯¹åº” sub1.example.com/index.html
&lt;script&gt;
    document.domain = &apos;example.com&apos;;
    let ifr = document.createElement(&apos;iframe&apos;);
    ifr.src = &apos;http://sub2.example.com/data.html&apos;;
    ifr.style.display = &apos;none&apos;;
    document.body.append(ifr);
    ifr.onload = function() {
        let win = ifr.contentWindow;
        alert(win.data);
    }
&lt;/script&gt;
</code></pre><p>æ•°æ®ç«¯é€»è¾‘ï¼š</p>
<pre><code>// domain/server/data å¯¹åº” sub2.example.com/data.html
&lt;script&gt;
    document.domain = &apos;example.com&apos;;
    window.data = &apos;data.html çš„æ•°æ®ï¼&apos;;
&lt;/script&gt;
</code></pre><p>æ‰“å¼€æ“ä½œç³»ç»Ÿä¸‹çš„ hosts æ–‡ä»¶ï¼šmac æ˜¯ä½äº /etc/hosts æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ï¼š</p>
<pre><code>127.0.0.1 sub1.example.com
127.0.0.1 sub2.example.com
</code></pre><p>ä¹‹åæ‰“å¼€ nginx çš„é…ç½®æ–‡ä»¶ï¼š/usr/local/etc/nginx/nginx.confï¼Œå¹¶åœ¨ http æ¨¡å—é‡Œæ·»åŠ ï¼Œè®°å¾—è¾“å…¥ nginx å¯åŠ¨ nginx æœåŠ¡ï¼š</p>
<pre><code>/usr/local/etc/nginx/nginx.conf
http {
    // ...
    server {
        listen 80;
        server_name sub1.example.com;
        location / {
            proxy_pass http://127.0.0.1:8080/;
        }
    }
    server {
        listen 80;
        server_name sub2.example.com;
        location / {
            proxy_pass http://127.0.0.1:8081/;
        }
    }
    // ...
}
</code></pre><p>ç›¸å½“äºæ˜¯è®² <code>sub1.example.com</code> å’Œ <code>sub2.example.com</code> è¿™äº›åŸŸååœ°å€æŒ‡å‘æœ¬åœ° <code>127.0.0.1:80</code>ï¼Œç„¶åç”¨ nginx åšåå‘ä»£ç†åˆ†åˆ«æ˜ å°„åˆ° 8080 å’Œ 8081 ç«¯å£ã€‚</p>
<p>è¿™æ ·è®¿é—® <code>sub1(2).example.com</code> ç­‰äºè®¿é—® <code>127.0.0.1:8080(1)</code></p>
<p>å¯åŠ¨æœåŠ¡ <code>yarn domain</code> è®¿é—®æµè§ˆå™¨å³å¯çœ‹åˆ°æ•ˆæœï¼š</p>
<p><img src="https://pic2.zhimg.com/v2-19277c077856648ca1d593f44afadf6e_b.jpg" alt=""><img src="https://pic2.zhimg.com/80/v2-19277c077856648ca1d593f44afadf6e_hd.jpg" alt=""></p>
<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>å‰é¢ä¸ƒç§è·¨åŸŸæ–¹å¼æˆ‘å·²ç»å…¨éƒ¨è®²å®Œï¼Œå…¶å®è®²é“ç†ï¼Œå¸¸ç”¨çš„ä¹Ÿå°±æ˜¯å‰ä¸‰ç§æ–¹å¼ï¼Œåé¢å››ç§æ›´å¤šæ—¶å€™æ˜¯ä¸€äº›å°æŠ€å·§ï¼Œè™½ç„¶åœ¨å·¥ä½œä¸­ä¸ä¸€å®šä¼šç”¨åˆ°ï¼Œä½†æ˜¯å¦‚æœä½ åœ¨é¢è¯•è¿‡ç¨‹ä¸­èƒ½å¤Ÿæåˆ°è¿™äº›è·¨åŸŸçš„æŠ€å·§ï¼Œæ— ç–‘åœ¨é¢è¯•å®˜çš„å¿ƒä¸­æ˜¯ä¸€ä¸ªåŠ åˆ†é¡¹ã€‚</p>
<p>ä¸Šé¢é˜è¿°æ–¹æ³•çš„æ—¶å€™å¯èƒ½æœ‰äº›è®²çš„ä¸æ˜ç™½ï¼Œå¸Œæœ›åœ¨é˜…è¯»çš„è¿‡ç¨‹ä¸­å»ºè®®ä½ è·Ÿç€æˆ‘æ•²ä»£ç ï¼Œå½“ä½ æ‰“å¼€æµè§ˆå™¨çœ‹åˆ°ç»“æœçš„æ—¶å€™ï¼Œä½ ä¹Ÿå°±èƒ½æŒæ¡åˆ°è¿™ç§æ–¹æ³•ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/tx.jpg"
                alt="ææ–Œ" />
            
              <p class="site-author-name" itemprop="name">ææ–Œ</p>
              <p class="site-description motion-element" itemprop="description">æƒ³è¦é£å¾—é«˜ï¼Œé‚£å°±æŠŠåœ°å¹³çº¿å¿˜æ‰</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="3120217729@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ææ–Œ</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

